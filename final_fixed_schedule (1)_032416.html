<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Definitive Schedule Generator</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 1600px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1c293a; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; align-items: start; }
        .control-group { background: #f8f9fa; padding: 20px; border-radius: 6px; border: 1px solid #dee2e6; }
        .btn { font-size: 14px; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; transition: all 0.2s; margin-top: 5px; }
        .btn:disabled { background-color: #adb5bd; cursor: not-allowed; }
        .btn-primary { background-color: #0d6efd; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-success { background-color: #198754; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
        th, td { border: 1px solid #dee2e6; padding: 6px; text-align: center; font-size: 12px; min-width: 75px; }
        .employee-name { text-align: left; font-weight: bold; position: sticky; left: 0; background-color: #f8f9fa; z-index: 5; width: 160px; min-width: 160px; }
        .open-shift-row { background-color: #fffbe6; font-weight: bold; }
        td[contenteditable="true"]:hover { background-color: #e9ecef; cursor: pointer; }
        td[contenteditable="true"]:focus { background-color: #d1e7fd; outline: 2px solid #0d6efd; }
        input, select { width: 100%; box-sizing: border-box; padding: 8px; border-radius: 4px; border: 1px solid #ced4da; margin-bottom: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 900px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        td.pto-cell { background-color: #fff3cd !important; }
        td.pto-approved { background-color: #d4edda !important; }
        td.pto-pending { background-color: #f8d7da !important; }
        td.weekend { background-color: #f1f1f1; }
        .shift-assigned { background-color: #d4edda !important; }
        .shift-overtime { background-color: #f8d7da !important; }
        .shift-undertime { background-color: #fff3cd !important; }
        .holiday { background-color: #e2e3e5 !important; border: 2px solid #6c757d !important; }
        .employee-stats { font-size: 10px; color: #666; display: block; }
        .submenu { display: none; position: absolute; left: 100%; top: 0; background: white; border: 1px solid #ccc; min-width: 150px; z-index: 10001; }
        .submenu div { padding: 8px 15px; cursor: pointer; }
        .submenu div:hover { background-color: #0d6efd; color: white; }
        .bulk-select { background-color: #e3f2fd !important; }
        .conflict-cell { background-color: #f8d7da !important; border: 2px solid #dc3545 !important; }
        #contextMenu { display: none; position: absolute; background-color: white; border: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.2); padding: 5px 0; border-radius: 5px; z-index: 10000; }
        #contextMenu div { padding: 8px 15px; cursor: pointer; }
        #contextMenu div:hover { background-color: #0d6efd; color: white; }
        .note-indicator { position: absolute; top: 2px; right: 2px; width: 0; height: 0; border-left: 6px solid transparent; border-top: 6px solid #0d6efd; }
        .dashboard-under { background-color: #cfe2ff; } .dashboard-over { background-color: #f8d7da; } .dashboard-low-staff { background-color: #fff3cd; }
        #employee-portal h1 { text-align: center; } #employee-portal .schedule-list { list-style-type: none; padding: 0; } #employee-portal .schedule-list li { background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; } #employee-portal .schedule-list .day-name { font-weight: bold; }
        .pto-request-item { background: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 10px; }
        .pto-status-pending { border-left: 4px solid #ffc107; }
        .pto-status-approved { border-left: 4px solid #28a745; }
        .pto-status-denied { border-left: 4px solid #dc3545; }
        .pto-conflict { background-color: #f8d7da !important; border: 2px solid #dc3545 !important; }
        .pto-eligible { color: #28a745; font-weight: bold; }
        .pto-ineligible { color: #dc3545; font-weight: bold; }
        .pto-calendar-view { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0; }
        .pto-calendar-day { padding: 8px; border: 1px solid #ddd; text-align: center; min-height: 40px; }
        .pto-calendar-approved { background-color: #d4edda; }
        .pto-calendar-pending { background-color: #fff3cd; }
        .pto-calendar-conflict { background-color: #f8d7da; }
        @media print {
            body { background-color: white; padding: 0; margin: 0; }
            .container, .controls, .dashboard, hr, .modal, #contextMenu { display: none; }
            #schedule-table { display: table !important; width: 100%; }
            thead th, .employee-name { position: static; }
            td, th { font-size: 9pt; padding: 4px; color: black !important; }
            .open-shift-row { background-color: #fcf8e3 !important; }
            .pto-cell { background-color: #faf2cc !important; }
            .weekend { background-color: #f1f1f1 !important; }
            .conflict-cell { border: 1px solid black !important; background-color: #dddddd !important; }
            @page { size: landscape; }
        }
    </style>
</head>
<body>

    <div id="manager-view">
        <div class="container">
            <h1>Definitive Schedule Generator</h1>
            <p>A complete scheduling workspace. This tool auto-saves your progress to the browser.</p>

            <div class="controls">
                <div class="control-group">
                    <h3>‚öôÔ∏è Admin & Setup</h3>
                    <label for="scheduleMonth">Select Month:</label>
                    <input id="scheduleMonth" type="month"/>
                    <button class="btn btn-primary" onclick="openEmployeeModal()">üë• Manage Employees</button>
                    <button class="btn btn-secondary" onclick="importJSON()">üì• Import .json Backup</button>
                    <button class="btn btn-secondary" onclick="exportJSON()">üì§ Export .json Backup</button>
                    <button class="btn btn-danger" onclick="resetSavedState()">üîÑ Reset All Data</button>
                    <button class="btn btn-success" onclick="openExcelImportModal()">üìÑ Import from Excel</button>
                    <button class="btn btn-warning" onclick="showValidationResults()">‚úì Validate Schedule</button>
		    <button class="btn btn-primary" onclick="openReportsModal()">üìä View Reports</button>
		    <button class="btn btn-success" onclick="openBidsModal()">üôã Manage Bids</button>
		    <button class="btn btn-secondary" onclick="printSchedule()">üñ®Ô∏è Print Schedule</button>
                    <button class="btn btn-success" onclick="openBulkPTOModal()">üìÖ Bulk PTO</button>
                    <button class="btn btn-primary" onclick="openPTORequestsModal()">üèñÔ∏è Review PTO Requests</button>
                    <button class="btn btn-success" onclick="generateMonthlyPTOReports()">üìä Generate Monthly PTO Reports</button>
                </div>
                <div class="control-group">
                    <h3>ü§ñ Scheduling Actions</h3>
                    <button class="btn btn-primary" onclick="autoGenerateFullSchedule()">‚ú® Generate Full Schedule</button>
                    <button class="btn btn-secondary" onclick="moveOpenPositionShifts()">‚û°Ô∏è Move 'Open Position' Shifts</button>
                    <button class="btn btn-warning" onclick="findConflicts()">üö® Find Conflicts</button>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="undo()" id="undoBtn" disabled>‚Ü©Ô∏è Undo</button>
                        <button class="btn btn-secondary" onclick="redo()" id="redoBtn" disabled>‚Ü™Ô∏è Redo</button>
                    </div>
                </div>
                <div class="control-group">
                    <h3>üìã Export to Excel</h3>
                     <p>Follow these steps to update your shared Excel file.</p>
                    <button class="btn btn-primary" onclick="openEmailModal()">üìß Email Schedule</button>
                    <button class="btn btn-danger" onclick="clearSchedule()">üóëÔ∏è Clear Schedule Grid</button>
                    <button class="btn btn-secondary" onclick="copyEmployeeListForExcel()">1. Copy Employee List</button>
                    <button class="btn btn-success" onclick="copyScheduleForExcel()">2. Copy Schedule Grid</button>
                    <button class="btn btn-success" onclick="copyOpenShiftsForExcel()">3. Copy Open Shifts List</button>
                </div>
            </div>
            <hr style="margin: 30px 0;"/>

            <h2 style="margin-top: 30px;">Interactive Schedule Preview</h2>
            <p>Right-click a shift for options. Left-click to edit manually.</p>
            <div style="overflow-x: auto;">
                <table id="schedule-table"><thead></thead><tbody></tbody></table>
            </div>

            <div class="dashboard">
                <h2 style="margin-top: 30px;">Live Workload Dashboard</h2>
                <div class="controls" style="grid-template-columns: 1fr 1fr;">
                    <div id="employee-dashboard-container">
                        <h3>Employee Workload</h3>
                        <div style="margin-top: 10px;">
                            <label for="targetHours" style="font-size: 12px;">Target Hours for FT (approx):</label>
                            <input type="number" id="targetHours" value="160" style="padding: 4px; width: 80px; margin-bottom: 10px;" onchange="renderDashboard()">
                        </div>
                        <table id="employee-dashboard-table"></table>
                    </div>
                    <div id="daily-dashboard-container">
                        <h3>Daily Coverage</h3>
                        <div style="margin-top: 10px;">
                            <label for="minStaff" style="font-size: 12px;">Min Staffing Level:</label>
                            <input type="number" id="minStaff" value="3" style="padding: 4px; width: 80px; margin-bottom: 10px;" onchange="renderDashboard()">
                        </div>
                        <table id="daily-dashboard-table"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<div id="employee-portal" style="display:none;">
    <div class="container">
        <h1 id="portal-title" style="position: relative; text-align: center;">
            Your Schedule
            <span id="notification-bell" style="position: absolute; right: 10px; top: 5px; font-size: 24px; cursor: pointer;">üîî</span>
        </h1>
        <div id="notification-popup" style="display: none; position: absolute; right: 20px; top: 80px; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 5px; width: 300px; z-index: 1001;"></div>
        <h3 id="portal-employee-name" style="text-align:center; margin-top: -10px;"></h3>
        <div id="portal-schedule-view"></div>
        <hr>
        <!-- PTO Request Section -->
        <div id="portal-pto-section">
            <h2>Request Time Off</h2>
            <div id="pto-balance-display" style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <h4>Your PTO Balance</h4>
                <div id="pto-balance-details"></div>
            </div>
            <div id="pto-request-form" style="background: #f8f9fa; padding: 20px; border-radius: 5px; border: 1px solid #dee2e6;">
                <h4>Submit New PTO Request</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label for="pto-start-date">Start Date:</label>
                        <input type="date" id="pto-start-date" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                    </div>
                    <div>
                        <label for="pto-end-date">End Date:</label>
                        <input type="date" id="pto-end-date" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="pto-type">Reason/Type:</label>
                    <select id="pto-type" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                        <option value="vacation">Vacation</option>
                        <option value="sick">Sick Leave</option>
                        <option value="personal">Personal</option>
                        <option value="emergency">Emergency</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="pto-days-display">Days Requested:</label>
                    <input type="text" id="pto-days-display" readonly style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da; background: #e9ecef;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="pto-comments">Comments/Notes:</label>
                    <textarea id="pto-comments" rows="3" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitPTORequest()" style="width: 100%;">Submit PTO Request</button>
            </div>
            <div id="pto-request-history" style="margin-top: 20px;">
                <h4>Your PTO Request History</h4>
                <div id="pto-history-list"></div>
            </div>
        </div>
        <hr>
        <div id="portal-bids-view"></div>
    </div>
</div>

    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Manage Employees</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <h3 id="modal-title">Add New Employee</h3>
            <div class="controls" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                 <input id="empIndex" type="hidden"/>
                 <input id="empId" type="hidden"/>
                 <input id="newName" placeholder="Last, First" type="text"/>
                 <select id="newType"><option value="FT">Full Time (FT)</option><option value="PT">Part Time (PT)</option></select>
                 <input id="newShifts" placeholder="Regular Shifts (e.g., 10a-6:30p)" type="text"/>
                 <div>
                    <label for="newTargetHours" style="font-size:12px;display:block;">Target Hours/Month</label>
                    <input id="newTargetHours" type="number" value="0" min="0"/>
                 </div>
                 <input id="newAvailability" placeholder="Availability (e.g., Mon,Tue,Fri)" type="text" style="grid-column: 1 / span 2;"/>
		 <input id="newEmail" placeholder="employee@email.com" type="email" style="grid-column: 1 / span 2;"/>
                 <div>
                    <label for="newHireDate" style="font-size:12px;display:block;">Hire Date*</label>
                    <input id="newHireDate" type="date" required/>
                 </div>
                 <div>
                    <label for="newMaxDays" style="font-size:12px;display:block;">Max Days/Week (0=no limit)</label>
                    <input id="newMaxDays" type="number" value="0" min="0" max="7"/>
                 </div>
            </div>
            <button class="btn btn-primary" id="saveEmpBtn" onclick="saveEmployee()">üíæ Save Employee</button>
            <button class="btn btn-secondary" onclick="clearEmployeeForm()">Clear Form</button>
            <hr>
            <h3>Current Roster</h3>
            <div id="employee-list-container" style="max-height: 300px; overflow-y: auto;">
                <table id="employee-list-table"></table>
            </div>
        </div>
    </div>
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Add/Edit Note</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <textarea id="noteText" rows="4" style="width: 100%;"></textarea>
            <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
        </div>
    </div>
    <div id="bulkPTOModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Bulk PTO Assignment</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <label for="ptoEmployee">Select Employee:</label>
            <select id="ptoEmployee"></select>
            <label for="ptoStartDate">Start Date:</label>
            <input id="ptoStartDate" type="date"/>
            <label for="ptoEndDate">End Date:</label>
            <input id="ptoEndDate" type="date"/>
            <button class="btn btn-primary" onclick="applyBulkPTO()">Apply PTO</button>
        </div>
    </div>
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Email Schedule</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <label for="emailEmployee">Select Employee:</label>
            <select id="emailEmployee"></select>
            <label for="emailAddress">Email Address:</label>
            <input id="emailAddress" type="email" placeholder="employee@company.com"/>
            <button class="btn btn-primary" onclick="generateEmail()">Generate Email</button>
            <div id="emailPreview" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
                <h4>Email Preview:</h4>
                <div id="emailContent"></div>
                <button class="btn btn-success" onclick="sendEmail()">Send Email</button>
            </div>
        </div>
    </div>
    <div id="excelImportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Import Schedule from Excel</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <p>Please select an Excel (.xlsx) or CSV (.csv) file with the correct format:</p>
            <ul style="margin-top: 0; padding-left: 20px;">
                <li><b>Column A:</b> Employee names, starting from row 4.</li>
                <li><b>Row 2:</b> Full dates for the schedule (e.g., 8/1/2025, 8/2/2025...).</li>
            </ul>
            <input type="file" id="excel-file-input" accept=".xlsx, .csv" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%;"/>
            <button class="btn btn-primary" onclick="importFromExcel()" style="margin-top: 15px;">Process Selected File</button>
        </div>
    </div>
<div id="notificationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h2>Notify Employee of Change?</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <p id="notification-text"></p>
            <div style="text-align: right;">
                <button class="btn btn-secondary" onclick="closeAllModals()">Don't Notify</button>
                <button class="btn btn-primary" onclick="sendChangeNotification()">Notify Employee</button>
            </div>
        </div>
    </div>
<div id="bidsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Manage Open Shift Bids</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <div id="bids-container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
    <div id="contextMenu"></div>
<div id="reportsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Schedule Reports</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <div id="reports-container"></div>
        </div>
    </div>

    <!-- PTO Requests Modal -->
    <div id="ptoRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>PTO Requests Management</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <hr>
            <div id="pto-dashboard" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #d4edda; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">Pending Requests</h4>
                    <div id="pending-count" style="font-size: 24px; font-weight: bold;">0</div>
                </div>
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">Conflicts Detected</h4>
                    <div id="conflicts-count" style="font-size: 24px; font-weight: bold;">0</div>
                </div>
                <div style="background: #cce5ff; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">Total Requests</h4>
                    <div id="total-requests-count" style="font-size: 24px; font-weight: bold;">0</div>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="batchApprovePTO()">‚úì Batch Approve Selected</button>
                <button class="btn btn-danger" onclick="batchDenyPTO()">‚úó Batch Deny Selected</button>
                <button class="btn btn-info" onclick="generateBatchPDFs()">üìÑ Generate PDFs for Selected</button>
                <button class="btn btn-warning" onclick="exportPTOReport()">üìä Export Full Report</button>
                <select id="pto-filter" onchange="filterPTORequests()" style="float: right; padding: 5px;">
                    <option value="all">All Requests</option>
                    <option value="pending">Pending Only</option>
                    <option value="approved">Approved Only</option>
                    <option value="denied">Denied Only</option>
                    <option value="conflicts">Conflicts Only</option>
                </select>
            </div>
            <div id="pto-requests-container" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="monthlyPTOReportsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>Monthly PTO Balance Reports</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <hr>
            <div style="margin-bottom: 20px;">
                <label for="reportMonth">Select Month for Report:</label>
                <input type="month" id="reportMonth" style="margin-left: 10px; padding: 5px;">
                <button class="btn btn-primary" onclick="generatePTOReportForMonth()" style="margin-left: 10px;">Generate Reports</button>
                <button class="btn btn-success" onclick="emailAllPTOReports()" style="margin-left: 10px;">üìß Email All Reports</button>
            </div>
            <div id="monthly-pto-reports-container" style="max-height: 600px; overflow-y: auto;"></div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
    let notifications = {};
    let employees = [];
    let scheduleData = {};
    let notesData = {};
    let currentDates = [];
    let contextMenuTarget = null;
    let conflicts = [];
    let history = [];
    let autoApprovalRules = { enabled: false, rule: 'firstCome' };
    let historyIndex = -1;
    let notificationInfo = null; 
    let bidsData = {};
    
    // PTO Management System Variables
    let ptoRequests = {};
    let employeePTOBalances = {};
    let ptoConflicts = [];

    const shiftsInfo = { "10p-6a": 8, "2p-10:30p": 8.5, "10a-6:30p": 8.5, "6:30p-3a": 8.5, "5:30a-2p": 8.5, "6a-2:30p": 8.5, "1p-9:30p": 8.5, "7a-7p": 12, "9:30p-6a": 8.5 };
    const shiftTemplates = {
        "Weekend Coverage": { "Sat": "10a-6:30p", "Sun": "10a-6:30p" },
        "Weekday Standard": { "Mon": "10a-6:30p", "Tue": "10a-6:30p", "Wed": "10a-6:30p", "Thu": "10a-6:30p", "Fri": "10a-6:30p" },
        "Night Shift": { "Mon": "10p-6a", "Tue": "10p-6a", "Wed": "10p-6a", "Thu": "10p-6a", "Fri": "10p-6a" }
    };
const shiftTypes = {
        opening: ["5:30a-2p", "6a-2:30p", "7a-7p"],
        closing: ["2p-10:30p", "6:30p-3a", "10p-6a", "9:30p-6a"]
    };
// --- Supabase Client Setup ---
    // --- Supabase Client Setup ---
    const supabaseUrl = "https://ulefvfpvgfdavztlwmpu.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZWZ2ZnB2Z2ZkYXZ6dGx3bXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTIzMDksImV4cCI6MjA3MDA2ODMwOX0.Se8nQg3BZUAYnt3bahw7iNePXm8G3X5PbH83XHY8edo";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    document.addEventListener('DOMContentLoaded', loadState);
    
    function generateUUID() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
    }

    document.getElementById('scheduleMonth').addEventListener('change', (e) => {
        recordHistory();
        clearSchedule(false);
        generateSchedule(e.target.value);
    });
  window.addEventListener('click', (event) => {
    // Hide context menu
    document.getElementById('contextMenu').style.display = 'none';
    
    // Close modals if clicking on modal background
    if (event.target.classList.contains('modal')) {
        closeAllModals();
    }
    
    // Hide notification popup if clicking outside of it
    const popup = document.getElementById('notification-popup');
    const bell = document.getElementById('notification-bell');
    if (popup && bell && 
        !popup.contains(event.target) && 
        !bell.contains(event.target)) {
        popup.style.display = 'none';
    }
});

    function getSortedEmployees() {
        return [...employees].sort((a, b) => {
            const aIsOpen = a.name.startsWith('OPEN SHIFTS');
            const bIsOpen = b.name.startsWith('OPEN SHIFTS');
            if (aIsOpen && !bIsOpen) return -1;
            if (!aIsOpen && bIsOpen) return 1;
            return a.name.localeCompare(b.name);
        });
    }

    function generateSchedule(monthString) {
        if (!monthString) return;
        const [year, month] = monthString.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        currentDates = Array.from({ length: daysInMonth }, (_, i) => new Date(year, month - 1, i + 1));
        employees.forEach(emp => { 
            if (!scheduleData[emp.name]) scheduleData[emp.name] = {}; 
            if (!notesData[emp.name]) notesData[emp.name] = {};
        });
        renderTable();
    }
    
    function renderTable() {
        const table = document.getElementById('schedule-table');
        const tbody = table.querySelector('tbody') || table.appendChild(document.createElement('tbody'));
        const thead = table.querySelector('thead') || table.appendChild(document.createElement('thead'));
        thead.innerHTML = `<tr><th class="employee-name">Employee</th>${currentDates.map(d => `<th>${d.getDate()}<br>${d.toLocaleDateString('en-US', { weekday: 'short' })}</th>`).join('')}</tr>`;
        const sortedEmployees = getSortedEmployees();
        tbody.innerHTML = sortedEmployees.map(emp => {
            const cells = currentDates.map(date => {
                const dateKey = date.toISOString().split('T')[0];
                const shift = scheduleData[emp.name]?.[dateKey] || '';
                const note = notesData[emp.name]?.[dateKey] || '';
                let cellClass = (date.getDay() === 0 || date.getDay() === 6) ? ' weekend' : '';
                if (shift.toUpperCase() === 'PTO') {
                    // Check if this is from an approved PTO request
                    const ptoRequest = Object.values(ptoRequests || {}).find(r => 
                        r.employeeName === emp.name && 
                        r.status === 'approved' &&
                        new Date(r.startDate) <= date && 
                        new Date(r.endDate) >= date
                    );
                    cellClass += ptoRequest ? ' pto-approved' : ' pto-cell';
                }
                if (conflicts.some(c => c.empName === emp.name && c.dateKey === dateKey)) cellClass += ' conflict-cell';
                const noteIndicator = note ? `<div class="note-indicator" title="${note}"></div>` : '';
                return `<td class="${cellClass}" contenteditable="true" onblur="updateShift(this, '${emp.name}', '${dateKey}')" oncontextmenu="showContextMenu(event, '${emp.name}', '${dateKey}')" data-original-shift="${shift}">${shift}${noteIndicator}</td>`;
            }).join('');
            return `<tr class="${emp.name.startsWith('OPEN SHIFTS') ? 'open-shift-row' : ''}"><td class="employee-name">${emp.name}</td>${cells}</tr>`;
        }).join('');
        renderDashboard();
        enhancePTODisplay(); // Add PTO visual enhancements
    }

    function renderDashboard() {
        if (document.getElementById('manager-view').style.display === 'none') return;
        const empTable = document.querySelector('#employee-dashboard-container table');
        const dailyTable = document.querySelector('#daily-dashboard-container table');
        const targetHours = parseFloat(document.getElementById('targetHours').value) || 0;
        const minStaff = parseInt(document.getElementById('minStaff').value) || 0;
        empTable.innerHTML = '<thead><tr><th>Employee</th><th>Days</th><th>Hours</th></tr></thead><tbody>' + 
            getSortedEmployees().map(emp => {
                if (emp.name.startsWith('OPEN SHIFTS')) return '';
                let days = 0, hours = 0;
                if (scheduleData[emp.name]) { for (const shift of Object.values(scheduleData[emp.name])) { if (shift && shift.toUpperCase() !== 'PTO') { days++; hours += shiftsInfo[shift] || 0; } } }
                let class_ = '';
                const empTargetHours = emp.targetHours || (emp.type === 'FT' ? targetHours : 0);
                if (empTargetHours > 0) {
                    if (hours < empTargetHours * 0.8) class_ = 'dashboard-under';
                    if (hours > empTargetHours * 1.1) class_ = 'dashboard-over';
                }
                return `<tr class="${class_}"><td>${emp.name}</td><td>${days}</td><td>${hours.toFixed(1)}</td></tr>`;
            }).join('') + '</tbody>';
        dailyTable.innerHTML = '<thead><tr><th>Date</th><th>Staff</th><th>Hours</th></tr></thead><tbody>' + currentDates.map(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0, dailyHours = 0;
            employees.forEach(emp => {
                const shift = scheduleData[emp.name]?.[dateKey] || '';
                if (shift && shift.toUpperCase() !== 'PTO') { staffCount++; dailyHours += shiftsInfo[shift] || 0; }
            });
            const class_ = staffCount < minStaff ? 'dashboard-low-staff' : '';
            return `<tr class="${class_}"><td>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td><td>${staffCount}</td><td>${dailyHours.toFixed(1)}</td></tr>`;
        }).join('') + '</tbody>';
    }

  function updateShift(element, employeeName, dateKey) {
        const originalShift = element.getAttribute('data-original-shift');
        const newShift = element.textContent.trim().replace(/<div.*<\/div>/, '');

        if (originalShift === newShift) {
            return; // Do nothing if the shift hasn't actually changed
        }

        recordHistory();

        // If an existing shift was changed for a real employee, trigger notification modal
        if (originalShift && !employeeName.startsWith('OPEN SHIFTS')) {
            const employee = employees.find(e => e.name === employeeName);
            if (employee) {
                notificationInfo = {
                    employeeName,
                    dateKey,
                    originalShift,
                    newShift: newShift || "REMOVED"
                };
                document.getElementById('notification-text').innerHTML = `You changed a shift for <b>${employeeName}</b> from "<em>${originalShift}</em>" to "<em>${newShift || "REMOVED"}</em>".<br><br>Would you like to send an email notification?`;
                document.getElementById('notificationModal').style.display = 'block';
            }
        }

        if (newShift.toUpperCase() === 'PTO') {
            executePTO(employeeName, dateKey, originalShift);
        } else {
            scheduleData[employeeName][dateKey] = newShift;
        }
        
        saveState();
        renderTable();
    }

function clearSchedule(showAlert = true) {
    if (showAlert && !confirm("Are you sure you want to clear the schedule grid?")) return;
    recordHistory();
    scheduleData = {};
    bidsData = {};
    notifications = {};
    employees.forEach(emp => { scheduleData[emp.name] = {}; });
    if (showAlert) { renderTable(); saveState(); }
}

    function autoGenerateFullSchedule() {
        if (!confirm("This will generate a schedule based on availability and workload limits. Continue?")) return;
        recordHistory();
        clearSchedule(false);
        const dayAbbreviations = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        let weeklyWorkload = {};
        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || !emp.availability || !emp.shifts || emp.shifts === 'Varies') return;
            weeklyWorkload[emp.name] = {};
            const availability = emp.availability.toLowerCase();
            const maxDays = parseInt(emp.maxDays) || 0;
            currentDates.forEach(date => {
                const dayOfWeek = dayAbbreviations[date.getDay()];
                const dateKey = date.toISOString().split('T')[0];
                const weekNumber = Math.ceil((date.getDate() + new Date(date.getFullYear(), date.getMonth(), 1).getUTCDay()) / 7);
                if (availability.includes(dayOfWeek)) {
                    if (maxDays > 0) {
                        const daysThisWeek = weeklyWorkload[emp.name][weekNumber] || 0;
                        if (daysThisWeek >= maxDays) return;
                        weeklyWorkload[emp.name][weekNumber] = daysThisWeek + 1;
                    }
                    scheduleData[emp.name][dateKey] = emp.shifts;
                }
            });
        });
        renderTable();
        saveState();
        alert('‚ú® Full schedule generated!');
    }

    function moveOpenPositionShifts() {
        if (!confirm("This will move all shifts from 'OPEN POSITION' to 'OPEN SHIFTS (Coverage)'. Continue?")) return;
        recordHistory();
        const sourceName = 'OPEN POSITION';
        const targetName = 'OPEN SHIFTS (Coverage)';
        if (!scheduleData[sourceName] || !scheduleData[targetName]) { alert("Error: 'OPEN POSITION' or 'OPEN SHIFTS (Coverage)' not found in data."); return; }
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[sourceName][dateKey];
            if (shift) {
                scheduleData[targetName][dateKey] = scheduleData[targetName][dateKey] ? `${scheduleData[targetName][dateKey]}, ${shift}` : shift;
                scheduleData[sourceName][dateKey] = '';
            }
        });
        renderTable();
        saveState();
        alert("‚úÖ Shifts from 'OPEN POSITION' have been moved.");
    }

    function showContextMenu(event, employeeName, dateKey) {
        event.preventDefault();
        contextMenuTarget = { employeeName, dateKey, originalShift: scheduleData[employeeName]?.[dateKey] || '' };
        const menu = document.getElementById('contextMenu');
        
        let templateOptions = '';
        if (!employeeName.startsWith('OPEN SHIFTS')) {
            templateOptions = `
                <div onmouseover="this.querySelector('.submenu').style.display='block'" onmouseout="this.querySelector('.submenu').style.display='none'">
                    Apply Template ‚ñ∫
                    <div class="submenu">
                        ${Object.keys(shiftTemplates).map(t => `<div onclick="applyShiftTemplate('${employeeName}', '${t}')">${t}</div>`).join('')}
                    </div>
                </div>`;
        }
        
        menu.innerHTML = `
            <div onclick="markAsPTO()">Mark as PTO</div>
            <div onclick="openNoteModal()">Add/Edit Note</div>
            <div onclick="showSuggestion('${employeeName}', '${dateKey}')">üí° Suggest Shift</div>
            <div onclick="clearEmployeeSchedule('${employeeName}')">üóëÔ∏è Clear All Shifts</div>
            ${templateOptions}
        `;
        menu.style.top = `${event.pageY}px`; 
        menu.style.left = `${event.pageX}px`; 
        menu.style.display = 'block';
    }

    function markAsPTO() {
        if (contextMenuTarget) {
            recordHistory();
            const { employeeName, dateKey, originalShift } = contextMenuTarget;
            executePTO(employeeName, dateKey, originalShift);
            renderTable();
        }
    }

    function executePTO(employeeName, dateKey, originalShift) {
    const employee = employees.find(e => e.name === employeeName);
    if (!employee || employee.name.startsWith('OPEN SHIFTS')) return;
    
    // If there was an original shift, move it to open shifts
    if (originalShift && originalShift.toUpperCase() !== 'PTO') {
        const openShiftsEmp = employees.find(e => e.name.startsWith('OPEN SHIFTS'));
        if (openShiftsEmp) {
            const currentOpenShifts = scheduleData[openShiftsEmp.name]?.[dateKey] || '';
            scheduleData[openShiftsEmp.name][dateKey] = currentOpenShifts ? 
                `${currentOpenShifts}, ${originalShift}` : originalShift;
        }
    }
    
    // Mark as PTO
    scheduleData[employeeName][dateKey] = 'PTO';
    saveState();
}
function findConflicts() {
    conflicts = [];
    
    // Check for availability conflicts
    employees.forEach(emp => {
        if (emp.name.startsWith('OPEN SHIFTS') || !emp.availability) return;
        
        const availability = emp.availability.toLowerCase();
        const dayAbbreviations = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[emp.name]?.[dateKey];
            const dayOfWeek = dayAbbreviations[date.getDay()];
            
            if (shift && shift.toUpperCase() !== 'PTO' && !availability.includes(dayOfWeek)) {
                conflicts.push({ empName: emp.name, dateKey: dateKey });
            }
        });
    });
    
    renderTable();
    if (conflicts.length > 0) { 
        alert(`üö® Found ${conflicts.length} conflict(s), highlighted in red.`); 
    } else { 
        alert('‚úÖ No availability conflicts found!'); 
    }
}

function recordHistory() {
    history = history.slice(0, historyIndex + 1);
    history.push(JSON.parse(JSON.stringify({ employees, scheduleData, notesData, bidsData, notifications })));
    historyIndex++;
    updateUndoRedoButtons();
}

   function undo() {
        if (historyIndex > 0) {
            historyIndex--;
            const state = JSON.parse(JSON.stringify(history[historyIndex]));
            employees = state.employees; scheduleData = state.scheduleData; notesData = state.notesData || {}; bidsData = state.bidsData || {}; notifications = state.notifications || {};
            renderTable(); saveState(); updateUndoRedoButtons();
        }
    }

 function redo() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            const state = JSON.parse(JSON.stringify(history[historyIndex]));
            employees = state.employees; scheduleData = state.scheduleData; notesData = state.notesData || {}; bidsData = state.bidsData || {}; notifications = state.notifications || {};
            renderTable(); saveState(); updateUndoRedoButtons();
        }
    }

    function updateUndoRedoButtons() {
        document.getElementById('undoBtn').disabled = historyIndex <= 0;
        document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
    }

async function saveState() {
    const stateToSave = {
        employees,
        schedule: scheduleData,
        notesData,
        bidsData,
        notifications,
        ptoRequests,
        employeePTOBalances,
        month: document.getElementById('scheduleMonth').value,
        config: {
            targetHours: document.getElementById('targetHours').value,
            minStaff: document.getElementById('minStaff').value
        }
    };

    // Always save to localStorage as backup
    try {
        localStorage.setItem('scheduleGeneratorState', JSON.stringify(stateToSave));
    } catch (e) {
        console.warn("Could not save to localStorage:", e);
    }

    // Try to save to Supabase
    try {
        if (typeof supabaseClient !== 'undefined') {
            const { error } = await supabaseClient
                .from('schedules')
                .upsert({ id: 1, data: stateToSave });

            if (error) {
                console.error("Supabase save error:", error);
                console.log('‚úÖ Data saved locally (cloud backup failed)');
                return; // Don't throw error, data is saved locally
            }
            console.log('‚úÖ Successfully saved to cloud and locally');
        } else {
            console.log('‚úÖ Data saved locally (cloud service unavailable)');
        }
    } catch (err) {
        console.error("Save failed:", err);
        console.log('‚úÖ Data saved locally (cloud backup failed)');
        // Don't throw error, data is saved locally
    }
}
// Replace your existing loadState function with this final, complete version.

async function loadState() {
    const urlParams = new URLSearchParams(window.location.search);
    const portalId = urlParams.get('portal');
    
    let records = null;
    let error = null;
    
    // Try to load from Supabase first
    try {
        if (typeof supabaseClient !== 'undefined') {
            if (portalId) {
                document.getElementById('manager-view').style.display = 'none';
                document.getElementById('employee-portal').style.display = 'block';
                
                const result = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
                records = result.data;
                error = result.error;
                
                if (records && records.data) {
                    loadAndRenderPortal(portalId, records.data);
                } else {
                    document.getElementById('portal-schedule-view').innerHTML = '<h2>Error</h2><p>Could not load schedule data. Please ensure the manager has saved a schedule.</p>';
                    if (error && error.code !== 'PGRST116') console.error("Portal load error:", error);
                }
                return;
            }

            // Manager view - try Supabase
            const result = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            records = result.data;
            error = result.error;
        }
    } catch (err) {
        console.warn("Could not load from cloud, trying localStorage:", err);
        error = err;
    }

    // If Supabase failed, try localStorage
    if (!records || error) {
        try {
            const localData = localStorage.getItem('scheduleGeneratorState');
            if (localData) {
                records = { data: JSON.parse(localData) };
                error = null;
                console.log('‚úÖ Loaded data from localStorage');
            }
        } catch (err) {
            console.warn("Could not load from localStorage:", err);
        }
    }

    if (error && error.code !== 'PGRST116' && !records) {
        console.error("Error loading state:", error);
        // Don't alert, just continue with default data
    }

    let monthToLoad;
    let needsInitialSave = false;

    if (records && records.data) {
        const state = records.data;
        employees = state.employees || [];
        scheduleData = state.schedule || {};
        notesData = state.notesData || {};
        bidsData = state.bidsData || {};
        notifications = state.notifications || {};
        ptoRequests = state.ptoRequests || {};
        employeePTOBalances = state.employeePTOBalances || {};
        monthToLoad = state.month;
        autoApprovalRules = state.autoApprovalRules || { enabled: false, rule: 'firstCome' };

        if (state.config) {
            document.getElementById('targetHours').value = state.config.targetHours || 160;
            document.getElementById('minStaff').value = state.config.minStaff || 3;
        }
    } else {
        // This block runs only if there is no saved data in the cloud.
        needsInitialSave = true;
        employees = [
            { name: "Dowling, Tina", id: generateUUID(), type: "PT", shifts: "10p-6a", availability: "Fri,Sat", maxDays: "2", targetHours: "64", email: "", hireDate: "2024-01-15" }, 
            { name: "Garcia, Mosserat", id: generateUUID(), type: "PT", shifts: "2p-10:30p", availability: "Sat,Sun", maxDays: "2", targetHours: "64", email: "", hireDate: "2024-02-20" }, 
            { name: "Harvey-Edwin, Jean", id: generateUUID(), type: "PT", shifts: "Varies", availability: "Varies", maxDays: "3", targetHours: "96", email: "", hireDate: "2023-11-10" }, 
            { name: "Heberer, Jacob", id: generateUUID(), type: "FT", shifts: "10a-6:30p", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "160", email: "", hireDate: "2023-08-05" }, 
            { name: "Hosey, Dianna", id: generateUUID(), type: "PT", shifts: "Varies", availability: "Varies", maxDays: "3", targetHours: "96", email: "", hireDate: "2024-03-12" }, 
            { name: "Sifuentes, Stephany", id: generateUUID(), type: "FT", shifts: "6:30p-3a", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "160", email: "", hireDate: "2023-09-01" }, 
            { name: "Keene, Shanetra", id: generateUUID(), type: "FT", shifts: "2p-10:30p", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "160", email: "", hireDate: "2023-07-18" }, 
            { name: "Melgar, Lisa", id: generateUUID(), type: "PT", shifts: "5:30a-2p", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "120", email: "", hireDate: "2024-01-08" }, 
            { name: "Merrick, Tanya", id: generateUUID(), type: "PT", shifts: "6a-2:30p", availability: "Sat,Sun", maxDays: "2", targetHours: "64", email: "", hireDate: "2024-04-22" }, 
            { name: "OPEN POSITION", type: "FT", shifts: "1p-9:30p", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "160" }, 
            { name: "OPEN POSITION", type: "PT", shifts: "6:30p-3a", availability: "Sat,Sun", maxDays: "2", targetHours: "64" },
            { name: "Puebla, Alisia", id: generateUUID(), type: "PT", shifts: "10a-6:30p", availability: "Sat,Sun", maxDays: "2", targetHours: "64", email: "", hireDate: "2024-05-15" }, 
            { name: "Scales, Jack", id: generateUUID(), type: "PT", shifts: "7a-7p", availability: "Sat,Sun", maxDays: "2", targetHours: "96", email: "", hireDate: "2023-12-01" }, 
            { name: "Thaxton, Tequita", id: generateUUID(), type: "PT", shifts: "9:30p-6a", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "96", email: "", hireDate: "2024-06-10" }, 
            { name: "Thompson, Quientia", id: generateUUID(), type: "PT", shifts: "Varies", availability: "Varies", maxDays: "3", targetHours: "96", email: "", hireDate: "2024-07-01" }, 
            { name: "OPEN SHIFTS (Coverage)", type: "Bank" }, 
            { name: "OPEN SHIFTS (Extra)", type: "Bank" },
            { name: "OPEN SHIFTS (Misc)", type: "Bank" } 
        ];
        
        // Initialize PTO balances for all employees
        employees.forEach(emp => {
            if (emp.id && !emp.name.startsWith("OPEN SHIFTS")) {
                employeePTOBalances[emp.id] = {
                    employeeName: emp.name,
                    hireDate: emp.hireDate || "2024-01-01",
                    totalPTODays: emp.type === "FT" ? 20 : 15,
                    usedPTODays: 0,
                    pendingPTODays: 0
                };
            }
        });
    }
    
    let updatedEmployees = false;
    employees.forEach(e => {
        if (!e.id && !e.name.startsWith("OPEN SHIFTS")) { e.id = generateUUID(); updatedEmployees = true; }
        if (e.email === undefined && !e.name.startsWith("OPEN SHIFTS") && e.type !== 'Bank') { e.email = ""; updatedEmployees = true; }
        if (!e.hireDate && !e.name.startsWith("OPEN SHIFTS") && e.type !== 'Bank') { 
            e.hireDate = "2024-01-01"; // Default hire date for existing employees
            updatedEmployees = true; 
        }
        // Initialize PTO balance if missing
        if (e.id && !e.name.startsWith("OPEN SHIFTS") && !employeePTOBalances[e.id]) {
            employeePTOBalances[e.id] = {
                employeeName: e.name,
                hireDate: e.hireDate || "2024-01-01",
                totalPTODays: e.type === "FT" ? 20 : 15,
                usedPTODays: 0,
                pendingPTODays: 0
            };
            updatedEmployees = true;
        }
    });

    if (!monthToLoad) {
        const now = new Date();
        let year = now.getFullYear(); let month = now.getMonth() + 1;
        if (now.getDate() > 15) { month++; if (month > 12) { month = 1; year++; } }
        monthToLoad = `${year}-${month.toString().padStart(2, '0')}`;
    }
    
    document.getElementById('scheduleMonth').value = monthToLoad;
    generateSchedule(monthToLoad);
    
    if (needsInitialSave || updatedEmployees) {
        await saveState();
    }
    
    recordHistory();
}

function loadAndRenderPortal(portalId, state) {
    if (!state) {
        const scheduleView = document.getElementById('portal-schedule-view');
        if (scheduleView) {
            scheduleView.innerHTML = '<h2>Error</h2><p>Could not load schedule data.</p>';
        }
        return;
    }
    
    const employee = state.employees.find(e => e.id === portalId);
    if (!employee) {
        const scheduleView = document.getElementById('portal-schedule-view');
        if (scheduleView) {
            scheduleView.innerHTML = '<h2>Error</h2><p>Invalid portal link.</p>';
        }
        return;
    }
    
    const allBids = state.bidsData || {};
    const allNotifications = state.notifications || {};
    const myNotifications = allNotifications[employee.id] || [];
    const unreadCount = myNotifications.filter(n => !n.read).length;

    // Update notification bell with null check
    const bell = document.getElementById('notification-bell');
    if (bell) {
        bell.innerHTML = unreadCount > 0 ? `üîî<span style="color:red; font-size:12px; position:absolute; top:-5px; right:-5px;">‚óè</span>` : 'üîî';
        bell.onclick = () => {
            const popup = document.getElementById('notification-popup');
            if (!popup) return;
            
            if (popup.style.display === 'block') {
                popup.style.display = 'none';
                return;
            }
            let popupHTML = `<div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold;">Notifications</div><div style="max-height: 300px; overflow-y:auto;">`;
            if (myNotifications.length === 0) {
                popupHTML += `<div style="padding:15px; text-align:center; color:#777;">No new notifications.</div>`;
            } else {
                 myNotifications.forEach(n => {
                    popupHTML += `<div style="padding:10px; border-bottom: 1px solid #eee; ${!n.read ? 'font-weight:bold;' : ''}">${n.message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`;
                });
            }
            popupHTML += '</div>';
            popup.innerHTML = popupHTML;
            popup.style.display = 'block';

            if (unreadCount > 0) {
                markNotificationsAsRead(employee.id);
            }
        };
    }

    // Update page title and employee name with null checks
    document.title = `${employee.name}'s Schedule`;
    
    const employeeNameEl = document.getElementById('portal-employee-name');
    if (employeeNameEl) {
        employeeNameEl.textContent = employee.name;
    }
    
    const titleEl = document.getElementById('portal-title');
    if (titleEl) {
        titleEl.textContent = `Your Schedule for ${new Date(state.month + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}`;
    }

    // Update schedule view with null check
    const scheduleView = document.getElementById('portal-schedule-view');
    if (scheduleView) {
        const employeeSchedule = state.schedule[employee.name] || {};
        const scheduleDates = Object.keys(employeeSchedule).filter(key => employeeSchedule[key]).map(key => new Date(key + 'T12:00:00Z')).sort((a, b) => a - b);
        let scheduleHTML = '<h2>Your Assigned Shifts</h2>';
        if (scheduleDates.length === 0) { 
            scheduleHTML += '<p>You have no shifts scheduled for this month.</p>'; 
        } else {
            scheduleHTML += '<ul class="schedule-list">';
            scheduleDates.forEach(date => {
                const dateKey = date.toISOString().split('T')[0];
                const shift = employeeSchedule[dateKey];
                const note = state.notesData[employee.name]?.[dateKey];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                scheduleHTML += `<li><div><span class="day-name">${dayName}, ${dateStr}</span></div><div><span>${shift}${note ? ` <em>(${note})</em>` : ''}</span></div></li>`;
            });
            scheduleHTML += '</ul>';
        }
        scheduleView.innerHTML = scheduleHTML;
    }

    // Update PTO balance display
    const ptoBalanceDisplay = document.getElementById('pto-balance-details');
    if (ptoBalanceDisplay) {
        const ptoBalance = state.employeePTOBalances?.[employee.id];
        if (ptoBalance) {
            const remaining = ptoBalance.totalPTODays - ptoBalance.usedPTODays - ptoBalance.pendingPTODays;
            const eligibility = isEmployeeEligibleForPTO(employee.id);
            
            let balanceHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${remaining}</div>
                        <div style="font-size: 12px;">Available</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${ptoBalance.usedPTODays}</div>
                        <div style="font-size: 12px;">Used</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${ptoBalance.pendingPTODays}</div>
                        <div style="font-size: 12px;">Pending</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #0d6efd;">${ptoBalance.totalPTODays}</div>
                        <div style="font-size: 12px;">Total</div>
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <span class="${eligibility.eligible ? 'pto-eligible' : 'pto-ineligible'}">
                        ${eligibility.eligible ? '‚úì Eligible for PTO' : eligibility.reason}
                    </span>
                </div>
            `;
            ptoBalanceDisplay.innerHTML = balanceHTML;
        } else {
            ptoBalanceDisplay.innerHTML = '<p style="text-align: center; color: #666;">PTO balance information not available.</p>';
        }
    }

    // Update PTO request history
    const ptoHistoryList = document.getElementById('pto-history-list');
    if (ptoHistoryList) {
        const employeeRequests = Object.values(state.ptoRequests || {})
            .filter(r => r.employeeId === employee.id)
            .sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));

        if (employeeRequests.length === 0) {
            ptoHistoryList.innerHTML = '<p style="text-align: center; color: #666;">No PTO requests found.</p>';
        } else {
            let historyHTML = '';
            employeeRequests.forEach(request => {
                const statusClass = `pto-status-${request.status}`;
                const startDate = new Date(request.startDate).toLocaleDateString();
                const endDate = new Date(request.endDate).toLocaleDateString();
                const submissionDate = new Date(request.submissionDate).toLocaleDateString();

                historyHTML += `
                    <div class="pto-request-item ${statusClass}">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <strong>${startDate} - ${endDate}</strong>
                            <span style="text-transform: capitalize; font-weight: bold;">${request.status}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 14px;">
                            <div><strong>Days:</strong> ${request.daysRequested}</div>
                            <div><strong>Type:</strong> ${request.requestType}</div>
                            <div><strong>Submitted:</strong> ${submissionDate}</div>
                        </div>
                        ${request.reason ? `<div style="margin-top: 10px; font-size: 14px;"><strong>Comments:</strong> ${request.reason}</div>` : ''}
                        ${request.managerComments ? `<div style="margin-top: 10px; font-size: 14px; color: #dc3545;"><strong>Manager Comments:</strong> ${request.managerComments}</div>` : ''}
                    </div>
                `;
            });
            ptoHistoryList.innerHTML = historyHTML;
        }
    }
    
    // Set up PTO form listeners after rendering
    setupPTOFormListeners();

    // Update bids view with null check
    const bidsView = document.getElementById('portal-bids-view');
    if (bidsView) {
        const openShiftRows = state.employees.filter(e => e.name.startsWith("OPEN SHIFTS"));
        let bidsHTML = '<h2>Available Open Shifts</h2>';
        let openShifts = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const scheduleMonth = new Date(state.month + '-02T12:00:00Z').getMonth();
        openShiftRows.forEach(row => {
            if (state.schedule[row.name]) {
                Object.keys(state.schedule[row.name]).forEach(dateKey => {
                    const shiftText = state.schedule[row.name][dateKey];
                    const shiftDate = new Date(dateKey + 'T12:00:00Z');
                    if (shiftText && shiftDate >= today) {
                        if (shiftDate.getMonth() !== scheduleMonth) return;
                        shiftText.split(',').forEach(shift => {
                            shift = shift.trim();
                            if (shift) openShifts.push({ date: shiftDate, shift, dateKey });
                        });
                    }
                });
            }
        });
        openShifts.sort((a,b) => a.date - b.date);

        if (openShifts.length === 0) { 
            bidsHTML += '<p>There are no open shifts available for bidding at this time.</p>'; 
        } else {
            bidsHTML += '<ul class="bids-list">';
            openShifts.forEach(({ date, shift, dateKey }) => {
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const bidsForShift = allBids[dateKey]?.[shift] || [];
                const hasBid = bidsForShift.includes(employee.id);
                bidsHTML += `<li><div><span class="day-name">${dayName}, ${dateStr}</span></div><div><span>${shift}</span></div><button class="btn ${hasBid ? 'btn-secondary' : 'btn-success'}" onclick="placeBid('${employee.id}', '${dateKey}', '${shift}')" ${hasBid ? 'disabled' : ''}>${hasBid ? 'Bid Placed' : 'Bid on Shift'}</button></li>`;
            });
            bidsHTML += '</ul>';
        }
        bidsView.innerHTML = bidsHTML;
    }
}

    function resetSavedState() { if (confirm("Are you sure you want to clear ALL saved data?")) { localStorage.removeItem('scheduleGeneratorState'); location.reload(); } }
    
    function openEmployeeModal(index = -1) {
        clearEmployeeForm();
        if (index > -1) {
            const emp = employees[index];
            document.getElementById('modal-title').textContent = 'Edit Employee';
            document.getElementById('empIndex').value = index;
            document.getElementById('empId').value = emp.id;
            document.getElementById('newName').value = emp.name;
            document.getElementById('newType').value = emp.type;
            document.getElementById('newShifts').value = emp.shifts;
            document.getElementById('newAvailability').value = emp.availability;
            document.getElementById('newMaxDays').value = emp.maxDays || 0;
            document.getElementById('newTargetHours').value = emp.targetHours || 0;
        }
        renderEmployeeList();
        document.getElementById('employeeModal').style.display = 'block';
    }

    function closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    
    function clearEmployeeForm() {
        document.getElementById('modal-title').textContent = 'Add New Employee';
        document.getElementById('empIndex').value = '-1';
        document.getElementById('empId').value = '';
        document.getElementById('newName').value = ''; document.getElementById('newType').value = 'FT'; document.getElementById('newShifts').value = ''; document.getElementById('newAvailability').value = ''; document.getElementById('newMaxDays').value = '0'; document.getElementById('newTargetHours').value = '0'; document.getElementById('newEmail').value = ''; document.getElementById('newHireDate').value = '';
    }

    function renderEmployeeList() {
        const table = document.getElementById('employee-list-table');
        table.innerHTML = '<thead><tr><th>Name</th><th>Type</th><th>Email</th><th>Actions</th></tr></thead><tbody>' +
            getSortedEmployees().map((emp) => {
                if (emp.name.startsWith('OPEN SHIFTS')) return '';
                const originalIndex = employees.findIndex(originalEmp => originalEmp.name === emp.name);
                return `<tr><td>${emp.name}</td><td>${emp.type}</td><td>${emp.email || ''}</td><td><button class="btn btn-secondary btn-sm" onclick="editEmployee(${originalIndex})">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${originalIndex})">Del</button> <button class="btn btn-primary btn-sm" onclick="copyPortalLink(${originalIndex})">Copy Portal Link</button></td></tr>`;
            }).join('') + '</tbody>';
    }
    
    function copyPortalLink(index) {
        const employee = employees[index];
        if (!employee.id) {
            alert("Could not generate link. Please save this employee again to create an ID.");
            return;
        }
        const url = new URL(window.location.href);
        url.search = `?portal=${employee.id}`;
        navigator.clipboard.writeText(url.href).then(() => {
            alert(`‚úÖ Link for ${employee.name} copied to clipboard.`);
        });
    }

    function saveEmployee() {
        recordHistory();
        const name = document.getElementById('newName').value.trim();
        if (!name) { alert('Employee name cannot be empty.'); return; }
        
        const hireDate = document.getElementById('newHireDate').value;
        if (!hireDate && !name.startsWith('OPEN SHIFTS')) { 
            alert('Hire date is required for all employees.'); 
            return; 
        }
        const index = parseInt(document.getElementById('empIndex').value);
        let empId = document.getElementById('empId').value;
        if (!empId) { empId = generateUUID(); }
        const empData = { 
            name, 
            id: empId,
            type: document.getElementById('newType').value, 
            shifts: document.getElementById('newShifts').value.trim(), 
            availability: document.getElementById('newAvailability').value.trim(), 
            email: document.getElementById('newEmail').value.trim(),
            hireDate: document.getElementById('newHireDate').value,
            maxDays: document.getElementById('newMaxDays').value, 
            targetHours: document.getElementById('newTargetHours').value 
        };

        if (index > -1) {
            const oldName = employees[index].name;
            if (oldName !== name) {
                scheduleData[name] = scheduleData[oldName]; notesData[name] = notesData[oldName];
                delete scheduleData[oldName]; delete notesData[oldName];
            }
            employees[index] = empData;
        } else {
            employees.push(empData);
            scheduleData[name] = {}; notesData[name] = {};
            // Initialize PTO balance for new employee
            if (empData.id) {
                employeePTOBalances[empData.id] = {
                    employeeName: empData.name,
                    hireDate: empData.hireDate || new Date().toISOString().split('T')[0],
                    totalPTODays: empData.type === "FT" ? 20 : 15,
                    usedPTODays: 0,
                    pendingPTODays: 0
                };
            }
        }
        renderEmployeeList(); renderTable(); saveState(); closeAllModals();
    }

    function editEmployee(index) {
        const emp = employees[index];
        document.getElementById('modal-title').textContent = 'Edit Employee';
        document.getElementById('empIndex').value = index;
        document.getElementById('empId').value = emp.id;
        document.getElementById('newName').value = emp.name;
        document.getElementById('newType').value = emp.type;
        document.getElementById('newShifts').value = emp.shifts || '';
        document.getElementById('newAvailability').value = emp.availability || '';
        document.getElementById('newEmail').value = emp.email || '';
        document.getElementById('newHireDate').value = emp.hireDate || '';
        document.getElementById('newMaxDays').value = emp.maxDays || 0;
        document.getElementById('newTargetHours').value = emp.targetHours || 0;
        document.getElementById('employeeModal').style.display = 'block';
    }
    
    function deleteEmployee(index) { 
        if (confirm(`Are you sure you want to delete ${employees[index].name}?`)) { 
            recordHistory(); 
            delete scheduleData[employees[index].name]; 
            delete notesData[employees[index].name]; 
            employees.splice(index, 1); 
            renderEmployeeList(); 
            renderTable(); 
            saveState(); 
        } 
    }

    function openNoteModal() {
        if (contextMenuTarget) {
            const { employeeName, dateKey } = contextMenuTarget;
            document.getElementById('noteText').value = notesData[employeeName]?.[dateKey] || '';
            document.getElementById('noteModal').style.display = 'block';
        }
    }

    function saveNote() {
        if (contextMenuTarget) {
            recordHistory();
            const { employeeName, dateKey } = contextMenuTarget;
            if (!notesData[employeeName]) notesData[employeeName] = {};
            notesData[employeeName][dateKey] = document.getElementById('noteText').value;
            closeAllModals(); renderTable(); saveState();
        }
    }

    function copyEmployeeListForExcel() {
        let excelString = 'Name\tType\tShifts\tMax Days/Week\tTarget Hours\tAvailability\n';
        getSortedEmployees().forEach(emp => { if (!emp.name.startsWith('OPEN SHIFTS')) excelString += `${emp.name}\t${emp.type}\t${emp.shifts}\t${emp.maxDays || 0}\t${emp.targetHours || 0}\t${emp.availability}\n`; });
        navigator.clipboard.writeText(excelString).then(() => alert('‚úÖ Employee List Copied!'));
    }

    function copyScheduleForExcel() {
        const sortedEmployees = getSortedEmployees();
        let excelString = sortedEmployees.map(emp => currentDates.map(date => { const dateKey = date.toISOString().split('T')[0]; const shift = scheduleData[emp.name]?.[dateKey] || ''; const note = notesData[emp.name]?.[dateKey] || ''; return note ? `${shift} (${note})` : shift; }).join('\t')).join('\n');
        navigator.clipboard.writeText(excelString).then(() => alert('‚úÖ Schedule Grid Copied (Shifts Only)!'));
    }

   function copyOpenShiftsForExcel() {
        let openShiftText = "Date\tDay\tShift\tStatus\n";
        const openShiftRows = employees.filter(e => e.name.startsWith('OPEN SHIFTS'));
        let shiftsFound = [];
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            openShiftRows.forEach(emp => {
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift) {
                    shift.split(',').forEach(s => {
                        if (s.trim()) {
                            const month = date.getMonth() + 1;
                            const day = date.getDate();
                            const year = date.getFullYear();
                            const formattedDate = `${month}/${day}/${year}`;
                            const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'short' });
                            shiftsFound.push({ date: formattedDate, day: dayOfWeek, shift: s.trim(), status: 'Available', originalDate: date });
                        }
                    });
                }
            });
        });
        
        shiftsFound.sort((a,b) => a.originalDate - b.originalDate);
        openShiftText += shiftsFound.map(s => `${s.date}\t${s.day}\t${s.shift}\t${s.status}`).join('\n');
        
        navigator.clipboard.writeText(openShiftText).then(() => { alert('‚úÖ Open Shifts List Copied in Excel Format!'); });
    }

function exportJSON() {
        const backupData = { employees, scheduleData, notesData, bidsData, notifications, month: document.getElementById('scheduleMonth').value, config: { targetHours: document.getElementById('targetHours').value, minStaff: document.getElementById('minStaff').value } };
        const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `schedule_backup_${backupData.month}.json`; a.click(); URL.revokeObjectURL(a.href);
    }

 function importJSON() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = readerEvent => {
                try {
                    const content = JSON.parse(readerEvent.target.result);
                    if (content.employees && content.scheduleData && content.month) {
                        recordHistory();
                        employees = content.employees; scheduleData = content.scheduleData; notesData = content.notesData || {}; bidsData = content.bidsData || {}; notifications = content.notifications || {};
                        // ... rest of function
                        generateSchedule(content.month); saveState();
                        alert('‚úÖ Backup successfully imported!');
                    } else { alert('‚ùå Invalid backup file format.'); }
                } catch (error) { alert('‚ùå Error reading file.'); }
            };
            reader.readAsText(file, 'UTF-8');
        }
        input.click();
    }
    function applyShiftTemplate(employeeName, templateName) {
        recordHistory();
        const template = shiftTemplates[templateName];
        const dayMap = {0: 'Sun', 1: 'Mon', 2: 'Tue', 3: 'Wed', 4: 'Thu', 5: 'Fri', 6: 'Sat'};
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const dayName = dayMap[date.getDay()];
            if (template[dayName]) {
                scheduleData[employeeName][dateKey] = template[dayName];
            }
        });
        renderTable();
        saveState();
        alert(`‚úÖ Applied ${templateName} template to ${employeeName}`);
    }

    function getSuggestedShift(employeeName, dateKey) {
        const employee = employees.find(e => e.name === employeeName);
        if (!employee || employee.name.startsWith('OPEN SHIFTS')) return '';
        
        const date = new Date(dateKey + 'T12:00:00Z');
        const dayOfWeek = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getUTCDay()];
        
        if (!employee.availability.toLowerCase().includes(dayOfWeek)) return '';
        
        let currentHours = 0;
        Object.values(scheduleData[employeeName] || {}).forEach(shift => {
            if (shift && shift.toUpperCase() !== 'PTO') {
                currentHours += shiftsInfo[shift] || 0;
            }
        });
        
        const targetHours = employee.targetHours || (employee.type === 'FT' ? 160 : 0);
        if (targetHours > 0 && currentHours >= targetHours) return '';
        
        return employee.shifts !== 'Varies' ? employee.shifts : '10a-6:30p';
    }

    function showSuggestion(employeeName, dateKey) {
        const suggestion = getSuggestedShift(employeeName, dateKey);
        if (suggestion) {
            recordHistory();
            scheduleData[employeeName][dateKey] = suggestion;
            renderTable();
            saveState();
            alert(`‚úÖ Applied suggested shift: ${suggestion}`);
        } else {
            alert('No suggestion available for this employee/date');
        }
    }

    function validateSchedule() {
        const warnings = [];
        const errors = [];
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0;
            
            employees.forEach(emp => {
                const shift = scheduleData[emp.name]?.[dateKey] || '';
                if (shift && shift.toUpperCase() !== 'PTO' && !emp.name.startsWith('OPEN SHIFTS')) {
                    staffCount++;
                }
            });
            
            const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
            if (staffCount < minStaff) {
                warnings.push(`${date.toLocaleDateString()}: Only ${staffCount} staff scheduled (min: ${minStaff})`);
            }
        });
        
        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS')) return;
            
            let totalHours = 0;
            Object.values(scheduleData[emp.name] || {}).forEach(shift => {
                if (shift && shift.toUpperCase() !== 'PTO') {
                    totalHours += shiftsInfo[shift] || 0;
                }
            });
            
            const targetHours = emp.targetHours || (emp.type === 'FT' ? 160 : 0);
            if (targetHours > 0 && totalHours > targetHours * 1.2) {
                errors.push(`${emp.name}: ${totalHours}h scheduled (target: ${targetHours}h)`);
            }
        });
        
        return { warnings, errors };
    }

    function showValidationResults() {
        const { warnings, errors } = validateSchedule();
        let message = '';
        
        if (errors.length > 0) {
            message += '‚ùå ERRORS:\n' + errors.join('\n') + '\n\n';
        }
        if (warnings.length > 0) {
            message += '‚ö†Ô∏è WARNINGS:\n' + warnings.join('\n');
        }
        
        if (message) {
            alert(message);
        } else {
            alert('‚úÖ Schedule validation passed!');
        }
    }

    function clearEmployeeSchedule(employeeName) {
        if (!confirm(`Clear all shifts for ${employeeName}?`)) return;
        
        recordHistory();
        scheduleData[employeeName] = {};
        renderTable();
        saveState();
        alert(`‚úÖ Cleared all shifts for ${employeeName}`);
    }

    function printSchedule() {
        const printWindow = window.open('', '_blank');
        const scheduleTable = document.getElementById('schedule-table').outerHTML;
        
        printWindow.document.write(`
            <html>
            <head>
                <title>Schedule - ${document.getElementById('scheduleMonth').value}</title>
                <style>
                    body { font-family: Arial, sans-serif; font-size: 10pt; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #000; padding: 4px; text-align: center; }
                    .employee-name { text-align: left; font-weight: bold; }
                    .open-shift-row { background-color: #f0f0f0; }
                    @page { size: landscape; margin: 0.5in; }
                </style>
            </head>
            <body>
                <h2>Schedule for ${document.getElementById('scheduleMonth').value}</h2>
                ${scheduleTable}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.print();
    }

    function openBulkPTOModal() {
        const select = document.getElementById('ptoEmployee');
        select.innerHTML = employees.filter(e => !e.name.startsWith('OPEN SHIFTS'))
            .map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        
        if (currentDates.length > 0) {
            document.getElementById('ptoStartDate').value = currentDates[0].toISOString().split('T')[0];
            document.getElementById('ptoEndDate').value = currentDates[currentDates.length - 1].toISOString().split('T')[0];
        }
        
        document.getElementById('bulkPTOModal').style.display = 'block';
    }

    function applyBulkPTO() {
        const employeeName = document.getElementById('ptoEmployee').value;
        const startDate = new Date(document.getElementById('ptoStartDate').value + 'T12:00:00Z');
        const endDate = new Date(document.getElementById('ptoEndDate').value + 'T12:00:00Z');
        
        if (!employeeName || !startDate || !endDate) {
            alert('Please fill in all fields');
            return;
        }
        
        if (startDate > endDate) {
            alert('Start date must be before end date');
            return;
        }
        
        recordHistory();
        
        let ptoCount = 0;
        currentDates.forEach(date => {
            if (date >= startDate && date <= endDate) {
                const dateKey = date.toISOString().split('T')[0];
                const originalShift = scheduleData[employeeName]?.[dateKey] || '';
                
                if (originalShift && originalShift.toUpperCase() !== 'PTO') {
                    executePTO(employeeName, dateKey, originalShift);
                    ptoCount++;
                }
            }
        });
        
        renderTable();
        closeAllModals();
        alert(`‚úÖ Applied PTO to ${ptoCount} days for ${employeeName}`);
    }

    function openEmailModal() {
        const select = document.getElementById('emailEmployee');
        select.innerHTML = employees.filter(e => !e.name.startsWith('OPEN SHIFTS'))
            .map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        
        document.getElementById('emailModal').style.display = 'block';
    }

    function generateEmail() {
        const employeeName = document.getElementById('emailEmployee').value;
        const emailAddress = document.getElementById('emailAddress').value;
        
        if (!employeeName || !emailAddress) {
            alert('Please select an employee and enter an email address');
            return;
        }
        
        let scheduleText = `Schedule for ${employeeName} - ${document.getElementById('scheduleMonth').value}\n\n`;
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[employeeName]?.[dateKey] || '';
            const note = notesData[employeeName]?.[dateKey] || '';
            
            if (shift) {
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                scheduleText += `${dayName}, ${dateStr}: ${shift}`;
                if (note) scheduleText += ` (${note})`;
                scheduleText += '\n';
            }
        });
        
        let totalHours = 0;
        Object.values(scheduleData[employeeName] || {}).forEach(shift => {
            if (shift && shift.toUpperCase() !== 'PTO') {
                totalHours += shiftsInfo[shift] || 0;
            }
        });
        
        scheduleText += `\nTotal Hours: ${totalHours}`;
        
        const emailContent = `
            <strong>To:</strong> ${emailAddress}<br>
            <strong>Subject:</strong> Your Work Schedule - ${document.getElementById('scheduleMonth').value}<br><br>
            <strong>Message:</strong><br>
            <pre>${scheduleText}</pre>
        `;
        
        document.getElementById('emailContent').innerHTML = emailContent;
        document.getElementById('emailPreview').style.display = 'block';
    }

    function sendEmail() {
        const employeeName = document.getElementById('emailEmployee').value;
        const emailAddress = document.getElementById('emailAddress').value;
        
        let scheduleText = `Schedule for ${employeeName} - ${document.getElementById('scheduleMonth').value}\r\n\r\n`;
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[employeeName]?.[dateKey] || '';
            const note = notesData[employeeName]?.[dateKey] || '';
            
            if (shift) {
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                scheduleText += `${dayName}, ${dateStr}: ${shift}`;
                if (note) scheduleText += ` (${note})`;
                scheduleText += '\r\n';
            }
        });
        
        let totalHours = 0;
        Object.values(scheduleData[employeeName] || {}).forEach(shift => {
            if (shift && shift.toUpperCase() !== 'PTO') {
                totalHours += shiftsInfo[shift] || 0;
            }
        });
        
        scheduleText += `\r\nTotal Hours: ${totalHours}`;
        
        const subject = `Your Work Schedule - ${document.getElementById('scheduleMonth').value}`;
        const mailtoLink = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(scheduleText)}`;
        
        window.open(mailtoLink, '_blank');
        closeAllModals();
    }

    function openExcelImportModal() {
        const fileInput = document.getElementById('excel-file-input');
        fileInput.value = '';
        document.getElementById('excelImportModal').style.display = 'block';
    }

function sendChangeNotification() {
        if (!notificationInfo) return;

        const { employeeName, dateKey, originalShift, newShift } = notificationInfo;
        const date = new Date(dateKey + 'T12:00:00Z');
        const dateString = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

        const subject = "Update to your work schedule";
        const body = `Hi ${employeeName.split(',')[1].trim()},\n\nPlease note a change has been made to your schedule for ${dateString}.\n\n- Your previous shift was: ${originalShift}\n- Your new shift is: ${newShift}\n\nPlease check your employee portal for the most up-to-date schedule.\n\nThank you`;

        const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailtoLink, '_blank');
        
        closeAllModals();
        notificationInfo = null; // Clear the info after use
    }
    function importFromExcel() {
        const fileInput = document.getElementById('excel-file-input');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file before processing.');
            return;
        }
        if (!currentDates.length) {
            alert('Please ensure a month is loaded in the schedule before importing.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates:true});

                let firstVisibleSheetName = null;
                for (const sheetName of workbook.SheetNames) {
                    if (!workbook.Sheets[sheetName].Hidden) {
                        firstVisibleSheetName = sheetName;
                        break;
                    }
                }

                if (!firstVisibleSheetName) {
                    throw new Error("No visible sheets were found in the workbook.");
                }

                const worksheet = workbook.Sheets[firstVisibleSheetName];
                const sheetData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                if (sheetData.length < 4) {
                    throw new Error("The visible sheet must have at least 4 rows to import.");
                }
                
                recordHistory();
                clearSchedule(false);

                const dateHeaders = sheetData[1];
                const appMonth = currentDates[0].getMonth();
                const appYear = currentDates[0].getFullYear();
                let shiftsImported = 0;
                let skippedShifts = 0;

                for (let i = 3; i < sheetData.length; i++) {
                    const row = sheetData[i];
                    const employeeName = row[0];
                    
                    if (employeeName && employees.some(emp => emp.name === employeeName)) {
                        for (let j = 1; j < dateHeaders.length; j++) {
                            const headerDate = dateHeaders[j];
                            const shift = row[j];
                            
                            if (headerDate instanceof Date && !isNaN(headerDate) && shift != null && String(shift).trim() !== '') {
                                if (headerDate.getMonth() === appMonth && headerDate.getFullYear() === appYear) {
                                    headerDate.setUTCHours(12, 0, 0, 0);
                                    const dateKey = headerDate.toISOString().split('T')[0];

                                    if (!scheduleData[employeeName]) {
                                        scheduleData[employeeName] = {};
                                    }
                                    scheduleData[employeeName][dateKey] = String(shift).trim();
                                    shiftsImported++;
                                } else {
                                    skippedShifts++;
                                }
                            }
                        }
                    }
                }

                renderTable();
                saveState();
                closeAllModals();

                let alertMessage = `‚úÖ Import successful! ${shiftsImported} shifts were loaded from sheet "${firstVisibleSheetName}".`;
                if (skippedShifts > 0) {
                    alertMessage += `\n\n(Note: ${skippedShifts} shifts were skipped because their dates did not match the selected month.)`;
                }
                alert(alertMessage);

            } catch (error) {
                console.error("Excel import failed:", error);
                alert(`‚ùå Import Failed. Please ensure the file is not corrupt and matches the required format.\n\nError: ${error.message}`);
                closeAllModals();
            }
        };
        reader.readAsArrayBuffer(file);
    }
// Replace your existing openBidsModal function with this new version.

    async function openBidsModal() {
        // --- NEW: First, fetch the most recent data from Supabase ---
        const { data: records, error } = await supabaseClient
            .from('schedules')
            .select('data')
            .eq('id', 1)
            .single();

        if (error || !records || !records.data) {
            alert("‚ùå Could not load bid data from the cloud. Check the console for errors.");
            console.error("Error loading bids:", error);
            return;
        }
        
        // Update the local bidsData variable with the fresh data from the cloud
        bidsData = records.data.bidsData || {};
        // --- END NEW LOGIC ---

        const container = document.getElementById('bids-container');
        container.innerHTML = '';
        const openShiftRows = employees.filter(e => e.name.startsWith("OPEN SHIFTS"));
        let openShifts = [];

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        openShiftRows.forEach(row => {
            if(scheduleData[row.name]) {
                Object.keys(scheduleData[row.name]).forEach(dateKey => {
                    const shiftText = scheduleData[row.name][dateKey];
                    const shiftDate = new Date(dateKey + 'T12:00:00Z');

                    if (shiftText && shiftDate >= today) {
                        shiftText.split(',').forEach(shift => {
                            shift = shift.trim();
                            if (shift) openShifts.push({ date: shiftDate, shift, dateKey, source: row.name });
                        });
                    }
                });
            }
        });

        openShifts.sort((a,b) => a.date - b.date);

        if (openShifts.length === 0) {
            container.innerHTML = '<p>No open shifts are currently available.</p>';
        } else {
            let hasBids = false;
            openShifts.forEach(({ date, shift, dateKey, source }) => {
                const bidders = bidsData[dateKey]?.[shift] || [];
                if (bidders.length > 0) {
                    hasBids = true;
                    const shiftElement = document.createElement('div');
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    shiftElement.innerHTML = `<h4>${shift} on ${dateStr}</h4>`;
                    
                    bidders.forEach(empId => {
                        const employee = employees.find(e => e.id === empId);
                        if (employee) {
                            let totalHours = 0;
                            Object.values(scheduleData[employee.name] || {}).forEach(s => {
                                if (s && s.toUpperCase() !== 'PTO') totalHours += shiftsInfo[s] || 0;
                            });

                            const weekStart = new Date(date);
                            weekStart.setUTCHours(0,0,0,0);
                            weekStart.setDate(weekStart.getDate() - weekStart.getUTCDay());
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekEnd.getDate() + 6);
                            
                            let shiftsThisWeek = 0;
                            for (let d = new Date(weekStart); d <= weekEnd; d.setDate(d.getDate() + 1)) {
                                const key = d.toISOString().split('T')[0];
                                if(scheduleData[employee.name]?.[key] && scheduleData[employee.name][key].toUpperCase() !== 'PTO') {
                                    shiftsThisWeek++;
                                }
                            }
                            
                            const dayAbbreviations = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                            const dayOfWeek = dayAbbreviations[date.getUTCDay()];
                            const isAvailable = employee.availability ? employee.availability.toLowerCase().includes(dayOfWeek) : true;

                            const bidderElement = document.createElement('div');
                            bidderElement.className = 'bid-item';
                            bidderElement.innerHTML = `
                                <span>${employee.name}</span>
                                <span class="bid-stats">
                                    Stats: ${totalHours.toFixed(1)} Hrs | ${shiftsThisWeek} Shifts this week | ${isAvailable ? '‚úÖ Available' : '‚ùå Conflict'}
                                </span>
                                <button class="btn btn-success btn-sm" style="float: right; margin-top: -20px;" onclick="approveBid('${empId}', '${dateKey}', '${shift}', '${source}')">Approve</button>
                            `;
                            shiftElement.appendChild(bidderElement);
                        }
                    });
                    container.appendChild(shiftElement);
                }
            });

            if (!hasBids) {
                container.innerHTML = '<p>No bids have been placed on open shifts yet.</p>';
            }
        }
        document.getElementById('bidsModal').style.display = 'block';
    }
   // Replace your existing approveBid function with this final async version.

   async function approveBid(employeeId, dateKey, shift, sourceRowName) {
        const bidders = [...(bidsData[dateKey]?.[shift] || [])];
        const winner = employees.find(e => e.id === employeeId);
        if (!winner) { alert('Error: Could not find employee.'); return; }
        
        recordHistory();

        scheduleData[winner.name][dateKey] = shift;
        const openShiftsOnDay = scheduleData[sourceRowName][dateKey].split(',').map(s => s.trim());
        const indexToRemove = openShiftsOnDay.indexOf(shift);
        if (indexToRemove > -1) { openShiftsOnDay.splice(indexToRemove, 1); }
        scheduleData[sourceRowName][dateKey] = openShiftsOnDay.join(', ');

        if (bidsData[dateKey]?.[shift]) { delete bidsData[dateKey][shift]; }

        const dateString = new Date(dateKey + 'T12:00:00Z').toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });
        
        addNotification(winner.id, `‚úÖ **Approved:** Your bid for the ${shift} shift on ${dateString} was approved.`);
        
        bidders.forEach(bidderId => {
            if (bidderId !== employeeId) {
                addNotification(bidderId, `‚ùå **Not Approved:** Your bid for the ${shift} shift on ${dateString} was not approved this time.`);
            }
        });

        renderTable(); 
    await saveState(); 
    openBidsModal(); 
    alert(`Shift assigned to ${winner.name}. Notifications have been sent to the portal.`);
}  // <--- CLOSING BRACE HERE!

    async function denyBid(employeeId, dateKey, shift) {
        if (!bidsData[dateKey]?.[shift]) return;
        
        recordHistory();
        
        const indexToRemove = bidsData[dateKey][shift].indexOf(employeeId);
        if (indexToRemove > -1) {
            bidsData[dateKey][shift].splice(indexToRemove, 1);
        }

        const dateString = new Date(dateKey + 'T12:00:00Z').toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });
        addNotification(employeeId, `‚ùå **Not Approved:** Your bid for the ${shift} shift on ${dateString} was not approved this time.`);

        await saveState();
        openBidsModal();
        alert('Bid has been denied. A notification has been sent to the employee.');
    }

    async function placeBid(employeeId, dateKey, shift) {
        if (!confirm(`Are you sure you want to bid on the ${shift} shift for ${dateKey}?`)) return;
        try {
            const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            if (fetchError && fetchError.code !== 'PGRST116') { throw new Error(fetchError.message); }
            const state = records.data;
            if (!state) { throw new Error("Could not retrieve schedule data from the cloud."); }
            if (!state.bidsData) state.bidsData = {};
            if (!state.bidsData[dateKey]) state.bidsData[dateKey] = {};
            if (!state.bidsData[dateKey][shift]) state.bidsData[dateKey][shift] = [];
            
            if (!state.bidsData[dateKey][shift].includes(employeeId)) {
                state.bidsData[dateKey][shift].push(employeeId);
                const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
                if (saveError) { throw new Error(saveError.message); }
                loadAndRenderPortal(employeeId, state);
            }
        } catch (error) {
            console.error("Bidding failed:", error);
            alert(`‚ùå Error placing bid: ${error.message}`);
        }
    }
async function sendEmailWithSendGrid(toEmail, subject, bodyText) {
        const apiKey = "YOUR_SENDGRID_API_KEY"; // <-- IMPORTANT: PASTE YOUR KEY HERE
        const fromEmail = "jack.scales@northside.com"; // <-- IMPORTANT: USE YOUR SENDGRID VERIFIED EMAIL

        if (!apiKey.startsWith("SG.") || fromEmail === "you@yourcompany.com") {
            console.error("SendGrid API Key or From Email not set.");
            alert("Email notification could not be sent. API Key not configured.");
            return;
        }

        const body = {
            personalizations: [{ to: [{ email: toEmail }] }],
            from: { email: fromEmail },
            subject: subject,
            content: [{ type: "text/plain", value: bodyText }]
        };

        try {
            const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                console.error("SendGrid error:", await response.json());
                alert(`Email could not be sent to ${toEmail}. Check the console for details.`);
            }
        } catch (error) {
            console.error("Failed to send email:", error);
            alert(`An error occurred while trying to send an email to ${toEmail}.`);
        }
    }
function openReportsModal() {
        const container = document.getElementById('reports-container');
        let reportHTML = '<h3>Fairness Report</h3><p>This report analyzes the distribution of key shifts for the current month.</p>';
        
        const reportData = [];

        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;

            let weekendShifts = 0;
            let openingShifts = 0;
            let closingShifts = 0;

            if (scheduleData[emp.name]) {
                Object.keys(scheduleData[emp.name]).forEach(dateKey => {
                    const shift = scheduleData[emp.name][dateKey];
                    if (shift && shift.toUpperCase() !== 'PTO') {
                        const date = new Date(dateKey + 'T12:00:00Z');
                        const dayOfWeek = date.getDay();

                        // Check for weekend shifts (Saturday or Sunday)
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            weekendShifts++;
                        }
                        // Check for opening shifts
                        if (shiftTypes.opening.includes(shift)) {
                            openingShifts++;
                        }
                        // Check for closing shifts
                        if (shiftTypes.closing.includes(shift)) {
                            closingShifts++;
                        }
                    }
                });
            }
            reportData.push({ name: emp.name, weekendShifts, openingShifts, closingShifts });
        });

        reportHTML += `
            <table style="width:100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="text-align: left;">Employee Name</th>
                        <th>Weekend Shifts</th>
                        <th>Opening Shifts</th>
                        <th>Closing Shifts</th>
                    </tr>
                </thead>
                <tbody>
                    ${reportData.map(emp => `
                        <tr>
                            <td style="text-align: left;">${emp.name}</td>
                            <td>${emp.weekendShifts}</td>
                            <td>${emp.openingShifts}</td>
                            <td>${emp.closingShifts}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        container.innerHTML = reportHTML;
        document.getElementById('reportsModal').style.display = 'block';
    }
function toggleAutoApproval() {
        autoApprovalRules.enabled = !autoApprovalRules.enabled;
        if(autoApprovalRules.enabled) {
            const ruleText = autoApprovalRules.rule === 'firstCome' ? "'First Come, First Served'" : "'Lowest Hours Priority'";
            if (confirm(`Activate ${ruleText} auto-approval?\n\nThe system will now automatically approve bids based on this rule.`)) {
                runAutoApproval(); // Run it once in case any bids are waiting
            } else {
                autoApprovalRules.enabled = false; // User cancelled, so revert
            }
        }
        updateAutoApprovalUI();
        saveState();
    }

    function changeAutoApprovalRule() {
        autoApprovalRules.rule = document.getElementById('auto-approval-rule-select').value;
        saveState();
    }

    function updateAutoApprovalUI() {
        const btn = document.getElementById('auto-approval-btn');
        const select = document.getElementById('auto-approval-rule-select');
        select.value = autoApprovalRules.rule;

        if (autoApprovalRules.enabled) {
            btn.textContent = "Auto-Approval is ON";
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-success');
            select.disabled = true;
        } else {
            btn.textContent = "Activate Auto-Approval";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            select.disabled = false;
        }
    }

    function runAutoApproval() {
        if (!autoApprovalRules.enabled) return;

        let approvedCount = 0;
        const openShiftRows = employees.filter(e => e.name.startsWith("OPEN SHIFTS"));

        openShiftRows.forEach(row => {
            if(scheduleData[row.name]) {
                Object.keys(scheduleData[row.name]).forEach(dateKey => {
                    const shiftText = scheduleData[row.name][dateKey] || '';
                    shiftText.split(',').forEach(shift => {
                        shift = shift.trim();
                        if (!shift) return;

                        const bidders = bidsData[dateKey]?.[shift] || [];
                        if (bidders.length > 0) {
                            let winnerId = null;

                            if (autoApprovalRules.rule === 'firstCome') {
                                winnerId = bidders[0];
                            } 
                            else if (autoApprovalRules.rule === 'lowestHours') {
                                let lowestHours = Infinity;
                                let bestCandidate = null;
                                bidders.forEach(empId => {
                                    const employee = employees.find(e => e.id === empId);
                                    if (employee) {
                                        let totalHours = 0;
                                        Object.values(scheduleData[employee.name] || {}).forEach(s => {
                                            if (s && s.toUpperCase() !== 'PTO') totalHours += shiftsInfo[s] || 0;
                                        });
                                        if (totalHours < lowestHours) {
                                            lowestHours = totalHours;
                                            bestCandidate = empId;
                                        }
                                    }
                                });
                                winnerId = bestCandidate;
                            }

                            if (winnerId) {
                                approveBid(winnerId, dateKey, shift, row.name);
                                approvedCount++;
                            }
                        }
                    });
                });
            }
        });
        
        if (approvedCount > 0) {
            alert(`Auto-approval ran and assigned ${approvedCount} shift(s).`);
        }
    }
function addNotification(employeeId, message) {
        if (!notifications[employeeId]) {
            notifications[employeeId] = [];
        }
        notifications[employeeId].unshift({ message: message, read: false, date: new Date().toISOString() });
        // Keep only the last 20 notifications to prevent data from getting too large
        if (notifications[employeeId].length > 20) {
            notifications[employeeId].pop();
        }
    }
async function markNotificationsAsRead(employeeId) {
        const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
        if (fetchError || !records) return;

        const state = records.data;
        if (state.notifications && state.notifications[employeeId]) {
            state.notifications[employeeId].forEach(n => n.read = true);
            const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
            if (saveError) console.error("Error saving read status:", saveError);
        }
    }

    // ===== PTO MANAGEMENT SYSTEM FUNCTIONS =====

    // Calculate days between two dates (inclusive)
    function calculatePTODays(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const timeDifference = end.getTime() - start.getTime();
        const dayDifference = Math.ceil(timeDifference / (1000 * 3600 * 24)) + 1; // +1 to include both start and end dates
        return Math.max(0, dayDifference);
    }

    // Check if employee is eligible for PTO (90-day rule)
    function isEmployeeEligibleForPTO(employeeId) {
        const employee = employees.find(e => e.id === employeeId);
        if (!employee || !employee.hireDate) return { eligible: false, reason: "No hire date found" };
        
        const hireDate = new Date(employee.hireDate);
        const currentDate = new Date('2025-08-07'); // Using the date specified in requirements
        const daysSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24));
        
        if (daysSinceHire < 90) {
            const remainingDays = 90 - daysSinceHire;
            return { 
                eligible: false, 
                reason: `New employees must wait 90 days before requesting PTO. ${remainingDays} days remaining.`
            };
        }
        
        return { eligible: true, reason: "Employee is eligible for PTO" };
    }

    // Update PTO form based on date selection
    function updatePTOForm() {
        const startDate = document.getElementById('pto-start-date').value;
        const endDate = document.getElementById('pto-end-date').value;
        const daysDisplay = document.getElementById('pto-days-display');
        
        if (startDate && endDate) {
            const days = calculatePTODays(startDate, endDate);
            daysDisplay.value = `${days} day${days !== 1 ? 's' : ''}`;
        } else {
            daysDisplay.value = '';
        }
    }

    // Add event listeners for PTO form
    function setupPTOFormListeners() {
        const startDateInput = document.getElementById('pto-start-date');
        const endDateInput = document.getElementById('pto-end-date');
        
        if (startDateInput && endDateInput) {
            startDateInput.addEventListener('change', updatePTOForm);
            endDateInput.addEventListener('change', updatePTOForm);
            
            // Set minimum date to today for PTO requests
            const today = new Date().toISOString().split('T')[0];
            startDateInput.min = today;
            endDateInput.min = today;
        }
    }

    // Submit PTO request
    async function submitPTORequest() {
        const urlParams = new URLSearchParams(window.location.search);
        const employeeId = urlParams.get('portal');
        
        if (!employeeId) {
            alert('Error: Employee ID not found');
            return;
        }

        // Get form data
        const startDate = document.getElementById('pto-start-date').value;
        const endDate = document.getElementById('pto-end-date').value;
        const ptoType = document.getElementById('pto-type').value;
        const comments = document.getElementById('pto-comments').value;

        // Basic validation
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }

        // Enhanced validation with conflict detection
        const validation = validatePTORequest(employeeId, startDate, endDate, ptoType);
        
        if (!validation.valid) {
            alert('PTO Request Errors:\n' + validation.errors.join('\n'));
            return;
        }

        // Show warnings if any, but allow user to proceed
        if (validation.warnings.length > 0) {
            const proceed = confirm(
                'PTO Request Warnings:\n' + validation.warnings.join('\n') + 
                '\n\nDo you want to proceed with this request?'
            );
            if (!proceed) return;
        }

        const daysRequested = validation.daysRequested;
        const employee = employees.find(e => e.id === employeeId);

        try {
            // Create PTO request
            const requestId = generateUUID();
            const newRequest = {
                id: requestId,
                employeeId: employeeId,
                employeeName: employee.name,
                startDate: startDate,
                endDate: endDate,
                daysRequested: daysRequested,
                requestType: ptoType,
                reason: comments,
                status: 'pending',
                submissionDate: new Date().toISOString(),
                approvalDate: null,
                managerId: null,
                managerComments: '',
                conflicts: validation.conflicts, // Store conflict information
                validationWarnings: validation.warnings
            };

            // Try to load current state from Supabase, fallback to localStorage
            let state = {};
            try {
                if (typeof supabaseClient !== 'undefined') {
                    const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
                    if (!fetchError && records?.data) {
                        state = records.data;
                    }
                }
            } catch (err) {
                console.warn('Could not load from Supabase, using local data:', err);
            }
            
            // Fallback to localStorage or current data
            if (!state.ptoRequests) {
                const localData = localStorage.getItem('scheduleGeneratorState');
                if (localData) {
                    state = JSON.parse(localData);
                } else {
                    state = {
                        employees,
                        schedule: scheduleData,
                        notesData,
                        bidsData,
                        notifications,
                        ptoRequests,
                        employeePTOBalances
                    };
                }
            }

            if (!state.ptoRequests) state.ptoRequests = {};
            if (!state.employeePTOBalances) state.employeePTOBalances = {};

            // Add the request
            state.ptoRequests[requestId] = newRequest;

            // Update pending PTO balance
            if (!state.employeePTOBalances[employeeId]) {
                state.employeePTOBalances[employeeId] = employeePTOBalances[employeeId] || {
                    employeeName: employee.name,
                    hireDate: employee.hireDate || "2024-01-01",
                    totalPTODays: employee.type === "FT" ? 20 : 15,
                    usedPTODays: 0,
                    pendingPTODays: 0
                };
            }
            state.employeePTOBalances[employeeId].pendingPTODays += daysRequested;

            // Save to both Supabase and localStorage
            try {
                if (typeof supabaseClient !== 'undefined') {
                    const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
                    if (saveError) throw new Error(saveError.message);
                }
            } catch (err) {
                console.warn('Could not save to Supabase, saving locally:', err);
            }
            
            // Always save to localStorage as backup
            localStorage.setItem('scheduleGeneratorState', JSON.stringify(state));

            // Update local state
            ptoRequests[requestId] = newRequest;
            if (employeePTOBalances[employeeId]) {
                employeePTOBalances[employeeId].pendingPTODays += daysRequested;
            }

            alert(`‚úÖ PTO request submitted successfully!\n\nRequest Details:\n‚Ä¢ ${daysRequested} days requested\n‚Ä¢ ${ptoType} leave\n‚Ä¢ Status: Pending approval\n\nYour manager will be notified of this request.`);

            // Clear form
            document.getElementById('pto-start-date').value = '';
            document.getElementById('pto-end-date').value = '';
            document.getElementById('pto-comments').value = '';
            document.getElementById('pto-days-display').value = '';

            // Refresh the PTO balance display
            displayPTOBalance(employeeId);
            loadPTOHistory(employeeId);

        } catch (error) {
            console.error('Error submitting PTO request:', error);
            alert('Error submitting PTO request: ' + error.message);
        }
    }

    // Open PTO Requests Management Modal for Managers
    async function openPTORequestsModal() {
        try {
            // Load fresh data from Supabase
            const { data: records, error } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            if (error) throw new Error(error.message);

            const state = records.data || {};
            ptoRequests = state.ptoRequests || {};
            employeePTOBalances = state.employeePTOBalances || {};

            renderPTORequestsModal();
            document.getElementById('ptoRequestsModal').style.display = 'block';

        } catch (error) {
            console.error('Error loading PTO requests:', error);
            alert('Error loading PTO requests: ' + error.message);
        }
    }

    // Render PTO Requests Modal Content
    function renderPTORequestsModal() {
        const container = document.getElementById('pto-requests-container');
        const allRequests = Object.values(ptoRequests);
        
        // Update dashboard counters
        const pendingCount = allRequests.filter(r => r.status === 'pending').length;
        const conflictsCount = detectPTOConflicts().length;
        const totalCount = allRequests.length;

        document.getElementById('pending-count').textContent = pendingCount;
        document.getElementById('conflicts-count').textContent = conflictsCount;
        document.getElementById('total-requests-count').textContent = totalCount;

        // Filter requests based on selection
        const filter = document.getElementById('pto-filter').value;
        let filteredRequests = allRequests;

        switch (filter) {
            case 'pending':
                filteredRequests = allRequests.filter(r => r.status === 'pending');
                break;
            case 'approved':
                filteredRequests = allRequests.filter(r => r.status === 'approved');
                break;
            case 'denied':
                filteredRequests = allRequests.filter(r => r.status === 'denied');
                break;
            case 'conflicts':
                const conflicts = detectPTOConflicts();
                filteredRequests = allRequests.filter(r => conflicts.some(c => c.requestId === r.id));
                break;
        }

        // Sort by submission date (newest first)
        filteredRequests.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));

        if (filteredRequests.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No PTO requests found.</p>';
            return;
        }

        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #f8f9fa;">';
        html += '<th style="padding: 10px; border: 1px solid #ddd;"><input type="checkbox" id="select-all-pto" onchange="toggleAllPTOSelection()"></th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Employee</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Dates</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Days</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Type</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Status</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Submitted</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Actions</th>';
        html += '</tr></thead><tbody>';

        const conflicts = detectPTOConflicts();

        filteredRequests.forEach(request => {
            const hasConflict = conflicts.some(c => c.requestId === request.id);
            const rowClass = hasConflict ? 'pto-conflict' : '';
            const statusClass = `pto-status-${request.status}`;

            const startDate = new Date(request.startDate).toLocaleDateString();
            const endDate = new Date(request.endDate).toLocaleDateString();
            const submissionDate = new Date(request.submissionDate).toLocaleDateString();

            html += `<tr class="${rowClass} ${statusClass}">`;
            html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">`;
            if (request.status === 'pending') {
                html += `<input type="checkbox" class="pto-select" value="${request.id}">`;
            }
            html += `</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd;">${request.employeeName}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd;">${startDate} - ${endDate}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${request.daysRequested}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd; text-transform: capitalize;">${request.requestType}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd; text-transform: capitalize; font-weight: bold;">${request.status}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd;">${submissionDate}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd;">`;
            
            if (request.status === 'pending') {
                html += `<button class="btn btn-success btn-sm" onclick="approvePTORequest('${request.id}')" style="margin-right: 5px;">‚úì Approve</button>`;
                html += `<button class="btn btn-danger btn-sm" onclick="denyPTORequest('${request.id}')">‚úó Deny</button>`;
            }
            html += `<button class="btn btn-secondary btn-sm" onclick="viewPTODetails('${request.id}')" style="margin-left: 5px;">üëÅÔ∏è Details</button>`;
            html += `<button class="btn btn-warning btn-sm" onclick="generatePTOPDF('${request.id}')" style="margin-left: 5px;">üìÑ PDF</button>`;
            html += `</td></tr>`;

            // Add details row
            if (request.reason || hasConflict) {
                html += `<tr class="${rowClass}"><td colspan="8" style="padding: 5px 8px; border: 1px solid #ddd; background: #f9f9f9; font-size: 12px;">`;
                if (request.reason) {
                    html += `<strong>Comments:</strong> ${request.reason}<br>`;
                }
                if (hasConflict) {
                    const conflict = conflicts.find(c => c.requestId === request.id);
                    html += `<span style="color: #dc3545;"><strong>‚ö†Ô∏è CONFLICT:</strong> ${conflict.details}</span>`;
                }
                html += `</td></tr>`;
            }
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Detect PTO conflicts (one person off at a time rule)
    function detectPTOConflicts() {
        const conflicts = [];
        const approvedRequests = Object.values(ptoRequests).filter(r => r.status === 'approved');
        const pendingRequests = Object.values(ptoRequests).filter(r => r.status === 'pending');

        pendingRequests.forEach(pendingRequest => {
            const pendingStart = new Date(pendingRequest.startDate);
            const pendingEnd = new Date(pendingRequest.endDate);

            // Check against approved requests
            approvedRequests.forEach(approvedRequest => {
                if (approvedRequest.employeeId === pendingRequest.employeeId) return; // Same employee

                const approvedStart = new Date(approvedRequest.startDate);
                const approvedEnd = new Date(approvedRequest.endDate);

                // Check for date overlap
                if (pendingStart <= approvedEnd && pendingEnd >= approvedStart) {
                    conflicts.push({
                        requestId: pendingRequest.id,
                        conflictWith: approvedRequest.id,
                        details: `Conflicts with ${approvedRequest.employeeName}'s approved PTO from ${approvedStart.toLocaleDateString()} to ${approvedEnd.toLocaleDateString()}`
                    });
                }
            });

            // Check against other pending requests (for potential future conflicts)
            pendingRequests.forEach(otherPending => {
                if (otherPending.id === pendingRequest.id || otherPending.employeeId === pendingRequest.employeeId) return;

                const otherStart = new Date(otherPending.startDate);
                const otherEnd = new Date(otherPending.endDate);

                if (pendingStart <= otherEnd && pendingEnd >= otherStart && 
                    new Date(otherPending.submissionDate) < new Date(pendingRequest.submissionDate)) {
                    conflicts.push({
                        requestId: pendingRequest.id,
                        conflictWith: otherPending.id,
                        details: `Potential conflict with ${otherPending.employeeName}'s pending PTO from ${otherStart.toLocaleDateString()} to ${otherEnd.toLocaleDateString()}`
                    });
                }
            });
        });

        return conflicts;
    }

    // Approve PTO Request
    async function approvePTORequest(requestId) {
        const request = ptoRequests[requestId];
        if (!request) {
            alert('Request not found');
            return;
        }

        const conflicts = detectPTOConflicts().filter(c => c.requestId === requestId);
        if (conflicts.length > 0) {
            const proceed = confirm(`This request has conflicts:\n${conflicts.map(c => c.details).join('\n')}\n\nDo you want to proceed with approval anyway?`);
            if (!proceed) return;
        }

        try {
            // Load current state
            const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            if (fetchError) throw new Error(fetchError.message);

            const state = records.data;
            
            // Update request status
            state.ptoRequests[requestId].status = 'approved';
            state.ptoRequests[requestId].approvalDate = new Date().toISOString();
            state.ptoRequests[requestId].managerId = 'manager'; // You could track specific manager

            // Update PTO balances
            const employeeId = request.employeeId;
            if (state.employeePTOBalances[employeeId]) {
                state.employeePTOBalances[employeeId].usedPTODays += request.daysRequested;
                state.employeePTOBalances[employeeId].pendingPTODays -= request.daysRequested;
            }

            // Add PTO to schedule
            addPTOToSchedule(request.startDate, request.endDate, request.employeeName, state);

            // Save state
            const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
            if (saveError) throw new Error(saveError.message);

            // Update local state
            ptoRequests[requestId] = state.ptoRequests[requestId];
            if (employeePTOBalances[employeeId]) {
                employeePTOBalances[employeeId].usedPTODays += request.daysRequested;
                employeePTOBalances[employeeId].pendingPTODays -= request.daysRequested;
            }

    // Send notification to employee
            addNotification(employeeId, `‚úÖ **PTO Approved:** Your PTO request for ${new Date(request.startDate).toLocaleDateString()} to ${new Date(request.endDate).toLocaleDateString()} has been approved.`);

            // Send email notification if employee has email
            const employee = employees.find(e => e.id === employeeId);
            if (employee && employee.email) {
                sendPTONotificationEmail(employee.email, employee.name, 'approved', request);
            }

            // Refresh display
            renderPTORequestsModal();
            renderTable(); // Update main schedule

            alert('PTO request approved successfully!');

        } catch (error) {
            console.error('Error approving PTO request:', error);
            alert('Error approving PTO request: ' + error.message);
        }
    }

    // Deny PTO Request
    async function denyPTORequest(requestId) {
        const request = ptoRequests[requestId];
        if (!request) {
            alert('Request not found');
            return;
        }

        const reason = prompt('Please provide a reason for denial (optional):') || 'No reason provided';

        try {
            // Load current state
            const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            if (fetchError) throw new Error(fetchError.message);

            const state = records.data;
            
            // Update request status
            state.ptoRequests[requestId].status = 'denied';
            state.ptoRequests[requestId].approvalDate = new Date().toISOString();
            state.ptoRequests[requestId].managerComments = reason;

            // Update PTO balances (restore pending days)
            const employeeId = request.employeeId;
            if (state.employeePTOBalances[employeeId]) {
                state.employeePTOBalances[employeeId].pendingPTODays -= request.daysRequested;
            }

            // Save state
            const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
            if (saveError) throw new Error(saveError.message);

            // Update local state
            ptoRequests[requestId] = state.ptoRequests[requestId];
            if (employeePTOBalances[employeeId]) {
                employeePTOBalances[employeeId].pendingPTODays -= request.daysRequested;
            }

            // Send notification to employee
            addNotification(employeeId, `‚ùå **PTO Denied:** Your PTO request for ${new Date(request.startDate).toLocaleDateString()} to ${new Date(request.endDate).toLocaleDateString()} was denied. Reason: ${reason}`);

            // Send email notification if employee has email
            const employee = employees.find(e => e.id === employeeId);
            if (employee && employee.email) {
                sendPTONotificationEmail(employee.email, employee.name, 'denied', request, reason);
            }

            // Refresh display
            renderPTORequestsModal();

            alert('PTO request denied.');

        } catch (error) {
            console.error('Error denying PTO request:', error);
            alert('Error denying PTO request: ' + error.message);
        }
    }

    // Add PTO to schedule
    function addPTOToSchedule(startDate, endDate, employeeName, state) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
            const dateKey = date.toISOString().split('T')[0];
            
            if (!state.schedule[employeeName]) {
                state.schedule[employeeName] = {};
            }
            
            // Store original shift if it exists
            const originalShift = state.schedule[employeeName][dateKey];
            if (originalShift && originalShift.toUpperCase() !== 'PTO') {
                // Move original shift to open shifts
                const openShiftsEmp = state.employees.find(e => e.name.startsWith('OPEN SHIFTS'));
                if (openShiftsEmp) {
                    if (!state.schedule[openShiftsEmp.name]) {
                        state.schedule[openShiftsEmp.name] = {};
                    }
                    const currentOpenShifts = state.schedule[openShiftsEmp.name][dateKey] || '';
                    state.schedule[openShiftsEmp.name][dateKey] = currentOpenShifts ? 
                        `${currentOpenShifts}, ${originalShift}` : originalShift;
                }
            }
            
            state.schedule[employeeName][dateKey] = 'PTO';
        }
    }

    // Filter PTO requests
    function filterPTORequests() {
        renderPTORequestsModal();
    }

    // Toggle all PTO selection
    function toggleAllPTOSelection() {
        const selectAll = document.getElementById('select-all-pto');
        const checkboxes = document.querySelectorAll('.pto-select');
        
        checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
        });
    }

    // Batch approve PTO requests
    async function batchApprovePTO() {
        const selectedRequests = Array.from(document.querySelectorAll('.pto-select:checked')).map(cb => cb.value);
        
        if (selectedRequests.length === 0) {
            alert('Please select requests to approve');
            return;
        }

        if (!confirm(`Approve ${selectedRequests.length} PTO request(s)?`)) return;

        for (const requestId of selectedRequests) {
            await approvePTORequest(requestId);
        }

        renderPTORequestsModal();
    }

    // Batch deny PTO requests
    async function batchDenyPTO() {
        const selectedRequests = Array.from(document.querySelectorAll('.pto-select:checked')).map(cb => cb.value);
        
        if (selectedRequests.length === 0) {
            alert('Please select requests to deny');
            return;
        }

        const reason = prompt('Please provide a reason for denial:') || 'Batch denial - no reason provided';

        if (!confirm(`Deny ${selectedRequests.length} PTO request(s)?`)) return;

        for (const requestId of selectedRequests) {
            await denyPTORequest(requestId);
        }

        renderPTORequestsModal();
    }

    // View PTO details
    function viewPTODetails(requestId) {
        const request = ptoRequests[requestId];
        if (!request) {
            alert('Request not found');
            return;
        }

        const employee = employees.find(e => e.id === request.employeeId);
        const eligibility = isEmployeeEligibleForPTO(request.employeeId);
        const balance = employeePTOBalances[request.employeeId];

        let details = `PTO Request Details\n\n`;
        details += `Employee: ${request.employeeName}\n`;
        details += `Dates: ${new Date(request.startDate).toLocaleDateString()} - ${new Date(request.endDate).toLocaleDateString()}\n`;
        details += `Days Requested: ${request.daysRequested}\n`;
        details += `Type: ${request.requestType}\n`;
        details += `Status: ${request.status}\n`;
        details += `Submitted: ${new Date(request.submissionDate).toLocaleDateString()}\n`;
        
        if (request.reason) {
            details += `Comments: ${request.reason}\n`;
        }
        
        if (employee && employee.hireDate) {
            details += `Hire Date: ${new Date(employee.hireDate).toLocaleDateString()}\n`;
            details += `Eligibility: ${eligibility.eligible ? 'Eligible' : eligibility.reason}\n`;
        }
        
        if (balance) {
            const remaining = balance.totalPTODays - balance.usedPTODays - balance.pendingPTODays;
            details += `PTO Balance: ${remaining} days remaining (${balance.totalPTODays} total, ${balance.usedPTODays} used, ${balance.pendingPTODays} pending)\n`;
        }

        if (request.approvalDate) {
            details += `Decision Date: ${new Date(request.approvalDate).toLocaleDateString()}\n`;
        }
        
        if (request.managerComments) {
            details += `Manager Comments: ${request.managerComments}\n`;
        }

        alert(details);
    }

    // Export PTO Report (basic version - can be enhanced with proper PDF library)
    function exportPTOReport() {
        const allRequests = Object.values(ptoRequests);
        let report = 'PTO Report - ' + new Date().toLocaleDateString() + '\n\n';
        
        const pending = allRequests.filter(r => r.status === 'pending').length;
        const approved = allRequests.filter(r => r.status === 'approved').length;
        const denied = allRequests.filter(r => r.status === 'denied').length;
        
        report += `Summary:\n`;
        report += `Total Requests: ${allRequests.length}\n`;
        report += `Pending: ${pending}\n`;
        report += `Approved: ${approved}\n`;
        report += `Denied: ${denied}\n\n`;
        
        report += `Detailed Report:\n`;
        report += `Employee\tDates\tDays\tType\tStatus\tSubmitted\n`;
        
        allRequests.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
        
        allRequests.forEach(request => {
            const startDate = new Date(request.startDate).toLocaleDateString();
            const endDate = new Date(request.endDate).toLocaleDateString();
            const submissionDate = new Date(request.submissionDate).toLocaleDateString();
            
            report += `${request.employeeName}\t${startDate} - ${endDate}\t${request.daysRequested}\t${request.requestType}\t${request.status}\t${submissionDate}\n`;
        });
        
        // Create and download file
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `PTO_Report_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ===== PDF GENERATION FUNCTIONS =====

    // Generate professional PTO PDF
    function generatePTOPDF(requestId) {
        const request = ptoRequests[requestId];
        if (!request) {
            alert('Request not found');
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('PDF library not loaded. Please try again.');
                return;
            }

            const doc = new jsPDF();
            const employee = employees.find(e => e.id === request.employeeId);
            const balance = employeePTOBalances[request.employeeId];

            // Company Header
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("NSG Schedule", 105, 20, { align: "center" });
            
            doc.setFontSize(16);
            doc.text("PTO Request Form", 105, 30, { align: "center" });

            // Add line separator
            doc.setLineWidth(0.5);
            doc.line(20, 35, 190, 35);

            // Employee Information Section
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Employee Information", 20, 50);
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            let yPos = 60;
            
            doc.text(`Employee Name: ${request.employeeName}`, 20, yPos);
            yPos += 8;
            
            if (employee && employee.id) {
                doc.text(`Employee ID: ${employee.id.substring(0, 8)}`, 20, yPos);
                yPos += 8;
            }
            
            if (employee && employee.type) {
                doc.text(`Employment Type: ${employee.type}`, 20, yPos);
                yPos += 8;
            }
            
            if (employee && employee.hireDate) {
                doc.text(`Hire Date: ${new Date(employee.hireDate).toLocaleDateString()}`, 20, yPos);
                yPos += 8;
            }

            // PTO Request Details Section
            yPos += 10;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("PTO Request Details", 20, yPos);
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            yPos += 10;
            
            const startDate = new Date(request.startDate).toLocaleDateString();
            const endDate = new Date(request.endDate).toLocaleDateString();
            
            doc.text(`Start Date: ${startDate}`, 20, yPos);
            doc.text(`End Date: ${endDate}`, 120, yPos);
            yPos += 8;
            
            doc.text(`Days Requested: ${request.daysRequested}`, 20, yPos);
            doc.text(`Request Type: ${request.requestType}`, 120, yPos);
            yPos += 8;
            
            doc.text(`Submission Date: ${new Date(request.submissionDate).toLocaleDateString()}`, 20, yPos);
            yPos += 8;
            
            if (request.reason) {
                doc.text(`Comments: ${request.reason}`, 20, yPos);
                yPos += 8;
            }

            // PTO Balance Section
            if (balance) {
                yPos += 10;
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("PTO Balance Information", 20, yPos);
                
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                yPos += 10;
                
                const remaining = balance.totalPTODays - balance.usedPTODays - balance.pendingPTODays;
                
                doc.text(`Total PTO Days: ${balance.totalPTODays}`, 20, yPos);
                doc.text(`Used Days: ${balance.usedPTODays}`, 70, yPos);
                doc.text(`Pending Days: ${balance.pendingPTODays}`, 120, yPos);
                doc.text(`Remaining: ${remaining}`, 170, yPos);
                yPos += 8;
            }

            // Approval Section
            yPos += 10;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Approval Status", 20, yPos);
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            yPos += 10;
            
            const statusColor = request.status === 'approved' ? [0, 128, 0] : 
                               request.status === 'denied' ? [255, 0, 0] : [255, 165, 0];
            
            doc.setTextColor(...statusColor);
            doc.setFont("helvetica", "bold");
            doc.text(`Status: ${request.status.toUpperCase()}`, 20, yPos);
            doc.setTextColor(0, 0, 0); // Reset to black
            doc.setFont("helvetica", "normal");
            yPos += 8;
            
            if (request.approvalDate) {
                doc.text(`Decision Date: ${new Date(request.approvalDate).toLocaleDateString()}`, 20, yPos);
                yPos += 8;
            }
            
            if (request.managerComments) {
                doc.text(`Manager Comments: ${request.managerComments}`, 20, yPos);
                yPos += 8;
            }

            // Digital Signature Section
            yPos += 20;
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Digital Approval", 20, yPos);
            
            if (request.status === 'approved') {
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Approved by: Manager`, 20, yPos);
                yPos += 6;
                doc.text(`Approval Date: ${new Date(request.approvalDate).toLocaleDateString()}`, 20, yPos);
                yPos += 6;
                doc.text(`Document ID: ${request.id.substring(0, 12)}`, 20, yPos);
            }

            // QR Code for verification (if available)
            try {
                if (typeof qrcode !== 'undefined') {
                    const qrData = `NSG-PTO-${request.id}`;
                    const qr = qrcode(0, 'M');
                    qr.addData(qrData);
                    qr.make();
                    
                    // Add QR code as text (basic implementation)
                    yPos += 15;
                    doc.setFontSize(8);
                    doc.text(`Verification Code: NSG-PTO-${request.id.substring(0, 8)}`, 20, yPos);
                }
            } catch (e) {
                console.log('QR code generation not available:', e);
            }

            // Footer
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.text("This document was generated electronically by NSG Schedule System", 105, pageHeight - 20, { align: "center" });
            doc.text(`Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 105, pageHeight - 15, { align: "center" });

            // Save the PDF
            const filename = `PTO_Request_${request.employeeName.replace(/[^a-zA-Z0-9]/g, '_')}_${request.startDate}.pdf`;
            doc.save(filename);

        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF: ' + error.message);
        }
    }

    // Batch PDF generation for multiple requests
    function generateBatchPDFs() {
        const selectedRequests = Array.from(document.querySelectorAll('.pto-select:checked')).map(cb => cb.value);
        
        if (selectedRequests.length === 0) {
            alert('Please select requests to generate PDFs for');
            return;
        }

        selectedRequests.forEach((requestId, index) => {
            setTimeout(() => {
                generatePTOPDF(requestId);
            }, index * 500); // Delay between downloads to prevent browser blocking
        });
    }

    // Enhanced export PTO Report with PDF option
    function exportPTOReport() {
        const format = prompt('Export format:\n1. Text file (enter "text")\n2. PDF report (enter "pdf")', 'text');
        
        if (format === 'pdf') {
            generatePTOReportPDF();
        } else {
            // Existing text export functionality
            const allRequests = Object.values(ptoRequests);
            let report = 'PTO Report - ' + new Date().toLocaleDateString() + '\n\n';
            
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'approved').length;
            const denied = allRequests.filter(r => r.status === 'denied').length;
            
            report += `Summary:\n`;
            report += `Total Requests: ${allRequests.length}\n`;
            report += `Pending: ${pending}\n`;
            report += `Approved: ${approved}\n`;
            report += `Denied: ${denied}\n\n`;
            
            report += `Detailed Report:\n`;
            report += `Employee\tDates\tDays\tType\tStatus\tSubmitted\n`;
            
            allRequests.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
            
            allRequests.forEach(request => {
                const startDate = new Date(request.startDate).toLocaleDateString();
                const endDate = new Date(request.endDate).toLocaleDateString();
                const submissionDate = new Date(request.submissionDate).toLocaleDateString();
                
                report += `${request.employeeName}\t${startDate} - ${endDate}\t${request.daysRequested}\t${request.requestType}\t${request.status}\t${submissionDate}\n`;
            });
            
            // Create and download file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PTO_Report_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }

    // Generate comprehensive PDF report
    function generatePTOReportPDF() {
        try {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('PDF library not loaded. Please try again.');
                return;
            }

            const doc = new jsPDF();
            const allRequests = Object.values(ptoRequests);
            
            // Header
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("NSG Schedule - PTO Management Report", 105, 20, { align: "center" });
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: "center" });

            // Summary statistics
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'approved').length;
            const denied = allRequests.filter(r => r.status === 'denied').length;
            const conflicts = detectPTOConflicts().length;

            let yPos = 50;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Summary Statistics", 20, yPos);
            
            yPos += 10;
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.text(`Total Requests: ${allRequests.length}`, 20, yPos);
            doc.text(`Pending: ${pending}`, 70, yPos);
            doc.text(`Approved: ${approved}`, 120, yPos);
            doc.text(`Denied: ${denied}`, 170, yPos);
            yPos += 8;
            doc.text(`Active Conflicts: ${conflicts}`, 20, yPos);

            // Detailed table
            yPos += 20;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Detailed Request Log", 20, yPos);

            yPos += 10;
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            
            // Table headers
            doc.text("Employee", 20, yPos);
            doc.text("Dates", 65, yPos);
            doc.text("Days", 105, yPos);
            doc.text("Type", 125, yPos);
            doc.text("Status", 150, yPos);
            doc.text("Submitted", 175, yPos);
            
            doc.setLineWidth(0.1);
            doc.line(20, yPos + 2, 190, yPos + 2);
            
            yPos += 8;
            doc.setFont("helvetica", "normal");

            allRequests.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
            
            allRequests.forEach(request => {
                if (yPos > 280) { // Start new page if needed
                    doc.addPage();
                    yPos = 20;
                }
                
                const startDate = new Date(request.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endDate = new Date(request.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const submissionDate = new Date(request.submissionDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                // Truncate long names
                const empName = request.employeeName.length > 15 ? 
                    request.employeeName.substring(0, 15) + '...' : request.employeeName;
                
                doc.text(empName, 20, yPos);
                doc.text(`${startDate}-${endDate}`, 65, yPos);
                doc.text(request.daysRequested.toString(), 105, yPos);
                doc.text(request.requestType, 125, yPos);
                doc.text(request.status, 150, yPos);
                doc.text(submissionDate, 175, yPos);
                
                yPos += 6;
            });

            // Footer
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.text("NSG Schedule System - Confidential", 105, pageHeight - 10, { align: "center" });

            // Save the PDF
            doc.save(`NSG_PTO_Report_${new Date().toISOString().split('T')[0]}.pdf`);

        } catch (error) {
            console.error('Error generating PDF report:', error);
            alert('Error generating PDF report: ' + error.message);
        }
    }

    // ===== EMAIL AUTOMATION FUNCTIONS =====

    // Send PTO notification email
    function sendPTONotificationEmail(email, employeeName, status, request, reason = '') {
        const startDate = new Date(request.startDate).toLocaleDateString();
        const endDate = new Date(request.endDate).toLocaleDateString();
        
        let subject, body;
        
        if (status === 'approved') {
            subject = `PTO Request Approved - ${startDate} to ${endDate}`;
            body = `Dear ${employeeName.split(',')[1]?.trim() || employeeName},\n\n`;
            body += `Your PTO request has been APPROVED!\n\n`;
            body += `Details:\n`;
            body += `- Dates: ${startDate} to ${endDate}\n`;
            body += `- Days: ${request.daysRequested}\n`;
            body += `- Type: ${request.requestType}\n`;
            if (request.reason) {
                body += `- Comments: ${request.reason}\n`;
            }
            body += `\nYour time off has been added to the schedule. Please check your employee portal for the most up-to-date information.\n\n`;
            body += `Thank you,\nNSG Schedule Management`;
        } else if (status === 'denied') {
            subject = `PTO Request Decision - ${startDate} to ${endDate}`;
            body = `Dear ${employeeName.split(',')[1]?.trim() || employeeName},\n\n`;
            body += `We regret to inform you that your PTO request has been DENIED.\n\n`;
            body += `Details:\n`;
            body += `- Requested Dates: ${startDate} to ${endDate}\n`;
            body += `- Days: ${request.daysRequested}\n`;
            body += `- Type: ${request.requestType}\n`;
            if (reason) {
                body += `- Reason for denial: ${reason}\n`;
            }
            body += `\nPlease contact your manager if you have any questions or would like to discuss alternative dates.\n\n`;
            body += `Thank you,\nNSG Schedule Management`;
        }
        
        // Use mailto link for now - can be enhanced with SendGrid or other email service
        const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        // Try to open email client, but don't show error if it fails
        try {
            window.open(mailtoLink, '_blank');
        } catch (e) {
            console.log('Email client not available:', e);
        }
    }

    // Send PTO submission notification to managers
    function notifyManagersOfNewPTORequest(request) {
        // This function can be enhanced to send emails to all managers
        console.log('New PTO request submitted:', request);
        
        // For now, just add to the notification system
        // In a real implementation, you would send emails to managers here
        const managerEmail = "manager@nsg.com"; // Replace with actual manager email
        
        const subject = `New PTO Request - ${request.employeeName}`;
        const body = `A new PTO request has been submitted:\n\n`;
        const startDate = new Date(request.startDate).toLocaleDateString();
        const endDate = new Date(request.endDate).toLocaleDateString();
        
        const emailBody = `Employee: ${request.employeeName}\n`;
        emailBody += `Dates: ${startDate} to ${endDate}\n`;
        emailBody += `Days: ${request.daysRequested}\n`;
        emailBody += `Type: ${request.requestType}\n`;
        if (request.reason) {
            emailBody += `Comments: ${request.reason}\n`;
        }
        emailBody += `\nPlease review and approve/deny this request in the NSG Schedule system.\n\n`;
        emailBody += `Access the system at: ${window.location.origin}${window.location.pathname}`;
        
        // Use mailto for manager notification
        const mailtoLink = `mailto:${managerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        
        try {
            window.open(mailtoLink, '_blank');
        } catch (e) {
            console.log('Email client not available for manager notification:', e);
        }
    }

    // ===== CALENDAR INTEGRATION FUNCTIONS =====

    // Add PTO calendar view to main dashboard
    function renderPTOCalendarView() {
        const container = document.createElement('div');
        container.id = 'pto-calendar-widget';
        container.innerHTML = `
            <h3>PTO Calendar Overview</h3>
            <div id="pto-mini-calendar" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                <p style="text-align: center; color: #666;">PTO calendar will display approved time off</p>
            </div>
        `;
        
        // Find a good place to add this in the dashboard
        const dashboardContainer = document.querySelector('.dashboard .controls');
        if (dashboardContainer) {
            dashboardContainer.appendChild(container);
        }
    }

    // Update the main schedule rendering to better highlight PTO
    function enhancePTODisplay() {
        // This function is called after the table is rendered to add PTO enhancements
        const cells = document.querySelectorAll('.pto-approved, .pto-pending');
        cells.forEach(cell => {
            if (cell.textContent.toUpperCase() === 'PTO') {
                // Add tooltip with PTO request details
                const employeeName = cell.closest('tr')?.querySelector('.employee-name')?.textContent;
                if (employeeName) {
                    const ptoRequests = Object.values(window.ptoRequests || {}).filter(r => 
                        r.employeeName === employeeName && 
                        (r.status === 'approved' || r.status === 'pending')
                    );
                    
                    if (ptoRequests.length > 0) {
                        const request = ptoRequests[0]; // Get the first matching request
                        cell.title = `PTO Request: ${request.requestType} (${request.status})`;
                        
                        // Add icon based on status
                        if (request.status === 'approved') {
                            cell.innerHTML = 'PTO ‚úÖ';
                        } else if (request.status === 'pending') {
                            cell.innerHTML = 'PTO ‚è≥';
                        }
                    }
                }
            }
        });
    }

    // Initialize PTO enhancements when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        setupPTOFormListeners();
    });

    // ===== MONTHLY PTO REPORTING SYSTEM =====
    
    function generateMonthlyPTOReports() {
        // Set default month to current month
        const now = new Date();
        const currentMonth = now.toISOString().substring(0, 7);
        document.getElementById('reportMonth').value = currentMonth;
        
        document.getElementById('monthlyPTOReportsModal').style.display = 'block';
        generatePTOReportForMonth();
    }

    function generatePTOReportForMonth() {
        const reportMonth = document.getElementById('reportMonth').value;
        if (!reportMonth) {
            alert('Please select a month for the report');
            return;
        }

        const container = document.getElementById('monthly-pto-reports-container');
        let reportsHTML = `<h3>PTO Balance Reports for ${new Date(reportMonth).toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}</h3>`;
        
        const eligibleEmployees = employees.filter(emp => 
            emp.id && !emp.name.startsWith('OPEN SHIFTS') && emp.type !== 'Bank'
        );

        if (eligibleEmployees.length === 0) {
            container.innerHTML = '<p>No employees found for reporting.</p>';
            return;
        }

        eligibleEmployees.forEach(employee => {
            const ptoBalance = employeePTOBalances[employee.id] || {
                totalPTODays: employee.type === "FT" ? 20 : 15,
                usedPTODays: 0,
                pendingPTODays: 0
            };

            const remainingPTO = ptoBalance.totalPTODays - ptoBalance.usedPTODays;
            const yearStartDate = new Date(new Date().getFullYear(), 0, 1);
            const currentDate = new Date();
            const daysSinceYearStart = Math.floor((currentDate - yearStartDate) / (1000 * 60 * 60 * 24));
            
            // Calculate accrued PTO based on hire date
            const hireDate = new Date(employee.hireDate || '2024-01-01');
            const monthsSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24 * 30));
            const accruedPTO = calculateAccruedPTO(employee, monthsSinceHire);

            // Get upcoming scheduled PTO for next 30 days
            const upcomingPTO = getUpcomingPTO(employee.name);

            reportsHTML += `
                <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f9f9f9;">
                    <h4 style="margin-top: 0; color: #333;">${employee.name}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Annual PTO Allocation:</strong> ${ptoBalance.totalPTODays} days<br>
                            <strong>Used This Year:</strong> ${ptoBalance.usedPTODays} days<br>
                            <strong>Remaining Balance:</strong> <span style="color: ${remainingPTO < 5 ? 'red' : 'green'}; font-weight: bold;">${remainingPTO} days</span>
                        </div>
                        <div>
                            <strong>Pending Requests:</strong> ${ptoBalance.pendingPTODays} days<br>
                            <strong>Accrued This Year:</strong> ${accruedPTO} days<br>
                            <strong>Hire Date:</strong> ${new Date(employee.hireDate || '2024-01-01').toLocaleDateString()}
                        </div>
                        <div>
                            <strong>Upcoming PTO:</strong><br>
                            ${upcomingPTO.length > 0 ? upcomingPTO.join('<br>') : 'None scheduled'}
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="emailIndividualPTOReport('${employee.id}', '${reportMonth}')" style="font-size: 12px;">üìß Email to ${employee.name.split(',')[1] || employee.name}</button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = reportsHTML;
    }

    function calculateAccruedPTO(employee, monthsSinceHire) {
        // Basic accrual calculation - can be enhanced based on company policy
        const yearlyAllocation = employee.type === "FT" ? 20 : 15;
        const monthlyAccrual = yearlyAllocation / 12;
        
        // First 90 days - no accrual
        if (monthsSinceHire < 3) return 0;
        
        // After 90 days, accrue monthly
        return Math.floor((monthsSinceHire - 3) * monthlyAccrual);
    }

    function getUpcomingPTO(employeeName) {
        const upcoming = [];
        const currentDate = new Date();
        const futureDate = new Date();
        futureDate.setDate(currentDate.getDate() + 30);

        currentDates.forEach(date => {
            if (date >= currentDate && date <= futureDate) {
                const dateKey = date.toISOString().split('T')[0];
                const shift = scheduleData[employeeName]?.[dateKey];
                if (shift && shift.toUpperCase() === 'PTO') {
                    upcoming.push(date.toLocaleDateString());
                }
            }
        });

        return upcoming;
    }

    function emailIndividualPTOReport(employeeId, reportMonth) {
        const employee = employees.find(emp => emp.id === employeeId);
        if (!employee) {
            alert('Employee not found');
            return;
        }

        const ptoBalance = employeePTOBalances[employeeId] || {
            totalPTODays: employee.type === "FT" ? 20 : 15,
            usedPTODays: 0,
            pendingPTODays: 0
        };

        const remainingPTO = ptoBalance.totalPTODays - ptoBalance.usedPTODays;
        const upcomingPTO = getUpcomingPTO(employee.name);

        const emailContent = `
Dear ${employee.name.split(',')[1] || employee.name},

Here is your monthly PTO balance summary for ${new Date(reportMonth).toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}:

üìä PTO BALANCE SUMMARY:
‚Ä¢ Annual PTO Allocation: ${ptoBalance.totalPTODays} days
‚Ä¢ Used This Year: ${ptoBalance.usedPTODays} days
‚Ä¢ Remaining Balance: ${remainingPTO} days
‚Ä¢ Pending Requests: ${ptoBalance.pendingPTODays} days

üìÖ UPCOMING SCHEDULED PTO (Next 30 Days):
${upcomingPTO.length > 0 ? upcomingPTO.map(date => `‚Ä¢ ${date}`).join('\n') : '‚Ä¢ None scheduled'}

${remainingPTO < 5 ? '\n‚ö†Ô∏è REMINDER: You have less than 5 PTO days remaining. Please plan accordingly.\n' : ''}

If you have any questions about your PTO balance or need to request time off, please contact your manager.

Best regards,
HR Department
        `;

        // Create email modal or copy to clipboard
        navigator.clipboard.writeText(emailContent).then(() => {
            alert(`PTO report for ${employee.name} has been copied to clipboard. You can now paste it into your email client.`);
        }).catch(() => {
            // Fallback - show in alert
            prompt('Copy this PTO report to send via email:', emailContent);
        });
    }

    function emailAllPTOReports() {
        const reportMonth = document.getElementById('reportMonth').value;
        if (!reportMonth) {
            alert('Please select a month for the report');
            return;
        }

        const eligibleEmployees = employees.filter(emp => 
            emp.id && !emp.name.startsWith('OPEN SHIFTS') && emp.type !== 'Bank'
        );

        let allReports = `MONTHLY PTO BALANCE REPORTS FOR ${new Date(reportMonth).toLocaleDateString('en-US', {month: 'long', year: 'numeric'}).toUpperCase()}\n`;
        allReports += '='.repeat(80) + '\n\n';

        eligibleEmployees.forEach(employee => {
            const ptoBalance = employeePTOBalances[employee.id] || {
                totalPTODays: employee.type === "FT" ? 20 : 15,
                usedPTODays: 0,
                pendingPTODays: 0
            };

            const remainingPTO = ptoBalance.totalPTODays - ptoBalance.usedPTODays;
            const upcomingPTO = getUpcomingPTO(employee.name);

            allReports += `${employee.name}\n`;
            allReports += '-'.repeat(employee.name.length) + '\n';
            allReports += `Annual Allocation: ${ptoBalance.totalPTODays} days | Used: ${ptoBalance.usedPTODays} days | Remaining: ${remainingPTO} days\n`;
            allReports += `Pending: ${ptoBalance.pendingPTODays} days | Hire Date: ${new Date(employee.hireDate || '2024-01-01').toLocaleDateString()}\n`;
            allReports += `Upcoming PTO: ${upcomingPTO.length > 0 ? upcomingPTO.join(', ') : 'None'}\n\n`;
        });

        // Copy all reports to clipboard
        navigator.clipboard.writeText(allReports).then(() => {
            alert('All PTO reports have been copied to clipboard. You can now paste them into your email client for bulk distribution.');
        }).catch(() => {
            // Fallback - show in prompt
            prompt('Copy these PTO reports for bulk email distribution:', allReports);
        });
    }

    // ===== ENHANCED PTO ACCRUAL SYSTEM =====
    
    function updatePTOAccruals() {
        // This function should be called monthly to update PTO accruals
        const currentDate = new Date();
        
        employees.forEach(employee => {
            if (!employee.id || employee.name.startsWith('OPEN SHIFTS') || employee.type === 'Bank') {
                return;
            }

            const hireDate = new Date(employee.hireDate || '2024-01-01');
            const monthsSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24 * 30));
            
            // Initialize balance if it doesn't exist
            if (!employeePTOBalances[employee.id]) {
                employeePTOBalances[employee.id] = {
                    employeeName: employee.name,
                    hireDate: employee.hireDate || "2024-01-01",
                    totalPTODays: employee.type === "FT" ? 20 : 15,
                    usedPTODays: 0,
                    pendingPTODays: 0,
                    lastAccrualDate: hireDate.toISOString().split('T')[0]
                };
            }

            const balance = employeePTOBalances[employee.id];
            const lastAccrual = new Date(balance.lastAccrualDate || hireDate);
            
            // Check if it's time for a new accrual (monthly)
            if (monthsSinceHire >= 3) { // No accrual first 90 days
                const monthsSinceLastAccrual = Math.floor((currentDate - lastAccrual) / (1000 * 60 * 60 * 24 * 30));
                
                if (monthsSinceLastAccrual >= 1) {
                    const yearlyAllocation = getYearlyPTOAllocation(employee, monthsSinceHire);
                    const monthlyAccrual = yearlyAllocation / 12;
                    
                    // Add accrued PTO (max out at yearly allocation)
                    const currentTotal = balance.totalPTODays || (employee.type === "FT" ? 20 : 15);
                    const newTotal = Math.min(currentTotal + monthlyAccrual, yearlyAllocation);
                    
                    balance.totalPTODays = Math.floor(newTotal);
                    balance.lastAccrualDate = currentDate.toISOString().split('T')[0];
                    
                    console.log(`Updated PTO accrual for ${employee.name}: +${monthlyAccrual.toFixed(1)} days`);
                }
            }
        });
        
        saveState();
    }

    function getYearlyPTOAllocation(employee, monthsSinceHire) {
        // Enhanced accrual rates based on seniority
        const baseAllocation = employee.type === "FT" ? 20 : 15;
        
        // Seniority bonuses
        if (monthsSinceHire >= 60) { // 5+ years
            return baseAllocation + 5; // Extra week
        } else if (monthsSinceHire >= 36) { // 3+ years
            return baseAllocation + 3; // Extra few days
        } else if (monthsSinceHire >= 12) { // 1+ year
            return baseAllocation + 1; // Small bonus
        }
        
        return baseAllocation;
    }

    function checkPTOEligibilityEnhanced(employeeId) {
        const employee = employees.find(emp => emp.id === employeeId);
        if (!employee || !employee.hireDate) {
            return { eligible: false, reason: "No hire date found" };
        }
        
        const currentDate = new Date();
        const hireDate = new Date(employee.hireDate);
        const daysSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24));
        
        // 90-day waiting period
        if (daysSinceHire < 90) {
            const remainingDays = 90 - daysSinceHire;
            return { 
                eligible: false, 
                reason: `Must wait ${remainingDays} more days before PTO eligibility (90-day waiting period)` 
            };
        }
        
        // Check if employee has sufficient PTO balance
        const balance = employeePTOBalances[employeeId];
        if (!balance || balance.totalPTODays - balance.usedPTODays <= 0) {
            return { 
                eligible: false, 
                reason: "Insufficient PTO balance available" 
            };
        }
        
        return { eligible: true, availableDays: balance.totalPTODays - balance.usedPTODays };
    }

    // Auto-run PTO accrual update on page load (for demo purposes)
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            updatePTOAccruals();
        }, 1000);
    });

    // ===== PTO CONFLICT DETECTION SYSTEM =====
    
    function checkPTOConflicts(employeeName, startDate, endDate) {
        const conflicts = [];
        const requestStart = new Date(startDate);
        const requestEnd = new Date(endDate);
        
        // Check against existing PTO requests
        Object.values(ptoRequests).forEach(request => {
            if (request.employeeName === employeeName && 
                (request.status === 'approved' || request.status === 'pending')) {
                
                const existingStart = new Date(request.startDate);
                const existingEnd = new Date(request.endDate);
                
                // Check for overlap
                if (requestStart <= existingEnd && requestEnd >= existingStart) {
                    conflicts.push({
                        type: 'employee_overlap',
                        message: `Overlaps with existing ${request.status} PTO request (${request.startDate} to ${request.endDate})`,
                        request: request
                    });
                }
            }
        });
        
        // Check against scheduled PTO in the schedule grid
        const dateRange = getDateRange(requestStart, requestEnd);
        dateRange.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[employeeName]?.[dateKey];
            if (shift && shift.toUpperCase() === 'PTO') {
                conflicts.push({
                    type: 'schedule_conflict',
                    message: `PTO already scheduled on ${date.toLocaleDateString()}`,
                    date: dateKey
                });
            }
        });
        
        // Check minimum staffing levels for those dates
        const staffingConflicts = checkMinimumStaffing(dateRange, employeeName);
        conflicts.push(...staffingConflicts);
        
        return conflicts;
    }
    
    function getDateRange(startDate, endDate) {
        const dates = [];
        const current = new Date(startDate);
        const end = new Date(endDate);
        
        while (current <= end) {
            dates.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }
    
    function checkMinimumStaffing(dateRange, requestingEmployee) {
        const conflicts = [];
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
        
        dateRange.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0;
            
            // Count available staff for this date
            employees.forEach(emp => {
                if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
                if (emp.name === requestingEmployee) return; // Exclude the requesting employee
                
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift && shift.toUpperCase() !== 'PTO' && shift.trim() !== '') {
                    staffCount++;
                }
            });
            
            if (staffCount < minStaff) {
                conflicts.push({
                    type: 'staffing_shortage',
                    message: `Minimum staffing violation on ${date.toLocaleDateString()} (${staffCount}/${minStaff} available)`,
                    date: dateKey,
                    currentStaff: staffCount,
                    requiredStaff: minStaff
                });
            }
        });
        
        return conflicts;
    }
    
    // Enhanced PTO request validation
    function validatePTORequest(employeeId, startDate, endDate, requestType) {
        const employee = employees.find(emp => emp.id === employeeId);
        if (!employee) {
            return { valid: false, errors: ['Employee not found'] };
        }
        
        const errors = [];
        const warnings = [];
        
        // Check eligibility
        const eligibility = checkPTOEligibilityEnhanced(employeeId);
        if (!eligibility.eligible) {
            errors.push(eligibility.reason);
        }
        
        // Check date validity
        const start = new Date(startDate);
        const end = new Date(endDate);
        const today = new Date();
        
        if (start > end) {
            errors.push('Start date must be before end date');
        }
        
        if (start < today && requestType !== 'emergency') {
            errors.push('Cannot request PTO for past dates (except emergency leave)');
        }
        
        // Calculate days requested
        const daysRequested = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        const balance = employeePTOBalances[employeeId];
        const availableDays = balance ? balance.totalPTODays - balance.usedPTODays : 0;
        
        if (daysRequested > availableDays) {
            errors.push(`Insufficient PTO balance. Requested: ${daysRequested} days, Available: ${availableDays} days`);
        }
        
        // Check for conflicts
        const conflicts = checkPTOConflicts(employee.name, startDate, endDate);
        
        conflicts.forEach(conflict => {
            if (conflict.type === 'employee_overlap' || conflict.type === 'schedule_conflict') {
                errors.push(conflict.message);
            } else if (conflict.type === 'staffing_shortage') {
                warnings.push(conflict.message);
            }
        });
        
        // Advanced notice requirements
        const advanceNotice = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
        if (requestType === 'vacation' && advanceNotice < 14) {
            warnings.push('Vacation requests should be submitted at least 14 days in advance');
        }
        
        return {
            valid: errors.length === 0,
            errors: errors,
            warnings: warnings,
            conflicts: conflicts,
            daysRequested: daysRequested,
            availableDays: availableDays
        };
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>