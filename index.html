<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="test scheduler">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0d6efd">
    <title>test scheduler - Employee Scheduling System</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icon-192.svg">
    <style>
        /* Base styles */
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f8fafc; 
            padding: 0; 
            margin: 0;
            line-height: 1.5;
            color: #334155;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container { 
            max-width: 1600px; 
            margin: auto; 
            background: white; 
            min-height: 100vh;
        }
        
        /* Typography hierarchy */
        h1 { 
            color: #0f172a; 
            margin: 0; 
            font-size: 2rem; 
            font-weight: 700; 
            letter-spacing: -0.025em;
        }
        h2 { 
            color: #1e293b; 
            margin: 0 0 1rem 0; 
            font-size: 1.5rem; 
            font-weight: 600; 
        }
        h3 { 
            color: #475569; 
            margin: 0 0 0.75rem 0; 
            font-size: 1.125rem; 
            font-weight: 600; 
        }
        
        /* Dashboard header */
        .dashboard-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 2rem 2rem 1rem 2rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .dashboard-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .dashboard-title h1 {
            color: white;
            margin: 0;
        }
        .dashboard-subtitle {
            color: #cbd5e1;
            font-size: 1rem;
            margin: 0;
        }
        
        /* Key metrics dashboard */
        .metrics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
        }
        .metric-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }
        .metric-label {
            font-size: 0.875rem;
            color: #cbd5e1;
            margin: 0.25rem 0 0 0;
        }
        .metric-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        .metric-change.positive { color: #86efac; }
        .metric-change.negative { color: #fca5a5; }
        .metric-change.neutral { color: #cbd5e1; }
        
        /* Main dashboard layout */
        .dashboard-main {
            padding: 2rem;
        }
        
        /* Schedule section - primary focus */
        .schedule-section {
            background: white;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .schedule-header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .schedule-content {
            padding: 1.5rem 2rem;
        }
        
        /* Action cards grid */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Card design */
        .action-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }
        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .card-icon {
            font-size: 1.5rem;
            margin-right: 0.75rem;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }
        .card-description {
            color: #64748b;
            font-size: 0.875rem;
            margin: 0 0 1.5rem 0;
            line-height: 1.5;
        }
        .card-stats {
            background: #f1f5f9;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }
        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin: 0;
        }
        
        /* Button styles for cards */
        .btn { 
            font-size: 0.875rem; 
            padding: 0.625rem 1rem; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            margin: 0.25rem 0.5rem 0.25rem 0; 
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            text-decoration: none;
            font-weight: 500;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:hover, .btn:focus { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        .btn:active { transform: translateY(0); }
        .btn:disabled { 
            background-color: #e2e8f0; 
            color: #94a3b8;
            cursor: not-allowed; 
            transform: none; 
        }
        .btn-primary { 
            background-color: #3b82f6; 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: #2563eb; 
        }
        .btn-danger { 
            background-color: #ef4444; 
            color: white; 
        }
        .btn-danger:hover { 
            background-color: #dc2626; 
        }
        .btn-secondary { 
            background-color: #64748b; 
            color: white; 
        }
        .btn-secondary:hover { 
            background-color: #475569; 
        }
        .btn-success { 
            background-color: #10b981; 
            color: white; 
        }
        .btn-success:hover { 
            background-color: #059669; 
        }
        .btn-warning { 
            background-color: #f59e0b; 
            color: white; 
        }
        .btn-warning:hover { 
            background-color: #d97706; 
        }
        .btn-outline {
            background-color: transparent;
            border: 1px solid #e2e8f0;
            color: #475569;
        }
        .btn-outline:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }
        
        /* Primary action button */
        .btn-primary-large {
            font-size: 1rem;
            padding: 0.875rem 1.5rem;
            font-weight: 600;
        }
        
        /* Quick action buttons */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        /* Schedule table */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.75rem; 
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        thead th { 
            position: sticky; 
            top: 0; 
            background: #f8fafc; 
            z-index: 10; 
            border-bottom: 1px solid #e2e8f0;
            padding: 0.75rem 0.5rem;
            font-weight: 600;
            color: #475569;
            text-align: center;
        }
        th, td { 
            border-right: 1px solid #f1f5f9; 
            padding: 0.5rem; 
            text-align: center; 
            min-width: 60px; 
        }
        .employee-name { 
            text-align: left; 
            font-weight: 600; 
            position: sticky; 
            left: 0; 
            background-color: #f8fafc; 
            z-index: 5; 
            width: 140px; 
            min-width: 140px; 
            font-size: 0.75rem;
            border-right: 1px solid #e2e8f0;
        }
        .open-shift-row { 
            background-color: #fef3c7; 
            font-weight: 600; 
        }
        .open-shift-row .employee-name {
            background-color: #fbbf24;
            color: #92400e;
        }
        td[contenteditable="true"]:hover { 
            background-color: #f1f5f9; 
            cursor: pointer; 
        }
        td[contenteditable="true"]:focus { 
            background-color: #dbeafe; 
            outline: 2px solid #3b82f6; 
            outline-offset: -2px;
        }
        
        /* Mobile-friendly form inputs */
        input, select, textarea { 
            width: 100%; 
            box-sizing: border-box; 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid #ced4da; 
            margin-bottom: 10px; 
            font-size: 16px; /* Prevents zoom on iOS */
            -webkit-appearance: none;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }
        
        /* Mobile navigation */
        .mobile-nav { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: #0d6efd; 
            color: white; 
            padding: 15px; 
            z-index: 1002; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hamburger {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        .mobile-menu {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }
        .mobile-menu.show { display: block; }
        .mobile-menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mobile-menu-item:hover { background-color: #f8f9fa; }
        
        /* PWA Install Banner */
        .pwa-install-banner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: #0d6efd;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1003;
        }
        .pwa-install-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        .pwa-install-text {
            flex: 1;
            font-size: 14px;
        }
        .pwa-install-buttons {
            display: flex;
            gap: 10px;
        }
        .pwa-install-btn {
            background: white;
            color: #0d6efd;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        .pwa-dismiss-btn {
            background: none;
            color: white;
            border: 1px solid white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        /* Bottom navigation for mobile */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dee2e6;
            padding: 10px 0;
            z-index: 1001;
        }
        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #6c757d;
            font-size: 12px;
            padding: 5px;
            min-width: 60px;
        }
        .bottom-nav-item.active {
            color: #0d6efd;
        }
        .bottom-nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        /* Modal responsive improvements */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { 
            background-color: #fefefe; 
            margin: 5% auto; 
            padding: 20px; 
            border: 1px solid #888; 
            width: 95%; 
            max-width: 900px; 
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: #000; text-decoration: none; }
        
        /* Touch gesture support */
        .swipeable {
            touch-action: pan-y;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .schedule-swipe-container {
            overflow-x: hidden;
            position: relative;
        }
        
        .schedule-week {
            transition: transform 0.3s ease-out;
        }
        
        /* Camera integration styles */
        td.pto-cell { background-color: #fff3cd !important; }
        td.pto-approved { background-color: #d4edda !important; }
        td.pto-pending { background-color: #f8d7da !important; }
        td.weekend { background-color: #f1f1f1; }
        .shift-assigned { background-color: #d4edda !important; }
        .shift-overtime { background-color: #f8d7da !important; }
        .shift-undertime { background-color: #fff3cd !important; }
        .holiday { background-color: #e2e3e5 !important; border: 2px solid #6c757d !important; }
        .employee-stats { font-size: 9px; color: #666; display: block; }
        .submenu { display: none; position: absolute; left: 100%; top: 0; background: white; border: 1px solid #ccc; min-width: 150px; z-index: 10001; }
        .submenu div { padding: 12px 15px; cursor: pointer; }
        .submenu div:hover { background-color: #0d6efd; color: white; }
        .bulk-select { background-color: #e3f2fd !important; }
        .conflict-cell { background-color: #f8d7da !important; border: 2px solid #dc3545 !important; }
        #contextMenu { 
            display: none; 
            position: absolute; 
            background-color: white; 
            border: 1px solid #ccc; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            padding: 5px 0; 
            border-radius: 5px; 
            z-index: 10000;
            min-width: 180px;
        }
        #contextMenu div { padding: 12px 15px; cursor: pointer; }
        #contextMenu div:hover { background-color: #0d6efd; color: white; }
        .note-indicator { position: absolute; top: 2px; right: 2px; width: 0; height: 0; border-left: 6px solid transparent; border-top: 6px solid #0d6efd; }
        .dashboard-under { background-color: #cfe2ff; } 
        .dashboard-over { background-color: #f8d7da; } 
        .dashboard-low-staff { background-color: #fff3cd; }
        
        /* Employee portal mobile improvements */
        #employee-portal h1 { text-align: center; } 
        #employee-portal .schedule-list { list-style-type: none; padding: 0; } 
        #employee-portal .schedule-list li { 
            background: #fff; 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 8px; 
            border-radius: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        } 
        #employee-portal .schedule-list .day-name { font-weight: bold; }
        .pto-request-item { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .pto-status-pending { border-left: 4px solid #ffc107; }
        .pto-status-approved { border-left: 4px solid #28a745; }
        .pto-status-denied { border-left: 4px solid #dc3545; }
        .pto-conflict { background-color: #f8d7da !important; border: 2px solid #dc3545 !important; }
        .pto-eligible { color: #28a745; font-weight: bold; }
        .pto-ineligible { color: #dc3545; font-weight: bold; }
        .pto-calendar-view { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0; }
        .pto-calendar-day { padding: 8px; border: 1px solid #ddd; text-align: center; min-height: 40px; }
        .pto-calendar-approved { background-color: #d4edda; }
        .pto-calendar-pending { background-color: #fff3cd; }

        /* Enhanced Employee Portal Styles */
        .enhanced-portal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .view-controls {
            display: flex;
            gap: 0.5rem;
        }
        .view-controls button {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-controls button:hover {
            background: #f3f4f6;
        }
        .view-controls button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .export-btn {
            background: #059669 !important;
            color: white !important;
            border-color: #059669 !important;
        }
        .export-btn:hover {
            background: #047857 !important;
        }

        /* List View Styles */
        .list-view .month-section {
            margin-bottom: 2rem;
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .month-header {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            margin: 0;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }
        .month-content {
            padding: 1rem;
        }
        .events-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .event-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid #e5e7eb;
        }
        .event-shift {
            background: #ecfdf5;
            border-left-color: #10b981;
        }
        .event-pto {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }
        .event-open {
            background: #e0e7ff;
            border-left-color: #6366f1;
        }
        .event-date {
            min-width: 80px;
            text-align: center;
            margin-right: 1rem;
        }
        .day-name {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
        }
        .date-str {
            font-weight: 600;
            color: #374151;
        }
        .event-content {
            flex: 1;
            font-weight: 500;
        }
        .no-events {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
            padding: 2rem;
        }

        /* Calendar View Styles */
        .calendar-view .calendar-month {
            margin-bottom: 2rem;
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-header {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
        }
        .calendar-header:last-child {
            border-right: none;
        }
        .calendar-day {
            min-height: 100px;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            position: relative;
        }
        .calendar-day:last-child {
            border-right: none;
        }
        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }
        .day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .day-event {
            font-size: 0.75rem;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            margin-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .shift-event {
            background: #dcfce7;
            color: #166534;
        }
        .pto-event {
            background: #fef3c7;
            color: #92400e;
        }
        .open-event {
            background: #dbeafe;
            color: #1e40af;
        }
        .calendar-day.has-shift {
            background: #f0fdf4;
        }
        .calendar-day.has-pto {
            background: #fffbeb;
        }
        .calendar-day.has-open {
            background: #eff6ff;
        }
        .pto-calendar-conflict { background-color: #f8d7da; }
        
        /* Responsive breakpoints */
        @media (min-width: 768px) {
            .dashboard-header { padding: 3rem 3rem 2rem 3rem; }
            .dashboard-main { padding: 3rem; }
            .action-cards { 
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
                gap: 2rem; 
            }
            .metrics-dashboard { 
                grid-template-columns: repeat(4, 1fr); 
            }
        }
        
        @media (max-width: 767px) {
            .mobile-nav { display: block; }
            .bottom-nav { display: block; }
            .container { 
                margin-top: 60px; 
                margin-bottom: 70px; 
                border-radius: 0;
                min-height: calc(100vh - 130px);
            }
            .dashboard-header { 
                padding: 1.5rem 1rem 1rem 1rem; 
            }
            .dashboard-main { 
                padding: 1rem; 
            }
            .action-cards { 
                grid-template-columns: 1fr; 
                gap: 1rem; 
            }
            .metrics-dashboard { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 0.75rem; 
            }
            .metric-card { 
                padding: 0.75rem; 
            }
            .metric-value { 
                font-size: 1.5rem; 
            }
            .action-card { 
                padding: 1rem; 
            }
            .schedule-header, .schedule-content { 
                padding: 1rem; 
            }
            .modal-content { 
                width: 98%; 
                margin: 2% auto; 
                padding: 15px;
                border-radius: 0;
                max-height: 96vh;
            }
            
            /* Hide desktop-specific elements on mobile */
            .desktop-only { display: none !important; }
            
            /* Make tables horizontally scrollable on mobile */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
            }
        }
        
        @media print {
            body { background-color: white; padding: 0; margin: 0; }
            .container, .controls, .dashboard, hr, .modal, #contextMenu, .mobile-nav, .bottom-nav, .pwa-install-banner { display: none; }
            #schedule-table { display: table !important; width: 100%; }
            thead th, .employee-name { position: static; }
            td, th { font-size: 9pt; padding: 4px; color: black !important; }
            .open-shift-row { background-color: #fcf8e3 !important; }
            .pto-cell { background-color: #faf2cc !important; }
            .weekend { background-color: #f1f1f1 !important; }
            .conflict-cell { border: 1px solid black !important; background-color: #dddddd !important; }
            @page { size: landscape; }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading-spinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 0.5rem; text-align: center; max-width: 300px;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
            <div class="loading-message" style="font-weight: 600; margin-bottom: 0.5rem;">Loading...</div>
            <div style="font-size: 0.875rem; color: #6b7280;">Please wait while we process your request</div>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 0.5rem 1rem; font-size: 0.875rem; color: #6b7280; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span id="connection-status">üü¢ Connected</span>
        </div>
        <div>
            <span id="last-saved-indicator">Ready</span>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <div class="mobile-nav-header">
            <button class="hamburger" onclick="toggleMobileMenu()">‚ò∞</button>
            <h1 style="margin: 0; font-size: 18px;">test scheduler</h1>
            <div style="width: 32px;"></div> <!-- Spacer for centering -->
        </div>
        <div class="mobile-menu" id="mobile-menu">
            <div class="mobile-menu-item" onclick="showManagerView()">
                <span>‚öôÔ∏è</span> Manager Dashboard
            </div>
            <div class="mobile-menu-item" onclick="showEmployeePortal()">
                <span>üë§</span> Employee Portal
            </div>
            <div class="mobile-menu-item" onclick="openTeamDirectory()">
                <span>üë•</span> Team Directory
            </div>
            <div class="mobile-menu-item" onclick="openAnnouncementsModal()">
                <span>üì¢</span> Announcements
            </div>
            <div class="mobile-menu-item" onclick="openAuditLogsModal()">
                <span>üìã</span> Audit Logs
            </div>
            <div class="mobile-menu-item" onclick="requestNotificationPermission()">
                <span>üîî</span> Enable Notifications
            </div>
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div class="pwa-install-banner" id="pwa-install-banner">
        <div class="pwa-install-content">
            <div class="pwa-install-text">
                <strong>Install test scheduler</strong><br>
                Get the app experience with offline access and notifications.
            </div>
            <div class="pwa-install-buttons">
                <button class="pwa-install-btn" onclick="installPWA()">Install</button>
                <button class="pwa-dismiss-btn" onclick="dismissPWABanner()">Not Now</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation for Mobile -->
    <div class="bottom-nav">
        <div class="bottom-nav-items">
            <a href="#" class="bottom-nav-item active" onclick="showManagerView(); setActiveBottomNav(this)">
                <div class="bottom-nav-icon">‚öôÔ∏è</div>
                <div>Manager</div>
            </a>
            <a href="#" class="bottom-nav-item" onclick="showEmployeePortal(); setActiveBottomNav(this)">
                <div class="bottom-nav-icon">üë§</div>
                <div>Portal</div>
            </a>
            <a href="#" class="bottom-nav-item" onclick="openTeamDirectory(); setActiveBottomNav(this)">
                <div class="bottom-nav-icon">üë•</div>
                <div>Team</div>
            </a>
            <a href="#" class="bottom-nav-item" onclick="openAnnouncementsModal(); setActiveBottomNav(this)">
                <div class="bottom-nav-icon">üì¢</div>
                <div>News</div>
            </a>
        </div>
    </div>

    <div id="manager-view"></div>
    
<div id="employee-portal" style="display:none;">
    <div class="container">
        <h1 id="portal-title" style="position: relative; text-align: center;">
            Your Schedule
            <span id="notification-bell" style="position: absolute; right: 10px; top: 5px; font-size: 24px; cursor: pointer;">üîî</span>
        </h1>
        <div id="notification-popup" style="display: none; position: absolute; right: 20px; top: 80px; background: white; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 5px; width: 300px; z-index: 1001;"></div>
        <h3 id="portal-employee-name" style="text-align:center; margin-top: -10px;"></h3>
        
        <!-- Quick Actions Section -->
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn btn-primary" onclick="openTeamDirectory()" style="margin: 5px;">üë• Team Directory</button>
            <button class="btn btn-secondary" onclick="openAnnouncementsModal()" style="margin: 5px;">üì¢ Announcements</button>
            <button class="btn btn-success" onclick="toggleQuickScheduleWidget()" style="margin: 5px;">üìÖ Quick Schedule</button>
            <div style="margin-top: 10px;">
                <button class="btn btn-info" onclick="openShiftSwapModal(getCurrentEmployeeId())" style="margin: 5px;">üîÑ Request Shift Swap</button>
                <button class="btn btn-warning" onclick="openShiftBiddingModal(getCurrentEmployeeId())" style="margin: 5px;">üéØ Bid on Open Shifts</button>
                <button class="btn btn-secondary" onclick="openCalendarExportModal()" style="margin: 5px;">üìÖ Export Calendar</button>
            </div>
        </div>
        
        <!-- Enhanced Tabs Navigation -->
        <div style="border-bottom: 2px solid #e2e8f0; margin: 20px 0;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="portal-tab active" onclick="showPortalTab('schedule')" data-tab="schedule" style="padding: 10px 15px; border: none; border-bottom: 3px solid #0f172a; background: #f8fafc; cursor: pointer; font-weight: 600;">üìÖ My Schedule</button>
                <button class="portal-tab" onclick="showPortalTab('history')" data-tab="history" style="padding: 10px 15px; border: none; border-bottom: 3px solid transparent; background: #f8fafc; cursor: pointer;">üìã Shift History</button>
                <button class="portal-tab" onclick="showPortalTab('requests')" data-tab="requests" style="padding: 10px 15px; border: none; border-bottom: 3px solid transparent; background: #f8fafc; cursor: pointer;">üìù My Requests</button>
                <button class="portal-tab" onclick="showPortalTab('notifications')" data-tab="notifications" style="padding: 10px 15px; border: none; border-bottom: 3px solid transparent; background: #f8fafc; cursor: pointer;">üîî Notifications</button>
            </div>
        </div>
        
        <!-- Tab Content Areas -->
        <div id="portal-tab-schedule" class="portal-tab-content" style="display: block;">
            <div id="portal-schedule-view"></div>
        </div>
        
        <div id="portal-tab-history" class="portal-tab-content" style="display: none;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3>üìã Shift History</h3>
                <div id="shift-history-filters" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <label>Filter by:</label>
                        <select id="history-filter-type" onchange="filterShiftHistory()" style="padding: 5px;">
                            <option value="all">All Activities</option>
                            <option value="shifts">Regular Shifts</option>
                            <option value="pto">PTO Days</option>
                            <option value="swaps">Shift Swaps</option>
                            <option value="bids">Shift Bids</option>
                        </select>
                        <input type="date" id="history-start-date" onchange="filterShiftHistory()" style="padding: 5px;">
                        <span>to</span>
                        <input type="date" id="history-end-date" onchange="filterShiftHistory()" style="padding: 5px;">
                        <button class="btn btn-sm btn-secondary" onclick="exportShiftHistory()">üìä Export</button>
                    </div>
                </div>
                <div id="shift-history-content">Loading shift history...</div>
            </div>
        </div>
        
        <div id="portal-tab-requests" class="portal-tab-content" style="display: none;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3>üìù My Requests & Applications</h3>
                
                <!-- Swap Requests Section -->
                <div style="margin-bottom: 25px;">
                    <h4>üîÑ Shift Swap Requests</h4>
                    <div id="my-swap-requests" style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e2e8f0;">
                        Loading swap requests...
                    </div>
                </div>
                
                <!-- Bid Requests Section -->
                <div style="margin-bottom: 25px;">
                    <h4>üéØ Shift Bid Applications</h4>
                    <div id="my-bid-requests" style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e2e8f0;">
                        Loading bid applications...
                    </div>
                </div>
                
                <!-- Feedback Submissions -->
                <div style="margin-bottom: 25px;">
                    <h4>üí¨ Feedback & Issue Reports</h4>
                    <div id="my-feedback-requests" style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e2e8f0;">
                        Loading feedback submissions...
                    </div>
                </div>
            </div>
        </div>
        
        <div id="portal-tab-notifications" class="portal-tab-content" style="display: none;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3>üîî Notifications & Alerts</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <button class="btn btn-sm btn-primary" onclick="markAllNotificationsRead()">üìñ Mark All Read</button>
                        <button class="btn btn-sm btn-secondary" onclick="clearOldNotifications()">üóëÔ∏è Clear Old</button>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-info" onclick="openNotificationPreferences()">‚öôÔ∏è Preferences</button>
                    </div>
                </div>
                <div id="notifications-content" style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e2e8f0; max-height: 400px; overflow-y: auto;">
                    Loading notifications...
                </div>
            </div>
        </div>
        
        <div id="portal-tab-pto" class="portal-tab-content" style="display: none;">
            <!-- PTO Request Section -->
            <div id="portal-pto-section">
                <h2>Request Time Off</h2>
                
                <!-- Smart PTO Planning Assistant -->
                <div id="smart-pto-assistant" style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h4>ü§ñ Smart PTO Assistant</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <button class="btn btn-info" onclick="suggestBestPTODates()" style="font-size: 14px;">üìÖ Suggest Best Dates</button>
                        <button class="btn btn-secondary" onclick="showTeamPTOCalendar()" style="font-size: 14px;">üë• View Team Calendar</button>
                    </div>
                    <div id="pto-suggestions" style="display: none; background: #fff; padding: 10px; border-radius: 3px; margin-top: 10px;">
                        <!-- Smart suggestions will appear here -->
                    </div>
                    <div id="team-pto-preview" style="display: none; background: #fff; padding: 10px; border-radius: 3px; margin-top: 10px;">
                        <!-- Team PTO preview will appear here -->
                    </div>
                </div>
                
                <div id="pto-balance-display" style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h4>Your PTO Balance</h4>
                    <div id="pto-balance-details"></div>
                </div>
                <div id="pto-request-form" style="background: #f8f9fa; padding: 20px; border-radius: 5px; border: 1px solid #dee2e6;">
                    <h4>Submit New PTO Request</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label for="pto-start-date">Start Date:</label>
                            <input type="date" id="pto-start-date" onchange="updatePTOPreview()" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                        </div>
                        <div>
                            <label for="pto-end-date">End Date:</label>
                            <input type="date" id="pto-end-date" onchange="updatePTOPreview()" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                        </div>
                    </div>
                    
                    <!-- Real-time impact preview -->
                    <div id="pto-impact-preview" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
                        <!-- Impact preview will be shown here -->
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="pto-type">Reason/Type:</label>
                        <select id="pto-type" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                            <option value="vacation">Vacation</option>
                            <option value="sick">Sick Leave</option>
                            <option value="personal">Personal</option>
                            <option value="emergency">Emergency</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="pto-days-display">Days Requested:</label>
                        <input type="text" id="pto-days-display" readonly style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da; background: #e9ecef;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="pto-comments">Comments/Notes:</label>
                        <textarea id="pto-comments" rows="3" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="submitPTORequest()" style="width: 100%;">Submit PTO Request</button>
                </div>
                <div id="pto-request-history" style="margin-top: 20px;">
                    <h4>Your PTO Request History</h4>
                    <div id="pto-history-list"></div>
                </div>
            </div>
        </div>
        
        <!-- Clock In/Out Section -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6;">
            <h4>üïí Clock In/Out</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="clockIn()" style="flex: 1; min-width: 120px;">üü¢ Clock In</button>
                <button class="btn btn-danger" onclick="clockOut()" style="flex: 1; min-width: 120px;">üî¥ Clock Out</button>
                <button class="btn btn-secondary" onclick="viewTimesheet()" style="flex: 1; min-width: 120px;">üìä Timesheet</button>
            </div>
        </div>
        
        <!-- Quick Schedule Widget -->
        <div id="quick-schedule-widget" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6;">
            <h4>üìÖ Today's Schedule</h4>
            <div id="today-schedule-content">Loading...</div>
            <div style="margin-top: 10px;">
                <button class="btn btn-primary" onclick="openOneTapPTO()" style="margin-right: 10px;">üèñÔ∏è Quick PTO</button>
                <button class="btn btn-secondary" onclick="openShiftTrading()">üîÑ Trade Shift</button>
            </div>
        </div>
        
        <div id="portal-schedule-view"></div>
        <hr>
        <!-- PTO Request Section -->
        <div id="portal-pto-section">
            <h2>Request Time Off</h2>
            
            <!-- Smart PTO Planning Assistant -->
            <div id="smart-pto-assistant" style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <h4>ü§ñ Smart PTO Assistant</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <button class="btn btn-info" onclick="suggestBestPTODates()" style="font-size: 14px;">üìÖ Suggest Best Dates</button>
                    <button class="btn btn-secondary" onclick="showTeamPTOCalendar()" style="font-size: 14px;">üë• View Team Calendar</button>
                </div>
                <div id="pto-suggestions" style="display: none; background: #fff; padding: 10px; border-radius: 3px; margin-top: 10px;">
                    <!-- Smart suggestions will appear here -->
                </div>
                <div id="team-pto-preview" style="display: none; background: #fff; padding: 10px; border-radius: 3px; margin-top: 10px;">
                    <!-- Team PTO preview will appear here -->
                </div>
            </div>
            
            <div id="pto-balance-display" style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <h4>Your PTO Balance</h4>
                <div id="pto-balance-details"></div>
            </div>
            <div id="pto-request-form" style="background: #f8f9fa; padding: 20px; border-radius: 5px; border: 1px solid #dee2e6;">
                <h4>Submit New PTO Request</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label for="pto-start-date">Start Date:</label>
                        <input type="date" id="pto-start-date" onchange="updatePTOPreview()" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                    </div>
                    <div>
                        <label for="pto-end-date">End Date:</label>
                        <input type="date" id="pto-end-date" onchange="updatePTOPreview()" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                    </div>
                </div>
                
                <!-- Real-time impact preview -->
                <div id="pto-impact-preview" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
                    <!-- Impact preview will be shown here -->
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="pto-type">Reason/Type:</label>
                    <select id="pto-type" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                        <option value="vacation">Vacation</option>
                        <option value="sick">Sick Leave</option>
                        <option value="personal">Personal</option>
                        <option value="emergency">Emergency</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="pto-days-display">Days Requested:</label>
                    <input type="text" id="pto-days-display" readonly style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da; background: #e9ecef;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="pto-comments">Comments/Notes:</label>
                    <textarea id="pto-comments" rows="3" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ced4da;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitPTORequest()" style="width: 100%;">Submit PTO Request</button>
            </div>
            <div id="pto-request-history" style="margin-top: 20px;">
                <h4>Your PTO Request History</h4>
                <div id="pto-history-list"></div>
            </div>
        </div>
        <hr>
        <div id="portal-bids-view"></div>
    </div>
</div>

    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Manage Employees</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <h3 id="modal-title">Add New Employee</h3>
            <div class="controls" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                 <input id="empIndex" type="hidden"/>
                 <input id="empId" type="hidden"/>
                 <input id="newName" placeholder="Last, First" type="text"/>
                 <select id="newType"><option value="FT">Full Time (FT)</option><option value="PT">Part Time (PT)</option></select>
                 <input id="newShifts" placeholder="Regular Shifts (e.g., 10a-6:30p)" type="text"/>
                 <div>
                    <label for="newTargetHours" style="font-size:12px;display:block;">Target Hours/Month</label>
                    <input id="newTargetHours" type="number" value="0" min="0"/>
                 </div>
                 <input id="newAvailability" placeholder="Availability (e.g., Mon,Tue,Fri)" type="text" style="grid-column: 1 / span 2;"/>
		 <input id="newEmail" placeholder="employee@email.com" type="email" style="grid-column: 1 / span 2;"/>
                 <div style="grid-column: 1 / span 2; display: flex; align-items: center; gap: 10px;">
                    <input id="newContactOptIn" type="checkbox" style="width: auto; margin: 0;"/>
                    <label for="newContactOptIn" style="font-size: 14px; margin: 0;">Allow contact info sharing in Team Directory</label>
                 </div>
                 <div>
                    <label for="newHireDate" style="font-size:12px;display:block;">Hire Date*</label>
                    <input id="newHireDate" type="date" required/>
                 </div>
                 <div>
                    <label for="newMaxDays" style="font-size:12px;display:block;">Max Days/Week (0=no limit)</label>
                    <input id="newMaxDays" type="number" value="0" min="0" max="7"/>
                 </div>
            </div>
            <button class="btn btn-primary" id="saveEmpBtn" onclick="saveEmployee()">üíæ Save Employee</button>
            <button class="btn btn-secondary" onclick="clearEmployeeForm()">Clear Form</button>
            <hr>
            <h3>Current Roster</h3>
            <div id="employee-list-container" style="max-height: 300px; overflow-y: auto;">
                <table id="employee-list-table"></table>
            </div>
        </div>
    </div>
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Add/Edit Note</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <textarea id="noteText" rows="4" style="width: 100%;"></textarea>
            <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
        </div>
    </div>
    <div id="bulkPTOModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Bulk PTO Assignment</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <label for="ptoEmployee">Select Employee:</label>
            <select id="ptoEmployee"></select>
            <label for="ptoStartDate">Start Date:</label>
            <input id="ptoStartDate" type="date"/>
            <label for="ptoEndDate">End Date:</label>
            <input id="ptoEndDate" type="date"/>
            <button class="btn btn-primary" onclick="applyBulkPTO()">Apply PTO</button>
        </div>
    </div>
    <div id="importExportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üìä Import/Export Data</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="text-align: center; padding: 20px; border: 2px solid #0d6efd; border-radius: 8px; background: #f8f9fa;">
                    <h4 style="margin-top: 0; color: #0d6efd;">üì• Import Data</h4>
                    <p style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">Restore schedule data from a backup file</p>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('importFileInput').click()" style="width: 100%;">
                        üì• Select Backup File
                    </button>
                </div>
                <div style="text-align: center; padding: 20px; border: 2px solid #198754; border-radius: 8px; background: #f8f9fa;">
                    <h4 style="margin-top: 0; color: #198754;">üì§ Export Data</h4>
                    <p style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">Download a backup of your current schedule</p>
                    <button class="btn btn-success" onclick="exportJSON()" style="width: 100%;">
                        üì§ Download Backup
                    </button>
                </div>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
                <h5 style="margin-top: 0; color: #856404;">üí° Tips:</h5>
                <ul style="margin: 0; padding-left: 20px; color: #856404; font-size: 14px;">
                    <li>Export your data regularly to create backups</li>
                    <li>Import files must be valid JSON backup files</li>
                    <li>Importing will replace all current data</li>
                </ul>
            </div>
        </div>
    </div>
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Email Schedule</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <label for="emailEmployee">Select Employee:</label>
            <select id="emailEmployee"></select>
            <label for="emailAddress">Email Address:</label>
            <input id="emailAddress" type="email" placeholder="employee@company.com"/>
            <button class="btn btn-primary" onclick="generateEmail()">Generate Email</button>
            <div id="emailPreview" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
                <h4>Email Preview:</h4>
                <div id="emailContent"></div>
                <button class="btn btn-success" onclick="sendEmail()">Send Email</button>
            </div>
        </div>
    </div>
    <div id="excelImportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Import Schedule from Excel</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <p>Please select an Excel (.xlsx) or CSV (.csv) file with the correct format:</p>
            <ul style="margin-top: 0; padding-left: 20px;">
                <li><b>Column A:</b> Employee names, starting from row 4.</li>
                <li><b>Row 2:</b> Full dates for the schedule (e.g., 8/1/2025, 8/2/2025...).</li>
            </ul>
            <input type="file" id="excel-file-input" accept=".xlsx, .csv" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%;"/>
            <button class="btn btn-primary" onclick="importFromExcel()" style="margin-top: 15px;">Process Selected File</button>
        </div>
    </div>
<div id="notificationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h2>Notify Employee of Change?</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <p id="notification-text"></p>
            <div style="text-align: right;">
                <button class="btn btn-secondary" onclick="closeAllModals()">Don't Notify</button>
                <button class="btn btn-primary" onclick="sendChangeNotification()">Notify Employee</button>
            </div>
        </div>
    </div>
<div id="bidsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Manage Open Shift Bids</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <div id="bids-container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
    <div id="contextMenu"></div>
<div id="reportsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Schedule Reports</h2><span class="close" onclick="closeAllModals()">√ó</span></div><hr>
            <div id="reports-container"></div>
        </div>
    </div>

    <!-- PTO Requests Modal -->
    <div id="ptoRequestsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>PTO Requests Management</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <hr>
            <div id="pto-dashboard" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #d4edda; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">Pending Requests</h4>
                    <div id="pending-count" style="font-size: 24px; font-weight: bold;">0</div>
                </div>
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">Conflicts Detected</h4>
                    <div id="conflicts-count" style="font-size: 24px; font-weight: bold;">0</div>
                </div>
                <div style="background: #cce5ff; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">Total Requests</h4>
                    <div id="total-requests-count" style="font-size: 24px; font-weight: bold;">0</div>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="batchApprovePTO()">‚úì Batch Approve Selected</button>
                <button class="btn btn-danger" onclick="batchDenyPTO()">‚úó Batch Deny Selected</button>
                <button class="btn btn-info" onclick="generateBatchPDFs()">üìÑ Generate PDFs for Selected</button>
                <button class="btn btn-warning" onclick="exportPTOReport()">üìä Export Full Report</button>
                <select id="pto-filter" onchange="filterPTORequests()" style="float: right; padding: 5px;">
                    <option value="all">All Requests</option>
                    <option value="pending">Pending Only</option>
                    <option value="approved">Approved Only</option>
                    <option value="denied">Denied Only</option>
                    <option value="conflicts">Conflicts Only</option>
                </select>
            </div>
            <div id="pto-requests-container" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="monthlyPTOReportsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>Monthly PTO Balance Reports</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <hr>
            <div style="margin-bottom: 20px;">
                <label for="reportMonth">Select Month for Report:</label>
                <input type="month" id="reportMonth" style="margin-left: 10px; padding: 5px;">
                <button class="btn btn-primary" onclick="generatePTOReportForMonth()" style="margin-left: 10px;">Generate Reports</button>
                <button class="btn btn-success" onclick="emailAllPTOReports()" style="margin-left: 10px;">üìß Email All Reports</button>
            </div>
            <div id="monthly-pto-reports-container" style="max-height: 600px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Team PTO Calendar Modal -->
    <div id="ptoCalendarModal" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h2>Team PTO Calendar</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <hr>
            <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                <label for="ptoCalendarMonth">View Month:</label>
                <input type="month" id="ptoCalendarMonth" onchange="renderPTOCalendar()" style="padding: 5px;">
                <label for="ptoCalendarView">View Type:</label>
                <select id="ptoCalendarView" onchange="renderPTOCalendar()" style="padding: 5px;">
                    <option value="monthly">Monthly View</option>
                    <option value="weekly">Weekly View</option>
                    <option value="timeline">Timeline View</option>
                </select>
                <label for="ptoCalendarFilter">Filter by:</label>
                <select id="ptoCalendarFilter" onchange="renderPTOCalendar()" style="padding: 5px;">
                    <option value="all">All PTO Types</option>
                    <option value="vacation">Vacation Only</option>
                    <option value="sick">Sick Leave Only</option>
                    <option value="personal">Personal Only</option>
                    <option value="approved">Approved Only</option>
                    <option value="pending">Pending Only</option>
                </select>
            </div>
            <div id="pto-calendar-container" style="background: #f8f9fa; padding: 20px; border-radius: 5px; min-height: 500px;">
                <!-- PTO Calendar will be rendered here -->
            </div>
            <div id="pto-conflicts-alert" style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px; display: none;">
                <strong>‚ö†Ô∏è Coverage Conflicts Detected:</strong>
                <div id="conflicts-list"></div>
            </div>
        </div>
    </div>

    <!-- Coverage Analysis Modal -->
    <div id="coverageAnalysisModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>Coverage Analysis & Planning</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <hr>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #d4edda; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">Adequate Coverage</h4>
                    <div id="adequate-coverage-count" style="font-size: 24px; font-weight: bold;">0</div>
                    <div style="font-size: 12px;">days this month</div>
                </div>
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">At Risk Days</h4>
                    <div id="at-risk-count" style="font-size: 24px; font-weight: bold;">0</div>
                    <div style="font-size: 12px;">need attention</div>
                </div>
                <div style="background: #f8d7da; padding: 15px; border-radius: 5px; text-align: center;">
                    <h4 style="margin: 0;">Critical Shortages</h4>
                    <div id="critical-shortage-count" style="font-size: 24px; font-weight: bold;">0</div>
                    <div style="font-size: 12px;">immediate action needed</div>
                </div>
            </div>
            <div id="coverage-analysis-container" style="max-height: 500px; overflow-y: auto;">
                <!-- Coverage analysis will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Smart Schedule Assistant Modal -->
    <div id="smartScheduleModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>Smart Schedule Assistant</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <hr>
            <div style="margin-bottom: 20px;">
                <h3>Schedule Optimization Options</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label for="optimization-priority">Optimization Priority:</label>
                        <select id="optimization-priority" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="coverage">Maximize Coverage</option>
                            <option value="cost">Minimize Costs</option>
                            <option value="fairness">Ensure Fairness</option>
                            <option value="preferences">Employee Preferences</option>
                        </select>
                        <label for="shift-distribution">Shift Distribution:</label>
                        <select id="shift-distribution" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="balanced">Balanced Distribution</option>
                            <option value="seniority">By Seniority</option>
                            <option value="availability">By Availability</option>
                            <option value="skills">By Skills</option>
                        </select>
                    </div>
                    <div>
                        <label for="constraint-level">Constraint Level:</label>
                        <select id="constraint-level" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="flexible">Flexible</option>
                            <option value="standard">Standard</option>
                            <option value="strict">Strict</option>
                        </select>
                        <label for="planning-horizon">Planning Horizon:</label>
                        <select id="planning-horizon" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="current">Current Month</option>
                            <option value="next">Next Month</option>
                            <option value="quarter">Next Quarter</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="runSmartScheduling()">üöÄ Generate Smart Schedule</button>
                    <button class="btn btn-secondary" onclick="previewScheduleChanges()">üëÅÔ∏è Preview Changes</button>
                    <button class="btn btn-success" onclick="validateProposedSchedule()">‚úÖ Validate Schedule</button>
                </div>
            </div>
            <div id="smart-schedule-results" style="background: #f8f9fa; padding: 15px; border-radius: 5px; display: none;">
                <h4>Optimization Results</h4>
                <div id="optimization-summary"></div>
                <div id="proposed-changes" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- Team Directory Modal -->
    <div id="teamDirectoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë• Team Directory</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <div style="margin-bottom: 20px;">
                <input type="text" id="team-search" placeholder="Search team members..." 
                       style="width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; margin-bottom: 15px;"
                       oninput="filterTeamDirectory()">
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="filterTeamByDepartment('all')">All</button>
                    <button class="btn btn-secondary" onclick="filterTeamByDepartment('management')">Management</button>
                    <button class="btn btn-secondary" onclick="filterTeamByDepartment('staff')">Staff</button>
                    <button class="btn btn-secondary" onclick="filterTeamByDepartment('part-time')">Part-time</button>
                </div>
            </div>
            <div id="team-directory-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;">
                <!-- Team member cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Announcements Modal -->
    <div id="announcementsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¢ Announcements</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <div id="admin-announcement-controls" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4>Create New Announcement</h4>
                <input type="text" id="announcement-title" placeholder="Announcement title..." style="width: 100%; margin-bottom: 10px;">
                <textarea id="announcement-content" placeholder="Announcement content..." rows="4" style="width: 100%; margin-bottom: 10px;"></textarea>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <select id="announcement-priority" style="flex: 1;">
                        <option value="normal">Normal Priority</option>
                        <option value="high">High Priority</option>
                        <option value="urgent">Urgent</option>
                    </select>
                    <select id="announcement-audience" style="flex: 1;">
                        <option value="all">All Employees</option>
                        <option value="management">Management Only</option>
                        <option value="staff">Staff Only</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="createAnnouncement()">Post Announcement</button>
            </div>
            <div id="announcements-list" style="max-height: 500px; overflow-y: auto;">
                <!-- Announcements will be populated here -->
            </div>
        </div>
    </div>

    <!-- Audit Logs Modal -->
    <div id="auditLogsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Audit Logs</h2>
                <span class="close" onclick="closeAllModals()">√ó</span>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="date" id="audit-start-date" style="flex: 1; min-width: 150px;">
                <input type="date" id="audit-end-date" style="flex: 1; min-width: 150px;">
                <select id="audit-action-filter" style="flex: 1; min-width: 150px;">
                    <option value="">All Actions</option>
                    <option value="login">Logins</option>
                    <option value="schedule_change">Schedule Changes</option>
                    <option value="pto_request">PTO Requests</option>
                    <option value="employee_update">Employee Updates</option>
                </select>
                <button class="btn btn-primary" onclick="searchAuditLogs()">Search</button>
                <button class="btn btn-secondary" onclick="exportAuditLogs()">Export CSV</button>
            </div>
            <div id="audit-logs-list" style="max-height: 500px; overflow-y: auto;">
                <!-- Audit logs will be populated here -->
            </div>
        </div>
    </div>



<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
    let notifications = {};
    let employees = [];
    let scheduleData = {};
    let notesData = {};
    let currentDates = [];
    let contextMenuTarget = null;
    let conflicts = [];
    let history = [];
    let autoApprovalRules = { enabled: false, rule: 'firstCome' };
    let historyIndex = -1;
    let notificationInfo = null; 
    let bidsData = {};
    
    // PTO Management System Variables
    let ptoRequests = {};
    let employeePTOBalances = {};
    let ptoConflicts = [];

    // New Features Variables
    let teamDirectoryData = [];
    let announcements = [];
    let auditLogs = [];



    const shiftsInfo = { "10p-6a": 8, "2p-10:30p": 8.5, "10a-6:30p": 8.5, "6:30p-3a": 8.5, "5:30a-2p": 8.5, "6a-2:30p": 8.5, "1p-9:30p": 8.5, "7a-7p": 12, "9:30p-6a": 8.5 };
    const shiftTemplates = {
        "Weekend Coverage": { "Sat": "10a-6:30p", "Sun": "10a-6:30p" },
        "Weekday Standard": { "Mon": "10a-6:30p", "Tue": "10a-6:30p", "Wed": "10a-6:30p", "Thu": "10a-6:30p", "Fri": "10a-6:30p" },
        "Night Shift": { "Mon": "10p-6a", "Tue": "10p-6a", "Wed": "10p-6a", "Thu": "10p-6a", "Fri": "10p-6a" }
    };
const shiftTypes = {
        opening: ["5:30a-2p", "6a-2:30p", "7a-7p"],
        closing: ["2p-10:30p", "6:30p-3a", "10p-6a", "9:30p-6a"]
    };
// --- Supabase Client Setup ---
    const supabaseUrl = "https://ulefvfpvgfdavztlwmpu.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZWZ2ZnB2Z2ZkYXZ6dGx3bXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0OTIzMDksImV4cCI6MjA3MDA2ODMwOX0.Se8nQg3BZUAYnt3bahw7iNePXm8G3X5PbH83XHY8edo";
    
    let supabaseClient = null;
    let realtimeChannel = null;
    
    // Enhanced data structures for new features
    let shiftNotes = {};          // { employeeId_date_shiftType: { managerNote: '', employeeNote: '', timestamp: '' } }
    let shiftSwaps = [];          // Array of swap requests with approval status
    let shiftBids = [];           // Array of shift bids with approval status
    let shiftFeedback = [];       // Array of feedback/issue reports
    let notificationQueue = [];   // Enhanced notification system
    
    try {
        if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            console.log('Supabase client initialized successfully');
            
            // Initialize real-time subscriptions for live updates
            initializeRealtimeSubscriptions();
        } else {
            console.error('Supabase library not available - application requires cloud database');
        }
    } catch (error) {
        console.warn('Failed to initialize Supabase client:', error);
        supabaseClient = null;
    }
    
    // Initialize real-time subscriptions for live data updates
    async function initializeRealtimeSubscriptions() {
        if (!supabaseClient) return;
        
        try {
            // Subscribe to schedule data changes
            realtimeChannel = supabaseClient
                .channel('schedule-updates')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'schedules' },
                    (payload) => {
                        console.log('Real-time update received:', payload);
                        handleRealtimeUpdate(payload);
                    }
                )
                .subscribe();
                
            console.log('Real-time subscriptions initialized');
        } catch (error) {
            console.warn('Failed to initialize real-time subscriptions:', error);
        }
    }
    
    // Handle real-time updates from Supabase
    function handleRealtimeUpdate(payload) {
        if (payload.new && payload.new.data) {
            const newData = payload.new.data;
            
            // Update local data structures
            if (newData.shiftNotes) shiftNotes = newData.shiftNotes;
            if (newData.shiftSwaps) shiftSwaps = newData.shiftSwaps;
            if (newData.shiftBids) shiftBids = newData.shiftBids;
            if (newData.shiftFeedback) shiftFeedback = newData.shiftFeedback;
            if (newData.notificationQueue) notificationQueue = newData.notificationQueue;
            
            // Refresh UI if in employee portal
            const currentView = getCurrentView();
            if (currentView === 'employee-portal') {
                refreshEmployeePortalData();
            } else if (currentView === 'manager-view') {
                renderTable(); // Refresh scheduler grid
            }
            
            // Update notification bell
            updateNotificationBell();
        }
    }
    
    // Get current view (manager or employee portal)
    function getCurrentView() {
        const managerView = document.getElementById('manager-view');
        const employeePortal = document.getElementById('employee-portal');
        
        if (managerView && managerView.style.display !== 'none') return 'manager-view';
        if (employeePortal && employeePortal.style.display !== 'none') return 'employee-portal';
        return 'unknown';
    }
    
    // ================== SHIFT NOTES SYSTEM ==================
    
    // Get shift note key for storage
    function getShiftNoteKey(employeeId, date, shiftType) {
        return `${employeeId}_${date}_${shiftType}`;
    }
    
    // Add or update shift note
    async function updateShiftNote(employeeId, date, shiftType, noteType, noteText, isManager = false) {
        const noteKey = getShiftNoteKey(employeeId, date, shiftType);
        
        if (!shiftNotes[noteKey]) {
            shiftNotes[noteKey] = {
                employeeId,
                date,
                shiftType,
                managerNote: '',
                employeeNote: '',
                lastUpdated: new Date().toISOString()
            };
        }
        
        // Update the appropriate note type
        if (noteType === 'manager' && isManager) {
            shiftNotes[noteKey].managerNote = noteText;
        } else if (noteType === 'employee' && !isManager) {
            shiftNotes[noteKey].employeeNote = noteText;
        } else {
            throw new Error('Insufficient permissions to update this note type');
        }
        
        shiftNotes[noteKey].lastUpdated = new Date().toISOString();
        
        // Save to Supabase
        await saveState();
        
        // Add notification for note update
        await addNotification(employeeId, {
            type: 'shift_note',
            title: 'Shift Note Updated',
            message: `A note has been ${noteType === 'manager' ? 'added by management' : 'updated'} for your ${shiftType} shift on ${date}`,
            date: new Date().toISOString(),
            read: false
        });
        
        return shiftNotes[noteKey];
    }
    
    // Get shift note
    function getShiftNote(employeeId, date, shiftType) {
        const noteKey = getShiftNoteKey(employeeId, date, shiftType);
        return shiftNotes[noteKey] || null;
    }
    
    // Open shift notes modal
    function openShiftNotesModal(employeeId, date, shiftType, isManager = false) {
        const note = getShiftNote(employeeId, date, shiftType) || {
            managerNote: '',
            employeeNote: ''
        };
        
        const employee = employees.find(e => e.name === employeeId);
        const employeeName = employee ? employee.name : employeeId;
        
        const modalHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Shift Notes - ${employeeName}</h3>
                    <span class="close-button" onclick="closeAllModals()">&times;</span>
                </div>
                <div class="modal-body">
                    <p><strong>Shift:</strong> ${shiftType} on ${date}</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label><strong>Manager Notes:</strong></label>
                        <textarea id="manager-note-text" 
                                  ${!isManager ? 'readonly' : ''} 
                                  style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; ${!isManager ? 'background: #f5f5f5;' : ''}"
                                  placeholder="${isManager ? 'Add notes visible to the employee...' : 'No manager notes'}">${note.managerNote}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label><strong>Private Employee Notes:</strong></label>
                        <textarea id="employee-note-text" 
                                  ${isManager ? 'readonly' : ''} 
                                  style="width: 100%; height: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; ${isManager ? 'background: #f5f5f5;' : ''}"
                                  placeholder="${!isManager ? 'Add your private notes...' : 'Employee private notes (view only)'}">${note.employeeNote}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAllModals()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveShiftNote('${employeeId}', '${date}', '${shiftType}', ${isManager})">Save Notes</button>
                </div>
            </div>
        `;
        
        openModal('shift-notes-modal', modalHTML);
    }
    
    // Save shift note from modal
    async function saveShiftNote(employeeId, date, shiftType, isManager) {
        const managerNoteText = document.getElementById('manager-note-text').value;
        const employeeNoteText = document.getElementById('employee-note-text').value;
        
        try {
            if (isManager) {
                await updateShiftNote(employeeId, date, shiftType, 'manager', managerNoteText, true);
            } else {
                await updateShiftNote(employeeId, date, shiftType, 'employee', employeeNoteText, false);
            }
            
            closeAllModals();
            
            // Refresh current view
            const currentView = getCurrentView();
            if (currentView === 'manager-view') {
                renderTable();
            } else if (currentView === 'employee-portal') {
                refreshEmployeePortalData();
            }
            
            alert('Shift note saved successfully!');
        } catch (error) {
            console.error('Error saving shift note:', error);
            alert('Error saving shift note: ' + error.message);
        }
    }
    
    // ================== SHIFT SWAP SYSTEM ==================
    
    // Check if employee has open shift on date (business rule enforcement)
    function hasOpenShiftOnDate(employeeId, date) {
        const dateKey = date;
        const openShiftsEmployee = employees.find(e => e.name.includes('OPEN SHIFTS'));
        
        if (openShiftsEmployee && scheduleData[openShiftsEmployee.name] && scheduleData[openShiftsEmployee.name][dateKey]) {
            // Check if there are any open shifts on this date
            const openShifts = scheduleData[openShiftsEmployee.name][dateKey];
            return openShifts && openShifts.trim() !== '';
        }
        
        return false;
    }
    
    // Create shift swap request
    async function createShiftSwapRequest(requestorId, requestorDate, requestorShift, targetEmployeeId, targetDate, targetShift, reason) {
        // Business rule: Cannot swap if there's an open shift on the same day
        if (hasOpenShiftOnDate(requestorId, requestorDate)) {
            throw new Error('You cannot request a shift swap when there is an open shift available on the same day. Please bid on the open shift instead.');
        }
        
        const swapId = generateUUID();
        const swapRequest = {
            id: swapId,
            requestorId,
            requestorDate,
            requestorShift,
            targetEmployeeId,
            targetDate,
            targetShift,
            reason,
            status: 'pending', // pending, approved_by_target, approved_by_manager, denied, cancelled
            requestDate: new Date().toISOString(),
            approvalDate: null,
            targetApprovalDate: null,
            managerApprovalDate: null,
            targetResponse: null,
            managerComments: ''
        };
        
        shiftSwaps.push(swapRequest);
        await saveState();
        
        // Add notifications
        await addNotification(targetEmployeeId, {
            type: 'shift_swap_request',
            title: 'Shift Swap Request',
            message: `${requestorId} wants to swap their ${requestorShift} shift on ${requestorDate} for your ${targetShift} shift on ${targetDate}`,
            date: new Date().toISOString(),
            read: false,
            relatedId: swapId
        });
        
        await addNotification(requestorId, {
            type: 'shift_swap_sent',
            title: 'Swap Request Sent',
            message: `Your shift swap request has been sent to ${targetEmployeeId}`,
            date: new Date().toISOString(),
            read: false,
            relatedId: swapId
        });
        
        return swapRequest;
    }
    
    // Respond to shift swap request (employee)
    async function respondToShiftSwapRequest(swapId, response, comments = '') {
        const swap = shiftSwaps.find(s => s.id === swapId);
        if (!swap) throw new Error('Swap request not found');
        
        if (response === 'approve') {
            swap.status = 'approved_by_target';
            swap.targetApprovalDate = new Date().toISOString();
            swap.targetResponse = 'approved';
        } else {
            swap.status = 'denied';
            swap.targetResponse = 'denied';
            swap.targetApprovalDate = new Date().toISOString();
        }
        
        if (comments) {
            swap.targetComments = comments;
        }
        
        await saveState();
        
        // Notify requestor
        await addNotification(swap.requestorId, {
            type: 'shift_swap_response',
            title: `Swap Request ${response === 'approve' ? 'Approved' : 'Denied'}`,
            message: `${swap.targetEmployeeId} has ${response === 'approve' ? 'approved' : 'denied'} your shift swap request`,
            date: new Date().toISOString(),
            read: false,
            relatedId: swapId
        });
        
        // Notify manager if approved by target
        if (response === 'approve') {
            await addNotification('MANAGER', {
                type: 'shift_swap_manager_approval',
                title: 'Shift Swap Needs Manager Approval',
                message: `${swap.requestorId} and ${swap.targetEmployeeId} have agreed to swap shifts. Manager approval required.`,
                date: new Date().toISOString(),
                read: false,
                relatedId: swapId
            });
        }
        
        return swap;
    }
    
    // Manager approval for shift swap
    async function managerApproveShiftSwap(swapId, approved, managerComments = '') {
        const swap = shiftSwaps.find(s => s.id === swapId);
        if (!swap) throw new Error('Swap request not found');
        
        if (approved) {
            swap.status = 'approved';
            swap.managerApprovalDate = new Date().toISOString();
            
            // Execute the swap in scheduleData
            const requestorCurrentShift = scheduleData[swap.requestorId]?.[swap.requestorDate];
            const targetCurrentShift = scheduleData[swap.targetEmployeeId]?.[swap.targetDate];
            
            // Perform the swap
            if (!scheduleData[swap.requestorId]) scheduleData[swap.requestorId] = {};
            if (!scheduleData[swap.targetEmployeeId]) scheduleData[swap.targetEmployeeId] = {};
            
            scheduleData[swap.requestorId][swap.targetDate] = swap.targetShift;
            scheduleData[swap.targetEmployeeId][swap.requestorDate] = swap.requestorShift;
            
            // Clear original shifts if they were just the ones being swapped
            if (scheduleData[swap.requestorId][swap.requestorDate] === swap.requestorShift) {
                scheduleData[swap.requestorId][swap.requestorDate] = '';
            }
            if (scheduleData[swap.targetEmployeeId][swap.targetDate] === swap.targetShift) {
                scheduleData[swap.targetEmployeeId][swap.targetDate] = '';
            }
            
        } else {
            swap.status = 'denied';
        }
        
        swap.managerComments = managerComments;
        await saveState();
        
        // Notify both employees
        const statusText = approved ? 'approved' : 'denied';
        await addNotification(swap.requestorId, {
            type: 'shift_swap_manager_decision',
            title: `Swap Request ${approved ? 'Approved' : 'Denied'}`,
            message: `Management has ${statusText} your shift swap request with ${swap.targetEmployeeId}`,
            date: new Date().toISOString(),
            read: false,
            relatedId: swapId
        });
        
        await addNotification(swap.targetEmployeeId, {
            type: 'shift_swap_manager_decision',
            title: `Swap Request ${approved ? 'Approved' : 'Denied'}`,
            message: `Management has ${statusText} the shift swap request from ${swap.requestorId}`,
            date: new Date().toISOString(),
            read: false,
            relatedId: swapId
        });
        
        return swap;
    }
    
    // Open shift swap modal
    function openShiftSwapModal(employeeId) {
        const employee = employees.find(e => e.name === employeeId);
        if (!employee) {
            alert('Employee not found');
            return;
        }
        
        // Check if employee has any upcoming shifts to swap
        const currentDate = new Date();
        const upcomingShifts = [];
        
        const employeeSchedule = scheduleData[employeeId] || {};
        Object.keys(employeeSchedule).forEach(dateKey => {
            const shiftDate = new Date(dateKey + 'T00:00:00');
            if (shiftDate >= currentDate && employeeSchedule[dateKey] && employeeSchedule[dateKey].trim() !== '') {
                upcomingShifts.push({
                    date: dateKey,
                    shift: employeeSchedule[dateKey]
                });
            }
        });
        
        if (upcomingShifts.length === 0) {
            alert('You have no upcoming shifts available for swapping.');
            return;
        }
        
        // Get list of other employees for swap targets
        const otherEmployees = employees.filter(e => 
            e.name !== employeeId && 
            !e.name.includes('OPEN SHIFTS') && 
            !e.name.includes('Archived')
        );
        
        const modalHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Request Shift Swap</h3>
                    <span class="close-button" onclick="closeAllModals()">&times;</span>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 15px;">
                        <label for="swap-my-shift"><strong>Your Shift to Swap:</strong></label>
                        <select id="swap-my-shift" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Select your shift...</option>
                            ${upcomingShifts.map(shift => 
                                `<option value="${shift.date}|${shift.shift}">${shift.shift} on ${shift.date}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="swap-target-employee"><strong>Swap With:</strong></label>
                        <select id="swap-target-employee" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" onchange="loadTargetEmployeeShifts()">
                            <option value="">Select employee...</option>
                            ${otherEmployees.map(emp => 
                                `<option value="${emp.name}">${emp.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div id="target-shifts-container" style="margin-bottom: 15px; display: none;">
                        <label for="swap-target-shift"><strong>Their Shift:</strong></label>
                        <select id="swap-target-shift" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Select their shift...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="swap-reason"><strong>Reason for Swap:</strong></label>
                        <textarea id="swap-reason" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Please explain why you need this swap..."></textarea>
                    </div>
                    
                    <div id="swap-business-rule-warning" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <strong>‚ö†Ô∏è Notice:</strong> There is an open shift available on your selected date. Please bid on the open shift instead of requesting a swap.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAllModals()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitShiftSwapRequest('${employeeId}')">Send Swap Request</button>
                </div>
            </div>
        `;
        
        openModal('shift-swap-modal', modalHTML);
    }
    
    // Load target employee shifts for swap
    function loadTargetEmployeeShifts() {
        const targetEmployeeId = document.getElementById('swap-target-employee').value;
        const targetShiftsContainer = document.getElementById('target-shifts-container');
        const targetShiftSelect = document.getElementById('swap-target-shift');
        
        if (!targetEmployeeId) {
            targetShiftsContainer.style.display = 'none';
            return;
        }
        
        const currentDate = new Date();
        const targetUpcomingShifts = [];
        
        const targetSchedule = scheduleData[targetEmployeeId] || {};
        Object.keys(targetSchedule).forEach(dateKey => {
            const shiftDate = new Date(dateKey + 'T00:00:00');
            if (shiftDate >= currentDate && targetSchedule[dateKey] && targetSchedule[dateKey].trim() !== '') {
                targetUpcomingShifts.push({
                    date: dateKey,
                    shift: targetSchedule[dateKey]
                });
            }
        });
        
        targetShiftSelect.innerHTML = '<option value="">Select their shift...</option>';
        targetUpcomingShifts.forEach(shift => {
            const option = document.createElement('option');
            option.value = `${shift.date}|${shift.shift}`;
            option.textContent = `${shift.shift} on ${shift.date}`;
            targetShiftSelect.appendChild(option);
        });
        
        targetShiftsContainer.style.display = 'block';
    }
    
    // Submit shift swap request
    async function submitShiftSwapRequest(employeeId) {
        const myShiftValue = document.getElementById('swap-my-shift').value;
        const targetEmployeeId = document.getElementById('swap-target-employee').value;
        const targetShiftValue = document.getElementById('swap-target-shift').value;
        const reason = document.getElementById('swap-reason').value;
        
        if (!myShiftValue || !targetEmployeeId || !targetShiftValue || !reason.trim()) {
            alert('Please fill in all fields');
            return;
        }
        
        const [myDate, myShift] = myShiftValue.split('|');
        const [targetDate, targetShift] = targetShiftValue.split('|');
        
        try {
            await createShiftSwapRequest(employeeId, myDate, myShift, targetEmployeeId, targetDate, targetShift, reason);
            closeAllModals();
            alert('Shift swap request sent successfully!');
            refreshEmployeePortalData();
        } catch (error) {
            console.error('Error creating swap request:', error);
            alert('Error creating swap request: ' + error.message);
        }
    }
    
    // ================== SHIFT BIDDING SYSTEM ==================
    
    // Get available open shifts for bidding
    function getAvailableOpenShifts(excludeEmployeeId = null, excludeDate = null) {
        const openShiftsEmployee = employees.find(e => e.name.includes('OPEN SHIFTS'));
        if (!openShiftsEmployee) return [];
        
        const currentDate = new Date();
        const availableShifts = [];
        
        const openSchedule = scheduleData[openShiftsEmployee.name] || {};
        Object.keys(openSchedule).forEach(dateKey => {
            const shiftDate = new Date(dateKey + 'T00:00:00');
            if (shiftDate >= currentDate && openSchedule[dateKey] && openSchedule[dateKey].trim() !== '') {
                // Don't include shifts on dates where the employee already has shifts (business rule)
                if (excludeEmployeeId && excludeDate && dateKey === excludeDate) {
                    return; // Skip this date
                }
                
                // Check if employee already has a shift on this date
                if (excludeEmployeeId && scheduleData[excludeEmployeeId]?.[dateKey]?.trim()) {
                    return; // Skip - employee already has shift this day
                }
                
                availableShifts.push({
                    date: dateKey,
                    shift: openSchedule[dateKey],
                    currentBids: shiftBids.filter(bid => 
                        bid.date === dateKey && 
                        bid.shiftType === openSchedule[dateKey] && 
                        bid.status === 'pending'
                    ).length
                });
            }
        });
        
        return availableShifts;
    }
    
    // Create shift bid
    async function createShiftBid(employeeId, date, shiftType, reason) {
        // Business rule: Cannot bid if employee already has a shift that day
        if (scheduleData[employeeId]?.[date]?.trim()) {
            throw new Error('You cannot bid on a shift when you already have a shift scheduled for that day.');
        }
        
        // Check if already bid on this shift
        const existingBid = shiftBids.find(bid => 
            bid.employeeId === employeeId && 
            bid.date === date && 
            bid.shiftType === shiftType && 
            bid.status === 'pending'
        );
        
        if (existingBid) {
            throw new Error('You have already placed a bid on this shift.');
        }
        
        const bidId = generateUUID();
        const bid = {
            id: bidId,
            employeeId,
            date,
            shiftType,
            reason,
            status: 'pending', // pending, awarded, denied
            bidDate: new Date().toISOString(),
            awardDate: null,
            managerComments: ''
        };
        
        shiftBids.push(bid);
        await saveState();
        
        // Add notification to employee
        await addNotification(employeeId, {
            type: 'shift_bid_placed',
            title: 'Shift Bid Placed',
            message: `Your bid for ${shiftType} on ${date} has been submitted`,
            date: new Date().toISOString(),
            read: false,
            relatedId: bidId
        });
        
        // Add notification to manager
        await addNotification('MANAGER', {
            type: 'shift_bid_received',
            title: 'New Shift Bid',
            message: `${employeeId} has bid on ${shiftType} shift on ${date}`,
            date: new Date().toISOString(),
            read: false,
            relatedId: bidId
        });
        
        return bid;
    }
    
    // Award shift bid (manager function)
    async function awardShiftBid(bidId, awarded, managerComments = '') {
        const bid = shiftBids.find(b => b.id === bidId);
        if (!bid) throw new Error('Bid not found');
        
        if (awarded) {
            bid.status = 'awarded';
            bid.awardDate = new Date().toISOString();
            
            // Assign the shift to the employee
            if (!scheduleData[bid.employeeId]) scheduleData[bid.employeeId] = {};
            scheduleData[bid.employeeId][bid.date] = bid.shiftType;
            
            // Remove from open shifts
            const openShiftsEmployee = employees.find(e => e.name.includes('OPEN SHIFTS'));
            if (openShiftsEmployee && scheduleData[openShiftsEmployee.name]?.[bid.date]) {
                delete scheduleData[openShiftsEmployee.name][bid.date];
            }
            
            // Deny all other bids for this shift
            shiftBids.forEach(otherBid => {
                if (otherBid.id !== bidId && 
                    otherBid.date === bid.date && 
                    otherBid.shiftType === bid.shiftType && 
                    otherBid.status === 'pending') {
                    otherBid.status = 'denied';
                    otherBid.managerComments = 'Shift awarded to another employee';
                }
            });
            
        } else {
            bid.status = 'denied';
        }
        
        bid.managerComments = managerComments;
        await saveState();
        
        // Notify employee
        await addNotification(bid.employeeId, {
            type: 'shift_bid_decision',
            title: `Shift Bid ${awarded ? 'Awarded' : 'Denied'}`,
            message: `Your bid for ${bid.shiftType} on ${bid.date} has been ${awarded ? 'awarded' : 'denied'}`,
            date: new Date().toISOString(),
            read: false,
            relatedId: bidId
        });
        
        return bid;
    }
    
    // Open shift bidding modal
    function openShiftBiddingModal(employeeId) {
        const availableShifts = getAvailableOpenShifts(employeeId);
        
        if (availableShifts.length === 0) {
            alert('No open shifts available for bidding at this time.');
            return;
        }
        
        const modalHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Bid on Open Shifts</h3>
                    <span class="close-button" onclick="closeAllModals()">&times;</span>
                </div>
                <div class="modal-body">
                    <p><strong>Available Open Shifts:</strong></p>
                    <div style="margin-bottom: 15px;">
                        <label for="bid-shift-select"><strong>Select Shift:</strong></label>
                        <select id="bid-shift-select" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Choose a shift to bid on...</option>
                            ${availableShifts.map(shift => 
                                `<option value="${shift.date}|${shift.shift}">${shift.shift} on ${shift.date} (${shift.currentBids} current bids)</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="bid-reason"><strong>Why do you want this shift?</strong></label>
                        <textarea id="bid-reason" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Explain why you should be awarded this shift..."></textarea>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <strong>‚ÑπÔ∏è Bidding Rules:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>You can only bid on shifts for days when you don't already have a shift</li>
                            <li>Management will review all bids and award based on seniority, availability, and business needs</li>
                            <li>You'll be notified when a decision is made</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAllModals()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitShiftBid('${employeeId}')">Place Bid</button>
                </div>
            </div>
        `;
        
        openModal('shift-bidding-modal', modalHTML);
    }
    
    // Submit shift bid
    async function submitShiftBid(employeeId) {
        const shiftValue = document.getElementById('bid-shift-select').value;
        const reason = document.getElementById('bid-reason').value;
        
        if (!shiftValue || !reason.trim()) {
            alert('Please select a shift and provide a reason for your bid');
            return;
        }
        
        const [date, shiftType] = shiftValue.split('|');
        
        try {
            await createShiftBid(employeeId, date, shiftType, reason);
            closeAllModals();
            alert('Shift bid placed successfully!');
            refreshEmployeePortalData();
        } catch (error) {
            console.error('Error placing bid:', error);
            alert('Error placing bid: ' + error.message);
        }
    }
    
    // ================== ENHANCED NOTIFICATION SYSTEM ==================
    
    // Add notification to queue
    async function addNotification(employeeId, notification) {
        if (!notifications[employeeId]) {
            notifications[employeeId] = [];
        }
        
        notifications[employeeId].push({
            id: generateUUID(),
            ...notification,
            timestamp: new Date().toISOString()
        });
        
        // Also add to central notification queue for real-time updates
        notificationQueue.push({
            employeeId,
            notification: {
                id: generateUUID(),
                ...notification,
                timestamp: new Date().toISOString()
            }
        });
        
        // Keep only last 50 notifications per employee
        if (notifications[employeeId].length > 50) {
            notifications[employeeId] = notifications[employeeId].slice(-50);
        }
        
        // Update notification bell
        updateNotificationBell();
    }
    
    // Update notification bell appearance
    function updateNotificationBell() {
        const bellElement = document.getElementById('notification-bell');
        if (!bellElement) return;
        
        const currentView = getCurrentView();
        let unreadCount = 0;
        
        if (currentView === 'employee-portal') {
            // Get current employee ID from URL or portal context
            const urlParams = new URLSearchParams(window.location.search);
            const employeeId = urlParams.get('portal');
            
            if (employeeId && notifications[employeeId]) {
                unreadCount = notifications[employeeId].filter(n => !n.read).length;
            }
        } else if (currentView === 'manager-view') {
            // Count all unread notifications for manager view
            Object.keys(notifications).forEach(empId => {
                if (notifications[empId]) {
                    unreadCount += notifications[empId].filter(n => !n.read).length;
                }
            });
        }
        
        if (unreadCount > 0) {
            bellElement.innerHTML = `üîî <span style="background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; position: absolute; top: -5px; right: -5px;">${unreadCount}</span>`;
            bellElement.style.position = 'relative';
        } else {
            bellElement.innerHTML = 'üîî';
        }
    }
    
    // ================== SHIFT FEEDBACK SYSTEM ==================
    
    // Submit shift feedback/issue report
    async function submitShiftFeedback(employeeId, date, shiftType, feedbackType, description, severity = 'medium') {
        const feedbackId = generateUUID();
        const feedback = {
            id: feedbackId,
            employeeId,
            date,
            shiftType,
            feedbackType, // 'issue', 'feedback', 'suggestion', 'complaint'
            description,
            severity, // 'low', 'medium', 'high', 'urgent'
            status: 'pending', // pending, reviewed, resolved, dismissed
            submitDate: new Date().toISOString(),
            managerResponse: '',
            responseDate: null
        };
        
        shiftFeedback.push(feedback);
        await saveState();
        
        // Notify manager
        await addNotification('MANAGER', {
            type: 'shift_feedback',
            title: `New ${feedbackType.charAt(0).toUpperCase() + feedbackType.slice(1)}`,
            message: `${employeeId} submitted a ${feedbackType} for ${shiftType} shift on ${date}`,
            date: new Date().toISOString(),
            read: false,
            relatedId: feedbackId
        });
        
        // Notify employee
        await addNotification(employeeId, {
            type: 'feedback_submitted',
            title: 'Feedback Submitted',
            message: `Your ${feedbackType} has been submitted and will be reviewed by management`,
            date: new Date().toISOString(),
            read: false,
            relatedId: feedbackId
        });
        
        return feedback;
    }
    
    // Open shift feedback modal
    function openShiftFeedbackModal(employeeId, date, shiftType) {
        const modalHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Report Issue / Leave Feedback</h3>
                    <span class="close-button" onclick="closeAllModals()">&times;</span>
                </div>
                <div class="modal-body">
                    <p><strong>Shift:</strong> ${shiftType} on ${date}</p>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="feedback-type"><strong>Type:</strong></label>
                        <select id="feedback-type" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="issue">Report an Issue</option>
                            <option value="feedback">General Feedback</option>
                            <option value="suggestion">Suggestion</option>
                            <option value="complaint">Formal Complaint</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="feedback-severity"><strong>Priority:</strong></label>
                        <select id="feedback-severity" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="low">Low - Minor issue or suggestion</option>
                            <option value="medium" selected>Medium - Standard issue</option>
                            <option value="high">High - Significant problem</option>
                            <option value="urgent">Urgent - Immediate attention needed</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="feedback-description"><strong>Description:</strong></label>
                        <textarea id="feedback-description" rows="5" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Please provide details about the issue or your feedback..."></textarea>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px;">
                        <strong>‚ÑπÔ∏è Note:</strong> All feedback is confidential and will be reviewed by management. For urgent issues, please also contact your supervisor directly.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAllModals()">Cancel</button>
                    <button class="btn btn-primary" onclick="submitFeedback('${employeeId}', '${date}', '${shiftType}')">Submit Feedback</button>
                </div>
            </div>
        `;
        
        openModal('shift-feedback-modal', modalHTML);
    }
    
    // Submit feedback from modal
    async function submitFeedback(employeeId, date, shiftType) {
        const feedbackType = document.getElementById('feedback-type').value;
        const severity = document.getElementById('feedback-severity').value;
        const description = document.getElementById('feedback-description').value;
        
        if (!description.trim()) {
            alert('Please provide a description of your feedback');
            return;
        }
        
        try {
            await submitShiftFeedback(employeeId, date, shiftType, feedbackType, description, severity);
            closeAllModals();
            alert('Feedback submitted successfully! Management will review and respond.');
            refreshEmployeePortalData();
        } catch (error) {
            console.error('Error submitting feedback:', error);
            alert('Error submitting feedback: ' + error.message);
        }
    }
    
    // ================== HELPER FUNCTIONS ==================
    
    // Open generic modal
    function openModal(modalId, content) {
        // Remove existing modal if present
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
            existingModal.remove();
        }
        
        // Create new modal
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal';
        modal.style.cssText = `
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        `;
        
        const modalContainer = document.createElement('div');
        modalContainer.style.cssText = `
            position: relative;
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        `;
        
        modalContainer.innerHTML = content;
        modal.appendChild(modalContainer);
        document.body.appendChild(modal);
        
        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeAllModals();
            }
        });
    }
    
    // Refresh employee portal data
    function refreshEmployeePortalData() {
        const urlParams = new URLSearchParams(window.location.search);
        const employeeId = urlParams.get('portal');
        
        if (employeeId) {
            loadAndRenderPortal(employeeId, {
                employees,
                schedule: scheduleData,
                notesData,
                bidsData,
                notifications,
                ptoRequests,
                employeePTOBalances,
                announcements,
                auditLogs,
                shiftNotes,
                shiftSwaps,
                shiftBids,
                shiftFeedback,
                notificationQueue
            });
        }
    }
    
    // ================== EMPLOYEE PORTAL ENHANCEMENTS ==================
    
    // Get current employee ID from portal context
    function getCurrentEmployeeId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('portal') || '';
    }
    
    // Show specific portal tab
    function showPortalTab(tabName) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll('.portal-tab-content');
        tabContents.forEach(content => {
            content.style.display = 'none';
        });
        
        // Remove active class from all tabs
        const tabs = document.querySelectorAll('.portal-tab');
        tabs.forEach(tab => {
            tab.classList.remove('active');
            tab.style.borderBottomColor = 'transparent';
            tab.style.fontWeight = 'normal';
        });
        
        // Show selected tab content
        const selectedContent = document.getElementById(`portal-tab-${tabName}`);
        if (selectedContent) {
            selectedContent.style.display = 'block';
        }
        
        // Activate selected tab
        const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (selectedTab) {
            selectedTab.classList.add('active');
            selectedTab.style.borderBottomColor = '#0f172a';
            selectedTab.style.fontWeight = '600';
        }
        
        // Load tab-specific content
        switch (tabName) {
            case 'schedule':
                // Schedule content is loaded by default
                break;
            case 'pto':
                // PTO content is already there
                break;
            case 'history':
                loadShiftHistory();
                break;
            case 'requests':
                loadMyRequests();
                break;
            case 'notifications':
                loadNotifications();
                break;
        }
    }
    
    // Mark all notifications as read
    async function markAllNotificationsRead() {
        const employeeId = getCurrentEmployeeId();
        if (!employeeId) return;
        
        if (notifications[employeeId]) {
            notifications[employeeId].forEach(notification => {
                notification.read = true;
            });
            
            await saveState();
            updateNotificationBell();
            loadNotifications();
        }
    }
    
    // Load notifications for current employee  
    function loadNotifications() {
        const employeeId = getCurrentEmployeeId();
        if (!employeeId) return;
        
        const notificationsContent = document.getElementById('notifications-content');
        if (!notificationsContent) return;
        
        const employeeNotifications = notifications[employeeId] || [];
        
        if (employeeNotifications.length === 0) {
            notificationsContent.innerHTML = '<p>No notifications.</p>';
            return;
        }
        
        const sortedNotifications = [...employeeNotifications].sort((a, b) => 
            new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date)
        );
        
        const notificationHTML = sortedNotifications.map(notification => {
            const typeIcons = {
                'shift_note': 'üìù',
                'shift_swap_request': 'üîÑ',
                'shift_swap_response': 'üîÑ',
                'shift_swap_manager_decision': 'üîÑ',
                'shift_bid_placed': 'üéØ',
                'shift_bid_decision': 'üéØ',
                'feedback_submitted': 'üí¨',
                'pto_approved': 'üèñÔ∏è',
                'pto_denied': 'üèñÔ∏è',
                'schedule_change': 'üìÖ'
            };
            
            const icon = typeIcons[notification.type] || 'üîî';
            const isUnread = !notification.read;
            
            return `
                <div style="border: 1px solid #e2e8f0; padding: 10px; border-radius: 5px; margin-bottom: 10px; ${isUnread ? 'background: #fef3cd; border-color: #ffc107;' : 'background: white;'}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 18px;">${icon}</span>
                                <strong style="${isUnread ? 'font-weight: 700;' : ''}">${notification.title}</strong>
                                ${isUnread ? '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">NEW</span>' : ''}
                            </div>
                            <p style="margin: 5px 0; font-size: 14px; color: #6b7280;">${notification.message}</p>
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #9ca3af;">
                            ${new Date(notification.timestamp || notification.date).toLocaleDateString()}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        notificationsContent.innerHTML = notificationHTML;
    }
    
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM loaded, starting data initialization...');
        try {
            // Initialize manager view by default
            showManagerView();
            await loadState();
            console.log('Data loaded successfully');
        } catch (error) {
            console.error('Error during initialization:', error);
        }
    });
    
    function generateUUID() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
    }

    // Update last saved indicator
    function updateLastSavedIndicator(saveTime) {
        const indicator = document.getElementById('last-saved-indicator');
        if (indicator) {
            indicator.textContent = `Last saved: ${saveTime}`;
            indicator.style.color = '#059669'; // green color
            
            // Fade back to normal color after 3 seconds
            setTimeout(() => {
                indicator.style.color = '#6b7280'; // gray color
            }, 3000);
        }
    }

    // Show loading spinner
    function showLoadingSpinner(message = 'Loading...') {
        const spinner = document.getElementById('loading-spinner');
        if (spinner) {
            spinner.style.display = 'block';
            const messageEl = spinner.querySelector('.loading-message');
            if (messageEl) {
                messageEl.textContent = message;
            }
        }
    }

    // Hide loading spinner
    function hideLoadingSpinner() {
        const spinner = document.getElementById('loading-spinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
    }

    // Add event listener for schedule month with existence check
    function attachScheduleMonthListener() {
        const scheduleMonth = document.getElementById('scheduleMonth');
        if (scheduleMonth) {
            scheduleMonth.addEventListener('change', (e) => {
                recordHistory();
                clearSchedule(false);
                generateSchedule(e.target.value);
            });
        }
    }
  window.addEventListener('click', (event) => {
    // Hide context menu
    document.getElementById('contextMenu').style.display = 'none';
    
    // Close modals if clicking on modal background
    if (event.target.classList.contains('modal')) {
        closeAllModals();
    }
    
    // Hide notification popup if clicking outside of it
    const popup = document.getElementById('notification-popup');
    const bell = document.getElementById('notification-bell');
    if (popup && bell && 
        !popup.contains(event.target) && 
        !bell.contains(event.target)) {
        popup.style.display = 'none';
    }
});

    function getSortedEmployees() {
        return [...employees].sort((a, b) => {
            const aIsOpen = a.name.startsWith('OPEN SHIFTS');
            const bIsOpen = b.name.startsWith('OPEN SHIFTS');
            if (aIsOpen && !bIsOpen) return -1;
            if (!aIsOpen && bIsOpen) return 1;
            return a.name.localeCompare(b.name);
        });
    }

    function generateSchedule(monthString) {
        console.log('generateSchedule called with:', monthString);
        if (!monthString) {
            console.error('generateSchedule: monthString is required');
            return;
        }
        
        try {
            const [year, month] = monthString.split('-').map(Number);
            console.log('Generating schedule for year:', year, 'month:', month);
            
            const daysInMonth = new Date(year, month, 0).getDate();
            currentDates = Array.from({ length: daysInMonth }, (_, i) => new Date(year, month - 1, i + 1));
            console.log('Generated dates for', daysInMonth, 'days');
            
            // Ensure scheduleData and notesData are initialized for all employees
            employees.forEach(emp => { 
                if (!scheduleData[emp.name]) {
                    scheduleData[emp.name] = {};
                    console.log('Initialized scheduleData for:', emp.name);
                }
                if (!notesData[emp.name]) {
                    notesData[emp.name] = {};
                    console.log('Initialized notesData for:', emp.name);
                }
            });
            
            console.log('Calling renderTable...');
            renderTable();
            console.log('generateSchedule completed successfully');
        } catch (error) {
            console.error('Error in generateSchedule:', error);
            // Try to render table anyway with current data
            renderTable();
        }
    }
    
    function renderTable() {
        console.log('renderTable called...');
        try {
            const table = document.getElementById('schedule-table');
            if (!table) {
                console.error('schedule-table element not found');
                return;
            }
            
            const tbody = table.querySelector('tbody') || table.appendChild(document.createElement('tbody'));
            const thead = table.querySelector('thead') || table.appendChild(document.createElement('thead'));
            
            if (!currentDates || currentDates.length === 0) {
                console.warn('No currentDates available, table will be empty');
                thead.innerHTML = '<tr><th class="employee-name">Employee</th><th>No dates loaded</th></tr>';
                tbody.innerHTML = '';
                return;
            }
            
            console.log('Rendering table for', currentDates.length, 'dates and', employees.length, 'employees');
            
            // Create header row with dates
            thead.innerHTML = `<tr><th class="employee-name">Employee</th>${currentDates.map(d => `<th>${d.getDate()}<br>${d.toLocaleDateString('en-US', { weekday: 'short' })}</th>`).join('')}</tr>`;
            
            const sortedEmployees = getSortedEmployees();
            console.log('Sorted employees:', sortedEmployees.length);
            
            tbody.innerHTML = sortedEmployees.map(emp => {
                const cells = currentDates.map(date => {
                    const dateKey = date.toISOString().split('T')[0];
                    const shift = scheduleData[emp.name]?.[dateKey] || '';
                    const note = notesData[emp.name]?.[dateKey] || '';
                    let cellClass = (date.getDay() === 0 || date.getDay() === 6) ? ' weekend' : '';
                    if (shift.toUpperCase() === 'PTO') {
                        // Check if this is from an approved PTO request
                        const ptoRequest = Object.values(ptoRequests || {}).find(r => 
                            r.employeeName === emp.name && 
                            r.status === 'approved' &&
                            new Date(r.startDate) <= date && 
                            new Date(r.endDate) >= date
                        );
                        cellClass += ptoRequest ? ' pto-approved' : ' pto-cell';
                    }
                    if (conflicts.some(c => c.empName === emp.name && c.dateKey === dateKey)) cellClass += ' conflict-cell';
                    const noteIndicator = note ? `<div class="note-indicator" title="${note}"></div>` : '';
                    return `<td class="${cellClass}" contenteditable="true" onblur="updateShift(this, '${emp.name}', '${dateKey}')" oncontextmenu="showContextMenu(event, '${emp.name}', '${dateKey}')" data-original-shift="${shift}">${shift}${noteIndicator}</td>`;
                }).join('');
                return `<tr class="${emp.name.startsWith('OPEN SHIFTS') ? 'open-shift-row' : ''}"><td class="employee-name">${emp.name}</td>${cells}</tr>`;
            }).join('');
            
            console.log('Table rendered successfully');
            renderDashboard();
            enhancePTODisplay(); // Add PTO visual enhancements
        } catch (error) {
            console.error('Error in renderTable:', error);
        }
    }

    function renderDashboard() {
        if (document.getElementById('manager-view').style.display === 'none') return;
        const empTable = document.querySelector('#employee-dashboard-container table');
        const dailyTable = document.querySelector('#daily-dashboard-container table');
        const targetHours = parseFloat(document.getElementById('targetHours').value) || 0;
        const minStaff = parseInt(document.getElementById('minStaff').value) || 0;
        empTable.innerHTML = '<thead><tr><th>Employee</th><th>Days</th><th>Hours</th></tr></thead><tbody>' + 
            getSortedEmployees().map(emp => {
                if (emp.name.startsWith('OPEN SHIFTS')) return '';
                let days = 0, hours = 0;
                if (scheduleData[emp.name]) { for (const shift of Object.values(scheduleData[emp.name])) { if (shift && shift.toUpperCase() !== 'PTO') { days++; hours += shiftsInfo[shift] || 0; } } }
                let class_ = '';
                const empTargetHours = emp.targetHours || (emp.type === 'FT' ? targetHours : 0);
                if (empTargetHours > 0) {
                    if (hours < empTargetHours * 0.8) class_ = 'dashboard-under';
                    if (hours > empTargetHours * 1.1) class_ = 'dashboard-over';
                }
                return `<tr class="${class_}"><td>${emp.name}</td><td>${days}</td><td>${hours.toFixed(1)}</td></tr>`;
            }).join('') + '</tbody>';
        dailyTable.innerHTML = '<thead><tr><th>Date</th><th>Staff</th><th>Hours</th></tr></thead><tbody>' + currentDates.map(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0, dailyHours = 0;
            employees.forEach(emp => {
                const shift = scheduleData[emp.name]?.[dateKey] || '';
                if (shift && shift.toUpperCase() !== 'PTO') { staffCount++; dailyHours += shiftsInfo[shift] || 0; }
            });
            const class_ = staffCount < minStaff ? 'dashboard-low-staff' : '';
            return `<tr class="${class_}"><td>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td><td>${staffCount}</td><td>${dailyHours.toFixed(1)}</td></tr>`;
        }).join('') + '</tbody>';
    }

  function updateShift(element, employeeName, dateKey) {
        const originalShift = element.getAttribute('data-original-shift');
        const newShift = element.textContent.trim().replace(/<div.*<\/div>/, '');

        if (originalShift === newShift) {
            return; // Do nothing if the shift hasn't actually changed
        }

        recordHistory();

        // If an existing shift was changed for a real employee, trigger notification modal
        if (originalShift && !employeeName.startsWith('OPEN SHIFTS')) {
            const employee = employees.find(e => e.name === employeeName);
            if (employee) {
                notificationInfo = {
                    employeeName,
                    dateKey,
                    originalShift,
                    newShift: newShift || "REMOVED"
                };
                document.getElementById('notification-text').innerHTML = `You changed a shift for <b>${employeeName}</b> from "<em>${originalShift}</em>" to "<em>${newShift || "REMOVED"}</em>".<br><br>Would you like to send an email notification?`;
                document.getElementById('notificationModal').style.display = 'block';
            }
        }

        if (newShift.toUpperCase() === 'PTO') {
            executePTO(employeeName, dateKey, originalShift);
        } else {
            scheduleData[employeeName][dateKey] = newShift;
        }
        
        saveState();
        renderTable();
    }

function clearSchedule(showAlert = true) {
    if (showAlert && !confirm("Are you sure you want to clear the schedule grid?")) return;
    recordHistory();
    scheduleData = {};
    bidsData = {};
    notifications = {};
    employees.forEach(emp => { scheduleData[emp.name] = {}; });
    if (showAlert) { renderTable(); saveState(); }
}

    function autoGenerateFullSchedule() {
        if (!confirm("This will generate a schedule based on availability and workload limits. Continue?")) return;
        recordHistory();
        clearSchedule(false);
        const dayAbbreviations = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        let weeklyWorkload = {};
        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || !emp.availability || !emp.shifts || emp.shifts === 'Varies') return;
            weeklyWorkload[emp.name] = {};
            const availability = emp.availability.toLowerCase();
            const maxDays = parseInt(emp.maxDays) || 0;
            currentDates.forEach(date => {
                const dayOfWeek = dayAbbreviations[date.getDay()];
                const dateKey = date.toISOString().split('T')[0];
                const weekNumber = Math.ceil((date.getDate() + new Date(date.getFullYear(), date.getMonth(), 1).getUTCDay()) / 7);
                if (availability.includes(dayOfWeek)) {
                    if (maxDays > 0) {
                        const daysThisWeek = weeklyWorkload[emp.name][weekNumber] || 0;
                        if (daysThisWeek >= maxDays) return;
                        weeklyWorkload[emp.name][weekNumber] = daysThisWeek + 1;
                    }
                    scheduleData[emp.name][dateKey] = emp.shifts;
                }
            });
        });
        renderTable();
        saveState();
        alert('‚ú® Full schedule generated!');
    }

    function moveOpenPositionShifts() {
        if (!confirm("This will move all shifts from 'OPEN POSITION' to 'OPEN SHIFTS (Coverage)'. Continue?")) return;
        recordHistory();
        const sourceName = 'OPEN POSITION';
        const targetName = 'OPEN SHIFTS (Coverage)';
        if (!scheduleData[sourceName] || !scheduleData[targetName]) { alert("Error: 'OPEN POSITION' or 'OPEN SHIFTS (Coverage)' not found in data."); return; }
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[sourceName][dateKey];
            if (shift) {
                scheduleData[targetName][dateKey] = scheduleData[targetName][dateKey] ? `${scheduleData[targetName][dateKey]}, ${shift}` : shift;
                scheduleData[sourceName][dateKey] = '';
            }
        });
        renderTable();
        saveState();
        alert("‚úÖ Shifts from 'OPEN POSITION' have been moved.");
    }

    function showContextMenu(event, employeeName, dateKey) {
        event.preventDefault();
        contextMenuTarget = { employeeName, dateKey, originalShift: scheduleData[employeeName]?.[dateKey] || '' };
        const menu = document.getElementById('contextMenu');
        
        let templateOptions = '';
        if (!employeeName.startsWith('OPEN SHIFTS')) {
            templateOptions = `
                <div onmouseover="this.querySelector('.submenu').style.display='block'" onmouseout="this.querySelector('.submenu').style.display='none'">
                    Apply Template ‚ñ∫
                    <div class="submenu">
                        ${Object.keys(shiftTemplates).map(t => `<div onclick="applyShiftTemplate('${employeeName}', '${t}')">${t}</div>`).join('')}
                    </div>
                </div>`;
        }
        
        menu.innerHTML = `
            <div onclick="markAsPTO()">Mark as PTO</div>
            <div onclick="openNoteModal()">Add/Edit Note</div>
            <div onclick="showSuggestion('${employeeName}', '${dateKey}')">üí° Suggest Shift</div>
            <div onclick="clearEmployeeSchedule('${employeeName}')">üóëÔ∏è Clear All Shifts</div>
            ${templateOptions}
        `;
        menu.style.top = `${event.pageY}px`; 
        menu.style.left = `${event.pageX}px`; 
        menu.style.display = 'block';
    }

    function markAsPTO() {
        if (contextMenuTarget) {
            recordHistory();
            const { employeeName, dateKey, originalShift } = contextMenuTarget;
            executePTO(employeeName, dateKey, originalShift);
            renderTable();
        }
    }

    function executePTO(employeeName, dateKey, originalShift) {
    const employee = employees.find(e => e.name === employeeName);
    if (!employee || employee.name.startsWith('OPEN SHIFTS')) return;
    
    // If there was an original shift, move it to open shifts
    if (originalShift && originalShift.toUpperCase() !== 'PTO') {
        const openShiftsEmp = employees.find(e => e.name.startsWith('OPEN SHIFTS'));
        if (openShiftsEmp) {
            const currentOpenShifts = scheduleData[openShiftsEmp.name]?.[dateKey] || '';
            scheduleData[openShiftsEmp.name][dateKey] = currentOpenShifts ? 
                `${currentOpenShifts}, ${originalShift}` : originalShift;
        }
    }
    
    // Mark as PTO
    scheduleData[employeeName][dateKey] = 'PTO';
    saveState();
}
function findConflicts() {
    conflicts = [];
    
    // Check for availability conflicts
    employees.forEach(emp => {
        if (emp.name.startsWith('OPEN SHIFTS') || !emp.availability) return;
        
        const availability = emp.availability.toLowerCase();
        const dayAbbreviations = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[emp.name]?.[dateKey];
            const dayOfWeek = dayAbbreviations[date.getDay()];
            
            if (shift && shift.toUpperCase() !== 'PTO' && !availability.includes(dayOfWeek)) {
                conflicts.push({ empName: emp.name, dateKey: dateKey });
            }
        });
    });
    
    renderTable();
    if (conflicts.length > 0) { 
        alert(`üö® Found ${conflicts.length} conflict(s), highlighted in red.`); 
    } else { 
        alert('‚úÖ No availability conflicts found!'); 
    }
}

function recordHistory() {
    history = history.slice(0, historyIndex + 1);
    history.push(JSON.parse(JSON.stringify({ employees, scheduleData, notesData, bidsData, notifications })));
    historyIndex++;
    updateUndoRedoButtons();
}

   function undo() {
        if (historyIndex > 0) {
            historyIndex--;
            const state = JSON.parse(JSON.stringify(history[historyIndex]));
            employees = state.employees; scheduleData = state.scheduleData; notesData = state.notesData || {}; bidsData = state.bidsData || {}; notifications = state.notifications || {};
            renderTable(); saveState(); updateUndoRedoButtons();
        }
    }

 function redo() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            const state = JSON.parse(JSON.stringify(history[historyIndex]));
            employees = state.employees; scheduleData = state.scheduleData; notesData = state.notesData || {}; bidsData = state.bidsData || {}; notifications = state.notifications || {};
            renderTable(); saveState(); updateUndoRedoButtons();
        }
    }

    function updateUndoRedoButtons() {
        document.getElementById('undoBtn').disabled = historyIndex <= 0;
        document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
    }

async function saveState() {
    // Prevent accidental employee wipe: warn if employee list is empty
    if (!employees || employees.length === 0) {
        const confirmSave = confirm(
            "‚ö†Ô∏è WARNING: You are about to save with an empty employee list!\n\n" +
            "This will permanently delete all employee data from the database.\n\n" +
            "Are you sure you want to proceed?"
        );
        if (!confirmSave) {
            console.log('Save cancelled due to empty employee list warning');
            return;
        }
    }

    const stateToSave = {
        employees,
        schedule: scheduleData,
        notesData,
        bidsData,
        notifications,
        ptoRequests,
        employeePTOBalances,
        announcements,
        auditLogs,
        shiftNotes,
        shiftSwaps,
        shiftBids,
        shiftFeedback,
        notificationQueue,
        month: document.getElementById('scheduleMonth')?.value || '',
        config: {
            targetHours: document.getElementById('targetHours')?.value || '',
            minStaff: document.getElementById('minStaff')?.value || ''
        }
    };

    // Save to Supabase only
    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient !== null) {
            const { error } = await supabaseClient
                .from('schedules')
                .upsert({ id: 1, data: stateToSave });

            if (error) {
                console.error("Supabase save error:", error);
                
                // Show user-friendly error message
                let userMessage = "Failed to save data to cloud database. ";
                if (error.code === 'PGRST301') {
                    userMessage += "Database connection timeout. Please check your internet connection and try again.";
                } else if (error.code === '23505') {
                    userMessage += "Data conflict detected. Please refresh and try again.";
                } else if (error.message) {
                    userMessage += `Error: ${error.message}`;
                } else {
                    userMessage += "Please check your internet connection and try again.";
                }
                
                alert(`‚ùå Save Failed\n\n${userMessage}`);
                throw new Error(`Failed to save data: ${error.message}`);
            }
            console.log('‚úÖ Successfully saved to cloud');
            
            // Show success message
            const saveTime = new Date().toLocaleTimeString();
            updateLastSavedIndicator(saveTime);
            
        } else {
            const errorMsg = 'Cloud database not available - cannot save data';
            alert(`‚ùå Save Failed\n\n${errorMsg}\n\nPlease check your internet connection and refresh the page.`);
            throw new Error(errorMsg);
        }
    } catch (err) {
        console.error("Save failed:", err);
        
        // Only show alert if we haven't already shown one
        if (!err.message.includes('Failed to save data:')) {
            alert(`‚ùå Unexpected Save Error\n\n${err.message || 'Unknown error occurred'}\n\nPlease try again or contact support.`);
        }
        
        throw err; // Re-throw error to notify calling code
    }
}

// ================== BACKUP & RESTORE SYSTEM ==================

function exportBackup() {
    try {
        const backupData = {
            version: "1.0",
            timestamp: new Date().toISOString(),
            data: {
                employees,
                schedule: scheduleData,
                notesData,
                bidsData,
                notifications,
                ptoRequests,
                employeePTOBalances,
                announcements,
                auditLogs,
                shiftNotes,
                shiftSwaps,
                shiftBids,
                shiftFeedback,
                notificationQueue,
                month: document.getElementById('scheduleMonth')?.value || '',
                config: {
                    targetHours: document.getElementById('targetHours')?.value || '',
                    minStaff: document.getElementById('minStaff')?.value || ''
                }
            }
        };

        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `schedule-backup-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Backup exported successfully!\n\nThe backup file has been downloaded and contains all your schedule data.');
        
    } catch (err) {
        console.error('Export backup failed:', err);
        alert('‚ùå Export Failed\n\nFailed to create backup file. Please try again.');
    }
}

function importBackup() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    
    fileInput.onchange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const backupData = JSON.parse(text);
            
            // Validate backup structure
            if (!backupData.data) {
                throw new Error('Invalid backup file: missing data section');
            }
            
            const confirmRestore = confirm(
                `‚ö†Ô∏è RESTORE BACKUP\n\n` +
                `This will replace ALL current data with the backup from:\n` +
                `${new Date(backupData.timestamp || '').toLocaleString()}\n\n` +
                `Current data will be permanently lost!\n\n` +
                `Are you sure you want to proceed?`
            );
            
            if (!confirmRestore) return;
            
            showLoadingSpinner('Restoring backup...');
            
            // Restore data
            const state = backupData.data;
            employees = state.employees || [];
            scheduleData = state.schedule || {};
            notesData = state.notesData || {};
            bidsData = state.bidsData || {};
            notifications = state.notifications || {};
            ptoRequests = state.ptoRequests || {};
            employeePTOBalances = state.employeePTOBalances || {};
            announcements = state.announcements || [];
            auditLogs = state.auditLogs || [];
            
            // Restore form values
            if (state.month) {
                const monthEl = document.getElementById('scheduleMonth');
                if (monthEl) monthEl.value = state.month;
            }
            if (state.config) {
                if (state.config.targetHours) {
                    const targetEl = document.getElementById('targetHours');
                    if (targetEl) targetEl.value = state.config.targetHours;
                }
                if (state.config.minStaff) {
                    const minStaffEl = document.getElementById('minStaff');
                    if (minStaffEl) minStaffEl.value = state.config.minStaff;
                }
            }
            
            // Save to cloud and regenerate display
            await saveState();
            renderTable();
            updateEmployeeSummary();
            
            hideLoadingSpinner();
            alert('‚úÖ Backup restored successfully!\n\nAll data has been restored from the backup file.');
            
        } catch (err) {
            hideLoadingSpinner();
            console.error('Import backup failed:', err);
            alert(`‚ùå Import Failed\n\n${err.message || 'Failed to restore backup'}\n\nPlease check that the file is a valid backup file.`);
        }
    };
    
    fileInput.click();
}

async function quickBackupRestore() {
    try {
        showLoadingSpinner('Creating quick backup...');
        
        // Save current state to localStorage as emergency backup
        const backupData = {
            version: "1.0",
            timestamp: new Date().toISOString(),
            type: "emergency_backup",
            data: {
                employees,
                schedule: scheduleData,
                notesData,
                bidsData,
                notifications,
                ptoRequests,
                employeePTOBalances,
                announcements,
                auditLogs,
                month: document.getElementById('scheduleMonth')?.value || '',
                config: {
                    targetHours: document.getElementById('targetHours')?.value || '',
                    minStaff: document.getElementById('minStaff')?.value || ''
                }
            }
        };
        
        localStorage.setItem('emergency_backup', JSON.stringify(backupData));
        
        hideLoadingSpinner();
        alert('‚úÖ Emergency backup created!\n\nA backup has been saved locally and can be restored using the "Restore Emergency Backup" option.');
        
    } catch (err) {
        hideLoadingSpinner();
        console.error('Quick backup failed:', err);
        alert('‚ùå Quick Backup Failed\n\nFailed to create emergency backup.');
    }
}

async function restoreEmergencyBackup() {
    try {
        const backupString = localStorage.getItem('emergency_backup');
        if (!backupString) {
            alert('‚ùå No Emergency Backup Found\n\nNo emergency backup is available to restore.');
            return;
        }
        
        const backupData = JSON.parse(backupString);
        
        const confirmRestore = confirm(
            `‚ö†Ô∏è RESTORE EMERGENCY BACKUP\n\n` +
            `This will restore the emergency backup from:\n` +
            `${new Date(backupData.timestamp || '').toLocaleString()}\n\n` +
            `Current data will be replaced!\n\n` +
            `Are you sure you want to proceed?`
        );
        
        if (!confirmRestore) return;
        
        showLoadingSpinner('Restoring emergency backup...');
        
        // Restore data
        const state = backupData.data;
        employees = state.employees || [];
        scheduleData = state.schedule || {};
        notesData = state.notesData || {};
        bidsData = state.bidsData || {};
        notifications = state.notifications || {};
        ptoRequests = state.ptoRequests || {};
        employeePTOBalances = state.employeePTOBalances || {};
        announcements = state.announcements || [];
        auditLogs = state.auditLogs || [];
        
        // Restore form values
        if (state.month) {
            const monthEl = document.getElementById('scheduleMonth');
            if (monthEl) monthEl.value = state.month;
        }
        if (state.config) {
            if (state.config.targetHours) {
                const targetEl = document.getElementById('targetHours');
                if (targetEl) targetEl.value = state.config.targetHours;
            }
            if (state.config.minStaff) {
                const minStaffEl = document.getElementById('minStaff');
                if (minStaffEl) minStaffEl.value = state.config.minStaff;
            }
        }
        
        // Save to cloud and regenerate display
        await saveState();
        renderTable();
        updateEmployeeSummary();
        
        hideLoadingSpinner();
        alert('‚úÖ Emergency backup restored successfully!');
        
    } catch (err) {
        hideLoadingSpinner();
        console.error('Restore emergency backup failed:', err);
        alert(`‚ùå Restore Failed\n\n${err.message || 'Failed to restore emergency backup'}`);
    }
}

// ================== EMPLOYEE ARCHIVE MANAGEMENT ==================

function openEmployeeArchiveModal() {
    const inactiveEmployees = employees.filter(emp => emp.status === 'inactive');
    
    let modalHTML = `
        <div class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>üìÇ Employee Archive</h2>
                    <span class="close" onclick="closeAllModals()">√ó</span>
                </div>
                <div style="padding: 1rem;">
    `;
    
    if (inactiveEmployees.length === 0) {
        modalHTML += `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</div>
                <h3>No Archived Employees</h3>
                <p>All employees are currently active. Archived employees will appear here when you archive them.</p>
            </div>
        `;
    } else {
        modalHTML += `
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-success" onclick="restoreAllEmployees()">‚úÖ Restore All</button>
                <button class="btn btn-danger" onclick="permanentlyDeleteAllInactive()" style="float: right;">üóëÔ∏è Permanently Delete All</button>
            </div>
            <div class="archive-list">
        `;
        
        inactiveEmployees.forEach((emp, index) => {
            const archiveDate = emp.archivedDate ? new Date(emp.archivedDate).toLocaleDateString() : 'Unknown';
            modalHTML += `
                <div class="archive-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; background: #f9fafb;">
                    <div>
                        <div style="font-weight: 600;">${emp.name}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            ${emp.type} ‚Ä¢ Archived: ${archiveDate} ‚Ä¢ Hours: ${emp.targetHours || 0}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="restoreEmployee(${employees.indexOf(emp)})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem;">‚úÖ Restore</button>
                        <button class="btn btn-danger" onclick="permanentlyDeleteEmployee(${employees.indexOf(emp)})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
        });
        
        modalHTML += '</div>';
    }
    
    modalHTML += `
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function showInactiveEmployees() {
    const inactiveCount = employees.filter(emp => emp.status === 'inactive').length;
    
    if (inactiveCount === 0) {
        alert('üìÇ No Archived Employees\n\nAll employees are currently active.');
        return;
    }
    
    // Toggle display of inactive employees in the main employee list
    const showInactive = confirm(
        `üìÇ Show Archived Employees?\n\n` +
        `Found ${inactiveCount} archived employee(s).\n\n` +
        `Click OK to include them in the employee list, or Cancel to keep them hidden.`
    );
    
    if (showInactive) {
        // Re-render employee list including inactive employees
        renderEmployeeList(true); // true = include inactive
        alert('üëª Archived employees are now visible in the employee list with gray backgrounds.');
    }
}

function massArchiveEmployees() {
    const activeEmployees = employees.filter(emp => emp.status !== 'inactive');
    
    if (activeEmployees.length === 0) {
        alert('‚ùå No Active Employees\n\nAll employees are already archived.');
        return;
    }
    
    const selectedEmployees = [];
    let confirmationMessage = `‚ö†Ô∏è MASS ARCHIVE EMPLOYEES\n\nSelect employees to archive:\n\n`;
    
    // Show selection dialog
    const selections = activeEmployees.map(emp => {
        return confirm(`Archive ${emp.name} (${emp.type})?`);
    });
    
    const toArchive = activeEmployees.filter((emp, index) => selections[index]);
    
    if (toArchive.length === 0) {
        alert('No employees selected for archiving.');
        return;
    }
    
    const finalConfirm = confirm(
        `‚ö†Ô∏è FINAL CONFIRMATION\n\n` +
        `You are about to archive ${toArchive.length} employee(s):\n` +
        `${toArchive.map(emp => `‚Ä¢ ${emp.name}`).join('\n')}\n\n` +
        `This will remove them from active schedules but preserve their history.\n\n` +
        `Are you sure?`
    );
    
    if (finalConfirm) {
        recordHistory();
        
        toArchive.forEach(emp => {
            const empIndex = employees.indexOf(emp);
            if (empIndex !== -1) {
                employees[empIndex].status = 'inactive';
                employees[empIndex].archivedDate = new Date().toISOString();
                
                // Archive schedule data
                if (scheduleData[emp.name]) {
                    scheduleData[emp.name + ' (Archived)'] = scheduleData[emp.name];
                    delete scheduleData[emp.name];
                }
            }
        });
        
        renderEmployeeList();
        renderTable();
        saveState();
        
        alert(`‚úÖ Mass Archive Complete\n\n${toArchive.length} employee(s) have been archived successfully.`);
    }
}

function restoreAllEmployees() {
    const inactiveEmployees = employees.filter(emp => emp.status === 'inactive');
    
    if (inactiveEmployees.length === 0) {
        alert('üìÇ No Archived Employees\n\nThere are no employees to restore.');
        return;
    }
    
    const confirmRestore = confirm(
        `‚úÖ RESTORE ALL EMPLOYEES\n\n` +
        `This will restore ${inactiveEmployees.length} archived employee(s) to active status:\n` +
        `${inactiveEmployees.map(emp => `‚Ä¢ ${emp.name}`).join('\n')}\n\n` +
        `Are you sure?`
    );
    
    if (confirmRestore) {
        recordHistory();
        
        inactiveEmployees.forEach(emp => {
            delete emp.status;
            delete emp.archivedDate;
            
            // Restore schedule data if archived version exists
            if (scheduleData[emp.name + ' (Archived)']) {
                scheduleData[emp.name] = scheduleData[emp.name + ' (Archived)'];
                delete scheduleData[emp.name + ' (Archived)'];
            }
        });
        
        renderEmployeeList();
        renderTable();
        saveState();
        closeAllModals();
        
        alert(`‚úÖ All employees restored successfully!\n\n${inactiveEmployees.length} employee(s) are now active.`);
    }
}

function permanentlyDeleteAllInactive() {
    const inactiveEmployees = employees.filter(emp => emp.status === 'inactive');
    
    if (inactiveEmployees.length === 0) {
        alert('üìÇ No Archived Employees\n\nThere are no archived employees to delete.');
        return;
    }
    
    const confirmDelete = confirm(
        `üö® PERMANENTLY DELETE ALL ARCHIVED EMPLOYEES\n\n` +
        `This will PERMANENTLY DELETE ${inactiveEmployees.length} archived employee(s):\n` +
        `${inactiveEmployees.map(emp => `‚Ä¢ ${emp.name}`).join('\n')}\n\n` +
        `‚ö†Ô∏è THIS CANNOT BE UNDONE! ‚ö†Ô∏è\n` +
        `All their data, history, and records will be lost forever.\n\n` +
        `Are you absolutely sure?`
    );
    
    if (confirmDelete) {
        const doubleConfirm = prompt(
            `Type "DELETE ALL" to confirm permanent deletion of all archived employees:`,
            ""
        );
        
        if (doubleConfirm === "DELETE ALL") {
            recordHistory();
            
            inactiveEmployees.forEach(emp => {
                const empIndex = employees.indexOf(emp);
                if (empIndex !== -1) {
                    // Delete all data
                    delete scheduleData[emp.name];
                    delete scheduleData[emp.name + ' (Archived)'];
                    delete notesData[emp.name];
                    
                    employees.splice(empIndex, 1);
                }
            });
            
            renderEmployeeList();
            renderTable();
            saveState();
            closeAllModals();
            
            alert(`All archived employees have been permanently deleted.`);
        } else {
            alert('Deletion cancelled - incorrect confirmation.');
        }
    }
}

async function loadState() {
    console.log('Starting loadState function...');
    const urlParams = new URLSearchParams(window.location.search);
    const portalId = urlParams.get('portal');
    
    let records = null;
    let error = null;
    
    // Load from Supabase only
    try {
        if (typeof supabaseClient !== 'undefined' && supabaseClient !== null) {
            console.log('Attempting to load from Supabase...');
            if (portalId) {
                document.getElementById('manager-view').style.display = 'none';
                document.getElementById('employee-portal').style.display = 'block';
                
                const result = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
                records = result.data;
                error = result.error;
                
                if (records && records.data) {
                    loadAndRenderPortal(portalId, records.data);
                } else {
                    document.getElementById('portal-schedule-view').innerHTML = '<h2>Error</h2><p>Could not load schedule data. Please ensure the manager has saved a schedule.</p>';
                    if (error && error.code !== 'PGRST116') console.error("Portal load error:", error);
                }
                return;
            }

            // Manager view - load from Supabase
            const result = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            records = result.data;
            error = result.error;
            console.log('Supabase load result:', { records: !!records, error });
        } else {
            throw new Error('Supabase client not available - cannot load data');
        }
    } catch (err) {
        console.error("Could not load from cloud:", err);
        error = err;
        
        // Show user-friendly error message
        let userMessage = "Failed to load data from cloud database. ";
        if (err.message && err.message.includes('Supabase client not available')) {
            userMessage = "Cloud database is not available. ";
        } else if (err.code === 'PGRST301') {
            userMessage = "Database connection timeout. ";
        } else if (err.message) {
            userMessage += `Error: ${err.message} `;
        }
        userMessage += "Please check your internet connection and refresh the page.";
        
        // Only show alert for serious errors, not missing data
        if (err.code !== 'PGRST116') { // PGRST116 = no data found, which is normal for new instances
            alert(`‚ùå Load Failed\n\n${userMessage}`);
        }
    }

    if (error && error.code !== 'PGRST116' && !records) {
        console.error("Error loading state:", error);
        // Don't show error for "no data found" (PGRST116) as this is expected for new instances
        if (error.code !== 'PGRST116') {
            let errorDetail = error.message || 'Unknown database error';
            console.warn('Load error details:', errorDetail);
            // Error message already shown in catch block above
        }
    }

    let monthToLoad;
    let needsInitialSave = false;

    if (records && records.data) {
        console.log('Loading saved state...');
        const state = records.data;
        employees = state.employees || [];
        scheduleData = state.schedule || {};
        notesData = state.notesData || {};
        bidsData = state.bidsData || {};
        notifications = state.notifications || {};
        ptoRequests = state.ptoRequests || {};
        employeePTOBalances = state.employeePTOBalances || {};
        announcements = state.announcements || [];
        auditLogs = state.auditLogs || [];
        shiftNotes = state.shiftNotes || {};
        shiftSwaps = state.shiftSwaps || [];
        shiftBids = state.shiftBids || [];
        shiftFeedback = state.shiftFeedback || [];
        notificationQueue = state.notificationQueue || [];
        monthToLoad = state.month;
        autoApprovalRules = state.autoApprovalRules || { enabled: false, rule: 'firstCome' };

        if (state.config) {
            document.getElementById('targetHours').value = state.config.targetHours || 160;
            document.getElementById('minStaff').value = state.config.minStaff || 3;
        }
        console.log('Loaded employees:', employees.length, 'scheduleData keys:', Object.keys(scheduleData).length);
    } else {
        // This block runs only if there is no saved data in the cloud.
        console.log('No saved data found, initializing with default employees...');
        needsInitialSave = true;
        employees = [
            { name: "Dowling, Tina", id: generateUUID(), type: "PT", shifts: "10p-6a", availability: "Fri,Sat", maxDays: "2", targetHours: "64", email: "", hireDate: "2024-01-15" }, 
            { name: "Garcia, Mosserat", id: generateUUID(), type: "PT", shifts: "2p-10:30p", availability: "Sat,Sun", maxDays: "2", targetHours: "64", email: "", hireDate: "2024-02-20" }, 
            { name: "Harvey-Edwin, Jean", id: generateUUID(), type: "PT", shifts: "Varies", availability: "Varies", maxDays: "3", targetHours: "96", email: "", hireDate: "2023-11-10" }, 
            { name: "Heberer, Jacob", id: generateUUID(), type: "FT", shifts: "10a-6:30p", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "160", email: "", hireDate: "2023-08-05" }, 
            { name: "Hosey, Dianna", id: generateUUID(), type: "PT", shifts: "Varies", availability: "Varies", maxDays: "3", targetHours: "96", email: "", hireDate: "2024-03-12" }, 
            { name: "Sifuentes, Stephany", id: generateUUID(), type: "FT", shifts: "6:30p-3a", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "160", email: "", hireDate: "2023-09-01" }, 
            { name: "Keene, Shanetra", id: generateUUID(), type: "FT", shifts: "2p-10:30p", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "160", email: "", hireDate: "2023-07-18" }, 
            { name: "Melgar, Lisa", id: generateUUID(), type: "PT", shifts: "5:30a-2p", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "120", email: "", hireDate: "2024-01-08" }, 
            { name: "Merrick, Tanya", id: generateUUID(), type: "PT", shifts: "6a-2:30p", availability: "Sat,Sun", maxDays: "2", targetHours: "64", email: "", hireDate: "2024-04-22" }, 
            { name: "OPEN POSITION", type: "FT", shifts: "1p-9:30p", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "160" }, 
            { name: "OPEN POSITION", type: "PT", shifts: "6:30p-3a", availability: "Sat,Sun", maxDays: "2", targetHours: "64" },
            { name: "Puebla, Alisia", id: generateUUID(), type: "PT", shifts: "10a-6:30p", availability: "Sat,Sun", maxDays: "2", targetHours: "64", email: "", hireDate: "2024-05-15" }, 
            { name: "Scales, Jack", id: generateUUID(), type: "PT", shifts: "7a-7p", availability: "Sat,Sun", maxDays: "2", targetHours: "96", email: "", hireDate: "2023-12-01" }, 
            { name: "Thaxton, Tequita", id: generateUUID(), type: "PT", shifts: "9:30p-6a", availability: "Mon,Tue,Wed,Thu,Fri", maxDays: "5", targetHours: "96", email: "", hireDate: "2024-06-10" }, 
            { name: "Thompson, Quientia", id: generateUUID(), type: "PT", shifts: "Varies", availability: "Varies", maxDays: "3", targetHours: "96", email: "", hireDate: "2024-07-01" }, 
            { name: "OPEN SHIFTS (Coverage)", type: "Bank" }, 
            { name: "OPEN SHIFTS (Extra)", type: "Bank" },
            { name: "OPEN SHIFTS (Misc)", type: "Bank" } 
        ];
        
        // Initialize PTO balances for all employees
        employees.forEach(emp => {
            if (emp.id && !emp.name.startsWith("OPEN SHIFTS")) {
                employeePTOBalances[emp.id] = {
                    employeeName: emp.name,
                    hireDate: emp.hireDate || "2024-01-01",
                    totalPTODays: emp.type === "FT" ? 20 : 15,
                    usedPTODays: 0,
                    pendingPTODays: 0
                };
            }
        });
        console.log('Initialized default employees:', employees.length);
    }
    
    let updatedEmployees = false;
    employees.forEach(e => {
        if (!e.id && !e.name.startsWith("OPEN SHIFTS")) { e.id = generateUUID(); updatedEmployees = true; }
        if (e.email === undefined && !e.name.startsWith("OPEN SHIFTS") && e.type !== 'Bank') { e.email = ""; updatedEmployees = true; }
        if (!e.hireDate && !e.name.startsWith("OPEN SHIFTS") && e.type !== 'Bank') { 
            e.hireDate = "2024-01-01"; // Default hire date for existing employees
            updatedEmployees = true; 
        }
        // Initialize PTO balance if missing
        if (e.id && !e.name.startsWith("OPEN SHIFTS") && !employeePTOBalances[e.id]) {
            employeePTOBalances[e.id] = {
                employeeName: e.name,
                hireDate: e.hireDate || "2024-01-01",
                totalPTODays: e.type === "FT" ? 20 : 15,
                usedPTODays: 0,
                pendingPTODays: 0
            };
            updatedEmployees = true;
        }
    });

    // Calculate default month if not provided
    if (!monthToLoad) {
        console.log('Calculating default month...');
        const now = new Date();
        let year = now.getFullYear(); 
        let month = now.getMonth() + 1;
        if (now.getDate() > 15) { 
            month++; 
            if (month > 12) { 
                month = 1; 
                year++; 
            } 
        }
        monthToLoad = `${year}-${month.toString().padStart(2, '0')}`;
        console.log('Default month calculated:', monthToLoad);
    }
    
    console.log('Setting month input to:', monthToLoad);
    const scheduleMonthElement = document.getElementById('scheduleMonth');
    if (scheduleMonthElement) {
        scheduleMonthElement.value = monthToLoad;
    }
    
    console.log('Calling generateSchedule with month:', monthToLoad);
    generateSchedule(monthToLoad);
    
    if (needsInitialSave || updatedEmployees) {
        console.log('Saving initial state...');
        await saveState();
    }
    
    console.log('Recording history...');
    recordHistory();
    
    console.log('loadState completed successfully');
}

function loadAndRenderPortal(portalId, state) {
    if (!state) {
        const scheduleView = document.getElementById('portal-schedule-view');
        if (scheduleView) {
            scheduleView.innerHTML = '<h2>Error</h2><p>Could not load schedule data.</p>';
        }
        return;
    }
    
    const employee = state.employees.find(e => e.id === portalId);
    if (!employee) {
        const scheduleView = document.getElementById('portal-schedule-view');
        if (scheduleView) {
            scheduleView.innerHTML = '<h2>Error</h2><p>Invalid portal link.</p>';
        }
        return;
    }
    
    const allBids = state.bidsData || {};
    const allNotifications = state.notifications || {};
    const myNotifications = allNotifications[employee.id] || [];
    const unreadCount = myNotifications.filter(n => !n.read).length;

    // Update notification bell with null check
    const bell = document.getElementById('notification-bell');
    if (bell) {
        bell.innerHTML = unreadCount > 0 ? `üîî<span style="color:red; font-size:12px; position:absolute; top:-5px; right:-5px;">‚óè</span>` : 'üîî';
        bell.onclick = () => {
            const popup = document.getElementById('notification-popup');
            if (!popup) return;
            
            if (popup.style.display === 'block') {
                popup.style.display = 'none';
                return;
            }
            let popupHTML = `<div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold;">Notifications</div><div style="max-height: 300px; overflow-y:auto;">`;
            if (myNotifications.length === 0) {
                popupHTML += `<div style="padding:15px; text-align:center; color:#777;">No new notifications.</div>`;
            } else {
                 myNotifications.forEach(n => {
                    popupHTML += `<div style="padding:10px; border-bottom: 1px solid #eee; ${!n.read ? 'font-weight:bold;' : ''}">${n.message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`;
                });
            }
            popupHTML += '</div>';
            popup.innerHTML = popupHTML;
            popup.style.display = 'block';

            if (unreadCount > 0) {
                markNotificationsAsRead(employee.id);
            }
        };
    }

    // Update page title and employee name with null checks
    document.title = `${employee.name}'s Schedule`;
    
    const employeeNameEl = document.getElementById('portal-employee-name');
    if (employeeNameEl) {
        employeeNameEl.textContent = employee.name;
    }
    
    const titleEl = document.getElementById('portal-title');
    if (titleEl) {
        titleEl.textContent = `Your Schedule for ${new Date(state.month + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}`;
    }

    // Update schedule view with enhanced month-in-advance portal
    renderEnhancedPortalView(portalId, state, 'list');

    // Update PTO balance display
    const ptoBalanceDisplay = document.getElementById('pto-balance-details');
    if (ptoBalanceDisplay) {
        const ptoBalance = state.employeePTOBalances?.[employee.id];
        if (ptoBalance) {
            const remaining = ptoBalance.totalPTODays - ptoBalance.usedPTODays - ptoBalance.pendingPTODays;
            const eligibility = isEmployeeEligibleForPTO(employee.id);
            
            let balanceHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${remaining}</div>
                        <div style="font-size: 12px;">Available</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${ptoBalance.usedPTODays}</div>
                        <div style="font-size: 12px;">Used</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${ptoBalance.pendingPTODays}</div>
                        <div style="font-size: 12px;">Pending</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #0d6efd;">${ptoBalance.totalPTODays}</div>
                        <div style="font-size: 12px;">Total</div>
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <span class="${eligibility.eligible ? 'pto-eligible' : 'pto-ineligible'}">
                        ${eligibility.eligible ? '‚úì Eligible for PTO' : eligibility.reason}
                    </span>
                </div>
            `;
            ptoBalanceDisplay.innerHTML = balanceHTML;
        } else {
            ptoBalanceDisplay.innerHTML = '<p style="text-align: center; color: #666;">PTO balance information not available.</p>';
        }
    }

    // Update PTO request history
    const ptoHistoryList = document.getElementById('pto-history-list');
    if (ptoHistoryList) {
        const employeeRequests = Object.values(state.ptoRequests || {})
            .filter(r => r.employeeId === employee.id)
            .sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));

        if (employeeRequests.length === 0) {
            ptoHistoryList.innerHTML = '<p style="text-align: center; color: #666;">No PTO requests found.</p>';
        } else {
            let historyHTML = '';
            employeeRequests.forEach(request => {
                const statusClass = `pto-status-${request.status}`;
                const startDate = new Date(request.startDate).toLocaleDateString();
                const endDate = new Date(request.endDate).toLocaleDateString();
                const submissionDate = new Date(request.submissionDate).toLocaleDateString();

                historyHTML += `
                    <div class="pto-request-item ${statusClass}">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <strong>${startDate} - ${endDate}</strong>
                            <span style="text-transform: capitalize; font-weight: bold;">${request.status}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 14px;">
                            <div><strong>Days:</strong> ${request.daysRequested}</div>
                            <div><strong>Type:</strong> ${request.requestType}</div>
                            <div><strong>Submitted:</strong> ${submissionDate}</div>
                        </div>
                        ${request.reason ? `<div style="margin-top: 10px; font-size: 14px;"><strong>Comments:</strong> ${request.reason}</div>` : ''}
                        ${request.managerComments ? `<div style="margin-top: 10px; font-size: 14px; color: #dc3545;"><strong>Manager Comments:</strong> ${request.managerComments}</div>` : ''}
                    </div>
                `;
            });
            ptoHistoryList.innerHTML = historyHTML;
        }
    }
    
    // Set up PTO form listeners after rendering
    setupPTOFormListeners();

    // Update bids view with null check
    const bidsView = document.getElementById('portal-bids-view');
    if (bidsView) {
        const openShiftRows = state.employees.filter(e => e.name.startsWith("OPEN SHIFTS"));
        let bidsHTML = '<h2>Available Open Shifts</h2>';
        let openShifts = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const scheduleMonth = new Date(state.month + '-02T12:00:00Z').getMonth();
        openShiftRows.forEach(row => {
            if (state.schedule[row.name]) {
                Object.keys(state.schedule[row.name]).forEach(dateKey => {
                    const shiftText = state.schedule[row.name][dateKey];
                    const shiftDate = new Date(dateKey + 'T12:00:00Z');
                    if (shiftText && shiftDate >= today) {
                        if (shiftDate.getMonth() !== scheduleMonth) return;
                        shiftText.split(',').forEach(shift => {
                            shift = shift.trim();
                            if (shift) openShifts.push({ date: shiftDate, shift, dateKey });
                        });
                    }
                });
            }
        });
        openShifts.sort((a,b) => a.date - b.date);

        if (openShifts.length === 0) { 
            bidsHTML += '<p>There are no open shifts available for bidding at this time.</p>'; 
        } else {
            bidsHTML += '<ul class="bids-list">';
            openShifts.forEach(({ date, shift, dateKey }) => {
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const bidsForShift = allBids[dateKey]?.[shift] || [];
                const hasBid = bidsForShift.includes(employee.id);
                bidsHTML += `<li><div><span class="day-name">${dayName}, ${dateStr}</span></div><div><span>${shift}</span></div><button class="btn ${hasBid ? 'btn-secondary' : 'btn-success'}" onclick="placeBid('${employee.id}', '${dateKey}', '${shift}')" ${hasBid ? 'disabled' : ''}>${hasBid ? 'Bid Placed' : 'Bid on Shift'}</button></li>`;
            });
            bidsHTML += '</ul>';
        }
        bidsView.innerHTML = bidsHTML;
    }
}

// ================== ENHANCED EMPLOYEE PORTAL ==================

function generateMonthInAdvanceSchedule(employee, state, baseMonth = null) {
    const schedules = [];
    const today = new Date();
    const startDate = baseMonth ? new Date(baseMonth + '-01') : new Date(today.getFullYear(), today.getMonth(), 1);
    
    // Generate schedules for current month and next 3 months
    for (let monthOffset = 0; monthOffset < 4; monthOffset++) {
        const currentDate = new Date(startDate.getFullYear(), startDate.getMonth() + monthOffset, 1);
        const monthKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
        
        const monthData = {
            month: monthKey,
            monthName: currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            shifts: [],
            ptoRequests: [],
            openShifts: []
        };
        
        // Get employee schedule for this month
        const employeeSchedule = state.schedule[employee.name] || {};
        
        // Get all dates in this month
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
        
        for (let day = 1; day <= lastDay; day++) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const dateKey = date.toISOString().split('T')[0];
            
            // Employee's assigned shift
            if (employeeSchedule[dateKey]) {
                monthData.shifts.push({
                    date: dateKey,
                    dateObj: date,
                    shift: employeeSchedule[dateKey],
                    note: state.notesData[employee.name]?.[dateKey] || null
                });
            }
            
            // Employee's PTO requests
            const ptoRequest = state.ptoRequests?.[employee.id]?.find(pto => 
                new Date(pto.startDate) <= date && new Date(pto.endDate) >= date
            );
            if (ptoRequest) {
                monthData.ptoRequests.push({
                    date: dateKey,
                    dateObj: date,
                    request: ptoRequest
                });
            }
        }
        
        // Get open shifts for this month
        const openShiftsEmployee = Object.keys(state.schedule).find(name => name.includes('OPEN SHIFTS'));
        if (openShiftsEmployee) {
            const openShiftSchedule = state.schedule[openShiftsEmployee] || {};
            Object.keys(openShiftSchedule).forEach(dateKey => {
                const shiftDate = new Date(dateKey + 'T12:00:00Z');
                if (shiftDate.getFullYear() === currentDate.getFullYear() && 
                    shiftDate.getMonth() === currentDate.getMonth()) {
                    const shifts = openShiftSchedule[dateKey].split(',').map(s => s.trim()).filter(s => s);
                    if (shifts.length > 0) {
                        monthData.openShifts.push({
                            date: dateKey,
                            dateObj: shiftDate,
                            shifts: shifts
                        });
                    }
                }
            });
        }
        
        schedules.push(monthData);
    }
    
    return schedules;
}

function renderEnhancedPortalView(portalId, state, viewMode = 'list') {
    const employee = state.employees.find(e => e.id === portalId);
    if (!employee) return;
    
    const scheduleView = document.getElementById('portal-schedule-view');
    if (!scheduleView) return;
    
    const monthSchedules = generateMonthInAdvanceSchedule(employee, state);
    
    let html = `
        <div class="enhanced-portal-header">
            <h2>Your Schedule - Next 4 Months</h2>
            <div class="view-controls">
                <button onclick="switchPortalView('${portalId}', 'list')" class="${viewMode === 'list' ? 'active' : ''}">üìã List View</button>
                <button onclick="switchPortalView('${portalId}', 'calendar')" class="${viewMode === 'calendar' ? 'active' : ''}">üìÖ Calendar View</button>
                <button onclick="exportPersonalSchedule('${portalId}')" class="export-btn">üíæ Export PDF</button>
            </div>
        </div>
    `;
    
    if (viewMode === 'list') {
        html += renderListView(monthSchedules);
    } else {
        html += renderCalendarView(monthSchedules);
    }
    
    scheduleView.innerHTML = html;
}

function renderListView(monthSchedules) {
    let html = '<div class="list-view">';
    
    monthSchedules.forEach(month => {
        html += `
            <div class="month-section">
                <h3 class="month-header">${month.monthName}</h3>
                <div class="month-content">
        `;
        
        // Combine all events and sort by date
        const allEvents = [];
        
        month.shifts.forEach(shift => {
            allEvents.push({
                date: shift.dateObj,
                type: 'shift',
                content: `üü¢ Shift: ${shift.shift}${shift.note ? ` (${shift.note})` : ''}`
            });
        });
        
        month.ptoRequests.forEach(pto => {
            allEvents.push({
                date: pto.dateObj,
                type: 'pto',
                content: `üå¥ PTO: ${pto.request.status} (${pto.request.reason || 'Personal'})`
            });
        });
        
        month.openShifts.forEach(openShift => {
            allEvents.push({
                date: openShift.dateObj,
                type: 'open',
                content: `üîì Available: ${openShift.shifts.join(', ')}`
            });
        });
        
        allEvents.sort((a, b) => a.date - b.date);
        
        if (allEvents.length === 0) {
            html += '<p class="no-events">No scheduled events for this month</p>';
        } else {
            html += '<ul class="events-list">';
            allEvents.forEach(event => {
                const dayName = event.date.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = event.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                html += `
                    <li class="event-item event-${event.type}">
                        <div class="event-date">
                            <div class="day-name">${dayName}</div>
                            <div class="date-str">${dateStr}</div>
                        </div>
                        <div class="event-content">${event.content}</div>
                    </li>
                `;
            });
            html += '</ul>';
        }
        
        html += '</div></div>';
    });
    
    html += '</div>';
    return html;
}

function renderCalendarView(monthSchedules) {
    let html = '<div class="calendar-view">';
    
    monthSchedules.forEach(month => {
        html += `<div class="calendar-month">
            <h3 class="month-header">${month.monthName}</h3>
            <div class="calendar-grid">`;
        
        // Calendar header
        const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        daysOfWeek.forEach(day => {
            html += `<div class="calendar-header">${day}</div>`;
        });
        
        // Generate calendar days
        const firstDay = new Date(month.month + '-01');
        const lastDay = new Date(firstDay.getFullYear(), firstDay.getMonth() + 1, 0);
        const startCalendar = new Date(firstDay);
        startCalendar.setDate(startCalendar.getDate() - firstDay.getDay());
        
        for (let i = 0; i < 42; i++) { // 6 weeks * 7 days
            const currentDate = new Date(startCalendar);
            currentDate.setDate(startCalendar.getDate() + i);
            
            const isCurrentMonth = currentDate.getMonth() === firstDay.getMonth();
            const dateKey = currentDate.toISOString().split('T')[0];
            
            let dayContent = '';
            let dayClass = 'calendar-day';
            
            if (!isCurrentMonth) dayClass += ' other-month';
            
            // Check for events on this day
            const shift = month.shifts.find(s => s.date === dateKey);
            const pto = month.ptoRequests.find(p => p.date === dateKey);
            const openShift = month.openShifts.find(o => o.date === dateKey);
            
            if (shift) {
                dayContent += `<div class="day-event shift-event">${shift.shift}</div>`;
                dayClass += ' has-shift';
            }
            
            if (pto) {
                dayContent += `<div class="day-event pto-event">PTO</div>`;
                dayClass += ' has-pto';
            }
            
            if (openShift) {
                dayContent += `<div class="day-event open-event">${openShift.shifts.length} open</div>`;
                dayClass += ' has-open';
            }
            
            html += `
                <div class="${dayClass}">
                    <div class="day-number">${currentDate.getDate()}</div>
                    ${dayContent}
                </div>
            `;
        }
        
        html += '</div></div>';
    });
    
    html += '</div>';
    return html;
}

function switchPortalView(portalId, viewMode) {
    // Re-load the current state and render with new view mode
    fetch(window.location.href)
        .then(() => loadState())
        .then(() => {
            const state = {
                employees,
                schedule: scheduleData,
                notesData,
                bidsData,
                notifications,
                ptoRequests,
                employeePTOBalances,
                announcements,
                auditLogs
            };
            renderEnhancedPortalView(portalId, state, viewMode);
        })
        .catch(err => {
            console.error('Failed to switch view:', err);
            alert('Failed to switch view. Please refresh the page.');
        });
}

function exportPersonalSchedule(portalId) {
    try {
        const employee = employees.find(e => e.id === portalId);
        if (!employee) {
            alert('Employee not found');
            return;
        }
        
        const state = {
            employees,
            schedule: scheduleData,
            notesData,
            bidsData,
            notifications,
            ptoRequests,
            employeePTOBalances,
            announcements,
            auditLogs
        };
        
        const monthSchedules = generateMonthInAdvanceSchedule(employee, state);
        
        // Generate text content for export
        let exportContent = `${employee.name} - Personal Schedule\n`;
        exportContent += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        monthSchedules.forEach(month => {
            exportContent += `${month.monthName}\n`;
            exportContent += '='.repeat(month.monthName.length) + '\n\n';
            
            const allEvents = [];
            
            month.shifts.forEach(shift => {
                allEvents.push({
                    date: shift.dateObj,
                    content: `Shift: ${shift.shift}${shift.note ? ` (${shift.note})` : ''}`
                });
            });
            
            month.ptoRequests.forEach(pto => {
                allEvents.push({
                    date: pto.dateObj,
                    content: `PTO: ${pto.request.status} (${pto.request.reason || 'Personal'})`
                });
            });
            
            allEvents.sort((a, b) => a.date - b.date);
            
            if (allEvents.length === 0) {
                exportContent += 'No scheduled events\n\n';
            } else {
                allEvents.forEach(event => {
                    const dateStr = event.date.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    exportContent += `${dateStr}: ${event.content}\n`;
                });
                exportContent += '\n';
            }
        });
        
        // Create downloadable file
        const blob = new Blob([exportContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${employee.name.replace(/\s+/g, '_')}_schedule_${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Schedule exported successfully!');
        
    } catch (err) {
        console.error('Export failed:', err);
        alert('‚ùå Export failed. Please try again.');
    }
}

    async function resetSavedState() { 
        if (confirm("Are you sure you want to clear ALL saved data?")) { 
            try {
                if (typeof supabaseClient !== 'undefined' && supabaseClient !== null) {
                    const { error } = await supabaseClient.from('schedules').delete().eq('id', 1);
                    if (error) throw error;
                    console.log('‚úÖ Data cleared from cloud');
                } else {
                    throw new Error('Supabase client not available');
                }
                location.reload();
            } catch (err) {
                console.error('Failed to clear data:', err);
                alert('Failed to clear data from cloud database. Please try again.');
            }
        } 
    }
    
    function openEmployeeModal(index = -1) {
        clearEmployeeForm();
        if (index > -1) {
            const emp = employees[index];
            document.getElementById('modal-title').textContent = 'Edit Employee';
            document.getElementById('empIndex').value = index;
            document.getElementById('empId').value = emp.id;
            document.getElementById('newName').value = emp.name;
            document.getElementById('newType').value = emp.type;
            document.getElementById('newShifts').value = emp.shifts;
            document.getElementById('newAvailability').value = emp.availability;
            document.getElementById('newMaxDays').value = emp.maxDays || 0;
            document.getElementById('newTargetHours').value = emp.targetHours || 0;
        }
        renderEmployeeList();
        document.getElementById('employeeModal').style.display = 'block';
    }

    function closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    
    function clearEmployeeForm() {
        document.getElementById('modal-title').textContent = 'Add New Employee';
        document.getElementById('empIndex').value = '-1';
        document.getElementById('empId').value = '';
        document.getElementById('newName').value = ''; document.getElementById('newType').value = 'FT'; document.getElementById('newShifts').value = ''; document.getElementById('newAvailability').value = ''; document.getElementById('newMaxDays').value = '0'; document.getElementById('newTargetHours').value = '0'; document.getElementById('newEmail').value = ''; document.getElementById('newHireDate').value = '';
    }

    function renderEmployeeList() {
        const table = document.getElementById('employee-list-table');
        table.innerHTML = '<thead><tr><th>Name</th><th>Type</th><th>Email</th><th>Actions</th></tr></thead><tbody>' +
            getSortedEmployees().map((emp) => {
                if (emp.name.startsWith('OPEN SHIFTS')) return '';
                const originalIndex = employees.findIndex(originalEmp => originalEmp.name === emp.name);
                return `<tr><td>${emp.name}</td><td>${emp.type}</td><td>${emp.email || ''}</td><td><button class="btn btn-secondary btn-sm" onclick="editEmployee(${originalIndex})">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${originalIndex})">Del</button> <button class="btn btn-primary btn-sm" onclick="copyPortalLink(${originalIndex})">Copy Portal Link</button></td></tr>`;
            }).join('') + '</tbody>';
    }
    
    function copyPortalLink(index) {
        const employee = employees[index];
        if (!employee.id) {
            alert("Could not generate link. Please save this employee again to create an ID.");
            return;
        }
        const url = new URL(window.location.href);
        url.search = `?portal=${employee.id}`;
        navigator.clipboard.writeText(url.href).then(() => {
            alert(`‚úÖ Link for ${employee.name} copied to clipboard.`);
        });
    }

    function saveEmployee() {
        recordHistory();
        const name = document.getElementById('newName').value.trim();
        if (!name) { alert('Employee name cannot be empty.'); return; }
        
        const hireDate = document.getElementById('newHireDate').value;
        if (!hireDate && !name.startsWith('OPEN SHIFTS')) { 
            alert('Hire date is required for all employees.'); 
            return; 
        }
        const index = parseInt(document.getElementById('empIndex').value);
        let empId = document.getElementById('empId').value;
        if (!empId) { empId = generateUUID(); }
        const empData = { 
            name, 
            id: empId,
            type: document.getElementById('newType').value, 
            shifts: document.getElementById('newShifts').value.trim(), 
            availability: document.getElementById('newAvailability').value.trim(), 
            email: document.getElementById('newEmail').value.trim(),
            hireDate: document.getElementById('newHireDate').value,
            maxDays: document.getElementById('newMaxDays').value, 
            targetHours: document.getElementById('newTargetHours').value 
        };

        if (index > -1) {
            const oldName = employees[index].name;
            if (oldName !== name) {
                scheduleData[name] = scheduleData[oldName]; notesData[name] = notesData[oldName];
                delete scheduleData[oldName]; delete notesData[oldName];
            }
            employees[index] = empData;
        } else {
            employees.push(empData);
            scheduleData[name] = {}; notesData[name] = {};
            // Initialize PTO balance for new employee
            if (empData.id) {
                employeePTOBalances[empData.id] = {
                    employeeName: empData.name,
                    hireDate: empData.hireDate || new Date().toISOString().split('T')[0],
                    totalPTODays: empData.type === "FT" ? 20 : 15,
                    usedPTODays: 0,
                    pendingPTODays: 0
                };
            }
        }
        renderEmployeeList(); renderTable(); saveState(); closeAllModals();
    }

    function editEmployee(index) {
        const emp = employees[index];
        document.getElementById('modal-title').textContent = 'Edit Employee';
        document.getElementById('empIndex').value = index;
        document.getElementById('empId').value = emp.id;
        document.getElementById('newName').value = emp.name;
        document.getElementById('newType').value = emp.type;
        document.getElementById('newShifts').value = emp.shifts || '';
        document.getElementById('newAvailability').value = emp.availability || '';
        document.getElementById('newEmail').value = emp.email || '';
        document.getElementById('newHireDate').value = emp.hireDate || '';
        document.getElementById('newMaxDays').value = emp.maxDays || 0;
        document.getElementById('newTargetHours').value = emp.targetHours || 0;
        document.getElementById('employeeModal').style.display = 'block';
    }
    
    function deleteEmployee(index) { 
        const employee = employees[index];
        if (!employee) return;
        
        const choice = confirm(
            `‚ö†Ô∏è Archive Employee: ${employee.name}\n\n` +
            `Choose an option:\n` +
            `‚Ä¢ OK = Archive employee (preserve history, hide from schedule)\n` +
            `‚Ä¢ Cancel = Keep employee active\n\n` +
            `Note: Archived employees can be restored later.`
        );
        
        if (choice) {
            recordHistory(); 
            
            // Mark employee as inactive instead of deleting
            employees[index].status = 'inactive';
            employees[index].archivedDate = new Date().toISOString();
            
            // Remove from active schedule but preserve historical data
            if (scheduleData[employee.name]) {
                // Keep the schedule data but mark it as archived
                scheduleData[employee.name + ' (Archived)'] = scheduleData[employee.name];
                delete scheduleData[employee.name];
            }
            
            renderEmployeeList(); 
            renderTable(); 
            saveState(); 
            
            alert(`‚úÖ ${employee.name} has been archived.\n\nTheir history is preserved and they can be restored from the admin panel.`);
        } 
    }

    function permanentlyDeleteEmployee(index) {
        const employee = employees[index];
        if (!employee) return;
        
        const confirmDelete = confirm(
            `üö® PERMANENT DELETE: ${employee.name}\n\n` +
            `This will permanently delete ALL data for this employee:\n` +
            `‚Ä¢ Personal information\n` +
            `‚Ä¢ Schedule history\n` +
            `‚Ä¢ Notes and records\n\n` +
            `This action CANNOT be undone!\n\n` +
            `Are you absolutely sure?`
        );
        
        if (confirmDelete) {
            const doubleConfirm = prompt(
                `Type "DELETE" to confirm permanent deletion of ${employee.name}:`,
                ""
            );
            
            if (doubleConfirm === "DELETE") {
                recordHistory(); 
                delete scheduleData[employee.name]; 
                delete notesData[employee.name]; 
                
                // Also delete archived version if it exists
                delete scheduleData[employee.name + ' (Archived)'];
                
                employees.splice(index, 1); 
                renderEmployeeList(); 
                renderTable(); 
                saveState(); 
                
                alert(`${employee.name} has been permanently deleted.`);
            } else {
                alert('Deletion cancelled - incorrect confirmation.');
            }
        }
    }

    function restoreEmployee(index) {
        const employee = employees[index];
        if (!employee || employee.status !== 'inactive') return;
        
        if (confirm(`Restore ${employee.name} to active status?`)) {
            recordHistory();
            
            // Restore employee to active status
            delete employee.status;
            delete employee.archivedDate;
            
            // Restore schedule data if archived version exists
            if (scheduleData[employee.name + ' (Archived)']) {
                scheduleData[employee.name] = scheduleData[employee.name + ' (Archived)'];
                delete scheduleData[employee.name + ' (Archived)'];
            }
            
            renderEmployeeList();
            renderTable();
            saveState();
            
            alert(`‚úÖ ${employee.name} has been restored to active status.`);
        }
    }

    function openNoteModal() {
        if (contextMenuTarget) {
            const { employeeName, dateKey } = contextMenuTarget;
            document.getElementById('noteText').value = notesData[employeeName]?.[dateKey] || '';
            document.getElementById('noteModal').style.display = 'block';
        }
    }

    function saveNote() {
        if (contextMenuTarget) {
            recordHistory();
            const { employeeName, dateKey } = contextMenuTarget;
            if (!notesData[employeeName]) notesData[employeeName] = {};
            notesData[employeeName][dateKey] = document.getElementById('noteText').value;
            closeAllModals(); renderTable(); saveState();
        }
    }

    function copyEmployeeListForExcel() {
        let excelString = 'Name\tType\tShifts\tMax Days/Week\tTarget Hours\tAvailability\n';
        getSortedEmployees().forEach(emp => { if (!emp.name.startsWith('OPEN SHIFTS')) excelString += `${emp.name}\t${emp.type}\t${emp.shifts}\t${emp.maxDays || 0}\t${emp.targetHours || 0}\t${emp.availability}\n`; });
        navigator.clipboard.writeText(excelString).then(() => alert('‚úÖ Employee List Copied!'));
    }

    function copyScheduleForExcel() {
        const sortedEmployees = getSortedEmployees();
        let excelString = sortedEmployees.map(emp => currentDates.map(date => { const dateKey = date.toISOString().split('T')[0]; const shift = scheduleData[emp.name]?.[dateKey] || ''; const note = notesData[emp.name]?.[dateKey] || ''; return note ? `${shift} (${note})` : shift; }).join('\t')).join('\n');
        navigator.clipboard.writeText(excelString).then(() => alert('‚úÖ Schedule Grid Copied (Shifts Only)!'));
    }

   function copyOpenShiftsForExcel() {
        let openShiftText = "Date\tDay\tShift\tStatus\n";
        const openShiftRows = employees.filter(e => e.name.startsWith('OPEN SHIFTS'));
        let shiftsFound = [];
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            openShiftRows.forEach(emp => {
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift) {
                    shift.split(',').forEach(s => {
                        if (s.trim()) {
                            const month = date.getMonth() + 1;
                            const day = date.getDate();
                            const year = date.getFullYear();
                            const formattedDate = `${month}/${day}/${year}`;
                            const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'short' });
                            shiftsFound.push({ date: formattedDate, day: dayOfWeek, shift: s.trim(), status: 'Available', originalDate: date });
                        }
                    });
                }
            });
        });
        
        shiftsFound.sort((a,b) => a.originalDate - b.originalDate);
        openShiftText += shiftsFound.map(s => `${s.date}\t${s.day}\t${s.shift}\t${s.status}`).join('\n');
        
        navigator.clipboard.writeText(openShiftText).then(() => { alert('‚úÖ Open Shifts List Copied in Excel Format!'); });
    }

function exportJSON() {
        const backupData = { employees, scheduleData, notesData, bidsData, notifications, month: document.getElementById('scheduleMonth')?.value || '', config: { targetHours: document.getElementById('targetHours')?.value || '', minStaff: document.getElementById('minStaff')?.value || '' } };
        const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `schedule_backup_${backupData.month}.json`; a.click(); URL.revokeObjectURL(a.href);
        
        // Close modal after export
        closeAllModals();
        showNotification('‚úÖ Data exported successfully!', 'success');
    }

    function openImportExportModal() {
        document.getElementById('importExportModal').style.display = 'block';
    }

    function handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = readerEvent => {
            try {
                const content = JSON.parse(readerEvent.target.result);
                if (content.employees && content.scheduleData && content.month) {
                    if (confirm('‚ö†Ô∏è This will replace all current data. Are you sure you want to continue?')) {
                        recordHistory();
                        employees = content.employees; 
                        scheduleData = content.scheduleData; 
                        notesData = content.notesData || {}; 
                        bidsData = content.bidsData || {}; 
                        notifications = content.notifications || {};
                        
                        // Update UI with imported config
                        if (content.config) {
                            document.getElementById('targetHours').value = content.config.targetHours || 160;
                            document.getElementById('minStaff').value = content.config.minStaff || 3;
                        }
                        
                        generateSchedule(content.month); 
                        saveState();
                        closeAllModals();
                        showNotification('‚úÖ Data imported successfully!', 'success');
                    }
                } else { 
                    showNotification('‚ùå Invalid backup file format. Please select a valid JSON backup file.', 'error'); 
                }
            } catch (error) { 
                showNotification('‚ùå Error reading file. Please check the file format.', 'error'); 
            }
        };
        reader.readAsText(file, 'UTF-8');
        
        // Reset file input
        event.target.value = '';
    }

 function importJSON() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = readerEvent => {
                try {
                    const content = JSON.parse(readerEvent.target.result);
                    if (content.employees && content.scheduleData && content.month) {
                        recordHistory();
                        employees = content.employees; scheduleData = content.scheduleData; notesData = content.notesData || {}; bidsData = content.bidsData || {}; notifications = content.notifications || {};
                        // ... rest of function
                        generateSchedule(content.month); saveState();
                        alert('‚úÖ Backup successfully imported!');
                    } else { alert('‚ùå Invalid backup file format.'); }
                } catch (error) { alert('‚ùå Error reading file.'); }
            };
            reader.readAsText(file, 'UTF-8');
        }
        input.click();
    }
    function applyShiftTemplate(employeeName, templateName) {
        recordHistory();
        const template = shiftTemplates[templateName];
        const dayMap = {0: 'Sun', 1: 'Mon', 2: 'Tue', 3: 'Wed', 4: 'Thu', 5: 'Fri', 6: 'Sat'};
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const dayName = dayMap[date.getDay()];
            if (template[dayName]) {
                scheduleData[employeeName][dateKey] = template[dayName];
            }
        });
        renderTable();
        saveState();
        alert(`‚úÖ Applied ${templateName} template to ${employeeName}`);
    }

    function getSuggestedShift(employeeName, dateKey) {
        const employee = employees.find(e => e.name === employeeName);
        if (!employee || employee.name.startsWith('OPEN SHIFTS')) return '';
        
        const date = new Date(dateKey + 'T12:00:00Z');
        const dayOfWeek = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getUTCDay()];
        
        if (!employee.availability.toLowerCase().includes(dayOfWeek)) return '';
        
        let currentHours = 0;
        Object.values(scheduleData[employeeName] || {}).forEach(shift => {
            if (shift && shift.toUpperCase() !== 'PTO') {
                currentHours += shiftsInfo[shift] || 0;
            }
        });
        
        const targetHours = employee.targetHours || (employee.type === 'FT' ? 160 : 0);
        if (targetHours > 0 && currentHours >= targetHours) return '';
        
        return employee.shifts !== 'Varies' ? employee.shifts : '10a-6:30p';
    }

    function showSuggestion(employeeName, dateKey) {
        const suggestion = getSuggestedShift(employeeName, dateKey);
        if (suggestion) {
            recordHistory();
            scheduleData[employeeName][dateKey] = suggestion;
            renderTable();
            saveState();
            alert(`‚úÖ Applied suggested shift: ${suggestion}`);
        } else {
            alert('No suggestion available for this employee/date');
        }
    }

    function validateSchedule() {
        const warnings = [];
        const errors = [];
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0;
            
            employees.forEach(emp => {
                const shift = scheduleData[emp.name]?.[dateKey] || '';
                if (shift && shift.toUpperCase() !== 'PTO' && !emp.name.startsWith('OPEN SHIFTS')) {
                    staffCount++;
                }
            });
            
            const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
            if (staffCount < minStaff) {
                warnings.push(`${date.toLocaleDateString()}: Only ${staffCount} staff scheduled (min: ${minStaff})`);
            }
        });
        
        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS')) return;
            
            let totalHours = 0;
            Object.values(scheduleData[emp.name] || {}).forEach(shift => {
                if (shift && shift.toUpperCase() !== 'PTO') {
                    totalHours += shiftsInfo[shift] || 0;
                }
            });
            
            const targetHours = emp.targetHours || (emp.type === 'FT' ? 160 : 0);
            if (targetHours > 0 && totalHours > targetHours * 1.2) {
                errors.push(`${emp.name}: ${totalHours}h scheduled (target: ${targetHours}h)`);
            }
        });
        
        return { warnings, errors };
    }

    function showValidationResults() {
        const { warnings, errors } = validateSchedule();
        let message = '';
        
        if (errors.length > 0) {
            message += '‚ùå ERRORS:\n' + errors.join('\n') + '\n\n';
        }
        if (warnings.length > 0) {
            message += '‚ö†Ô∏è WARNINGS:\n' + warnings.join('\n');
        }
        
        if (message) {
            alert(message);
        } else {
            alert('‚úÖ Schedule validation passed!');
        }
    }

    function clearEmployeeSchedule(employeeName) {
        if (!confirm(`Clear all shifts for ${employeeName}?`)) return;
        
        recordHistory();
        scheduleData[employeeName] = {};
        renderTable();
        saveState();
        alert(`‚úÖ Cleared all shifts for ${employeeName}`);
    }

    function printSchedule() {
        const printWindow = window.open('', '_blank');
        const scheduleTable = document.getElementById('schedule-table').outerHTML;
        
        printWindow.document.write(`
            <html>
            <head>
                <title>Schedule - ${document.getElementById('scheduleMonth').value}</title>
                <style>
                    body { font-family: Arial, sans-serif; font-size: 10pt; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #000; padding: 4px; text-align: center; }
                    .employee-name { text-align: left; font-weight: bold; }
                    .open-shift-row { background-color: #f0f0f0; }
                    @page { size: landscape; margin: 0.5in; }
                </style>
            </head>
            <body>
                <h2>Schedule for ${document.getElementById('scheduleMonth').value}</h2>
                ${scheduleTable}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.print();
    }

    function openBulkPTOModal() {
        const select = document.getElementById('ptoEmployee');
        select.innerHTML = employees.filter(e => !e.name.startsWith('OPEN SHIFTS'))
            .map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        
        if (currentDates.length > 0) {
            document.getElementById('ptoStartDate').value = currentDates[0].toISOString().split('T')[0];
            document.getElementById('ptoEndDate').value = currentDates[currentDates.length - 1].toISOString().split('T')[0];
        }
        
        document.getElementById('bulkPTOModal').style.display = 'block';
    }

    function applyBulkPTO() {
        const employeeName = document.getElementById('ptoEmployee').value;
        const startDate = new Date(document.getElementById('ptoStartDate').value + 'T12:00:00Z');
        const endDate = new Date(document.getElementById('ptoEndDate').value + 'T12:00:00Z');
        
        if (!employeeName || !startDate || !endDate) {
            alert('Please fill in all fields');
            return;
        }
        
        if (startDate > endDate) {
            alert('Start date must be before end date');
            return;
        }
        
        recordHistory();
        
        let ptoCount = 0;
        currentDates.forEach(date => {
            if (date >= startDate && date <= endDate) {
                const dateKey = date.toISOString().split('T')[0];
                const originalShift = scheduleData[employeeName]?.[dateKey] || '';
                
                if (originalShift && originalShift.toUpperCase() !== 'PTO') {
                    executePTO(employeeName, dateKey, originalShift);
                    ptoCount++;
                }
            }
        });
        
        renderTable();
        closeAllModals();
        alert(`‚úÖ Applied PTO to ${ptoCount} days for ${employeeName}`);
    }

    function openEmailModal() {
        const select = document.getElementById('emailEmployee');
        select.innerHTML = employees.filter(e => !e.name.startsWith('OPEN SHIFTS'))
            .map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        
        document.getElementById('emailModal').style.display = 'block';
    }

    function generateEmail() {
        const employeeName = document.getElementById('emailEmployee').value;
        const emailAddress = document.getElementById('emailAddress').value;
        
        if (!employeeName || !emailAddress) {
            alert('Please select an employee and enter an email address');
            return;
        }
        
        let scheduleText = `Schedule for ${employeeName} - ${document.getElementById('scheduleMonth').value}\n\n`;
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[employeeName]?.[dateKey] || '';
            const note = notesData[employeeName]?.[dateKey] || '';
            
            if (shift) {
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                scheduleText += `${dayName}, ${dateStr}: ${shift}`;
                if (note) scheduleText += ` (${note})`;
                scheduleText += '\n';
            }
        });
        
        let totalHours = 0;
        Object.values(scheduleData[employeeName] || {}).forEach(shift => {
            if (shift && shift.toUpperCase() !== 'PTO') {
                totalHours += shiftsInfo[shift] || 0;
            }
        });
        
        scheduleText += `\nTotal Hours: ${totalHours}`;
        
        const emailContent = `
            <strong>To:</strong> ${emailAddress}<br>
            <strong>Subject:</strong> Your Work Schedule - ${document.getElementById('scheduleMonth').value}<br><br>
            <strong>Message:</strong><br>
            <pre>${scheduleText}</pre>
        `;
        
        document.getElementById('emailContent').innerHTML = emailContent;
        document.getElementById('emailPreview').style.display = 'block';
    }

    function sendEmail() {
        const employeeName = document.getElementById('emailEmployee').value;
        const emailAddress = document.getElementById('emailAddress').value;
        
        let scheduleText = `Schedule for ${employeeName} - ${document.getElementById('scheduleMonth').value}\r\n\r\n`;
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[employeeName]?.[dateKey] || '';
            const note = notesData[employeeName]?.[dateKey] || '';
            
            if (shift) {
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                scheduleText += `${dayName}, ${dateStr}: ${shift}`;
                if (note) scheduleText += ` (${note})`;
                scheduleText += '\r\n';
            }
        });
        
        let totalHours = 0;
        Object.values(scheduleData[employeeName] || {}).forEach(shift => {
            if (shift && shift.toUpperCase() !== 'PTO') {
                totalHours += shiftsInfo[shift] || 0;
            }
        });
        
        scheduleText += `\r\nTotal Hours: ${totalHours}`;
        
        const subject = `Your Work Schedule - ${document.getElementById('scheduleMonth').value}`;
        const mailtoLink = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(scheduleText)}`;
        
        window.open(mailtoLink, '_blank');
        closeAllModals();
    }

    function openExcelImportModal() {
        const fileInput = document.getElementById('excel-file-input');
        fileInput.value = '';
        document.getElementById('excelImportModal').style.display = 'block';
    }

function sendChangeNotification() {
        if (!notificationInfo) return;

        const { employeeName, dateKey, originalShift, newShift } = notificationInfo;
        const date = new Date(dateKey + 'T12:00:00Z');
        const dateString = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

        const subject = "Update to your work schedule";
        const body = `Hi ${employeeName.split(',')[1].trim()},\n\nPlease note a change has been made to your schedule for ${dateString}.\n\n- Your previous shift was: ${originalShift}\n- Your new shift is: ${newShift}\n\nPlease check your employee portal for the most up-to-date schedule.\n\nThank you`;

        const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(mailtoLink, '_blank');
        
        closeAllModals();
        notificationInfo = null; // Clear the info after use
    }
    function importFromExcel() {
        const fileInput = document.getElementById('excel-file-input');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a file before processing.');
            return;
        }
        if (!currentDates.length) {
            alert('Please ensure a month is loaded in the schedule before importing.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates:true});

                let firstVisibleSheetName = null;
                for (const sheetName of workbook.SheetNames) {
                    if (!workbook.Sheets[sheetName].Hidden) {
                        firstVisibleSheetName = sheetName;
                        break;
                    }
                }

                if (!firstVisibleSheetName) {
                    throw new Error("No visible sheets were found in the workbook.");
                }

                const worksheet = workbook.Sheets[firstVisibleSheetName];
                const sheetData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                if (sheetData.length < 4) {
                    throw new Error("The visible sheet must have at least 4 rows to import.");
                }
                
                recordHistory();
                clearSchedule(false);

                const dateHeaders = sheetData[1];
                const appMonth = currentDates[0].getMonth();
                const appYear = currentDates[0].getFullYear();
                let shiftsImported = 0;
                let skippedShifts = 0;

                for (let i = 3; i < sheetData.length; i++) {
                    const row = sheetData[i];
                    const employeeName = row[0];
                    
                    if (employeeName && employees.some(emp => emp.name === employeeName)) {
                        for (let j = 1; j < dateHeaders.length; j++) {
                            const headerDate = dateHeaders[j];
                            const shift = row[j];
                            
                            if (headerDate instanceof Date && !isNaN(headerDate) && shift != null && String(shift).trim() !== '') {
                                if (headerDate.getMonth() === appMonth && headerDate.getFullYear() === appYear) {
                                    headerDate.setUTCHours(12, 0, 0, 0);
                                    const dateKey = headerDate.toISOString().split('T')[0];

                                    if (!scheduleData[employeeName]) {
                                        scheduleData[employeeName] = {};
                                    }
                                    scheduleData[employeeName][dateKey] = String(shift).trim();
                                    shiftsImported++;
                                } else {
                                    skippedShifts++;
                                }
                            }
                        }
                    }
                }

                renderTable();
                saveState();
                closeAllModals();

                let alertMessage = `‚úÖ Import successful! ${shiftsImported} shifts were loaded from sheet "${firstVisibleSheetName}".`;
                if (skippedShifts > 0) {
                    alertMessage += `\n\n(Note: ${skippedShifts} shifts were skipped because their dates did not match the selected month.)`;
                }
                alert(alertMessage);

            } catch (error) {
                console.error("Excel import failed:", error);
                alert(`‚ùå Import Failed. Please ensure the file is not corrupt and matches the required format.\n\nError: ${error.message}`);
                closeAllModals();
            }
        };
        reader.readAsArrayBuffer(file);
    }
// Replace your existing openBidsModal function with this new version.

    async function openBidsModal() {
        // --- NEW: First, fetch the most recent data from Supabase ---
        const { data: records, error } = await supabaseClient
            .from('schedules')
            .select('data')
            .eq('id', 1)
            .single();

        if (error || !records || !records.data) {
            alert("‚ùå Could not load bid data from the cloud. Check the console for errors.");
            console.error("Error loading bids:", error);
            return;
        }
        
        // Update the local bidsData variable with the fresh data from the cloud
        bidsData = records.data.bidsData || {};
        // --- END NEW LOGIC ---

        const container = document.getElementById('bids-container');
        container.innerHTML = '';
        const openShiftRows = employees.filter(e => e.name.startsWith("OPEN SHIFTS"));
        let openShifts = [];

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        openShiftRows.forEach(row => {
            if(scheduleData[row.name]) {
                Object.keys(scheduleData[row.name]).forEach(dateKey => {
                    const shiftText = scheduleData[row.name][dateKey];
                    const shiftDate = new Date(dateKey + 'T12:00:00Z');

                    if (shiftText && shiftDate >= today) {
                        shiftText.split(',').forEach(shift => {
                            shift = shift.trim();
                            if (shift) openShifts.push({ date: shiftDate, shift, dateKey, source: row.name });
                        });
                    }
                });
            }
        });

        openShifts.sort((a,b) => a.date - b.date);

        if (openShifts.length === 0) {
            container.innerHTML = '<p>No open shifts are currently available.</p>';
        } else {
            let hasBids = false;
            openShifts.forEach(({ date, shift, dateKey, source }) => {
                const bidders = bidsData[dateKey]?.[shift] || [];
                if (bidders.length > 0) {
                    hasBids = true;
                    const shiftElement = document.createElement('div');
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    shiftElement.innerHTML = `<h4>${shift} on ${dateStr}</h4>`;
                    
                    bidders.forEach(empId => {
                        const employee = employees.find(e => e.id === empId);
                        if (employee) {
                            let totalHours = 0;
                            Object.values(scheduleData[employee.name] || {}).forEach(s => {
                                if (s && s.toUpperCase() !== 'PTO') totalHours += shiftsInfo[s] || 0;
                            });

                            const weekStart = new Date(date);
                            weekStart.setUTCHours(0,0,0,0);
                            weekStart.setDate(weekStart.getDate() - weekStart.getUTCDay());
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekEnd.getDate() + 6);
                            
                            let shiftsThisWeek = 0;
                            for (let d = new Date(weekStart); d <= weekEnd; d.setDate(d.getDate() + 1)) {
                                const key = d.toISOString().split('T')[0];
                                if(scheduleData[employee.name]?.[key] && scheduleData[employee.name][key].toUpperCase() !== 'PTO') {
                                    shiftsThisWeek++;
                                }
                            }
                            
                            const dayAbbreviations = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                            const dayOfWeek = dayAbbreviations[date.getUTCDay()];
                            const isAvailable = employee.availability ? employee.availability.toLowerCase().includes(dayOfWeek) : true;

                            const bidderElement = document.createElement('div');
                            bidderElement.className = 'bid-item';
                            bidderElement.innerHTML = `
                                <span>${employee.name}</span>
                                <span class="bid-stats">
                                    Stats: ${totalHours.toFixed(1)} Hrs | ${shiftsThisWeek} Shifts this week | ${isAvailable ? '‚úÖ Available' : '‚ùå Conflict'}
                                </span>
                                <button class="btn btn-success btn-sm" style="float: right; margin-top: -20px;" onclick="approveBid('${empId}', '${dateKey}', '${shift}', '${source}')">Approve</button>
                            `;
                            shiftElement.appendChild(bidderElement);
                        }
                    });
                    container.appendChild(shiftElement);
                }
            });

            if (!hasBids) {
                container.innerHTML = '<p>No bids have been placed on open shifts yet.</p>';
            }
        }
        document.getElementById('bidsModal').style.display = 'block';
    }
   // Replace your existing approveBid function with this final async version.

   async function approveBid(employeeId, dateKey, shift, sourceRowName) {
        const bidders = [...(bidsData[dateKey]?.[shift] || [])];
        const winner = employees.find(e => e.id === employeeId);
        if (!winner) { alert('Error: Could not find employee.'); return; }
        
        recordHistory();

        scheduleData[winner.name][dateKey] = shift;
        const openShiftsOnDay = scheduleData[sourceRowName][dateKey].split(',').map(s => s.trim());
        const indexToRemove = openShiftsOnDay.indexOf(shift);
        if (indexToRemove > -1) { openShiftsOnDay.splice(indexToRemove, 1); }
        scheduleData[sourceRowName][dateKey] = openShiftsOnDay.join(', ');

        if (bidsData[dateKey]?.[shift]) { delete bidsData[dateKey][shift]; }

        const dateString = new Date(dateKey + 'T12:00:00Z').toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });
        
        addNotification(winner.id, `‚úÖ **Approved:** Your bid for the ${shift} shift on ${dateString} was approved.`);
        
        bidders.forEach(bidderId => {
            if (bidderId !== employeeId) {
                addNotification(bidderId, `‚ùå **Not Approved:** Your bid for the ${shift} shift on ${dateString} was not approved this time.`);
            }
        });

        renderTable(); 
        await saveState(); 
        openBidsModal(); 
        alert(`Shift assigned to ${winner.name}. Notifications have been sent to the portal.`);
}  // <--- CLOSING BRACE HERE!

    async function denyBid(employeeId, dateKey, shift) {
        if (!bidsData[dateKey]?.[shift]) return;
        
        recordHistory();
        
        const indexToRemove = bidsData[dateKey][shift].indexOf(employeeId);
        if (indexToRemove > -1) {
            bidsData[dateKey][shift].splice(indexToRemove, 1);
        }

        const dateString = new Date(dateKey + 'T12:00:00Z').toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });
        addNotification(employeeId, `‚ùå **Not Approved:** Your bid for the ${shift} shift on ${dateString} was not approved this time.`);

        await saveState();
        openBidsModal();
        alert('Bid has been denied. A notification has been sent to the employee.');
    }

    async function placeBid(employeeId, dateKey, shift) {
        if (!confirm(`Are you sure you want to bid on the ${shift} shift for ${dateKey}?`)) return;
        try {
            const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            if (fetchError && fetchError.code !== 'PGRST116') { throw new Error(fetchError.message); }
            const state = records.data;
            if (!state) { throw new Error("Could not retrieve schedule data from the cloud."); }
            if (!state.bidsData) state.bidsData = {};
            if (!state.bidsData[dateKey]) state.bidsData[dateKey] = {};
            if (!state.bidsData[dateKey][shift]) state.bidsData[dateKey][shift] = [];
            
            if (!state.bidsData[dateKey][shift].includes(employeeId)) {
                state.bidsData[dateKey][shift].push(employeeId);
                const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
                if (saveError) { throw new Error(saveError.message); }
                loadAndRenderPortal(employeeId, state);
            }
        } catch (error) {
            console.error("Bidding failed:", error);
            alert(`‚ùå Error placing bid: ${error.message}`);
        }
    }
async function sendEmailWithSendGrid(toEmail, subject, bodyText) {
        const apiKey = "YOUR_SENDGRID_API_KEY"; // <-- IMPORTANT: PASTE YOUR KEY HERE
        const fromEmail = "jack.scales@northside.com"; // <-- IMPORTANT: USE YOUR SENDGRID VERIFIED EMAIL

        if (!apiKey.startsWith("SG.") || fromEmail === "you@yourcompany.com") {
            console.error("SendGrid API Key or From Email not set.");
            alert("Email notification could not be sent. API Key not configured.");
            return;
        }

        const body = {
            personalizations: [{ to: [{ email: toEmail }] }],
            from: { email: fromEmail },
            subject: subject,
            content: [{ type: "text/plain", value: bodyText }]
        };

        try {
            const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                console.error("SendGrid error:", await response.json());
                alert(`Email could not be sent to ${toEmail}. Check the console for details.`);
            }
        } catch (error) {
            console.error("Failed to send email:", error);
            alert(`An error occurred while trying to send an email to ${toEmail}.`);
        }
    }
function openReportsModal() {
        const container = document.getElementById('reports-container');
        let reportHTML = '<h3>Fairness Report</h3><p>This report analyzes the distribution of key shifts for the current month.</p>';
        
        const reportData = [];

        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;

            let weekendShifts = 0;
            let openingShifts = 0;
            let closingShifts = 0;

            if (scheduleData[emp.name]) {
                Object.keys(scheduleData[emp.name]).forEach(dateKey => {
                    const shift = scheduleData[emp.name][dateKey];
                    if (shift && shift.toUpperCase() !== 'PTO') {
                        const date = new Date(dateKey + 'T12:00:00Z');
                        const dayOfWeek = date.getDay();

                        // Check for weekend shifts (Saturday or Sunday)
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            weekendShifts++;
                        }
                        // Check for opening shifts
                        if (shiftTypes.opening.includes(shift)) {
                            openingShifts++;
                        }
                        // Check for closing shifts
                        if (shiftTypes.closing.includes(shift)) {
                            closingShifts++;
                        }
                    }
                });
            }
            reportData.push({ name: emp.name, weekendShifts, openingShifts, closingShifts });
        });

        reportHTML += `
            <table style="width:100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="text-align: left;">Employee Name</th>
                        <th>Weekend Shifts</th>
                        <th>Opening Shifts</th>
                        <th>Closing Shifts</th>
                    </tr>
                </thead>
                <tbody>
                    ${reportData.map(emp => `
                        <tr>
                            <td style="text-align: left;">${emp.name}</td>
                            <td>${emp.weekendShifts}</td>
                            <td>${emp.openingShifts}</td>
                            <td>${emp.closingShifts}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        container.innerHTML = reportHTML;
        document.getElementById('reportsModal').style.display = 'block';
    }
function toggleAutoApproval() {
        autoApprovalRules.enabled = !autoApprovalRules.enabled;
        if(autoApprovalRules.enabled) {
            const ruleText = autoApprovalRules.rule === 'firstCome' ? "'First Come, First Served'" : "'Lowest Hours Priority'";
            if (confirm(`Activate ${ruleText} auto-approval?\n\nThe system will now automatically approve bids based on this rule.`)) {
                runAutoApproval(); // Run it once in case any bids are waiting
            } else {
                autoApprovalRules.enabled = false; // User cancelled, so revert
            }
        }
        updateAutoApprovalUI();
        saveState();
    }

    function changeAutoApprovalRule() {
        autoApprovalRules.rule = document.getElementById('auto-approval-rule-select').value;
        saveState();
    }

    function updateAutoApprovalUI() {
        const btn = document.getElementById('auto-approval-btn');
        const select = document.getElementById('auto-approval-rule-select');
        select.value = autoApprovalRules.rule;

        if (autoApprovalRules.enabled) {
            btn.textContent = "Auto-Approval is ON";
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-success');
            select.disabled = true;
        } else {
            btn.textContent = "Activate Auto-Approval";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            select.disabled = false;
        }
    }

    function runAutoApproval() {
        if (!autoApprovalRules.enabled) return;

        let approvedCount = 0;
        const openShiftRows = employees.filter(e => e.name.startsWith("OPEN SHIFTS"));

        openShiftRows.forEach(row => {
            if(scheduleData[row.name]) {
                Object.keys(scheduleData[row.name]).forEach(dateKey => {
                    const shiftText = scheduleData[row.name][dateKey] || '';
                    shiftText.split(',').forEach(shift => {
                        shift = shift.trim();
                        if (!shift) return;

                        const bidders = bidsData[dateKey]?.[shift] || [];
                        if (bidders.length > 0) {
                            let winnerId = null;

                            if (autoApprovalRules.rule === 'firstCome') {
                                winnerId = bidders[0];
                            } 
                            else if (autoApprovalRules.rule === 'lowestHours') {
                                let lowestHours = Infinity;
                                let bestCandidate = null;
                                bidders.forEach(empId => {
                                    const employee = employees.find(e => e.id === empId);
                                    if (employee) {
                                        let totalHours = 0;
                                        Object.values(scheduleData[employee.name] || {}).forEach(s => {
                                            if (s && s.toUpperCase() !== 'PTO') totalHours += shiftsInfo[s] || 0;
                                        });
                                        if (totalHours < lowestHours) {
                                            lowestHours = totalHours;
                                            bestCandidate = empId;
                                        }
                                    }
                                });
                                winnerId = bestCandidate;
                            }

                            if (winnerId) {
                                approveBid(winnerId, dateKey, shift, row.name);
                                approvedCount++;
                            }
                        }
                    });
                });
            }
        });
        
        if (approvedCount > 0) {
            alert(`Auto-approval ran and assigned ${approvedCount} shift(s).`);
        }
    }
function addNotification(employeeId, message) {
        if (!notifications[employeeId]) {
            notifications[employeeId] = [];
        }
        notifications[employeeId].unshift({ message: message, read: false, date: new Date().toISOString() });
        // Keep only the last 20 notifications to prevent data from getting too large
        if (notifications[employeeId].length > 20) {
            notifications[employeeId].pop();
        }
    }
async function markNotificationsAsRead(employeeId) {
        const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
        if (fetchError || !records) return;

        const state = records.data;
        if (state.notifications && state.notifications[employeeId]) {
            state.notifications[employeeId].forEach(n => n.read = true);
            const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
            if (saveError) console.error("Error saving read status:", saveError);
        }
    }

    // ===== PTO MANAGEMENT SYSTEM FUNCTIONS =====

    // Calculate days between two dates (inclusive)
    function calculatePTODays(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const timeDifference = end.getTime() - start.getTime();
        const dayDifference = Math.ceil(timeDifference / (1000 * 3600 * 24)) + 1; // +1 to include both start and end dates
        return Math.max(0, dayDifference);
    }

    // Check if employee is eligible for PTO (90-day rule)
    function isEmployeeEligibleForPTO(employeeId) {
        const employee = employees.find(e => e.id === employeeId);
        if (!employee || !employee.hireDate) return { eligible: false, reason: "No hire date found" };
        
        const hireDate = new Date(employee.hireDate);
        const currentDate = new Date('2025-08-07'); // Using the date specified in requirements
        const daysSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24));
        
        if (daysSinceHire < 90) {
            const remainingDays = 90 - daysSinceHire;
            return { 
                eligible: false, 
                reason: `New employees must wait 90 days before requesting PTO. ${remainingDays} days remaining.`
            };
        }
        
        return { eligible: true, reason: "Employee is eligible for PTO" };
    }

    // Update PTO form based on date selection
    function updatePTOForm() {
        const startDate = document.getElementById('pto-start-date').value;
        const endDate = document.getElementById('pto-end-date').value;
        const daysDisplay = document.getElementById('pto-days-display');
        
        if (startDate && endDate) {
            const days = calculatePTODays(startDate, endDate);
            daysDisplay.value = `${days} day${days !== 1 ? 's' : ''}`;
        } else {
            daysDisplay.value = '';
        }
    }

    // Add event listeners for PTO form
    function setupPTOFormListeners() {
        const startDateInput = document.getElementById('pto-start-date');
        const endDateInput = document.getElementById('pto-end-date');
        
        if (startDateInput && endDateInput) {
            startDateInput.addEventListener('change', updatePTOForm);
            endDateInput.addEventListener('change', updatePTOForm);
            
            // Set minimum date to today for PTO requests
            const today = new Date().toISOString().split('T')[0];
            startDateInput.min = today;
            endDateInput.min = today;
        }
    }

    // Submit PTO request
    async function submitPTORequest() {
        const urlParams = new URLSearchParams(window.location.search);
        const employeeId = urlParams.get('portal');
        
        if (!employeeId) {
            alert('Error: Employee ID not found');
            return;
        }

        // Get form data
        const startDate = document.getElementById('pto-start-date').value;
        const endDate = document.getElementById('pto-end-date').value;
        const ptoType = document.getElementById('pto-type').value;
        const comments = document.getElementById('pto-comments').value;

        // Basic validation
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }

        // Enhanced validation with conflict detection
        const validation = validatePTORequest(employeeId, startDate, endDate, ptoType);
        
        if (!validation.valid) {
            alert('PTO Request Errors:\n' + validation.errors.join('\n'));
            return;
        }

        // Show warnings if any, but allow user to proceed
        if (validation.warnings.length > 0) {
            const proceed = confirm(
                'PTO Request Warnings:\n' + validation.warnings.join('\n') + 
                '\n\nDo you want to proceed with this request?'
            );
            if (!proceed) return;
        }

        const daysRequested = validation.daysRequested;
        const employee = employees.find(e => e.id === employeeId);

        try {
            // Create PTO request
            const requestId = generateUUID();
            const newRequest = {
                id: requestId,
                employeeId: employeeId,
                employeeName: employee.name,
                startDate: startDate,
                endDate: endDate,
                daysRequested: daysRequested,
                requestType: ptoType,
                reason: comments,
                status: 'pending',
                submissionDate: new Date().toISOString(),
                approvalDate: null,
                managerId: null,
                managerComments: '',
                conflicts: validation.conflicts, // Store conflict information
                validationWarnings: validation.warnings
            };

            // Load current state from Supabase only
            let state = {};
            try {
                if (typeof supabaseClient !== 'undefined' && supabaseClient !== null) {
                    const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
                    if (!fetchError && records?.data) {
                        state = records.data;
                    } else {
                        // Create initial state structure if no data exists
                        state = {
                            employees,
                            schedule: scheduleData,
                            notesData,
                            bidsData,
                            notifications,
                            ptoRequests: {},
                            employeePTOBalances: {},
                            announcements: [],
                            auditLogs: []
                        };
                    }
                } else {
                    throw new Error('Supabase client not available');
                }
            } catch (err) {
                console.error('Could not load from Supabase:', err);
                alert('Failed to submit PTO request. Cloud database is not available.');
                return;
            }

            if (!state.ptoRequests) state.ptoRequests = {};
            if (!state.employeePTOBalances) state.employeePTOBalances = {};

            // Add the request
            state.ptoRequests[requestId] = newRequest;

            // Update pending PTO balance
            if (!state.employeePTOBalances[employeeId]) {
                state.employeePTOBalances[employeeId] = employeePTOBalances[employeeId] || {
                    employeeName: employee.name,
                    hireDate: employee.hireDate || "2024-01-01",
                    totalPTODays: employee.type === "FT" ? 20 : 15,
                    usedPTODays: 0,
                    pendingPTODays: 0
                };
            }
            state.employeePTOBalances[employeeId].pendingPTODays += daysRequested;

            // Save to Supabase only
            try {
                if (typeof supabaseClient !== 'undefined' && supabaseClient !== null) {
                    const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
                    if (saveError) throw new Error(saveError.message);
                    console.log('‚úÖ PTO request saved to cloud');
                } else {
                    throw new Error('Supabase client not available');
                }
            } catch (err) {
                console.error('Could not save to Supabase:', err);
                alert('Failed to submit PTO request. Could not save to cloud database.');
                return;
            }

            // Update local state
            ptoRequests[requestId] = newRequest;
            if (employeePTOBalances[employeeId]) {
                employeePTOBalances[employeeId].pendingPTODays += daysRequested;
            }

            alert(`‚úÖ PTO request submitted successfully!\n\nRequest Details:\n‚Ä¢ ${daysRequested} days requested\n‚Ä¢ ${ptoType} leave\n‚Ä¢ Status: Pending approval\n\nYour manager will be notified of this request.`);

            // Clear form
            document.getElementById('pto-start-date').value = '';
            document.getElementById('pto-end-date').value = '';
            document.getElementById('pto-comments').value = '';
            document.getElementById('pto-days-display').value = '';

            // Refresh the PTO balance display
            displayPTOBalance(employeeId);
            loadPTOHistory(employeeId);

        } catch (error) {
            console.error('Error submitting PTO request:', error);
            alert('Error submitting PTO request: ' + error.message);
        }
    }

    // Open PTO Requests Management Modal for Managers
    async function openPTORequestsModal() {
        try {
            // Load fresh data from Supabase
            const { data: records, error } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            if (error) throw new Error(error.message);

            const state = records.data || {};
            ptoRequests = state.ptoRequests || {};
            employeePTOBalances = state.employeePTOBalances || {};

            renderPTORequestsModal();
            document.getElementById('ptoRequestsModal').style.display = 'block';

        } catch (error) {
            console.error('Error loading PTO requests:', error);
            alert('Error loading PTO requests: ' + error.message);
        }
    }

    // Render PTO Requests Modal Content
    function renderPTORequestsModal() {
        const container = document.getElementById('pto-requests-container');
        const allRequests = Object.values(ptoRequests);
        
        // Update dashboard counters
        const pendingCount = allRequests.filter(r => r.status === 'pending').length;
        const conflictsCount = detectPTOConflicts().length;
        const totalCount = allRequests.length;

        document.getElementById('pending-count').textContent = pendingCount;
        document.getElementById('conflicts-count').textContent = conflictsCount;
        document.getElementById('total-requests-count').textContent = totalCount;

        // Filter requests based on selection
        const filter = document.getElementById('pto-filter').value;
        let filteredRequests = allRequests;

        switch (filter) {
            case 'pending':
                filteredRequests = allRequests.filter(r => r.status === 'pending');
                break;
            case 'approved':
                filteredRequests = allRequests.filter(r => r.status === 'approved');
                break;
            case 'denied':
                filteredRequests = allRequests.filter(r => r.status === 'denied');
                break;
            case 'conflicts':
                const conflicts = detectPTOConflicts();
                filteredRequests = allRequests.filter(r => conflicts.some(c => c.requestId === r.id));
                break;
        }

        // Sort by submission date (newest first)
        filteredRequests.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));

        if (filteredRequests.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No PTO requests found.</p>';
            return;
        }

        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #f8f9fa;">';
        html += '<th style="padding: 10px; border: 1px solid #ddd;"><input type="checkbox" id="select-all-pto" onchange="toggleAllPTOSelection()"></th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Employee</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Dates</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Days</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Type</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Status</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Submitted</th>';
        html += '<th style="padding: 10px; border: 1px solid #ddd;">Actions</th>';
        html += '</tr></thead><tbody>';

        const conflicts = detectPTOConflicts();

        filteredRequests.forEach(request => {
            const hasConflict = conflicts.some(c => c.requestId === request.id);
            const rowClass = hasConflict ? 'pto-conflict' : '';
            const statusClass = `pto-status-${request.status}`;

            const startDate = new Date(request.startDate).toLocaleDateString();
            const endDate = new Date(request.endDate).toLocaleDateString();
            const submissionDate = new Date(request.submissionDate).toLocaleDateString();

            html += `<tr class="${rowClass} ${statusClass}">`;
            html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">`;
            if (request.status === 'pending') {
                html += `<input type="checkbox" class="pto-select" value="${request.id}">`;
            }
            html += `</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd;">${request.employeeName}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd;">${startDate} - ${endDate}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${request.daysRequested}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd; text-transform: capitalize;">${request.requestType}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd; text-transform: capitalize; font-weight: bold;">${request.status}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd;">${submissionDate}</td>`;
            html += `<td style="padding: 8px; border: 1px solid #ddd;">`;
            
            if (request.status === 'pending') {
                html += `<button class="btn btn-success btn-sm" onclick="approvePTORequest('${request.id}')" style="margin-right: 5px;">‚úì Approve</button>`;
                html += `<button class="btn btn-danger btn-sm" onclick="denyPTORequest('${request.id}')">‚úó Deny</button>`;
            }
            html += `<button class="btn btn-secondary btn-sm" onclick="viewPTODetails('${request.id}')" style="margin-left: 5px;">üëÅÔ∏è Details</button>`;
            html += `<button class="btn btn-warning btn-sm" onclick="generatePTOPDF('${request.id}')" style="margin-left: 5px;">üìÑ PDF</button>`;
            html += `</td></tr>`;

            // Add details row
            if (request.reason || hasConflict) {
                html += `<tr class="${rowClass}"><td colspan="8" style="padding: 5px 8px; border: 1px solid #ddd; background: #f9f9f9; font-size: 12px;">`;
                if (request.reason) {
                    html += `<strong>Comments:</strong> ${request.reason}<br>`;
                }
                if (hasConflict) {
                    const conflict = conflicts.find(c => c.requestId === request.id);
                    html += `<span style="color: #dc3545;"><strong>‚ö†Ô∏è CONFLICT:</strong> ${conflict.details}</span>`;
                }
                html += `</td></tr>`;
            }
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // Detect PTO conflicts (one person off at a time rule)
    function detectPTOConflicts() {
        const conflicts = [];
        const approvedRequests = Object.values(ptoRequests).filter(r => r.status === 'approved');
        const pendingRequests = Object.values(ptoRequests).filter(r => r.status === 'pending');

        pendingRequests.forEach(pendingRequest => {
            const pendingStart = new Date(pendingRequest.startDate);
            const pendingEnd = new Date(pendingRequest.endDate);

            // Check against approved requests
            approvedRequests.forEach(approvedRequest => {
                if (approvedRequest.employeeId === pendingRequest.employeeId) return; // Same employee

                const approvedStart = new Date(approvedRequest.startDate);
                const approvedEnd = new Date(approvedRequest.endDate);

                // Check for date overlap
                if (pendingStart <= approvedEnd && pendingEnd >= approvedStart) {
                    conflicts.push({
                        requestId: pendingRequest.id,
                        conflictWith: approvedRequest.id,
                        details: `Conflicts with ${approvedRequest.employeeName}'s approved PTO from ${approvedStart.toLocaleDateString()} to ${approvedEnd.toLocaleDateString()}`
                    });
                }
            });

            // Check against other pending requests (for potential future conflicts)
            pendingRequests.forEach(otherPending => {
                if (otherPending.id === pendingRequest.id || otherPending.employeeId === pendingRequest.employeeId) return;

                const otherStart = new Date(otherPending.startDate);
                const otherEnd = new Date(otherPending.endDate);

                if (pendingStart <= otherEnd && pendingEnd >= otherStart && 
                    new Date(otherPending.submissionDate) < new Date(pendingRequest.submissionDate)) {
                    conflicts.push({
                        requestId: pendingRequest.id,
                        conflictWith: otherPending.id,
                        details: `Potential conflict with ${otherPending.employeeName}'s pending PTO from ${otherStart.toLocaleDateString()} to ${otherEnd.toLocaleDateString()}`
                    });
                }
            });
        });

        return conflicts;
    }

    // Approve PTO Request
    async function approvePTORequest(requestId) {
        const request = ptoRequests[requestId];
        if (!request) {
            alert('Request not found');
            return;
        }

        const conflicts = detectPTOConflicts().filter(c => c.requestId === requestId);
        if (conflicts.length > 0) {
            const proceed = confirm(`This request has conflicts:\n${conflicts.map(c => c.details).join('\n')}\n\nDo you want to proceed with approval anyway?`);
            if (!proceed) return;
        }

        try {
            // Load current state
            const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            if (fetchError) throw new Error(fetchError.message);

            const state = records.data;
            
            // Update request status
            state.ptoRequests[requestId].status = 'approved';
            state.ptoRequests[requestId].approvalDate = new Date().toISOString();
            state.ptoRequests[requestId].managerId = 'manager'; // You could track specific manager

            // Update PTO balances
            const employeeId = request.employeeId;
            if (state.employeePTOBalances[employeeId]) {
                state.employeePTOBalances[employeeId].usedPTODays += request.daysRequested;
                state.employeePTOBalances[employeeId].pendingPTODays -= request.daysRequested;
            }

            // Add PTO to schedule
            addPTOToSchedule(request.startDate, request.endDate, request.employeeName, state);

            // Save state
            const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
            if (saveError) throw new Error(saveError.message);

            // Update local state
            ptoRequests[requestId] = state.ptoRequests[requestId];
            if (employeePTOBalances[employeeId]) {
                employeePTOBalances[employeeId].usedPTODays += request.daysRequested;
                employeePTOBalances[employeeId].pendingPTODays -= request.daysRequested;
            }

    // Send notification to employee
            addNotification(employeeId, `‚úÖ **PTO Approved:** Your PTO request for ${new Date(request.startDate).toLocaleDateString()} to ${new Date(request.endDate).toLocaleDateString()} has been approved.`);

            // Send email notification if employee has email
            const employee = employees.find(e => e.id === employeeId);
            if (employee && employee.email) {
                sendPTONotificationEmail(employee.email, employee.name, 'approved', request);
            }

            // Refresh display
            renderPTORequestsModal();
            renderTable(); // Update main schedule

            alert('PTO request approved successfully!');

        } catch (error) {
            console.error('Error approving PTO request:', error);
            alert('Error approving PTO request: ' + error.message);
        }
    }

    // Deny PTO Request
    async function denyPTORequest(requestId) {
        const request = ptoRequests[requestId];
        if (!request) {
            alert('Request not found');
            return;
        }

        const reason = prompt('Please provide a reason for denial (optional):') || 'No reason provided';

        try {
            // Load current state
            const { data: records, error: fetchError } = await supabaseClient.from('schedules').select('data').eq('id', 1).single();
            if (fetchError) throw new Error(fetchError.message);

            const state = records.data;
            
            // Update request status
            state.ptoRequests[requestId].status = 'denied';
            state.ptoRequests[requestId].approvalDate = new Date().toISOString();
            state.ptoRequests[requestId].managerComments = reason;

            // Update PTO balances (restore pending days)
            const employeeId = request.employeeId;
            if (state.employeePTOBalances[employeeId]) {
                state.employeePTOBalances[employeeId].pendingPTODays -= request.daysRequested;
            }

            // Save state
            const { error: saveError } = await supabaseClient.from('schedules').upsert({ id: 1, data: state });
            if (saveError) throw new Error(saveError.message);

            // Update local state
            ptoRequests[requestId] = state.ptoRequests[requestId];
            if (employeePTOBalances[employeeId]) {
                employeePTOBalances[employeeId].pendingPTODays -= request.daysRequested;
            }

            // Send notification to employee
            addNotification(employeeId, `‚ùå **PTO Denied:** Your PTO request for ${new Date(request.startDate).toLocaleDateString()} to ${new Date(request.endDate).toLocaleDateString()} was denied. Reason: ${reason}`);

            // Send email notification if employee has email
            const employee = employees.find(e => e.id === employeeId);
            if (employee && employee.email) {
                sendPTONotificationEmail(employee.email, employee.name, 'denied', request, reason);
            }

            // Refresh display
            renderPTORequestsModal();

            alert('PTO request denied.');

        } catch (error) {
            console.error('Error denying PTO request:', error);
            alert('Error denying PTO request: ' + error.message);
        }
    }

    // Add PTO to schedule
    function addPTOToSchedule(startDate, endDate, employeeName, state) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
            const dateKey = date.toISOString().split('T')[0];
            
            if (!state.schedule[employeeName]) {
                state.schedule[employeeName] = {};
            }
            
            // Store original shift if it exists
            const originalShift = state.schedule[employeeName][dateKey];
            if (originalShift && originalShift.toUpperCase() !== 'PTO') {
                // Move original shift to open shifts
                const openShiftsEmp = state.employees.find(e => e.name.startsWith('OPEN SHIFTS'));
                if (openShiftsEmp) {
                    if (!state.schedule[openShiftsEmp.name]) {
                        state.schedule[openShiftsEmp.name] = {};
                    }
                    const currentOpenShifts = state.schedule[openShiftsEmp.name][dateKey] || '';
                    state.schedule[openShiftsEmp.name][dateKey] = currentOpenShifts ? 
                        `${currentOpenShifts}, ${originalShift}` : originalShift;
                }
            }
            
            state.schedule[employeeName][dateKey] = 'PTO';
        }
    }

    // Filter PTO requests
    function filterPTORequests() {
        renderPTORequestsModal();
    }

    // Toggle all PTO selection
    function toggleAllPTOSelection() {
        const selectAll = document.getElementById('select-all-pto');
        const checkboxes = document.querySelectorAll('.pto-select');
        
        checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
        });
    }

    // Batch approve PTO requests
    async function batchApprovePTO() {
        const selectedRequests = Array.from(document.querySelectorAll('.pto-select:checked')).map(cb => cb.value);
        
        if (selectedRequests.length === 0) {
            alert('Please select requests to approve');
            return;
        }

        if (!confirm(`Approve ${selectedRequests.length} PTO request(s)?`)) return;

        for (const requestId of selectedRequests) {
            await approvePTORequest(requestId);
        }

        renderPTORequestsModal();
    }

    // Batch deny PTO requests
    async function batchDenyPTO() {
        const selectedRequests = Array.from(document.querySelectorAll('.pto-select:checked')).map(cb => cb.value);
        
        if (selectedRequests.length === 0) {
            alert('Please select requests to deny');
            return;
        }

        const reason = prompt('Please provide a reason for denial:') || 'Batch denial - no reason provided';

        if (!confirm(`Deny ${selectedRequests.length} PTO request(s)?`)) return;

        for (const requestId of selectedRequests) {
            await denyPTORequest(requestId);
        }

        renderPTORequestsModal();
    }

    // View PTO details
    function viewPTODetails(requestId) {
        const request = ptoRequests[requestId];
        if (!request) {
            alert('Request not found');
            return;
        }

        const employee = employees.find(e => e.id === request.employeeId);
        const eligibility = isEmployeeEligibleForPTO(request.employeeId);
        const balance = employeePTOBalances[request.employeeId];

        let details = `PTO Request Details\n\n`;
        details += `Employee: ${request.employeeName}\n`;
        details += `Dates: ${new Date(request.startDate).toLocaleDateString()} - ${new Date(request.endDate).toLocaleDateString()}\n`;
        details += `Days Requested: ${request.daysRequested}\n`;
        details += `Type: ${request.requestType}\n`;
        details += `Status: ${request.status}\n`;
        details += `Submitted: ${new Date(request.submissionDate).toLocaleDateString()}\n`;
        
        if (request.reason) {
            details += `Comments: ${request.reason}\n`;
        }
        
        if (employee && employee.hireDate) {
            details += `Hire Date: ${new Date(employee.hireDate).toLocaleDateString()}\n`;
            details += `Eligibility: ${eligibility.eligible ? 'Eligible' : eligibility.reason}\n`;
        }
        
        if (balance) {
            const remaining = balance.totalPTODays - balance.usedPTODays - balance.pendingPTODays;
            details += `PTO Balance: ${remaining} days remaining (${balance.totalPTODays} total, ${balance.usedPTODays} used, ${balance.pendingPTODays} pending)\n`;
        }

        if (request.approvalDate) {
            details += `Decision Date: ${new Date(request.approvalDate).toLocaleDateString()}\n`;
        }
        
        if (request.managerComments) {
            details += `Manager Comments: ${request.managerComments}\n`;
        }

        alert(details);
    }

    // Export PTO Report (basic version - can be enhanced with proper PDF library)
    function exportPTOReport() {
        const allRequests = Object.values(ptoRequests);
        let report = 'PTO Report - ' + new Date().toLocaleDateString() + '\n\n';
        
        const pending = allRequests.filter(r => r.status === 'pending').length;
        const approved = allRequests.filter(r => r.status === 'approved').length;
        const denied = allRequests.filter(r => r.status === 'denied').length;
        
        report += `Summary:\n`;
        report += `Total Requests: ${allRequests.length}\n`;
        report += `Pending: ${pending}\n`;
        report += `Approved: ${approved}\n`;
        report += `Denied: ${denied}\n\n`;
        
        report += `Detailed Report:\n`;
        report += `Employee\tDates\tDays\tType\tStatus\tSubmitted\n`;
        
        allRequests.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
        
        allRequests.forEach(request => {
            const startDate = new Date(request.startDate).toLocaleDateString();
            const endDate = new Date(request.endDate).toLocaleDateString();
            const submissionDate = new Date(request.submissionDate).toLocaleDateString();
            
            report += `${request.employeeName}\t${startDate} - ${endDate}\t${request.daysRequested}\t${request.requestType}\t${request.status}\t${submissionDate}\n`;
        });
        
        // Create and download file
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `PTO_Report_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // ===== PDF GENERATION FUNCTIONS =====

    // Generate professional PTO PDF
    function generatePTOPDF(requestId) {
        const request = ptoRequests[requestId];
        if (!request) {
            alert('Request not found');
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('PDF library not loaded. Please try again.');
                return;
            }

            const doc = new jsPDF();
            const employee = employees.find(e => e.id === request.employeeId);
            const balance = employeePTOBalances[request.employeeId];

            // Company Header
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("test scheduler", 105, 20, { align: "center" });
            
            doc.setFontSize(16);
            doc.text("PTO Request Form", 105, 30, { align: "center" });

            // Add line separator
            doc.setLineWidth(0.5);
            doc.line(20, 35, 190, 35);

            // Employee Information Section
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Employee Information", 20, 50);
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            let yPos = 60;
            
            doc.text(`Employee Name: ${request.employeeName}`, 20, yPos);
            yPos += 8;
            
            if (employee && employee.id) {
                doc.text(`Employee ID: ${employee.id.substring(0, 8)}`, 20, yPos);
                yPos += 8;
            }
            
            if (employee && employee.type) {
                doc.text(`Employment Type: ${employee.type}`, 20, yPos);
                yPos += 8;
            }
            
            if (employee && employee.hireDate) {
                doc.text(`Hire Date: ${new Date(employee.hireDate).toLocaleDateString()}`, 20, yPos);
                yPos += 8;
            }

            // PTO Request Details Section
            yPos += 10;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("PTO Request Details", 20, yPos);
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            yPos += 10;
            
            const startDate = new Date(request.startDate).toLocaleDateString();
            const endDate = new Date(request.endDate).toLocaleDateString();
            
            doc.text(`Start Date: ${startDate}`, 20, yPos);
            doc.text(`End Date: ${endDate}`, 120, yPos);
            yPos += 8;
            
            doc.text(`Days Requested: ${request.daysRequested}`, 20, yPos);
            doc.text(`Request Type: ${request.requestType}`, 120, yPos);
            yPos += 8;
            
            doc.text(`Submission Date: ${new Date(request.submissionDate).toLocaleDateString()}`, 20, yPos);
            yPos += 8;
            
            if (request.reason) {
                doc.text(`Comments: ${request.reason}`, 20, yPos);
                yPos += 8;
            }

            // PTO Balance Section
            if (balance) {
                yPos += 10;
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("PTO Balance Information", 20, yPos);
                
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                yPos += 10;
                
                const remaining = balance.totalPTODays - balance.usedPTODays - balance.pendingPTODays;
                
                doc.text(`Total PTO Days: ${balance.totalPTODays}`, 20, yPos);
                doc.text(`Used Days: ${balance.usedPTODays}`, 70, yPos);
                doc.text(`Pending Days: ${balance.pendingPTODays}`, 120, yPos);
                doc.text(`Remaining: ${remaining}`, 170, yPos);
                yPos += 8;
            }

            // Approval Section
            yPos += 10;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Approval Status", 20, yPos);
            
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            yPos += 10;
            
            const statusColor = request.status === 'approved' ? [0, 128, 0] : 
                               request.status === 'denied' ? [255, 0, 0] : [255, 165, 0];
            
            doc.setTextColor(...statusColor);
            doc.setFont("helvetica", "bold");
            doc.text(`Status: ${request.status.toUpperCase()}`, 20, yPos);
            doc.setTextColor(0, 0, 0); // Reset to black
            doc.setFont("helvetica", "normal");
            yPos += 8;
            
            if (request.approvalDate) {
                doc.text(`Decision Date: ${new Date(request.approvalDate).toLocaleDateString()}`, 20, yPos);
                yPos += 8;
            }
            
            if (request.managerComments) {
                doc.text(`Manager Comments: ${request.managerComments}`, 20, yPos);
                yPos += 8;
            }

            // Digital Signature Section
            yPos += 20;
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Digital Approval", 20, yPos);
            
            if (request.status === 'approved') {
                yPos += 10;
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Approved by: Manager`, 20, yPos);
                yPos += 6;
                doc.text(`Approval Date: ${new Date(request.approvalDate).toLocaleDateString()}`, 20, yPos);
                yPos += 6;
                doc.text(`Document ID: ${request.id.substring(0, 12)}`, 20, yPos);
            }

            // QR Code for verification (if available)
            try {
                if (typeof qrcode !== 'undefined') {
                    const qrData = `NSG-PTO-${request.id}`;
                    const qr = qrcode(0, 'M');
                    qr.addData(qrData);
                    qr.make();
                    
                    // Add QR code as text (basic implementation)
                    yPos += 15;
                    doc.setFontSize(8);
                    doc.text(`Verification Code: NSG-PTO-${request.id.substring(0, 8)}`, 20, yPos);
                }
            } catch (e) {
                console.log('QR code generation not available:', e);
            }

            // Footer
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.text("This document was generated electronically by test scheduler System", 105, pageHeight - 20, { align: "center" });
            doc.text(`Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 105, pageHeight - 15, { align: "center" });

            // Save the PDF
            const filename = `PTO_Request_${request.employeeName.replace(/[^a-zA-Z0-9]/g, '_')}_${request.startDate}.pdf`;
            doc.save(filename);

        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF: ' + error.message);
        }
    }

    // Batch PDF generation for multiple requests
    function generateBatchPDFs() {
        const selectedRequests = Array.from(document.querySelectorAll('.pto-select:checked')).map(cb => cb.value);
        
        if (selectedRequests.length === 0) {
            alert('Please select requests to generate PDFs for');
            return;
        }

        selectedRequests.forEach((requestId, index) => {
            setTimeout(() => {
                generatePTOPDF(requestId);
            }, index * 500); // Delay between downloads to prevent browser blocking
        });
    }

    // Enhanced export PTO Report with PDF option
    function exportPTOReport() {
        const format = prompt('Export format:\n1. Text file (enter "text")\n2. PDF report (enter "pdf")', 'text');
        
        if (format === 'pdf') {
            generatePTOReportPDF();
        } else {
            // Existing text export functionality
            const allRequests = Object.values(ptoRequests);
            let report = 'PTO Report - ' + new Date().toLocaleDateString() + '\n\n';
            
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'approved').length;
            const denied = allRequests.filter(r => r.status === 'denied').length;
            
            report += `Summary:\n`;
            report += `Total Requests: ${allRequests.length}\n`;
            report += `Pending: ${pending}\n`;
            report += `Approved: ${approved}\n`;
            report += `Denied: ${denied}\n\n`;
            
            report += `Detailed Report:\n`;
            report += `Employee\tDates\tDays\tType\tStatus\tSubmitted\n`;
            
            allRequests.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
            
            allRequests.forEach(request => {
                const startDate = new Date(request.startDate).toLocaleDateString();
                const endDate = new Date(request.endDate).toLocaleDateString();
                const submissionDate = new Date(request.submissionDate).toLocaleDateString();
                
                report += `${request.employeeName}\t${startDate} - ${endDate}\t${request.daysRequested}\t${request.requestType}\t${request.status}\t${submissionDate}\n`;
            });
            
            // Create and download file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PTO_Report_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }

    // Generate comprehensive PDF report
    function generatePTOReportPDF() {
        try {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert('PDF library not loaded. Please try again.');
                return;
            }

            const doc = new jsPDF();
            const allRequests = Object.values(ptoRequests);
            
            // Header
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("test scheduler - PTO Management Report", 105, 20, { align: "center" });
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: "center" });

            // Summary statistics
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'approved').length;
            const denied = allRequests.filter(r => r.status === 'denied').length;
            const conflicts = detectPTOConflicts().length;

            let yPos = 50;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Summary Statistics", 20, yPos);
            
            yPos += 10;
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.text(`Total Requests: ${allRequests.length}`, 20, yPos);
            doc.text(`Pending: ${pending}`, 70, yPos);
            doc.text(`Approved: ${approved}`, 120, yPos);
            doc.text(`Denied: ${denied}`, 170, yPos);
            yPos += 8;
            doc.text(`Active Conflicts: ${conflicts}`, 20, yPos);

            // Detailed table
            yPos += 20;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Detailed Request Log", 20, yPos);

            yPos += 10;
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            
            // Table headers
            doc.text("Employee", 20, yPos);
            doc.text("Dates", 65, yPos);
            doc.text("Days", 105, yPos);
            doc.text("Type", 125, yPos);
            doc.text("Status", 150, yPos);
            doc.text("Submitted", 175, yPos);
            
            doc.setLineWidth(0.1);
            doc.line(20, yPos + 2, 190, yPos + 2);
            
            yPos += 8;
            doc.setFont("helvetica", "normal");

            allRequests.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
            
            allRequests.forEach(request => {
                if (yPos > 280) { // Start new page if needed
                    doc.addPage();
                    yPos = 20;
                }
                
                const startDate = new Date(request.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endDate = new Date(request.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const submissionDate = new Date(request.submissionDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                // Truncate long names
                const empName = request.employeeName.length > 15 ? 
                    request.employeeName.substring(0, 15) + '...' : request.employeeName;
                
                doc.text(empName, 20, yPos);
                doc.text(`${startDate}-${endDate}`, 65, yPos);
                doc.text(request.daysRequested.toString(), 105, yPos);
                doc.text(request.requestType, 125, yPos);
                doc.text(request.status, 150, yPos);
                doc.text(submissionDate, 175, yPos);
                
                yPos += 6;
            });

            // Footer
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.text("test scheduler System - Confidential", 105, pageHeight - 10, { align: "center" });

            // Save the PDF
            doc.save(`NSG_PTO_Report_${new Date().toISOString().split('T')[0]}.pdf`);

        } catch (error) {
            console.error('Error generating PDF report:', error);
            alert('Error generating PDF report: ' + error.message);
        }
    }

    // ===== EMAIL AUTOMATION FUNCTIONS =====

    // Send PTO notification email
    function sendPTONotificationEmail(email, employeeName, status, request, reason = '') {
        const startDate = new Date(request.startDate).toLocaleDateString();
        const endDate = new Date(request.endDate).toLocaleDateString();
        
        let subject, body;
        
        if (status === 'approved') {
            subject = `PTO Request Approved - ${startDate} to ${endDate}`;
            body = `Dear ${employeeName.split(',')[1]?.trim() || employeeName},\n\n`;
            body += `Your PTO request has been APPROVED!\n\n`;
            body += `Details:\n`;
            body += `- Dates: ${startDate} to ${endDate}\n`;
            body += `- Days: ${request.daysRequested}\n`;
            body += `- Type: ${request.requestType}\n`;
            if (request.reason) {
                body += `- Comments: ${request.reason}\n`;
            }
            body += `\nYour time off has been added to the schedule. Please check your employee portal for the most up-to-date information.\n\n`;
            body += `Thank you,\ntest scheduler Management`;
        } else if (status === 'denied') {
            subject = `PTO Request Decision - ${startDate} to ${endDate}`;
            body = `Dear ${employeeName.split(',')[1]?.trim() || employeeName},\n\n`;
            body += `We regret to inform you that your PTO request has been DENIED.\n\n`;
            body += `Details:\n`;
            body += `- Requested Dates: ${startDate} to ${endDate}\n`;
            body += `- Days: ${request.daysRequested}\n`;
            body += `- Type: ${request.requestType}\n`;
            if (reason) {
                body += `- Reason for denial: ${reason}\n`;
            }
            body += `\nPlease contact your manager if you have any questions or would like to discuss alternative dates.\n\n`;
            body += `Thank you,\ntest scheduler Management`;
        }
        
        // Use mailto link for now - can be enhanced with SendGrid or other email service
        const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        // Try to open email client, but don't show error if it fails
        try {
            window.open(mailtoLink, '_blank');
        } catch (e) {
            console.log('Email client not available:', e);
        }
    }

    // Send PTO submission notification to managers
    function notifyManagersOfNewPTORequest(request) {
        // This function can be enhanced to send emails to all managers
        console.log('New PTO request submitted:', request);
        
        // For now, just add to the notification system
        // In a real implementation, you would send emails to managers here
        const managerEmail = "manager@nsg.com"; // Replace with actual manager email
        
        const subject = `New PTO Request - ${request.employeeName}`;
        const body = `A new PTO request has been submitted:\n\n`;
        const startDate = new Date(request.startDate).toLocaleDateString();
        const endDate = new Date(request.endDate).toLocaleDateString();
        
        const emailBody = `Employee: ${request.employeeName}\n`;
        emailBody += `Dates: ${startDate} to ${endDate}\n`;
        emailBody += `Days: ${request.daysRequested}\n`;
        emailBody += `Type: ${request.requestType}\n`;
        if (request.reason) {
            emailBody += `Comments: ${request.reason}\n`;
        }
        emailBody += `\nPlease review and approve/deny this request in the test scheduler system.\n\n`;
        emailBody += `Access the system at: ${window.location.origin}${window.location.pathname}`;
        
        // Use mailto for manager notification
        const mailtoLink = `mailto:${managerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        
        try {
            window.open(mailtoLink, '_blank');
        } catch (e) {
            console.log('Email client not available for manager notification:', e);
        }
    }

    // ===== CALENDAR INTEGRATION FUNCTIONS =====

    // Add PTO calendar view to main dashboard
    function renderPTOCalendarView() {
        const container = document.createElement('div');
        container.id = 'pto-calendar-widget';
        container.innerHTML = `
            <h3>PTO Calendar Overview</h3>
            <div id="pto-mini-calendar" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                <p style="text-align: center; color: #666;">PTO calendar will display approved time off</p>
            </div>
        `;
        
        // Find a good place to add this in the dashboard
        const dashboardContainer = document.querySelector('.dashboard .controls');
        if (dashboardContainer) {
            dashboardContainer.appendChild(container);
        }
    }

    // Update the main schedule rendering to better highlight PTO
    function enhancePTODisplay() {
        // This function is called after the table is rendered to add PTO enhancements
        const cells = document.querySelectorAll('.pto-approved, .pto-pending');
        cells.forEach(cell => {
            if (cell.textContent.toUpperCase() === 'PTO') {
                // Add tooltip with PTO request details
                const employeeName = cell.closest('tr')?.querySelector('.employee-name')?.textContent;
                if (employeeName) {
                    const ptoRequests = Object.values(window.ptoRequests || {}).filter(r => 
                        r.employeeName === employeeName && 
                        (r.status === 'approved' || r.status === 'pending')
                    );
                    
                    if (ptoRequests.length > 0) {
                        const request = ptoRequests[0]; // Get the first matching request
                        cell.title = `PTO Request: ${request.requestType} (${request.status})`;
                        
                        // Add icon based on status
                        if (request.status === 'approved') {
                            cell.innerHTML = 'PTO ‚úÖ';
                        } else if (request.status === 'pending') {
                            cell.innerHTML = 'PTO ‚è≥';
                        }
                    }
                }
            }
        });
    }

    // Initialize PTO enhancements when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        setupPTOFormListeners();
    });

    // ===== MONTHLY PTO REPORTING SYSTEM =====
    
    function generateMonthlyPTOReports() {
        // Set default month to current month
        const now = new Date();
        const currentMonth = now.toISOString().substring(0, 7);
        document.getElementById('reportMonth').value = currentMonth;
        
        document.getElementById('monthlyPTOReportsModal').style.display = 'block';
        generatePTOReportForMonth();
    }

    function generatePTOReportForMonth() {
        const reportMonth = document.getElementById('reportMonth').value;
        if (!reportMonth) {
            alert('Please select a month for the report');
            return;
        }

        const container = document.getElementById('monthly-pto-reports-container');
        let reportsHTML = `<h3>PTO Balance Reports for ${new Date(reportMonth).toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}</h3>`;
        
        const eligibleEmployees = employees.filter(emp => 
            emp.id && !emp.name.startsWith('OPEN SHIFTS') && emp.type !== 'Bank'
        );

        if (eligibleEmployees.length === 0) {
            container.innerHTML = '<p>No employees found for reporting.</p>';
            return;
        }

        eligibleEmployees.forEach(employee => {
            // Calculate months since hire for proper PTO allocation
            const hireDate = new Date(employee.hireDate || '2024-01-01');
            const currentDate = new Date();
            const monthsSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24 * 30.44));
            const yearlyAllocation = getYearlyPTOAllocation(employee, monthsSinceHire);

            const ptoBalance = employeePTOBalances[employee.id] || {
                totalPTODays: yearlyAllocation,
                usedPTODays: 0,
                pendingPTODays: 0
            };
            
            // Ensure the total PTO days reflects the current year's allocation based on service length
            ptoBalance.totalPTODays = yearlyAllocation;

            const remainingPTO = ptoBalance.totalPTODays - ptoBalance.usedPTODays;
            const yearStartDate = new Date(new Date().getFullYear(), 0, 1);
            const daysSinceYearStart = Math.floor((currentDate - yearStartDate) / (1000 * 60 * 60 * 24));
            
            // Calculate accrued PTO based on hire date
            const accruedPTO = calculateAccruedPTO(employee, monthsSinceHire);

            // Get upcoming scheduled PTO for next 30 days
            const upcomingPTO = getUpcomingPTO(employee.name);

            reportsHTML += `
                <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f9f9f9;">
                    <h4 style="margin-top: 0; color: #333;">${employee.name}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Annual PTO Allocation:</strong> ${ptoBalance.totalPTODays} days<br>
                            <strong>Used This Year:</strong> ${ptoBalance.usedPTODays} days<br>
                            <strong>Remaining Balance:</strong> <span style="color: ${remainingPTO < 5 ? 'red' : 'green'}; font-weight: bold;">${remainingPTO} days</span>
                        </div>
                        <div>
                            <strong>Pending Requests:</strong> ${ptoBalance.pendingPTODays} days<br>
                            <strong>Accrued This Year:</strong> ${accruedPTO} days<br>
                            <strong>Hire Date:</strong> ${new Date(employee.hireDate || '2024-01-01').toLocaleDateString()}
                        </div>
                        <div>
                            <strong>Upcoming PTO:</strong><br>
                            ${upcomingPTO.length > 0 ? upcomingPTO.join('<br>') : 'None scheduled'}
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="emailIndividualPTOReport('${employee.id}', '${reportMonth}')" style="font-size: 12px;">üìß Email to ${employee.name.split(',')[1] || employee.name}</button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = reportsHTML;
    }

    function calculateAccruedPTO(employee, monthsSinceHire) {
        // New accrual calculation based on length of service rates
        // First 90 days - no accrual
        if (monthsSinceHire < 3) return 0;
        
        const yearsOfService = monthsSinceHire / 12;
        let dailyAccrualRate;
        let maxAnnualDays;
        
        // Determine accrual rate based on length of service
        if (yearsOfService >= 20) {
            dailyAccrualRate = 0.10384; // 20+ years
            maxAnnualDays = 27;
        } else if (yearsOfService >= 10) {
            dailyAccrualRate = 0.10000; // 10-19 years  
            maxAnnualDays = 26;
        } else if (yearsOfService >= 5) {
            dailyAccrualRate = 0.08461; // 5-9 years
            maxAnnualDays = 22;
        } else {
            dailyAccrualRate = 0.06538; // Less than 5 years
            maxAnnualDays = 17;
        }
        
        // Calculate accrued days based on working days since hire (minus 90-day waiting period)
        const monthsEligible = monthsSinceHire - 3;
        const workingDaysEligible = monthsEligible * 21.67; // Average working days per month (260/12)
        const accruedDays = workingDaysEligible * dailyAccrualRate;
        
        // Cap at maximum annual allocation
        return Math.min(Math.floor(accruedDays), maxAnnualDays);
    }

    function getUpcomingPTO(employeeName) {
        const upcoming = [];
        const currentDate = new Date();
        const futureDate = new Date();
        futureDate.setDate(currentDate.getDate() + 30);

        currentDates.forEach(date => {
            if (date >= currentDate && date <= futureDate) {
                const dateKey = date.toISOString().split('T')[0];
                const shift = scheduleData[employeeName]?.[dateKey];
                if (shift && shift.toUpperCase() === 'PTO') {
                    upcoming.push(date.toLocaleDateString());
                }
            }
        });

        return upcoming;
    }

    function emailIndividualPTOReport(employeeId, reportMonth) {
        const employee = employees.find(emp => emp.id === employeeId);
        if (!employee) {
            alert('Employee not found');
            return;
        }

        // Calculate months since hire for proper PTO allocation
        const hireDate = new Date(employee.hireDate || new Date());
        const currentDate = new Date();
        const monthsSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24 * 30.44));
        const yearlyAllocation = getYearlyPTOAllocation(employee, monthsSinceHire);

        const ptoBalance = employeePTOBalances[employeeId] || {
            totalPTODays: yearlyAllocation,
            usedPTODays: 0,
            pendingPTODays: 0
        };
        
        // Ensure the total PTO days reflects the current year's allocation based on service length
        ptoBalance.totalPTODays = yearlyAllocation;

        const remainingPTO = ptoBalance.totalPTODays - ptoBalance.usedPTODays;
        const upcomingPTO = getUpcomingPTO(employee.name);

        const emailContent = `
Dear ${employee.name.split(',')[1] || employee.name},

Here is your monthly PTO balance summary for ${new Date(reportMonth).toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}:

üìä PTO BALANCE SUMMARY:
‚Ä¢ Annual PTO Allocation: ${ptoBalance.totalPTODays} days
‚Ä¢ Used This Year: ${ptoBalance.usedPTODays} days
‚Ä¢ Remaining Balance: ${remainingPTO} days
‚Ä¢ Pending Requests: ${ptoBalance.pendingPTODays} days

üìÖ UPCOMING SCHEDULED PTO (Next 30 Days):
${upcomingPTO.length > 0 ? upcomingPTO.map(date => `‚Ä¢ ${date}`).join('\n') : '‚Ä¢ None scheduled'}

${remainingPTO < 5 ? '\n‚ö†Ô∏è REMINDER: You have less than 5 PTO days remaining. Please plan accordingly.\n' : ''}

If you have any questions about your PTO balance or need to request time off, please contact your manager.

Best regards,
HR Department
        `;

        // Create email modal or copy to clipboard
        navigator.clipboard.writeText(emailContent).then(() => {
            alert(`PTO report for ${employee.name} has been copied to clipboard. You can now paste it into your email client.`);
        }).catch(() => {
            // Fallback - show in alert
            prompt('Copy this PTO report to send via email:', emailContent);
        });
    }

    function emailAllPTOReports() {
        const reportMonth = document.getElementById('reportMonth').value;
        if (!reportMonth) {
            alert('Please select a month for the report');
            return;
        }

        const eligibleEmployees = employees.filter(emp => 
            emp.id && !emp.name.startsWith('OPEN SHIFTS') && emp.type !== 'Bank'
        );

        let allReports = `MONTHLY PTO BALANCE REPORTS FOR ${new Date(reportMonth).toLocaleDateString('en-US', {month: 'long', year: 'numeric'}).toUpperCase()}\n`;
        allReports += '='.repeat(80) + '\n\n';

        eligibleEmployees.forEach(employee => {
            const ptoBalance = employeePTOBalances[employee.id] || {
                totalPTODays: employee.type === "FT" ? 20 : 15,
                usedPTODays: 0,
                pendingPTODays: 0
            };

            const remainingPTO = ptoBalance.totalPTODays - ptoBalance.usedPTODays;
            const upcomingPTO = getUpcomingPTO(employee.name);

            allReports += `${employee.name}\n`;
            allReports += '-'.repeat(employee.name.length) + '\n';
            allReports += `Annual Allocation: ${ptoBalance.totalPTODays} days | Used: ${ptoBalance.usedPTODays} days | Remaining: ${remainingPTO} days\n`;
            allReports += `Pending: ${ptoBalance.pendingPTODays} days | Hire Date: ${new Date(employee.hireDate || '2024-01-01').toLocaleDateString()}\n`;
            allReports += `Upcoming PTO: ${upcomingPTO.length > 0 ? upcomingPTO.join(', ') : 'None'}\n\n`;
        });

        // Copy all reports to clipboard
        navigator.clipboard.writeText(allReports).then(() => {
            alert('All PTO reports have been copied to clipboard. You can now paste them into your email client for bulk distribution.');
        }).catch(() => {
            // Fallback - show in prompt
            prompt('Copy these PTO reports for bulk email distribution:', allReports);
        });
    }

    // ===== ENHANCED PTO ACCRUAL SYSTEM =====
    
    function updatePTOAccruals() {
        // This function should be called monthly to update PTO accruals
        const currentDate = new Date();
        
        employees.forEach(employee => {
            if (!employee.id || employee.name.startsWith('OPEN SHIFTS') || employee.type === 'Bank') {
                return;
            }

            const hireDate = new Date(employee.hireDate || '2024-01-01');
            const monthsSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24 * 30.44));
            const yearlyAllocation = getYearlyPTOAllocation(employee, monthsSinceHire);
            
            // Initialize balance if it doesn't exist
            if (!employeePTOBalances[employee.id]) {
                employeePTOBalances[employee.id] = {
                    employeeName: employee.name,
                    hireDate: employee.hireDate || "2024-01-01",
                    totalPTODays: yearlyAllocation,
                    usedPTODays: 0,
                    pendingPTODays: 0,
                    lastAccrualDate: hireDate.toISOString().split('T')[0]
                };
            }

            const balance = employeePTOBalances[employee.id];
            const lastAccrual = new Date(balance.lastAccrualDate || hireDate);
            
            // Check if it's time for a new accrual (monthly)
            if (monthsSinceHire >= 3) { // No accrual first 90 days
                const monthsSinceLastAccrual = Math.floor((currentDate - lastAccrual) / (1000 * 60 * 60 * 24 * 30.44));
                
                if (monthsSinceLastAccrual >= 1) {
                    const monthlyAccrual = yearlyAllocation / 12;
                    
                    // Add accrued PTO (max out at yearly allocation)
                    const currentTotal = balance.totalPTODays || yearlyAllocation;
                    const newTotal = Math.min(currentTotal + monthlyAccrual, yearlyAllocation);
                    
                    balance.totalPTODays = Math.floor(newTotal);
                    balance.lastAccrualDate = currentDate.toISOString().split('T')[0];
                    
                    console.log(`Updated PTO accrual for ${employee.name}: +${monthlyAccrual.toFixed(1)} days`);
                }
            }
        });
        
        saveState();
    }

    function getYearlyPTOAllocation(employee, monthsSinceHire) {
        // New accrual rates based on length of service
        const yearsOfService = monthsSinceHire / 12;
        
        if (yearsOfService >= 20) {
            return 27; // 20+ years: 27 days/216 hours
        } else if (yearsOfService >= 10) {
            return 26; // 10-19 years: 26 days/208 hours  
        } else if (yearsOfService >= 5) {
            return 22; // 5-9 years: 22 days/176 hours
        } else {
            return 17; // Less than 5 years: 17 days/136 hours
        }
    }

    function checkPTOEligibilityEnhanced(employeeId) {
        const employee = employees.find(emp => emp.id === employeeId);
        if (!employee || !employee.hireDate) {
            return { eligible: false, reason: "No hire date found" };
        }
        
        const currentDate = new Date();
        const hireDate = new Date(employee.hireDate);
        const daysSinceHire = Math.floor((currentDate - hireDate) / (1000 * 60 * 60 * 24));
        
        // 90-day waiting period
        if (daysSinceHire < 90) {
            const remainingDays = 90 - daysSinceHire;
            return { 
                eligible: false, 
                reason: `Must wait ${remainingDays} more days before PTO eligibility (90-day waiting period)` 
            };
        }
        
        // Check if employee has sufficient PTO balance
        const balance = employeePTOBalances[employeeId];
        if (!balance || balance.totalPTODays - balance.usedPTODays <= 0) {
            return { 
                eligible: false, 
                reason: "Insufficient PTO balance available" 
            };
        }
        
        return { eligible: true, availableDays: balance.totalPTODays - balance.usedPTODays };
    }

    // Auto-run PTO accrual update on page load (for demo purposes)
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            updatePTOAccruals();
        }, 1000);
    });

    // ===== PTO CONFLICT DETECTION SYSTEM =====
    
    function checkPTOConflicts(employeeName, startDate, endDate) {
        const conflicts = [];
        const requestStart = new Date(startDate);
        const requestEnd = new Date(endDate);
        
        // Check against existing PTO requests
        Object.values(ptoRequests).forEach(request => {
            if (request.employeeName === employeeName && 
                (request.status === 'approved' || request.status === 'pending')) {
                
                const existingStart = new Date(request.startDate);
                const existingEnd = new Date(request.endDate);
                
                // Check for overlap
                if (requestStart <= existingEnd && requestEnd >= existingStart) {
                    conflicts.push({
                        type: 'employee_overlap',
                        message: `Overlaps with existing ${request.status} PTO request (${request.startDate} to ${request.endDate})`,
                        request: request
                    });
                }
            }
        });
        
        // Check against scheduled PTO in the schedule grid
        const dateRange = getDateRange(requestStart, requestEnd);
        dateRange.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const shift = scheduleData[employeeName]?.[dateKey];
            if (shift && shift.toUpperCase() === 'PTO') {
                conflicts.push({
                    type: 'schedule_conflict',
                    message: `PTO already scheduled on ${date.toLocaleDateString()}`,
                    date: dateKey
                });
            }
        });
        
        // Check minimum staffing levels for those dates
        const staffingConflicts = checkMinimumStaffing(dateRange, employeeName);
        conflicts.push(...staffingConflicts);
        
        return conflicts;
    }
    
    function getDateRange(startDate, endDate) {
        const dates = [];
        const current = new Date(startDate);
        const end = new Date(endDate);
        
        while (current <= end) {
            dates.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }
    
    function checkMinimumStaffing(dateRange, requestingEmployee) {
        const conflicts = [];
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
        
        dateRange.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0;
            
            // Count available staff for this date
            employees.forEach(emp => {
                if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
                if (emp.name === requestingEmployee) return; // Exclude the requesting employee
                
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift && shift.toUpperCase() !== 'PTO' && shift.trim() !== '') {
                    staffCount++;
                }
            });
            
            if (staffCount < minStaff) {
                conflicts.push({
                    type: 'staffing_shortage',
                    message: `Minimum staffing violation on ${date.toLocaleDateString()} (${staffCount}/${minStaff} available)`,
                    date: dateKey,
                    currentStaff: staffCount,
                    requiredStaff: minStaff
                });
            }
        });
        
        return conflicts;
    }
    
    // Enhanced PTO request validation
    function validatePTORequest(employeeId, startDate, endDate, requestType) {
        const employee = employees.find(emp => emp.id === employeeId);
        if (!employee) {
            return { valid: false, errors: ['Employee not found'] };
        }
        
        const errors = [];
        const warnings = [];
        
        // Check eligibility
        const eligibility = checkPTOEligibilityEnhanced(employeeId);
        if (!eligibility.eligible) {
            errors.push(eligibility.reason);
        }
        
        // Check date validity
        const start = new Date(startDate);
        const end = new Date(endDate);
        const today = new Date();
        
        if (start > end) {
            errors.push('Start date must be before end date');
        }
        
        if (start < today && requestType !== 'emergency') {
            errors.push('Cannot request PTO for past dates (except emergency leave)');
        }
        
        // Calculate days requested
        const daysRequested = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        const balance = employeePTOBalances[employeeId];
        const availableDays = balance ? balance.totalPTODays - balance.usedPTODays : 0;
        
        if (daysRequested > availableDays) {
            errors.push(`Insufficient PTO balance. Requested: ${daysRequested} days, Available: ${availableDays} days`);
        }
        
        // Check for conflicts
        const conflicts = checkPTOConflicts(employee.name, startDate, endDate);
        
        conflicts.forEach(conflict => {
            if (conflict.type === 'employee_overlap' || conflict.type === 'schedule_conflict') {
                errors.push(conflict.message);
            } else if (conflict.type === 'staffing_shortage') {
                warnings.push(conflict.message);
            }
        });
        
        // Advanced notice requirements
        const advanceNotice = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
        if (requestType === 'vacation' && advanceNotice < 14) {
            warnings.push('Vacation requests should be submitted at least 14 days in advance');
        }
        
        return {
            valid: errors.length === 0,
            errors: errors,
            warnings: warnings,
            conflicts: conflicts,
            daysRequested: daysRequested,
            availableDays: availableDays
        };
    }

    // ===== SMART SCHEDULING ASSISTANT FUNCTIONS =====
    
    function smartScheduleAssistant() {
        document.getElementById('smartScheduleModal').style.display = 'block';
        
        // Set default month to current schedule month
        const currentMonth = document.getElementById('scheduleMonth').value;
        document.getElementById('planning-horizon').value = 'current';
    }

    function runSmartScheduling() {
        const priority = document.getElementById('optimization-priority').value;
        const distribution = document.getElementById('shift-distribution').value;
        const constraintLevel = document.getElementById('constraint-level').value;
        const horizon = document.getElementById('planning-horizon').value;

        // Show loading state
        const resultsDiv = document.getElementById('smart-schedule-results');
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><strong>üîÑ Analyzing schedule patterns and generating optimized assignments...</strong></div>';

        // Simulate processing time and then run the optimization
        setTimeout(() => {
            const optimizationResult = performScheduleOptimization(priority, distribution, constraintLevel);
            displayOptimizationResults(optimizationResult);
        }, 1500);
    }

    function performScheduleOptimization(priority, distribution, constraintLevel) {
        const optimizedSchedule = JSON.parse(JSON.stringify(scheduleData));
        const suggestions = [];
        const metrics = {
            coverageScore: 0,
            fairnessScore: 0,
            costSavings: 0,
            conflictsResolved: 0
        };

        // Analyze current schedule
        const currentProblems = analyzeScheduleProblems();
        
        // Generate optimization suggestions based on priority
        switch (priority) {
            case 'coverage':
                suggestions.push(...optimizeForCoverage(currentProblems));
                break;
            case 'cost':
                suggestions.push(...optimizeForCost(currentProblems));
                break;
            case 'fairness':
                suggestions.push(...optimizeForFairness(currentProblems));
                break;
            case 'preferences':
                suggestions.push(...optimizeForPreferences(currentProblems));
                break;
        }

        // Calculate metrics for the optimization
        metrics.coverageScore = calculateCoverageScore();
        metrics.fairnessScore = calculateFairnessScore();
        metrics.costSavings = calculatePotentialSavings(suggestions);
        metrics.conflictsResolved = currentProblems.length;

        return {
            suggestions,
            metrics,
            problems: currentProblems,
            optimizedSchedule
        };
    }

    function analyzeScheduleProblems() {
        const problems = [];
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;

        // Check each day for problems
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0;
            let scheduledEmployees = [];

            employees.forEach(emp => {
                if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
                
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift && shift.toUpperCase() !== 'PTO' && shift.trim() !== '') {
                    staffCount++;
                    scheduledEmployees.push({ name: emp.name, shift: shift });
                }
            });

            // Check for understaffing
            if (staffCount < minStaff) {
                problems.push({
                    type: 'understaffing',
                    date: dateKey,
                    currentStaff: staffCount,
                    requiredStaff: minStaff,
                    severity: minStaff - staffCount
                });
            }

            // Check for availability conflicts
            scheduledEmployees.forEach(scheduled => {
                const emp = employees.find(e => e.name === scheduled.name);
                if (emp && emp.availability) {
                    const dayOfWeek = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
                    if (!emp.availability.toLowerCase().includes(dayOfWeek)) {
                        problems.push({
                            type: 'availability_conflict',
                            date: dateKey,
                            employee: scheduled.name,
                            shift: scheduled.shift
                        });
                    }
                }
            });
        });

        return problems;
    }

    function optimizeForCoverage(problems) {
        const suggestions = [];
        
        problems.filter(p => p.type === 'understaffing').forEach(problem => {
            const availableEmployees = getAvailableEmployees(problem.date);
            const date = new Date(problem.date);
            const dayOfWeek = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
            
            availableEmployees.forEach(emp => {
                if (emp.availability.toLowerCase().includes(dayOfWeek)) {
                    suggestions.push({
                        type: 'add_shift',
                        employee: emp.name,
                        date: problem.date,
                        suggestedShift: emp.shifts || '10a-6:30p',
                        reason: `Add ${emp.name} to resolve understaffing (${problem.currentStaff}/${problem.requiredStaff})`
                    });
                }
            });
        });

        return suggestions;
    }

    function optimizeForCost(problems) {
        const suggestions = [];
        
        // Look for overtime opportunities to reduce
        const overtimeAnalysis = analyzeOvertimePatterns();
        
        overtimeAnalysis.forEach(overtime => {
            suggestions.push({
                type: 'reduce_overtime',
                employee: overtime.employee,
                currentHours: overtime.hours,
                suggestedReduction: overtime.excessHours,
                reason: `Reduce ${overtime.employee}'s hours by ${overtime.excessHours} to minimize overtime costs`
            });
        });

        return suggestions;
    }

    function optimizeForFairness(problems) {
        const suggestions = [];
        const workloadAnalysis = analyzeWorkloadDistribution();
        
        workloadAnalysis.unbalanced.forEach(emp => {
            if (emp.variance > 10) { // More than 10 hours difference from average
                suggestions.push({
                    type: 'rebalance_workload',
                    employee: emp.name,
                    currentHours: emp.hours,
                    targetHours: emp.targetHours,
                    adjustment: emp.variance > 0 ? 'decrease' : 'increase',
                    reason: `Rebalance ${emp.name}'s workload (currently ${emp.hours}h, target: ${emp.targetHours}h)`
                });
            }
        });

        return suggestions;
    }

    function optimizeForPreferences(problems) {
        // This would integrate with employee preference data when available
        return [{
            type: 'preference_optimization',
            reason: 'Employee preference optimization requires preference data setup'
        }];
    }

    function getAvailableEmployees(dateKey) {
        return employees.filter(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return false;
            
            const shift = scheduleData[emp.name]?.[dateKey];
            return !shift || shift.trim() === '';
        });
    }

    function analyzeOvertimePatterns() {
        const targetHours = parseFloat(document.getElementById('targetHours').value) || 160;
        const overtimeEmployees = [];

        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
            
            let totalHours = 0;
            if (scheduleData[emp.name]) {
                Object.values(scheduleData[emp.name]).forEach(shift => {
                    if (shift && shift.toUpperCase() !== 'PTO') {
                        totalHours += shiftsInfo[shift] || 0;
                    }
                });
            }

            const empTargetHours = emp.targetHours || (emp.type === 'FT' ? targetHours : 80);
            if (totalHours > empTargetHours * 1.1) {
                overtimeEmployees.push({
                    employee: emp.name,
                    hours: totalHours,
                    targetHours: empTargetHours,
                    excessHours: totalHours - empTargetHours
                });
            }
        });

        return overtimeEmployees;
    }

    function analyzeWorkloadDistribution() {
        const targetHours = parseFloat(document.getElementById('targetHours').value) || 160;
        const balanced = [];
        const unbalanced = [];

        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
            
            let totalHours = 0;
            if (scheduleData[emp.name]) {
                Object.values(scheduleData[emp.name]).forEach(shift => {
                    if (shift && shift.toUpperCase() !== 'PTO') {
                        totalHours += shiftsInfo[shift] || 0;
                    }
                });
            }

            const empTargetHours = emp.targetHours || (emp.type === 'FT' ? targetHours : 80);
            const variance = totalHours - empTargetHours;

            const empData = {
                name: emp.name,
                hours: totalHours,
                targetHours: empTargetHours,
                variance: variance
            };

            if (Math.abs(variance) > 5) {
                unbalanced.push(empData);
            } else {
                balanced.push(empData);
            }
        });

        return { balanced, unbalanced };
    }

    function calculateCoverageScore() {
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
        let adequateDays = 0;

        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0;

            employees.forEach(emp => {
                if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
                
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift && shift.toUpperCase() !== 'PTO' && shift.trim() !== '') {
                    staffCount++;
                }
            });

            if (staffCount >= minStaff) adequateDays++;
        });

        return Math.round((adequateDays / currentDates.length) * 100);
    }

    function calculateFairnessScore() {
        const workloadAnalysis = analyzeWorkloadDistribution();
        const fairEmployees = workloadAnalysis.balanced.length;
        const totalEmployees = workloadAnalysis.balanced.length + workloadAnalysis.unbalanced.length;
        
        return totalEmployees > 0 ? Math.round((fairEmployees / totalEmployees) * 100) : 100;
    }

    function calculatePotentialSavings(suggestions) {
        let savings = 0;
        
        suggestions.forEach(suggestion => {
            if (suggestion.type === 'reduce_overtime') {
                savings += suggestion.suggestedReduction * 15; // Assume $15/hour overtime premium
            }
        });

        return savings;
    }

    function displayOptimizationResults(result) {
        const { suggestions, metrics, problems } = result;
        
        let summaryHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 10px; background: #d4edda; border-radius: 5px;">
                    <strong>Coverage Score</strong><br>
                    <span style="font-size: 24px;">${metrics.coverageScore}%</span>
                </div>
                <div style="text-align: center; padding: 10px; background: #cce5ff; border-radius: 5px;">
                    <strong>Fairness Score</strong><br>
                    <span style="font-size: 24px;">${metrics.fairnessScore}%</span>
                </div>
                <div style="text-align: center; padding: 10px; background: #d1ecf1; border-radius: 5px;">
                    <strong>Potential Savings</strong><br>
                    <span style="font-size: 24px;">$${metrics.costSavings}</span>
                </div>
                <div style="text-align: center; padding: 10px; background: #fff3cd; border-radius: 5px;">
                    <strong>Issues Found</strong><br>
                    <span style="font-size: 24px;">${problems.length}</span>
                </div>
            </div>
        `;

        let changesHTML = '<h5>Suggested Optimizations:</h5>';
        
        if (suggestions.length === 0) {
            changesHTML += '<p style="color: #28a745; font-weight: bold;">‚úÖ No optimizations needed - schedule looks good!</p>';
        } else {
            changesHTML += '<div style="max-height: 300px; overflow-y: auto;">';
            suggestions.forEach((suggestion, index) => {
                changesHTML += `
                    <div style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; background: #f9f9f9;">
                        <strong>${index + 1}. ${suggestion.type.replace(/_/g, ' ').toUpperCase()}</strong><br>
                        <span style="color: #666;">${suggestion.reason}</span>
                        <div style="margin-top: 5px;">
                            <button class="btn btn-success" onclick="applySuggestion(${index})" style="font-size: 12px; padding: 5px 10px;">Apply</button>
                            <button class="btn btn-secondary" onclick="ignoreSuggestion(${index})" style="font-size: 12px; padding: 5px 10px;">Ignore</button>
                        </div>
                    </div>
                `;
            });
            changesHTML += '</div>';
        }

        document.getElementById('optimization-summary').innerHTML = summaryHTML;
        document.getElementById('proposed-changes').innerHTML = changesHTML;
        
        // Store suggestions globally for applying later
        window.currentOptimizationSuggestions = suggestions;
    }

    function applySuggestion(index) {
        const suggestion = window.currentOptimizationSuggestions[index];
        if (!suggestion) return;

        recordHistory();

        switch (suggestion.type) {
            case 'add_shift':
                if (!scheduleData[suggestion.employee]) {
                    scheduleData[suggestion.employee] = {};
                }
                scheduleData[suggestion.employee][suggestion.date] = suggestion.suggestedShift;
                break;
            // Add more cases as needed
        }

        saveState();
        renderTable();
        alert('‚úÖ Suggestion applied successfully!');
        
        // Remove the applied suggestion from the list
        window.currentOptimizationSuggestions.splice(index, 1);
        
        // Re-run optimization to show updated results
        runSmartScheduling();
    }

    function ignoreSuggestion(index) {
        window.currentOptimizationSuggestions.splice(index, 1);
        alert('Suggestion ignored.');
        
        // Re-display without the ignored suggestion
        const result = {
            suggestions: window.currentOptimizationSuggestions,
            metrics: window.lastOptimizationMetrics || {},
            problems: window.lastOptimizationProblems || []
        };
        displayOptimizationResults(result);
    }

    function previewScheduleChanges() {
        alert('Schedule preview functionality - would show a side-by-side comparison of current vs. optimized schedule');
    }

    function validateProposedSchedule() {
        const validation = performScheduleValidation();
        alert(`Schedule Validation Results:\n\n‚úÖ Valid shifts: ${validation.validShifts}\n‚ö†Ô∏è Conflicts: ${validation.conflicts}\nüìä Coverage score: ${validation.coverageScore}%\nüí∞ Cost efficiency: ${validation.costScore}%`);
    }

    function performScheduleValidation() {
        let validShifts = 0;
        let conflictCount = 0;
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;

        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            let staffCount = 0;

            employees.forEach(emp => {
                if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
                
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift && shift.toUpperCase() !== 'PTO' && shift.trim() !== '') {
                    validShifts++;
                    staffCount++;
                    
                    // Check availability conflicts
                    if (emp.availability) {
                        const dayOfWeek = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
                        if (!emp.availability.toLowerCase().includes(dayOfWeek)) {
                            conflictCount++;
                        }
                    }
                }
            });

            if (staffCount < minStaff) {
                conflictCount++;
            }
        });

        const coverageScore = calculateCoverageScore();
        const costScore = calculateCostEfficiency();

        return {
            validShifts,
            conflicts: conflictCount,
            coverageScore,
            costScore
        };
    }

    function calculateCostEfficiency() {
        // Simple cost efficiency calculation based on overtime vs. regular hours
        let regularHours = 0;
        let overtimeHours = 0;
        const targetHours = parseFloat(document.getElementById('targetHours').value) || 160;

        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
            
            let totalHours = 0;
            if (scheduleData[emp.name]) {
                Object.values(scheduleData[emp.name]).forEach(shift => {
                    if (shift && shift.toUpperCase() !== 'PTO') {
                        totalHours += shiftsInfo[shift] || 0;
                    }
                });
            }

            const empTargetHours = emp.targetHours || (emp.type === 'FT' ? targetHours : 80);
            if (totalHours > empTargetHours) {
                overtimeHours += totalHours - empTargetHours;
                regularHours += empTargetHours;
            } else {
                regularHours += totalHours;
            }
        });

        const totalHours = regularHours + overtimeHours;
        return totalHours > 0 ? Math.round((regularHours / totalHours) * 100) : 100;
    }

    function optimizeSchedule() {
        if (!confirm('This will automatically optimize the current schedule. Continue?')) return;
        
        recordHistory();
        
        // Run a simplified optimization
        const priority = 'coverage'; // Default to coverage optimization
        const optimizationResult = performScheduleOptimization(priority, 'balanced', 'standard');
        
        // Apply the first few suggestions automatically
        const autoApplySuggestions = optimizationResult.suggestions.slice(0, 3);
        
        autoApplySuggestions.forEach(suggestion => {
            switch (suggestion.type) {
                case 'add_shift':
                    if (!scheduleData[suggestion.employee]) {
                        scheduleData[suggestion.employee] = {};
                    }
                    scheduleData[suggestion.employee][suggestion.date] = suggestion.suggestedShift;
                    break;
            }
        });

        saveState();
        renderTable();
        
        alert(`‚ú® Schedule optimized! Applied ${autoApplySuggestions.length} improvements.\n\nCoverage Score: ${optimizationResult.metrics.coverageScore}%\nIssues Resolved: ${autoApplySuggestions.length}`);
    }

    // ===== TEAM PTO CALENDAR FUNCTIONS =====
    
    function openPTOCalendarModal() {
        // Set default month to current schedule month
        const currentMonth = document.getElementById('scheduleMonth').value;
        document.getElementById('ptoCalendarMonth').value = currentMonth;
        
        document.getElementById('ptoCalendarModal').style.display = 'block';
        renderPTOCalendar();
    }

    function renderPTOCalendar() {
        const selectedMonth = document.getElementById('ptoCalendarMonth').value;
        const viewType = document.getElementById('ptoCalendarView').value;
        const filter = document.getElementById('ptoCalendarFilter').value;
        
        if (!selectedMonth) return;

        const container = document.getElementById('pto-calendar-container');
        
        switch (viewType) {
            case 'monthly':
                renderMonthlyPTOView(container, selectedMonth, filter);
                break;
            case 'weekly':
                renderWeeklyPTOView(container, selectedMonth, filter);
                break;
            case 'timeline':
                renderTimelinePTOView(container, selectedMonth, filter);
                break;
        }

        // Check for conflicts and display alerts
        checkAndDisplayPTOConflicts(selectedMonth);
    }

    function renderMonthlyPTOView(container, month, filter) {
        const [year, monthNum] = month.split('-').map(Number);
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        const firstDay = new Date(year, monthNum - 1, 1).getDay();
        
        let calendarHTML = `
            <h4>PTO Calendar - ${new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h4>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-top: 15px;">
        `;
        
        // Add day headers
        const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayHeaders.forEach(day => {
            calendarHTML += `<div style="padding: 10px; background: #dee2e6; text-align: center; font-weight: bold;">${day}</div>`;
        });
        
        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            calendarHTML += '<div style="padding: 10px; background: #f8f9fa;"></div>';
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, monthNum - 1, day);
            const dateKey = date.toISOString().split('T')[0];
            const ptoInfo = getPTOInfoForDate(dateKey, filter);
            
            let cellClass = 'background: #fff; border: 1px solid #ddd;';
            if (ptoInfo.hasConflicts) cellClass = 'background: #f8d7da; border: 2px solid #dc3545;';
            else if (ptoInfo.count > 0) cellClass = 'background: #fff3cd; border: 1px solid #ffc107;';
            
            calendarHTML += `
                <div style="padding: 8px; ${cellClass} min-height: 80px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px;">${day}</div>
                    ${ptoInfo.details.map(detail => `
                        <div style="font-size: 10px; padding: 2px; margin: 1px 0; background: ${getPTOTypeColor(detail.type)}; border-radius: 3px;">
                            ${detail.employee}: ${detail.type}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        calendarHTML += '</div>';
        
        // Add legend
        calendarHTML += `
            <div style="margin-top: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 15px; height: 15px; background: #fff3cd; border: 1px solid #ffc107;"></div>
                    <span style="font-size: 12px;">PTO Scheduled</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 15px; height: 15px; background: #f8d7da; border: 2px solid #dc3545;"></div>
                    <span style="font-size: 12px;">Coverage Conflict</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 15px; height: 15px; background: #d4edda;"></div>
                    <span style="font-size: 12px;">Approved PTO</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div style="width: 15px; height: 15px; background: #cce5ff;"></div>
                    <span style="font-size: 12px;">Pending PTO</span>
                </div>
            </div>
        `;
        
        container.innerHTML = calendarHTML;
    }

    function renderWeeklyPTOView(container, month, filter) {
        container.innerHTML = `
            <h4>Weekly PTO View - ${month}</h4>
            <p style="color: #666; text-align: center; padding: 40px;">Weekly view implementation - would show PTO by week with more detail</p>
        `;
    }

    function renderTimelinePTOView(container, month, filter) {
        const [year, monthNum] = month.split('-').map(Number);
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        
        let timelineHTML = `
            <h4>PTO Timeline - ${new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h4>
            <div style="margin-top: 20px;">
        `;
        
        // Get all PTO requests for the month
        const ptoByEmployee = {};
        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
            ptoByEmployee[emp.name] = [];
        });

        // Collect PTO data
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, monthNum - 1, day);
            const dateKey = date.toISOString().split('T')[0];
            
            // Check schedule data
            Object.keys(ptoByEmployee).forEach(empName => {
                const shift = scheduleData[empName]?.[dateKey];
                if (shift && shift.toUpperCase() === 'PTO') {
                    ptoByEmployee[empName].push({
                        date: dateKey,
                        type: 'scheduled',
                        status: 'approved'
                    });
                }
            });

            // Check PTO requests
            Object.values(ptoRequests || {}).forEach(request => {
                const requestDate = new Date(request.startDate);
                const endDate = new Date(request.endDate);
                if (date >= requestDate && date <= endDate) {
                    if (ptoByEmployee[request.employeeName]) {
                        ptoByEmployee[request.employeeName].push({
                            date: dateKey,
                            type: request.requestType,
                            status: request.status
                        });
                    }
                }
            });
        }

        // Render timeline for each employee
        Object.keys(ptoByEmployee).forEach(empName => {
            const ptoDays = ptoByEmployee[empName];
            if (ptoDays.length === 0 && filter !== 'all') return;

            timelineHTML += `
                <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <strong>${empName}</strong>
                    <div style="display: flex; align-items: center; margin-top: 8px; position: relative; height: 30px;">
            `;

            // Create timeline bar
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, monthNum - 1, day);
                const dateKey = date.toISOString().split('T')[0];
                const hasPTO = ptoDays.find(p => p.date === dateKey);
                
                const width = 100 / daysInMonth;
                let backgroundColor = '#f8f9fa';
                
                if (hasPTO) {
                    backgroundColor = hasPTO.status === 'approved' ? '#d4edda' : 
                                   hasPTO.status === 'pending' ? '#fff3cd' : '#f8d7da';
                }

                timelineHTML += `
                    <div style="width: ${width}%; height: 20px; background: ${backgroundColor}; border: 1px solid #ddd; display: inline-block; position: relative;" 
                         title="${day}/${monthNum} ${hasPTO ? `- ${hasPTO.type} (${hasPTO.status})` : ''}">
                    </div>
                `;
            }

            timelineHTML += `
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ${ptoDays.length} PTO day(s) this month
                    </div>
                </div>
            `;
        });

        timelineHTML += '</div>';
        container.innerHTML = timelineHTML;
    }

    function getPTOInfoForDate(dateKey, filter) {
        const info = {
            count: 0,
            hasConflicts: false,
            details: []
        };

        // Check scheduled PTO in the grid
        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
            
            const shift = scheduleData[emp.name]?.[dateKey];
            if (shift && shift.toUpperCase() === 'PTO') {
                info.count++;
                info.details.push({
                    employee: emp.name.split(',')[0] || emp.name,
                    type: 'PTO',
                    status: 'approved'
                });
            }
        });

        // Check PTO requests
        Object.values(ptoRequests || {}).forEach(request => {
            const requestDate = new Date(dateKey);
            const startDate = new Date(request.startDate);
            const endDate = new Date(request.endDate);
            
            if (requestDate >= startDate && requestDate <= endDate) {
                if (filter === 'all' || filter === request.requestType || filter === request.status) {
                    info.count++;
                    info.details.push({
                        employee: request.employeeName.split(',')[0] || request.employeeName,
                        type: request.requestType,
                        status: request.status
                    });
                }
            }
        });

        // Check for conflicts (too many people off)
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
        if (info.count >= minStaff) {
            info.hasConflicts = true;
        }

        return info;
    }

    function getPTOTypeColor(type) {
        const colors = {
            'vacation': '#d4edda',
            'sick': '#f8d7da', 
            'personal': '#cce5ff',
            'emergency': '#ffe6cc',
            'approved': '#d4edda',
            'pending': '#fff3cd',
            'denied': '#f8d7da',
            'PTO': '#d4edda'
        };
        return colors[type] || '#e9ecef';
    }

    function checkAndDisplayPTOConflicts(month) {
        const conflicts = detectMonthlyPTOConflicts(month);
        const alertDiv = document.getElementById('pto-conflicts-alert');
        
        if (conflicts.length > 0) {
            let conflictHTML = '<ul style="margin: 10px 0; padding-left: 20px;">';
            conflicts.forEach(conflict => {
                conflictHTML += `<li>${conflict.date}: ${conflict.message}</li>`;
            });
            conflictHTML += '</ul>';
            
            document.getElementById('conflicts-list').innerHTML = conflictHTML;
            alertDiv.style.display = 'block';
        } else {
            alertDiv.style.display = 'none';
        }
    }

    function detectMonthlyPTOConflicts(month) {
        const conflicts = [];
        const [year, monthNum] = month.split('-').map(Number);
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, monthNum - 1, day);
            const dateKey = date.toISOString().split('T')[0];
            const ptoInfo = getPTOInfoForDate(dateKey, 'all');
            
            if (ptoInfo.count >= minStaff) {
                conflicts.push({
                    date: date.toLocaleDateString(),
                    message: `${ptoInfo.count} employees off, minimum ${minStaff} required`
                });
            }
        }

        return conflicts;
    }

    // ===== COVERAGE ANALYSIS FUNCTIONS =====
    
    function openCoverageAnalysisModal() {
        document.getElementById('coverageAnalysisModal').style.display = 'block';
        renderCoverageAnalysis();
    }

    function renderCoverageAnalysis() {
        const analysis = performCoverageAnalysis();
        
        // Update dashboard counters
        document.getElementById('adequate-coverage-count').textContent = analysis.adequate;
        document.getElementById('at-risk-count').textContent = analysis.atRisk;
        document.getElementById('critical-shortage-count').textContent = analysis.critical;
        
        // Render detailed analysis
        const container = document.getElementById('coverage-analysis-container');
        let analysisHTML = '<h4>Daily Coverage Analysis</h4>';
        
        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const coverageData = analyzeDailyCoverage(dateKey);
            
            let statusClass = 'background: #d4edda;'; // Good
            if (coverageData.status === 'at-risk') statusClass = 'background: #fff3cd;';
            if (coverageData.status === 'critical') statusClass = 'background: #f8d7da;';
            
            analysisHTML += `
                <div style="padding: 10px; margin: 5px 0; border-radius: 5px; ${statusClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>${date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</strong>
                        <span style="font-weight: bold;">${coverageData.staffCount}/${coverageData.requiredStaff} Staff</span>
                    </div>
                    <div style="font-size: 12px; margin-top: 5px;">
                        ${coverageData.message}
                    </div>
                    ${coverageData.suggestions.length > 0 ? `
                        <div style="margin-top: 8px; font-size: 12px;">
                            <strong>Suggestions:</strong> ${coverageData.suggestions.join(', ')}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        container.innerHTML = analysisHTML;
    }

    function performCoverageAnalysis() {
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
        let adequate = 0, atRisk = 0, critical = 0;

        currentDates.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            const coverage = analyzeDailyCoverage(dateKey);
            
            if (coverage.status === 'adequate') adequate++;
            else if (coverage.status === 'at-risk') atRisk++;
            else if (coverage.status === 'critical') critical++;
        });

        return { adequate, atRisk, critical };
    }

    function analyzeDailyCoverage(dateKey) {
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
        let staffCount = 0;
        let availableEmployees = [];
        let onPTO = [];

        employees.forEach(emp => {
            if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
            
            const shift = scheduleData[emp.name]?.[dateKey];
            if (shift && shift.toUpperCase() === 'PTO') {
                onPTO.push(emp.name);
            } else if (shift && shift.trim() !== '') {
                staffCount++;
                availableEmployees.push(emp.name);
            }
        });

        let status = 'adequate';
        let message = `${staffCount} employees scheduled`;
        let suggestions = [];

        if (staffCount < minStaff) {
            status = staffCount === 0 ? 'critical' : 'at-risk';
            message = `Understaffed: ${minStaff - staffCount} more employees needed`;
            
            // Generate suggestions
            const date = new Date(dateKey);
            const dayOfWeek = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
            
            employees.forEach(emp => {
                if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
                if (availableEmployees.includes(emp.name) || onPTO.includes(emp.name)) return;
                
                if (emp.availability && emp.availability.toLowerCase().includes(dayOfWeek)) {
                    suggestions.push(`Schedule ${emp.name.split(',')[0]}`);
                }
            });
        }

        if (onPTO.length > 0) {
            message += `, ${onPTO.length} on PTO`;
        }

        return {
            status,
            staffCount,
            requiredStaff: minStaff,
            message,
            suggestions: suggestions.slice(0, 3), // Limit to 3 suggestions
            onPTO,
            availableEmployees
        };
    }

    // ===== ENHANCED EMPLOYEE PORTAL FUNCTIONS =====
    
    function updatePTOPreview() {
        const startDate = document.getElementById('pto-start-date').value;
        const endDate = document.getElementById('pto-end-date').value;
        
        if (!startDate || !endDate) {
            document.getElementById('pto-impact-preview').style.display = 'none';
            document.getElementById('pto-days-display').value = '';
            return;
        }

        const start = new Date(startDate);
        const end = new Date(endDate);
        const daysRequested = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        
        document.getElementById('pto-days-display').value = daysRequested;
        
        // Show impact preview
        const urlParams = new URLSearchParams(window.location.search);
        const portalId = urlParams.get('portal');
        
        if (portalId) {
            const employee = employees.find(e => e.id === portalId);
            if (employee) {
                showPTOImpactPreview(employee.name, startDate, endDate, daysRequested);
            }
        }
    }

    function showPTOImpactPreview(employeeName, startDate, endDate, daysRequested) {
        const previewDiv = document.getElementById('pto-impact-preview');
        const conflicts = checkPTOConflicts(employeeName, startDate, endDate);
        
        let previewHTML = '<h5>üìä Request Impact Analysis</h5>';
        
        // Check team impact
        const teamImpact = analyzeTeamImpact(startDate, endDate);
        
        if (conflicts.length === 0) {
            previewHTML += '<div style="color: #28a745; font-weight: bold;">‚úÖ No conflicts detected - good time to request!</div>';
        } else {
            previewHTML += '<div style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è Potential issues detected:</div>';
            previewHTML += '<ul style="margin: 10px 0; padding-left: 20px; color: #dc3545;">';
            conflicts.forEach(conflict => {
                previewHTML += `<li>${conflict.message}</li>`;
            });
            previewHTML += '</ul>';
        }
        
        // Show team impact
        previewHTML += `
            <div style="margin-top: 10px;">
                <strong>Team Impact:</strong><br>
                <div style="font-size: 12px;">
                    ‚Ä¢ Others on PTO during this period: ${teamImpact.othersOnPTO}<br>
                    ‚Ä¢ Team coverage level: ${teamImpact.coverageLevel}<br>
                    ‚Ä¢ Recommended alternative dates: ${teamImpact.alternatives}
                </div>
            </div>
        `;
        
        previewDiv.innerHTML = previewHTML;
        previewDiv.style.display = 'block';
        previewDiv.style.background = conflicts.length > 0 ? '#f8d7da' : '#d4edda';
    }

    function analyzeTeamImpact(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        let othersOnPTO = 0;
        let coverageLevel = 'Good';
        let alternatives = 'None needed';

        // Count others on PTO during the requested period
        const dateRange = getDateRange(start, end);
        const ptoEmployees = new Set();

        dateRange.forEach(date => {
            const dateKey = date.toISOString().split('T')[0];
            employees.forEach(emp => {
                if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
                
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift && shift.toUpperCase() === 'PTO') {
                    ptoEmployees.add(emp.name);
                }
            });
        });

        othersOnPTO = ptoEmployees.size;
        
        // Determine coverage level
        const totalEmployees = employees.filter(emp => 
            !emp.name.startsWith('OPEN SHIFTS') && emp.type !== 'Bank'
        ).length;
        
        const availableStaff = totalEmployees - othersOnPTO - 1; // -1 for requesting employee
        const minStaff = parseInt(document.getElementById('minStaff').value) || 3;
        
        if (availableStaff < minStaff) {
            coverageLevel = 'Critical';
            alternatives = generateAlternativeDates(startDate, endDate);
        } else if (availableStaff < minStaff + 1) {
            coverageLevel = 'At Risk';
        }

        return {
            othersOnPTO,
            coverageLevel,
            alternatives
        };
    }

    function generateAlternativeDates(originalStart, originalEnd) {
        const start = new Date(originalStart);
        const end = new Date(originalEnd);
        const durationDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        const alternatives = [];

        // Check weeks before and after
        for (let weekOffset = -2; weekOffset <= 2; weekOffset++) {
            if (weekOffset === 0) continue; // Skip the original week
            
            const altStart = new Date(start);
            altStart.setDate(start.getDate() + (weekOffset * 7));
            
            const altEnd = new Date(altStart);
            altEnd.setDate(altStart.getDate() + durationDays - 1);
            
            // Check if this alternative has better coverage
            const altImpact = analyzeTeamImpact(
                altStart.toISOString().split('T')[0],
                altEnd.toISOString().split('T')[0]
            );
            
            if (altImpact.coverageLevel === 'Good') {
                alternatives.push(altStart.toLocaleDateString());
                if (alternatives.length >= 2) break; // Limit to 2 alternatives
            }
        }

        return alternatives.length > 0 ? alternatives.join(', ') : 'Consider shorter duration';
    }

    function suggestBestPTODates() {
        const urlParams = new URLSearchParams(window.location.search);
        const portalId = urlParams.get('portal');
        
        if (!portalId) return;
        
        const employee = employees.find(e => e.id === portalId);
        if (!employee) return;

        const suggestionsDiv = document.getElementById('pto-suggestions');
        suggestionsDiv.innerHTML = '<div style="text-align: center; padding: 10px;">üîÑ Analyzing best dates for PTO...</div>';
        suggestionsDiv.style.display = 'block';

        // Simulate analysis time
        setTimeout(() => {
            const suggestions = generatePTOSuggestions(employee);
            displayPTOSuggestions(suggestions);
        }, 1000);
    }

    function generatePTOSuggestions(employee) {
        const suggestions = [];
        const currentDate = new Date();
        
        // Analyze next 90 days for good PTO opportunities
        for (let i = 7; i < 90; i += 7) { // Check weekly intervals
            const checkDate = new Date(currentDate);
            checkDate.setDate(currentDate.getDate() + i);
            
            // Check a 3-day period starting from this date
            const endDate = new Date(checkDate);
            endDate.setDate(checkDate.getDate() + 2);
            
            const impact = analyzeTeamImpact(
                checkDate.toISOString().split('T')[0],
                endDate.toISOString().split('T')[0]
            );
            
            if (impact.coverageLevel === 'Good') {
                suggestions.push({
                    startDate: checkDate.toLocaleDateString(),
                    endDate: endDate.toLocaleDateString(),
                    reason: 'Good team coverage',
                    score: 100 - impact.othersOnPTO * 10
                });
            }
        }

        // Sort by score and return top 3
        return suggestions.sort((a, b) => b.score - a.score).slice(0, 3);
    }

    function displayPTOSuggestions(suggestions) {
        const suggestionsDiv = document.getElementById('pto-suggestions');
        
        if (suggestions.length === 0) {
            suggestionsDiv.innerHTML = '<div style="text-align: center; color: #666;">No optimal dates found in the next 90 days. Consider requesting shorter periods.</div>';
            return;
        }

        let suggestionsHTML = '<h5>üéØ Recommended PTO Dates</h5>';
        
        suggestions.forEach((suggestion, index) => {
            suggestionsHTML += `
                <div style="padding: 8px; border: 1px solid #28a745; border-radius: 3px; margin: 5px 0; background: #f8fff8;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>${suggestion.startDate} - ${suggestion.endDate}</strong>
                        <button class="btn btn-success" onclick="useSuggestedDates('${suggestion.startDate}', '${suggestion.endDate}')" style="font-size: 12px; padding: 3px 8px;">Use These Dates</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 3px;">
                        ${suggestion.reason} (Score: ${suggestion.score}/100)
                    </div>
                </div>
            `;
        });
        
        suggestionsDiv.innerHTML = suggestionsHTML;
    }

    function useSuggestedDates(startDateStr, endDateStr) {
        // Convert display format to input format
        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        
        document.getElementById('pto-start-date').value = startDate.toISOString().split('T')[0];
        document.getElementById('pto-end-date').value = endDate.toISOString().split('T')[0];
        
        updatePTOPreview();
        
        // Hide suggestions
        document.getElementById('pto-suggestions').style.display = 'none';
        
        alert('‚úÖ Suggested dates have been filled in the form!');
    }

    function showTeamPTOCalendar() {
        const previewDiv = document.getElementById('team-pto-preview');
        previewDiv.innerHTML = '<div style="text-align: center; padding: 10px;">üîÑ Loading team PTO calendar...</div>';
        previewDiv.style.display = 'block';

        // Simulate loading time
        setTimeout(() => {
            const teamCalendar = generateTeamPTOPreview();
            displayTeamPTOPreview(teamCalendar);
        }, 800);
    }

    function generateTeamPTOPreview() {
        const currentDate = new Date();
        const calendar = [];
        
        // Generate next 30 days
        for (let i = 0; i < 30; i++) {
            const date = new Date(currentDate);
            date.setDate(currentDate.getDate() + i);
            const dateKey = date.toISOString().split('T')[0];
            
            const dayData = {
                date: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                dateKey: dateKey,
                ptoEmployees: []
            };
            
            // Check who's on PTO this day
            employees.forEach(emp => {
                if (emp.name.startsWith('OPEN SHIFTS') || emp.type === 'Bank') return;
                
                const shift = scheduleData[emp.name]?.[dateKey];
                if (shift && shift.toUpperCase() === 'PTO') {
                    dayData.ptoEmployees.push(emp.name.split(',')[0] || emp.name);
                }
            });
            
            calendar.push(dayData);
        }
        
        return calendar;
    }

    function displayTeamPTOPreview(calendar) {
        const previewDiv = document.getElementById('team-pto-preview');
        
        let calendarHTML = '<h5>üìÖ Team PTO - Next 30 Days</h5>';
        calendarHTML += '<div style="max-height: 200px; overflow-y: auto;">';
        
        calendar.forEach(day => {
            if (day.ptoEmployees.length > 0) {
                calendarHTML += `
                    <div style="padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                        <strong>${day.date}</strong>
                        <span style="color: #dc3545;">${day.ptoEmployees.join(', ')}</span>
                    </div>
                `;
            }
        });
        
        if (calendar.every(day => day.ptoEmployees.length === 0)) {
            calendarHTML += '<div style="text-align: center; padding: 20px; color: #666;">No team PTO scheduled in the next 30 days</div>';
        }
        
        calendarHTML += '</div>';
        calendarHTML += '<div style="text-align: center; margin-top: 10px;"><button class="btn btn-secondary" onclick="document.getElementById(\'team-pto-preview\').style.display=\'none\'" style="font-size: 12px;">Close</button></div>';
        
        previewDiv.innerHTML = calendarHTML;
    }

    // Enhanced PTO form listeners for the employee portal
    function setupPTOFormListeners() {
        const startDateInput = document.getElementById('pto-start-date');
        const endDateInput = document.getElementById('pto-end-date');
        
        if (startDateInput && endDateInput) {
            startDateInput.addEventListener('change', updatePTOPreview);
            endDateInput.addEventListener('change', updatePTOPreview);
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            startDateInput.min = today;
            endDateInput.min = today;
            
            // Update end date minimum when start date changes
            startDateInput.addEventListener('change', function() {
                endDateInput.min = this.value;
                if (endDateInput.value && endDateInput.value < this.value) {
                    endDateInput.value = this.value;
                }
                updatePTOPreview();
            });
        }
    }

    // ================== PWA AND MOBILE FEATURES ==================
    
    // PWA Installation
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showPWAInstallBanner();
    });

    function showPWAInstallBanner() {
        if (!localStorage.getItem('pwa-dismissed')) {
            document.getElementById('pwa-install-banner').style.display = 'block';
        }
    }

    function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the PWA install prompt');
                    dismissPWABanner();
                }
                deferredPrompt = null;
            });
        }
    }

    function dismissPWABanner() {
        document.getElementById('pwa-install-banner').style.display = 'none';
        localStorage.setItem('pwa-dismissed', 'true');
    }

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('SW registered: ', registration);
                })
                .catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
        });
    }

    // Mobile Navigation
    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        menu.classList.toggle('show');
    }

    function setActiveBottomNav(element) {
        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.classList.remove('active');
        });
        element.classList.add('active');
        toggleMobileMenu(); // Close mobile menu if open
    }

    // Show/Hide Views
    function showManagerView() {
        const managerView = document.getElementById('manager-view');
        managerView.style.display = 'block';
        document.getElementById('employee-portal').style.display = 'none';
        closeAllModals();
        
        // Initialize dashboard content if empty
        if (!managerView.innerHTML.trim()) {
            initializeDashboard();
        }
    }
    
    function initializeDashboard() {
        const managerView = document.getElementById('manager-view');
        const currentMonth = new Date().toISOString().slice(0, 7);
        
        const dashboardContent = `
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <div>
                    <h1>Schedule Dashboard</h1>
                    <p class="dashboard-subtitle">Complete employee scheduling workspace with real-time insights</p>
                </div>
                <div style="text-align: right;">
                    <label for="scheduleMonth" style="display: block; font-size: 0.875rem; color: #cbd5e1; margin-bottom: 0.5rem;">Current Month:</label>
                    <input id="scheduleMonth" type="month" value="${currentMonth}" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.5rem; border-radius: 0.5rem;"/>
                </div>
            </div>
            
            <!-- Key Metrics Dashboard -->
            <div class="metrics-dashboard">
                <div class="metric-card">
                    <div class="metric-value" id="total-employees-metric">${employees.length}</div>
                    <div class="metric-label">Total Employees</div>
                    <div class="metric-change neutral" id="employee-change">Current roster</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="coverage-metric">0%</div>
                    <div class="metric-label">Schedule Coverage</div>
                    <div class="metric-change neutral" id="coverage-change">Generate schedule</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="pto-requests-metric">0</div>
                    <div class="metric-label">Pending PTO</div>
                    <div class="metric-change neutral" id="pto-change">No requests</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="conflicts-metric">0</div>
                    <div class="metric-label">Schedule Conflicts</div>
                    <div class="metric-change positive" id="conflicts-change">All clear</div>
                </div>
            </div>
        </div>

        <div class="dashboard-main">
            <!-- Schedule Section - Primary Focus -->
            <div class="schedule-section">
                <div class="schedule-header">
                    <div>
                        <h2>üìÖ Current Schedule</h2>
                        <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Interactive schedule grid - right-click for options, left-click to edit</p>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary btn-primary-large" onclick="autoGenerateFullSchedule()">‚ú® Generate Full Schedule</button>
                        <button class="btn btn-success" onclick="smartScheduleAssistant()">ü§ñ Smart Assistant</button>
                        <button class="btn btn-warning" onclick="findConflicts()">üö® Find Conflicts</button>
                    </div>
                </div>
                <div class="schedule-content">
                    <div class="table-container">
                        <table id="schedule-table"><thead></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions Section -->
            <div class="action-cards">
                <div class="action-card">
                    <div class="card-header">
                        <span class="card-icon">üë•</span>
                        <h3 class="card-title">Team Management</h3>
                    </div>
                    <p class="card-description">Manage employee roster, availability, and contact information</p>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="openEmployeeModal()">üë• Manage Employees</button>
                        <button class="btn btn-outline" onclick="openTeamDirectory()">üìã Team Directory</button>
                    </div>
                </div>

                <div class="action-card">
                    <div class="card-header">
                        <span class="card-icon">üèñÔ∏è</span>
                        <h3 class="card-title">Time Off Center</h3>
                    </div>
                    <p class="card-description">Review PTO requests, manage approvals, and track time off balances</p>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="openPTORequestsModal()">üèñÔ∏è Review Requests</button>
                        <button class="btn btn-outline" onclick="openPTOCalendarModal()">üìÖ PTO Calendar</button>
                        <button class="btn btn-outline" onclick="openBulkPTOModal()">üìÖ Bulk PTO</button>
                    </div>
                </div>

                <div class="action-card">
                    <div class="card-header">
                        <span class="card-icon">ü§ñ</span>
                        <h3 class="card-title">Schedule Actions</h3>
                    </div>
                    <p class="card-description">Automated scheduling tools and optimization features</p>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="optimizeSchedule()">‚ö° Optimize</button>
                        <button class="btn btn-outline" onclick="moveOpenPositionShifts()">‚û°Ô∏è Move Shifts</button>
                        <button class="btn btn-outline" onclick="showValidationResults()">‚úì Validate</button>
                    </div>
                </div>

                <div class="action-card">
                    <div class="card-header">
                        <span class="card-icon">üìä</span>
                        <h3 class="card-title">Reports & Analytics</h3>
                    </div>
                    <p class="card-description">Generate reports, analyze coverage, and export data</p>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="openReportsModal()">üìä View Reports</button>
                        <button class="btn btn-outline" onclick="openCoverageAnalysisModal()">üë• Coverage Analysis</button>
                        <button class="btn btn-outline" onclick="generateMonthlyPTOReports()">üìä PTO Reports</button>
                    </div>
                </div>

                <div class="action-card">
                    <div class="card-header">
                        <span class="card-icon">üíæ</span>
                        <h3 class="card-title">Data Management</h3>
                    </div>
                    <p class="card-description">Backup, restore, import, export and manage your scheduling data</p>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="exportBackup()">üì• Export Backup</button>
                        <button class="btn btn-outline" onclick="importBackup()">üì§ Import Backup</button>
                        <button class="btn btn-outline" onclick="quickBackupRestore()">‚ö° Quick Backup</button>
                    </div>
                    <div class="card-stats">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280;">
                            <span>Emergency Restore:</span>
                            <button onclick="restoreEmergencyBackup()" style="font-size: 0.75rem; padding: 0.125rem 0.25rem; background: #f59e0b; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">Restore</button>
                        </div>
                    </div>
                </div>

                <div class="action-card">
                    <div class="card-header">
                        <span class="card-icon">‚öôÔ∏è</span>
                        <h3 class="card-title">System Tools</h3>
                    </div>
                    <p class="card-description">Advanced tools, bidding system, and system maintenance</p>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="openBidsModal()">üôã Manage Bids</button>
                        <button class="btn btn-outline" onclick="openEmailModal()">üìß Email Schedule</button>
                        <button class="btn btn-danger" onclick="resetSavedState()">üîÑ Reset Data</button>
                    </div>
                </div>

                <div class="action-card">
                    <div class="card-header">
                        <span class="card-icon">‚ö†Ô∏è</span>
                        <h3 class="card-title">Employee Archive</h3>
                    </div>
                    <p class="card-description">Manage inactive employees and restore archived staff</p>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="openEmployeeArchiveModal()">üìÇ View Archive</button>
                        <button class="btn btn-outline" onclick="showInactiveEmployees()">üëª Show Inactive</button>
                        <button class="btn btn-outline" onclick="massArchiveEmployees()">üì• Mass Archive</button>
                    </div>
                </div>
            </div>

            <!-- Quick Export Actions -->
            <div class="schedule-section">
                <div class="schedule-header">
                    <div>
                        <h2>üìã Quick Export</h2>
                        <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Copy data to clipboard for Excel or other applications</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-secondary" onclick="undo()" id="undoBtn" disabled>‚Ü©Ô∏è Undo</button>
                        <button class="btn btn-secondary" onclick="redo()" id="redoBtn" disabled>‚Ü™Ô∏è Redo</button>
                    </div>
                </div>
                <div class="schedule-content">
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="copyEmployeeListForExcel()">1. Copy Employee List</button>
                        <button class="btn btn-success" onclick="copyScheduleForExcel()">2. Copy Schedule Grid</button>
                        <button class="btn btn-success" onclick="copyOpenShiftsForExcel()">3. Copy Open Shifts List</button>
                        <button class="btn btn-danger" onclick="clearSchedule()">üóëÔ∏è Clear Schedule Grid</button>
                    </div>
                </div>
            </div>

            <!-- Live Dashboard -->
            <div class="schedule-section">
                <div class="schedule-header">
                    <h2>üìä Live Workload Dashboard</h2>
                </div>
                <div class="schedule-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div id="employee-dashboard-container">
                            <h3>Employee Workload</h3>
                            <div style="margin-bottom: 1rem;">
                                <label for="targetHours" style="font-size: 0.875rem; color: #64748b;">Target Hours for FT (approx):</label>
                                <input type="number" id="targetHours" value="160" style="padding: 0.5rem; width: 80px; margin-left: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;" onchange="renderDashboard()">
                            </div>
                            <table id="employee-dashboard-table"></table>
                        </div>
                        <div id="daily-dashboard-container">
                            <h3>Daily Coverage</h3>
                            <div style="margin-bottom: 1rem;">
                                <label for="minStaff" style="font-size: 0.875rem; color: #64748b;">Min Staffing Level:</label>
                                <input type="number" id="minStaff" value="3" style="padding: 0.5rem; width: 80px; margin-left: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem;" onchange="renderDashboard()">
                            </div>
                            <table id="daily-dashboard-table"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
        
        managerView.innerHTML = dashboardContent;
        
        // Attach event listeners after DOM elements are created
        attachScheduleMonthListener();
        
        // Re-trigger table rendering and other initializations
        if (typeof renderTable === 'function') renderTable();
        if (typeof renderDashboard === 'function') renderDashboard();
    }

    function showEmployeePortal() {
        document.getElementById('manager-view').style.display = 'none';
        document.getElementById('employee-portal').style.display = 'block';
        closeAllModals();
        updateQuickScheduleWidget();
    }

    // Quick Schedule Widget
    function toggleQuickScheduleWidget() {
        const widget = document.getElementById('quick-schedule-widget');
        widget.style.display = widget.style.display === 'none' ? 'block' : 'none';
        if (widget.style.display === 'block') {
            updateQuickScheduleWidget();
        }
    }

    function updateQuickScheduleWidget() {
        const today = new Date();
        const dateKey = today.toISOString().split('T')[0];
        const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
        const currentEmployee = localStorage.getItem('currentEmployee');
        
        let content = `<strong>${dayName}, ${today.toLocaleDateString()}</strong><br>`;
        
        if (currentEmployee && scheduleData[currentEmployee]) {
            const shift = scheduleData[currentEmployee][dateKey];
            if (shift && shift.trim() !== '') {
                content += `Your shift: <span style="color: #0d6efd; font-weight: bold;">${shift}</span>`;
            } else {
                content += '<span style="color: #6c757d;">No shift scheduled</span>';
            }
        } else {
            content += '<span style="color: #6c757d;">Select an employee to view schedule</span>';
        }
        
        document.getElementById('today-schedule-content').innerHTML = content;
    }

    // One-tap PTO Request
    function openOneTapPTO() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3>üèñÔ∏è Quick PTO Request</h3>
                    <span class="close" onclick="this.closest('.modal').remove()">√ó</span>
                </div>
                <div>
                    <label>Request Date:</label>
                    <input type="date" id="quick-pto-date" style="width: 100%; margin-bottom: 15px;">
                    <label>Reason:</label>
                    <select id="quick-pto-reason" style="width: 100%; margin-bottom: 15px;">
                        <option value="sick">Sick Day</option>
                        <option value="personal">Personal</option>
                        <option value="vacation">Vacation</option>
                        <option value="emergency">Emergency</option>
                    </select>
                    <button class="btn btn-primary" onclick="submitQuickPTO()" style="width: 100%;">Submit Request</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function submitQuickPTO() {
        const date = document.getElementById('quick-pto-date').value;
        const reason = document.getElementById('quick-pto-reason').value;
        
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        // Use existing PTO submission logic
        document.getElementById('pto-start-date').value = date;
        document.getElementById('pto-end-date').value = date;
        document.getElementById('pto-type').value = reason;
        
        submitPTORequest();
        document.querySelector('.modal').remove();
        showNotification('Quick PTO request submitted!', 'success');
    }

    // Shift Trading Interface
    function openShiftTrading() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üîÑ Shift Trading</h3>
                    <span class="close" onclick="this.closest('.modal').remove()">√ó</span>
                </div>
                <div>
                    <p><em>Shift trading feature coming soon! Contact your manager to arrange shift trades.</em></p>
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // ================== TEAM DIRECTORY ==================

    function openTeamDirectory() {
        document.getElementById('teamDirectoryModal').style.display = 'block';
        loadTeamDirectory();
    }

    function loadTeamDirectory() {
        // Build team directory from employees data
        teamDirectoryData = employees.filter(emp => !emp.name.startsWith('OPEN SHIFTS')).map(emp => ({
            id: emp.id,
            name: emp.name,
            email: emp.email || 'Not provided',
            type: emp.type,
            shifts: emp.shifts || 'Variable',
            availability: emp.availability || 'Not specified',
            hireDate: emp.hireDate || 'Unknown',
            contactOptIn: emp.contactOptIn || false
        }));
        
        renderTeamDirectory();
    }

    function renderTeamDirectory() {
        const container = document.getElementById('team-directory-list');
        container.innerHTML = '';
        
        teamDirectoryData.forEach(member => {
            const card = document.createElement('div');
            card.className = 'team-member-card';
            card.style.cssText = `
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s;
            `;
            
            const photoHtml = `<div style="width: 60px; height: 60px; border-radius: 50%; background: #0d6efd; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px;">${member.name.charAt(0)}</div>`;
            
            const contactInfo = member.contactOptIn ? 
                `<div style="font-size: 12px; color: #6c757d; margin-top: 5px;">üìß ${member.email}</div>` :
                `<div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Contact info private</div>`;
            
            card.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                    ${photoHtml}
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 16px;">${member.name}</div>
                        <div style="color: #6c757d; font-size: 14px;">${member.type} Employee</div>
                        ${contactInfo}
                    </div>
                </div>
                <div style="font-size: 12px; color: #6c757d;">
                    <div><strong>Regular Shifts:</strong> ${member.shifts}</div>
                    <div><strong>Availability:</strong> ${member.availability}</div>
                    <div><strong>Hire Date:</strong> ${member.hireDate}</div>
                </div>
            `;
            
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-2px)';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
            });
            
            container.appendChild(card);
        });
    }

    function filterTeamDirectory() {
        const searchTerm = document.getElementById('team-search').value.toLowerCase();
        const cards = document.querySelectorAll('.team-member-card');
        
        cards.forEach(card => {
            const text = card.textContent.toLowerCase();
            card.style.display = text.includes(searchTerm) ? 'block' : 'none';
        });
    }

    function filterTeamByDepartment(department) {
        const cards = document.querySelectorAll('.team-member-card');
        
        cards.forEach(card => {
            if (department === 'all') {
                card.style.display = 'block';
            } else {
                const type = card.textContent.includes('PT') ? 'part-time' : 
                            card.textContent.includes('FT') ? 'staff' : 'management';
                card.style.display = type === department ? 'block' : 'none';
            }
        });
    }

    // ================== ANNOUNCEMENTS SYSTEM ==================

    function openAnnouncementsModal() {
        document.getElementById('announcementsModal').style.display = 'block';
        
        // Show admin controls if user is admin (simplified check)
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        document.getElementById('admin-announcement-controls').style.display = isAdmin ? 'block' : 'none';
        
        loadAnnouncements();
    }

    async function createAnnouncement() {
        const title = document.getElementById('announcement-title').value;
        const content = document.getElementById('announcement-content').value;
        const priority = document.getElementById('announcement-priority').value;
        const audience = document.getElementById('announcement-audience').value;
        
        if (!title || !content) {
            alert('Please fill in both title and content');
            return;
        }
        
        const announcement = {
            id: generateUUID(),
            title,
            content,
            priority,
            audience,
            author: 'Admin',
            createdAt: new Date().toISOString(),
            readBy: []
        };
        
        announcements.unshift(announcement);
        
        // Save to Supabase
        try {
            await saveState();
        } catch (err) {
            console.error('Failed to save announcement:', err);
            alert('Failed to save announcement to cloud database.');
            return;
        }
        
        // Clear form
        document.getElementById('announcement-title').value = '';
        document.getElementById('announcement-content').value = '';
        
        loadAnnouncements();
        showNotification('Announcement posted successfully!', 'success');
        
        // Send push notification for urgent announcements
        if (priority === 'urgent') {
            sendPushNotification('Urgent Announcement', title);
        }
    }

    function loadAnnouncements() {
        const container = document.getElementById('announcements-list');
        container.innerHTML = '';
        
        if (announcements.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 40px;">No announcements yet</div>';
            return;
        }
        
        announcements.forEach(announcement => {
            const item = document.createElement('div');
            item.style.cssText = `
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                border-left: 4px solid ${getPriorityColor(announcement.priority)};
            `;
            
            const priorityBadge = `<span style="background: ${getPriorityColor(announcement.priority)}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">${announcement.priority.toUpperCase()}</span>`;
            
            item.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: #1c293a;">${announcement.title}</h4>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                            ${announcement.author} ‚Ä¢ ${new Date(announcement.createdAt).toLocaleDateString()} ‚Ä¢ ${priorityBadge}
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 10px; line-height: 1.5;">${announcement.content}</div>
                <div style="font-size: 12px; color: #6c757d;">
                    Target: ${announcement.audience.charAt(0).toUpperCase() + announcement.audience.slice(1)}
                </div>
            `;
            
            container.appendChild(item);
        });
    }

    function getPriorityColor(priority) {
        switch (priority) {
            case 'urgent': return '#dc3545';
            case 'high': return '#fd7e14';
            case 'normal': default: return '#0d6efd';
        }
    }

    // ================== AUDIT LOGS SYSTEM ==================

    function logAuditEvent(action, details, userId = 'unknown') {
        const logEntry = {
            id: generateUUID(),
            timestamp: new Date().toISOString(),
            userId,
            userAgent: navigator.userAgent,
            ipAddress: 'client-side', // In a real app, this would come from server
            action,
            details,
            beforeValue: details.before || null,
            afterValue: details.after || null
        };
        
        auditLogs.unshift(logEntry);
        
        // Keep only last 1000 entries to prevent storage bloat
        if (auditLogs.length > 1000) {
            auditLogs = auditLogs.slice(0, 1000);
        }
        
        // Save to Supabase (fire and forget for audit logs)
        try {
            saveState().catch(err => console.warn('Failed to save audit log:', err));
        } catch (err) {
            console.warn('Failed to save audit log:', err);
        }
    }

    function openAuditLogsModal() {
        // Check if user has admin access
        if (localStorage.getItem('isAdmin') !== 'true') {
            alert('Access denied. Admin privileges required.');
            return;
        }
        
        document.getElementById('auditLogsModal').style.display = 'block';
        loadAuditLogs();
    }

    function loadAuditLogs() {
        const container = document.getElementById('audit-logs-list');
        container.innerHTML = '';
        
        let filteredLogs = [...auditLogs];
        
        // Apply filters
        const startDate = document.getElementById('audit-start-date').value;
        const endDate = document.getElementById('audit-end-date').value;
        const actionFilter = document.getElementById('audit-action-filter').value;
        
        if (startDate) {
            filteredLogs = filteredLogs.filter(log => 
                new Date(log.timestamp) >= new Date(startDate)
            );
        }
        
        if (endDate) {
            filteredLogs = filteredLogs.filter(log => 
                new Date(log.timestamp) <= new Date(endDate + 'T23:59:59')
            );
        }
        
        if (actionFilter) {
            filteredLogs = filteredLogs.filter(log => 
                log.action.includes(actionFilter)
            );
        }
        
        if (filteredLogs.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 40px;">No audit logs found</div>';
            return;
        }
        
        filteredLogs.forEach(log => {
            const item = document.createElement('div');
            item.style.cssText = `
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                font-family: monospace;
                font-size: 12px;
            `;
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <strong style="color: #0d6efd;">${log.action}</strong>
                    <span style="color: #6c757d;">${new Date(log.timestamp).toLocaleString()}</span>
                </div>
                <div style="margin-bottom: 8px; color: #495057;">${log.details.description || 'No description'}</div>
                <div style="font-size: 11px; color: #6c757d;">
                    User: ${log.userId} | IP: ${log.ipAddress}
                </div>
                ${log.beforeValue ? `<div style="font-size: 11px; color: #dc3545; margin-top: 5px;">Before: ${JSON.stringify(log.beforeValue)}</div>` : ''}
                ${log.afterValue ? `<div style="font-size: 11px; color: #198754; margin-top: 5px;">After: ${JSON.stringify(log.afterValue)}</div>` : ''}
            `;
            
            container.appendChild(item);
        });
    }

    function searchAuditLogs() {
        loadAuditLogs();
    }

    function exportAuditLogs() {
        const csv = auditLogs.map(log => 
            `"${log.timestamp}","${log.userId}","${log.action}","${log.details.description || ''}","${log.ipAddress}"`
        ).join('\n');
        
        const header = 'Timestamp,User ID,Action,Description,IP Address\n';
        const blob = new Blob([header + csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit-logs-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    // ================== PUSH NOTIFICATIONS ==================
    
    function requestNotificationPermission() {
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showNotification('Notifications enabled! You\'ll receive updates about schedule changes.', 'success');
                    localStorage.setItem('notificationsEnabled', 'true');
                } else {
                    showNotification('Notifications permission denied.', 'warning');
                }
            });
        } else {
            showNotification('This browser doesn\'t support notifications.', 'warning');
        }
    }

    function sendPushNotification(title, body, data = {}) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body,
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMTYiIGZpbGw9IiMwZDZlZmQiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0xOSAzSDVjLTEuMSAwLTIgLjktMiAydjE0YzAgMS4xLjkgMiAyIDJoMTRjMS4xIDAgMi0uOSAyLTJWNWMwLTEuMS0uOS0yLTItMnoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xOSA3SDV2MTBoMTRWN3oiIGZpbGw9IiMwZDZlZmQiLz4KPC9zdmc+',
                data
            });
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#198754' : type === 'warning' ? '#ffc107' : type === 'error' ? '#dc3545' : '#0d6efd'};
            color: ${type === 'warning' ? '#000' : '#fff'};
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span>${type === 'success' ? '‚úì' : type === 'warning' ? '‚ö†' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    // Enhanced saveEmployee function to include email and opt-in
    const originalSaveEmployee = window.saveEmployee;
    window.saveEmployee = function() {
        // Get the email and opt-in values
        const email = document.getElementById('newEmail').value;
        const contactOptIn = document.getElementById('newContactOptIn').checked;
        
        // Call original function first
        if (originalSaveEmployee) {
            originalSaveEmployee();
        }
        
        // Update the employee with email and opt-in info
        const empIndex = document.getElementById('empIndex').value;
        if (empIndex !== '' && employees[empIndex]) {
            const oldData = {
                email: employees[empIndex].email || '',
                contactOptIn: employees[empIndex].contactOptIn || false
            };
            
            employees[empIndex].email = email;
            employees[empIndex].contactOptIn = contactOptIn;
            
            // Log the audit event
            logAuditEvent('employee_update', {
                description: `Updated employee: ${employees[empIndex].name}`,
                employeeId: employees[empIndex].id,
                before: oldData,
                after: { email, contactOptIn }
            });
        }
        
        saveState();
    };

    // Initialize authentication check on page load
    document.addEventListener('DOMContentLoaded', async function() {
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Set up table container for mobile scrolling
        const table = document.getElementById('schedule-table');
        if (table && !table.parentElement.classList.contains('table-container')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'table-container';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
        }
        
        // Initialize gesture support
        initializeGestureSupport();
    });

    // ================== MOBILE GESTURE SUPPORT ==================
    
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    
    function initializeGestureSupport() {
        const scheduleTable = document.getElementById('schedule-table');
        if (scheduleTable) {
            scheduleTable.classList.add('swipeable');
            
            scheduleTable.addEventListener('touchstart', handleTouchStart, { passive: true });
            scheduleTable.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        
        // Add swipe support to modals
        document.querySelectorAll('.modal-content').forEach(modal => {
            modal.addEventListener('touchstart', handleModalTouchStart, { passive: true });
            modal.addEventListener('touchend', handleModalTouchEnd, { passive: true });
        });
    }
    
    function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }
    
    function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipeGesture();
    }
    
    function handleModalTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }
    
    function handleModalTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        
        // Swipe down to close modal
        if (touchStartY < touchEndY && (touchEndY - touchStartY) > 100) {
            closeAllModals();
        }
    }
    
    function handleSwipeGesture() {
        const swipeThreshold = 50;
        const swipeDistanceX = touchEndX - touchStartX;
        const swipeDistanceY = touchEndY - touchStartY;
        
        // Horizontal swipes for schedule navigation
        if (Math.abs(swipeDistanceX) > Math.abs(swipeDistanceY) && Math.abs(swipeDistanceX) > swipeThreshold) {
            if (swipeDistanceX > 0) {
                // Swipe right - previous week
                navigateSchedule('previous');
            } else {
                // Swipe left - next week
                navigateSchedule('next');
            }
        }
    }
    
    function navigateSchedule(direction) {
        const monthInput = document.getElementById('scheduleMonth');
        if (!monthInput.value) return;
        
        const currentDate = new Date(monthInput.value + '-01');
        if (direction === 'next') {
            currentDate.setMonth(currentDate.getMonth() + 1);
        } else {
            currentDate.setMonth(currentDate.getMonth() - 1);
        }
        
        const newValue = currentDate.toISOString().substr(0, 7);
        monthInput.value = newValue;
        
        // Trigger the change event
        monthInput.dispatchEvent(new Event('change'));
        
        showNotification(`Switched to ${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`, 'info');
    }

    async function clockIn() {
        try {
            const clockInTime = new Date();
            const timeEntry = {
                id: generateUUID(),
                type: 'clock_in',
                timestamp: clockInTime.toISOString(),
                employee: localStorage.getItem('currentEmployee') || 'Unknown'
            };
            
            // Store timesheet entry
            let timesheet = JSON.parse(localStorage.getItem('timesheet')) || [];
            timesheet.push(timeEntry);
            localStorage.setItem('timesheet', JSON.stringify(timesheet));
            
            // Log audit event
            logAuditEvent('clock_in', {
                description: `Employee clocked in at ${clockInTime.toLocaleString()}`,
                employee: timeEntry.employee
            });
            
            showNotification(`Clocked in successfully at ${clockInTime.toLocaleTimeString()}`, 'success');
            
        } catch (error) {
            showNotification(`Clock in failed: ${error}`, 'error');
            
            // Log failed attempt
            logAuditEvent('clock_in_failed', {
                description: `Failed clock in attempt: ${error}`,
                employee: localStorage.getItem('currentEmployee') || 'Unknown'
            });
        }
    }
    
    async function clockOut() {
        try {
            const clockOutTime = new Date();
            const timeEntry = {
                id: generateUUID(),
                type: 'clock_out',
                timestamp: clockOutTime.toISOString(),
                employee: localStorage.getItem('currentEmployee') || 'Unknown'
            };
            
            // Store timesheet entry
            let timesheet = JSON.parse(localStorage.getItem('timesheet')) || [];
            timesheet.push(timeEntry);
            localStorage.setItem('timesheet', JSON.stringify(timesheet));
            
            // Log audit event
            logAuditEvent('clock_out', {
                description: `Employee clocked out at ${clockOutTime.toLocaleString()}`,
                employee: timeEntry.employee
            });
            
            showNotification(`Clocked out successfully at ${clockOutTime.toLocaleTimeString()}`, 'success');
            
        } catch (error) {
            showNotification(`Clock out failed: ${error}`, 'error');
            
            // Log failed attempt
            logAuditEvent('clock_out_failed', {
                description: `Failed clock out attempt: ${error}`,
                employee: localStorage.getItem('currentEmployee') || 'Unknown'
            });
        }
    }
    
    function viewTimesheet() {
        const timesheet = JSON.parse(localStorage.getItem('timesheet')) || [];
        const currentEmployee = localStorage.getItem('currentEmployee');
        
        const employeeTimesheet = timesheet.filter(entry => 
            entry.employee === currentEmployee
        ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìä Your Timesheet</h3>
                    <span class="close" onclick="this.closest('.modal').remove()">√ó</span>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${employeeTimesheet.length === 0 ? 
                        '<p style="text-align: center; color: #6c757d;">No time entries found</p>' :
                        employeeTimesheet.map(entry => `
                            <div style="padding: 10px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${entry.type === 'clock_in' ? 'üü¢ Clock In' : 'üî¥ Clock Out'}</strong>
                                    <div style="font-size: 12px; color: #6c757d;">
                                        ${new Date(entry.timestamp).toLocaleString()}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    ${entry.verified ? '‚úÖ Verified' : '‚ùå Unverified'}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>